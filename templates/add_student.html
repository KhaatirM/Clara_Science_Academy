{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <h3 class="mb-4">{% if edit_mode %}Update Student Information{% else %}Add New Student{% endif %}</h3>

    {# The form_action will be set by the Flask route (e.g., url_for('add_student_director') or url_for('edit_student_director', student_numeric_id=student_data.id)) #}
    <form method="POST" action="{{ url_for('management.add_student') }}" enctype="multipart/form-data" class="needs-validation" novalidate>
        {# CSRF token would go here in a production app with Flask-WTF #}
        {# {{ form.csrf_token }} #}

        <div class="row g-3">
            <h4 class="mt-4 mb-3 border-bottom pb-2">Student Information</h4>
            <div class="col-12 col-md-4">
                <label for="student_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="student_first_name" name="student_first_name" 
                       value="{{ student_data.student_first_name if student_data else '' }}" required>
                <div class="invalid-feedback">First name is required.</div>
            </div>
            <div class="col-12 col-md-4">
                <label for="student_middle_name" class="form-label">Middle Name/Initial</label>
                <input type="text" class="form-control" id="student_middle_name" name="student_middle_name"
                       value="{{ student_data.student_middle_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-4">
                <label for="student_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="student_last_name" name="student_last_name"
                       value="{{ student_data.student_last_name if student_data else '' }}" required>
                <div class="invalid-feedback">Last name is required.</div>
            </div>

            <div class="col-12 col-md-4">
                <label for="grade_level" class="form-label">Current Grade Level <span class="text-danger">*</span></label>
                <select class="form-select" id="grade_level" name="grade_level" required>
                    <option value="">Choose...</option>
                    {% set grades = ["Kindergarten", "1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th", "9th", "10th", "11th", "12th"] %}
                    {% for grade in grades %}
                        <option value="{{ grade }}" {% if student_data and student_data.grade == grade %}selected{% endif %}>{{ grade.replace("st", "st Grade").replace("nd", "nd Grade").replace("rd", "rd Grade").replace("th", "th Grade") if grade not in ["Kindergarten"] else grade }}</option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">Please select a grade level.</div>
            </div>
            <div class="col-12 col-md-4">
                <label for="gender" class="form-label">Gender</label>
                <select class="form-select" id="gender" name="gender">
                    <option value="">Choose...</option>
                    {% set genders = ["Male", "Female", "Non-binary", "Prefer not to say", "Other"] %}
                    {% for g in genders %}
                    <option value="{{ g }}" {% if student_data and student_data.gender == g %}selected{% endif %}>{{ g }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label for="ethnicity" class="form-label">Ethnicity</label>
                <input type="text" class="form-control" id="ethnicity" name="ethnicity" placeholder="e.g., Hispanic, Asian, Caucasian"
                       value="{{ student_data.ethnicity if student_data else '' }}">
            </div>

            <div class="col-12 col-md-6">
                <label for="student_image" class="form-label">Student Image (shoulder view & up)</label>
                <input class="form-control" type="file" id="student_image" name="student_image" accept="image/*">
                {% if edit_mode and student_data and student_data.image and student_data.image != 'default.jpg' %}
                    <div class="form-text mt-1">Current image: <strong>{{ student_data.image }}</strong>. Upload a new file to replace it.</div>
                    <img src="{{ url_for('static', filename='uploads/' + student_data.image) }}" alt="Current Student Image" class="img-thumbnail mt-2 max-width-100" style="max-height: 100px;">
                {% elif edit_mode and student_data and student_data.image == 'default.jpg' %}
                     <div class="form-text mt-1">Currently using default image. Upload a new file to replace it.</div>
                     <img src="{{ url_for('static', filename='uploads/' + student_data.image) }}" alt="Default Student Image" class="img-thumbnail mt-2 max-width-100" style="max-height: 100px;">
                {% else %}
                    <div class="form-text">Upload a clear photo of the student.</div>
                {% endif %}
            </div>
            <div class="col-12 col-md-6">
                <label for="dob" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="dob" name="dob" 
                       value="{{ student_data.dob if student_data else '' }}" required>
                <div class="invalid-feedback">Date of birth is required.</div>
            </div>
            
            <div class="col-12 col-md-6">
                <label for="previous_school" class="form-label">Previous School Name</label>
                <input type="text" class="form-control" id="previous_school" name="previous_school"
                       value="{{ student_data.previous_school if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="transcript" class="form-label">Transcript (PDF, DOCX, JPG, PNG)</label>
                <input class="form-control" type="file" id="transcript" name="transcript" accept=".pdf,.doc,.docx,image/*">
                {% if edit_mode and student_data and student_data.transcript_filename %}
                    <div class="form-text mt-1">Current transcript: <a href="{{ url_for('static', filename='uploads/' + student_data.transcript_filename) }}" target="_blank">{{ student_data.transcript_filename }}</a>. Upload a new file to replace it.</div>
                {% elif edit_mode %}
                     <div class="form-text mt-1">No transcript currently uploaded.</div>
                {% endif %}
            </div>

            <h4 class="mt-5 mb-3 border-bottom pb-2">Student Address</h4>

            <div class="col-12">
                <label for="street_address" class="form-label">Street Address <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="street_address" name="street_address" placeholder="1234 Main St" value="{{ student_data.street_address if student_data else '' }}" required>
                <div class="invalid-feedback">Street address is required.</div>
            </div>

            <div class="col-12">
                <label for="apt_unit_suite" class="form-label">Apt, Unit, Suite, etc. <span class="text-muted">(Optional)</span></label>
                <input type="text" class="form-control" id="apt_unit_suite" name="apt_unit_suite" placeholder="Apartment, studio, or floor" value="{{ student_data.apt_unit_suite if student_data else '' }}">
            </div>

            <div class="col-12 col-md-5">
                <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="city" name="city" value="{{ student_data.city if student_data else '' }}" required>
                <div class="invalid-feedback">City is required.</div>
            </div>
            
            <div class="col-12 col-md-4">
                <label for="state" class="form-label">State <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="state" name="state" value="{{ student_data.state if student_data else '' }}" required>
                <div class="invalid-feedback">State is required.</div>
            </div>

            <div class="col-12 col-md-3">
                <label for="zip_code" class="form-label">Zip Code <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="zip_code" name="zip_code" value="{{ student_data.zip_code if student_data else '' }}" required>
                <div class="invalid-feedback">Zip code is required.</div>
            </div>
            
            <div class="col-12">
                 <label for="email" class="form-label">Email <span class="text-muted">(Optional)</span></label>
                 <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" value="{{ student_data.email if student_data else '' }}">
            </div>

            <h4 class="mt-5 mb-3 border-bottom pb-2">Parent/Guardian Information</h4>
            
            <!-- Parent 1 Information -->
            <h5 class="mt-3 mb-2">Parent 1</h5>
            <div class="col-12 col-md-6">
                <label for="parent1_first_name" class="form-label">First Name</label>
                <input type="text" class="form-control" id="parent1_first_name" name="parent1_first_name"
                       value="{{ student_data.parent1_first_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent1_last_name" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="parent1_last_name" name="parent1_last_name"
                       value="{{ student_data.parent1_last_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent1_email" class="form-label">Email</label>
                <input type="email" class="form-control" id="parent1_email" name="parent1_email"
                       value="{{ student_data.parent1_email if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent1_phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="parent1_phone" name="parent1_phone"
                       value="{{ student_data.parent1_phone if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent1_relationship" class="form-label">Relationship</label>
                <select class="form-select" id="parent1_relationship" name="parent1_relationship">
                    <option value="">Choose...</option>
                    <option value="Mother" {% if student_data and student_data.parent1_relationship == 'Mother' %}selected{% endif %}>Mother</option>
                    <option value="Father" {% if student_data and student_data.parent1_relationship == 'Father' %}selected{% endif %}>Father</option>
                </select>
            </div>
            
            <!-- Parent 2 Information -->
            <h5 class="mt-4 mb-2">Parent 2</h5>
            <div class="col-12 col-md-6">
                <label for="parent2_first_name" class="form-label">First Name</label>
                <input type="text" class="form-control" id="parent2_first_name" name="parent2_first_name"
                       value="{{ student_data.parent2_first_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent2_last_name" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="parent2_last_name" name="parent2_last_name"
                       value="{{ student_data.parent2_last_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent2_email" class="form-label">Email</label>
                <input type="email" class="form-control" id="parent2_email" name="parent2_email"
                       value="{{ student_data.parent2_email if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent2_phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="parent2_phone" name="parent2_phone"
                       value="{{ student_data.parent2_phone if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="parent2_relationship" class="form-label">Relationship</label>
                <select class="form-select" id="parent2_relationship" name="parent2_relationship">
                    <option value="">Choose...</option>
                    <option value="Mother" {% if student_data and student_data.parent2_relationship == 'Mother' %}selected{% endif %}>Mother</option>
                    <option value="Father" {% if student_data and student_data.parent2_relationship == 'Father' %}selected{% endif %}>Father</option>
                </select>
            </div>
            
            <!-- Emergency Contact -->
            <h5 class="mt-4 mb-2">Emergency Contact</h5>
            <div class="col-12 col-md-6">
                <label for="emergency_first_name" class="form-label">First Name</label>
                <input type="text" class="form-control" id="emergency_first_name" name="emergency_first_name"
                       value="{{ student_data.emergency_first_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="emergency_last_name" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="emergency_last_name" name="emergency_last_name"
                       value="{{ student_data.emergency_last_name if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="emergency_email" class="form-label">Email</label>
                <input type="email" class="form-control" id="emergency_email" name="emergency_email"
                       value="{{ student_data.emergency_email if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="emergency_phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="emergency_phone" name="emergency_phone"
                       value="{{ student_data.emergency_phone if student_data else '' }}">
            </div>
            <div class="col-12 col-md-6">
                <label for="emergency_relationship" class="form-label">Relationship</label>
                <select class="form-select" id="emergency_relationship" name="emergency_relationship">
                    <option value="">Choose...</option>
                    <option value="Parent" {% if student_data and student_data.emergency_relationship == 'Parent' %}selected{% endif %}>Parent</option>
                    <option value="Guardian" {% if student_data and student_data.emergency_relationship == 'Guardian' %}selected{% endif %}>Guardian</option>
                    <option value="Grandparent" {% if student_data and student_data.emergency_relationship == 'Grandparent' %}selected{% endif %}>Grandparent</option>
                    <option value="Aunt/Uncle" {% if student_data and student_data.emergency_relationship == 'Aunt/Uncle' %}selected{% endif %}>Aunt/Uncle</option>
                    <option value="Sibling" {% if student_data and student_data.emergency_relationship == 'Sibling' %}selected{% endif %}>Sibling</option>
                    <option value="Other" {% if student_data and student_data.emergency_relationship == 'Other' %}selected{% endif %}>Other</option>
                </select>
            </div>

            <h4 class="mt-5 mb-3 border-bottom pb-2">Additional Information</h4>
            <div class="col-12">
                <label for="medical_concerns" class="form-label">Medical Concerns</label>
                <textarea class="form-control" id="medical_concerns" name="medical_concerns" rows="3" placeholder="List any allergies, medications, or pertinent medical conditions...">{{ student_data.medical_concerns if student_data else '' }}</textarea>
            </div>
            <div class="col-12">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any other relevant information...">{{ student_data.notes if student_data else '' }}</textarea>
            </div>
        </div>

        <hr class="my-4">

        <button class="btn btn-primary btn-lg" type="submit">
            {% if edit_mode %}Update Student{% else %}Add Student{% endif %}
        </button>
        {# The Cancel/Discard button should link back to the student list for the current role #}
        <a href="{{ url_for('management.students') }}" class="btn btn-secondary btn-lg ms-2" role="button">
            {% if edit_mode %}Cancel{% else %}Discard{% endif %}
        </a>
    </form>

    <script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })()
    </script>
</div>
{% endblock %}