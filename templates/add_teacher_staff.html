{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <h3 class="mb-4">{% if edit_mode %}Update Teacher/Staff Information{% else %}Add New Teacher/Staff Member{% endif %}</h3>

    <form method="POST" action="{{ url_for('management.add_teacher_staff') }}" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row g-3">
            <h4 class="mt-4 mb-3 border-bottom pb-2">Personal Information</h4>
            <div class="col-12 col-md-5">
                <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="first_name" name="first_name"
                       value="{{ staff_data.first_name if staff_data else '' }}" required>
                <div class="invalid-feedback">First name is required.</div>
            </div>
            <div class="col-12 col-md-2">
                <label for="middle_initial" class="form-label">M.I.</label>
                <input type="text" class="form-control" id="middle_initial" name="middle_initial" maxlength="1"
                       value="{{ staff_data.middle_initial if staff_data else '' }}">
            </div>
            <div class="col-12 col-md-5">
                <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="last_name" name="last_name"
                       value="{{ staff_data.last_name if staff_data else '' }}" required>
                <div class="invalid-feedback">Last name is required.</div>
            </div>

            <div class="col-12 col-md-4">
                <label for="dob" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="dob" name="dob"
                       value="{{ staff_data.dob if staff_data else '' }}" required>
                <div class="invalid-feedback">Date of birth is required.</div>
            </div>
            <div class="col-12 col-md-4">
                <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                <input type="tel" class="form-control" id="phone" name="phone"
                       value="{{ staff_data.phone if staff_data else '' }}" required placeholder="e.g., 555-123-4567">
                <div class="invalid-feedback">Phone number is required.</div>
            </div>
            <div class="col-12 col-md-4">
                <label for="staff_ssn" class="form-label">Social Security Number</label>
                <input type="text" class="form-control" id="staff_ssn" name="staff_ssn"
                       value="{{ staff_data.ssn if staff_data else '' }}" placeholder="XXX-XX-XXXX">
                <div class="form-text text-danger small">Warning: Handle SSN with extreme care.</div>
            </div>

            <div class="col-12">
                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" value="{{ staff_data.email if staff_data else '' }}" required>
                 <div class="invalid-feedback">A valid email address is required.</div>
            </div>
            
            <h5 class="mt-4 mb-2 border-bottom pb-1">Address</h5>
            <div class="col-12">
                <label for="street_address" class="form-label">Street Address <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="street_address" name="street_address" placeholder="1234 Main St" value="{{ staff_data.street_address if staff_data else '' }}" required>
                <div class="invalid-feedback">Street address is required.</div>
            </div>
            <div class="col-12">
                <label for="apt_unit_suite" class="form-label">Apt, Unit, Suite, etc. <span class="text-muted">(Optional)</span></label>
                <input type="text" class="form-control" id="apt_unit_suite" name="apt_unit_suite" placeholder="Apartment, studio, or floor" value="{{ staff_data.apt_unit_suite if staff_data else '' }}">
            </div>
            <div class="col-12 col-md-5">
                <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="city" name="city" value="{{ staff_data.city if staff_data else '' }}" required>
                <div class="invalid-feedback">City is required.</div>
            </div>
            <div class="col-12 col-md-4">
                <label for="state" class="form-label">State <span class="text-danger">*</span></label>
                <select class="form-select" id="state" name="state" required>
                    <option value="">Choose state...</option>
                    <option value="AL" {% if staff_data and staff_data.state == 'AL' %}selected{% endif %}>Alabama</option>
                    <option value="AK" {% if staff_data and staff_data.state == 'AK' %}selected{% endif %}>Alaska</option>
                    <option value="AZ" {% if staff_data and staff_data.state == 'AZ' %}selected{% endif %}>Arizona</option>
                    <option value="AR" {% if staff_data and staff_data.state == 'AR' %}selected{% endif %}>Arkansas</option>
                    <option value="CA" {% if staff_data and staff_data.state == 'CA' %}selected{% endif %}>California</option>
                    <option value="CO" {% if staff_data and staff_data.state == 'CO' %}selected{% endif %}>Colorado</option>
                    <option value="CT" {% if staff_data and staff_data.state == 'CT' %}selected{% endif %}>Connecticut</option>
                    <option value="DE" {% if staff_data and staff_data.state == 'DE' %}selected{% endif %}>Delaware</option>
                    <option value="FL" {% if staff_data and staff_data.state == 'FL' %}selected{% endif %}>Florida</option>
                    <option value="GA" {% if staff_data and staff_data.state == 'GA' %}selected{% endif %}>Georgia</option>
                    <option value="HI" {% if staff_data and staff_data.state == 'HI' %}selected{% endif %}>Hawaii</option>
                    <option value="ID" {% if staff_data and staff_data.state == 'ID' %}selected{% endif %}>Idaho</option>
                    <option value="IL" {% if staff_data and staff_data.state == 'IL' %}selected{% endif %}>Illinois</option>
                    <option value="IN" {% if staff_data and staff_data.state == 'IN' %}selected{% endif %}>Indiana</option>
                    <option value="IA" {% if staff_data and staff_data.state == 'IA' %}selected{% endif %}>Iowa</option>
                    <option value="KS" {% if staff_data and staff_data.state == 'KS' %}selected{% endif %}>Kansas</option>
                    <option value="KY" {% if staff_data and staff_data.state == 'KY' %}selected{% endif %}>Kentucky</option>
                    <option value="LA" {% if staff_data and staff_data.state == 'LA' %}selected{% endif %}>Louisiana</option>
                    <option value="ME" {% if staff_data and staff_data.state == 'ME' %}selected{% endif %}>Maine</option>
                    <option value="MD" {% if staff_data and staff_data.state == 'MD' %}selected{% endif %}>Maryland</option>
                    <option value="MA" {% if staff_data and staff_data.state == 'MA' %}selected{% endif %}>Massachusetts</option>
                    <option value="MI" {% if staff_data and staff_data.state == 'MI' %}selected{% endif %}>Michigan</option>
                    <option value="MN" {% if staff_data and staff_data.state == 'MN' %}selected{% endif %}>Minnesota</option>
                    <option value="MS" {% if staff_data and staff_data.state == 'MS' %}selected{% endif %}>Mississippi</option>
                    <option value="MO" {% if staff_data and staff_data.state == 'MO' %}selected{% endif %}>Missouri</option>
                    <option value="MT" {% if staff_data and staff_data.state == 'MT' %}selected{% endif %}>Montana</option>
                    <option value="NE" {% if staff_data and staff_data.state == 'NE' %}selected{% endif %}>Nebraska</option>
                    <option value="NV" {% if staff_data and staff_data.state == 'NV' %}selected{% endif %}>Nevada</option>
                    <option value="NH" {% if staff_data and staff_data.state == 'NH' %}selected{% endif %}>New Hampshire</option>
                    <option value="NJ" {% if staff_data and staff_data.state == 'NJ' %}selected{% endif %}>New Jersey</option>
                    <option value="NM" {% if staff_data and staff_data.state == 'NM' %}selected{% endif %}>New Mexico</option>
                    <option value="NY" {% if staff_data and staff_data.state == 'NY' %}selected{% endif %}>New York</option>
                    <option value="NC" {% if staff_data and staff_data.state == 'NC' %}selected{% endif %}>North Carolina</option>
                    <option value="ND" {% if staff_data and staff_data.state == 'ND' %}selected{% endif %}>North Dakota</option>
                    <option value="OH" {% if staff_data and staff_data.state == 'OH' %}selected{% endif %}>Ohio</option>
                    <option value="OK" {% if staff_data and staff_data.state == 'OK' %}selected{% endif %}>Oklahoma</option>
                    <option value="OR" {% if staff_data and staff_data.state == 'OR' %}selected{% endif %}>Oregon</option>
                    <option value="PA" {% if staff_data and staff_data.state == 'PA' %}selected{% endif %}>Pennsylvania</option>
                    <option value="RI" {% if staff_data and staff_data.state == 'RI' %}selected{% endif %}>Rhode Island</option>
                    <option value="SC" {% if staff_data and staff_data.state == 'SC' %}selected{% endif %}>South Carolina</option>
                    <option value="SD" {% if staff_data and staff_data.state == 'SD' %}selected{% endif %}>South Dakota</option>
                    <option value="TN" {% if staff_data and staff_data.state == 'TN' %}selected{% endif %}>Tennessee</option>
                    <option value="TX" {% if staff_data and staff_data.state == 'TX' %}selected{% endif %}>Texas</option>
                    <option value="UT" {% if staff_data and staff_data.state == 'UT' %}selected{% endif %}>Utah</option>
                    <option value="VT" {% if staff_data and staff_data.state == 'VT' %}selected{% endif %}>Vermont</option>
                    <option value="VA" {% if staff_data and staff_data.state == 'VA' %}selected{% endif %}>Virginia</option>
                    <option value="WA" {% if staff_data and staff_data.state == 'WA' %}selected{% endif %}>Washington</option>
                    <option value="WV" {% if staff_data and staff_data.state == 'WV' %}selected{% endif %}>West Virginia</option>
                    <option value="WI" {% if staff_data and staff_data.state == 'WI' %}selected{% endif %}>Wisconsin</option>
                    <option value="WY" {% if staff_data and staff_data.state == 'WY' %}selected{% endif %}>Wyoming</option>
                    <option value="DC" {% if staff_data and staff_data.state == 'DC' %}selected{% endif %}>District of Columbia</option>
                </select>
                <div class="invalid-feedback">State is required.</div>
            </div>
            <div class="col-12 col-md-3">
                <label for="zip_code" class="form-label">Zip Code <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="zip_code" name="zip_code" value="{{ staff_data.zip_code if staff_data else '' }}" required>
                <div class="invalid-feedback">Zip code is required.</div>
            </div>

            <h5 class="mt-4 mb-2 border-bottom pb-1">Emergency Contact</h5>
            <div class="col-12 col-md-5">
                <label for="emergency_contact_name" class="form-label">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name"
                       value="{{ staff_data.emergency_contact_name if staff_data else '' }}" required>
                <div class="invalid-feedback">Emergency contact first name is required.</div>
            </div>
            <div class="col-12 col-md-5">
                <label for="emergency_contact_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="emergency_contact_last_name" name="emergency_contact_last_name"
                       value="{{ staff_data.emergency_contact_last_name if staff_data else '' }}" required>
                <div class="invalid-feedback">Emergency contact last name is required.</div>
            </div>
            <div class="col-12 col-md-2">
                <label for="emergency_contact_relationship" class="form-label">Relationship</label>
                <select class="form-select" id="emergency_contact_relationship" name="emergency_contact_relationship">
                    <option value="">Choose...</option>
                    {% set relationships = ["Spouse", "Parent", "Sibling", "Partner", "Friend", "Other"] %}
                    {% for rel in relationships %}
                        <option value="{{ rel }}" {% if staff_data and staff_data.emergency_contact_relationship == rel %}selected{% endif %}>{{ rel }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label for="emergency_contact_phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                <input type="tel" class="form-control" id="emergency_contact_phone" name="emergency_contact_phone"
                       value="{{ staff_data.emergency_contact_phone if staff_data else '' }}" required placeholder="e.g., 555-123-4567">
                <div class="invalid-feedback">Emergency contact phone is required.</div>
            </div>
            <div class="col-12 col-md-4">
                <label for="emergency_contact_email" class="form-label">Email</label>
                <input type="email" class="form-control" id="emergency_contact_email" name="emergency_contact_email"
                       value="{{ staff_data.emergency_contact_email if staff_data else '' }}" placeholder="emergency@example.com">
                <div class="form-text">Optional email for emergency contact.</div>
            </div>

            <div class="col-12 col-md-6 mt-3">
                <label for="staff_image" class="form-label">Image Upload</label>
                <input class="form-control" type="file" id="staff_image" name="staff_image" accept="image/*">
                 {% if edit_mode and staff_data and staff_data.image and staff_data.image not in ['teacher_default_m.jpg', 'teacher_default_f.jpg'] %}
                    <div class="form-text mt-1">Current image: <strong>{{ staff_data.image }}</strong>. Upload new to replace.</div>
                    <img src="{{ url_for('static', filename='uploads/' + staff_data.image) }}" alt="Current Staff Image" class="img-thumbnail mt-2 max-width-100" style="max-height: 100px;">
                {% elif edit_mode and staff_data and staff_data.image %}
                     <div class="form-text mt-1">Currently using: <strong>{{ staff_data.image }}</strong>. Upload new to replace.</div>
                     <img src="{{ url_for('static', filename='uploads/' + staff_data.image) }}" alt="Staff Image" class="img-thumbnail mt-2 max-width-100" style="max-height: 100px;">
                {% endif %}
            </div>
            
            <h4 class="mt-5 mb-3 border-bottom pb-2">Professional Information</h4>
            <div class="col-12 col-md-6">
                <label for="assigned_role" class="form-label">Assigned Role <span class="text-danger">*</span></label>
                <select class="form-select" id="assigned_role" name="assigned_role" required>
                    <option value="">Choose role...</option>
                    {% set roles = ["Director", "School Administrator", "Math Teacher", "Physics Teacher", "English Language Arts Teacher", "History Teacher", "Science Teacher", "Substitute Teacher", "School Counselor", "IT Support", "Other Staff"] %}
                    {% for role_option in roles %}
                    <option value="{{ role_option }}" {% if staff_data and staff_data.assigned_role == role_option %}selected{% endif %}>{{ role_option }}</option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">Please select an assigned role.</div>
            </div>
            <div class="col-12 col-md-6">
                <label for="hire_date" class="form-label">Hire Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="hire_date" name="hire_date"
                       value="{{ staff_data.hire_date if staff_data else '' }}" required>
                <div class="invalid-feedback">Hire date is required for staff ID generation.</div>
            </div>
            
            <div class="col-12">
                <label class="form-label d-block">Department(s) <span class="text-danger">*</span></label>
                <div class="row g-3 px-2">
                    {% set departments = ["Mathematics", "Science", "English", "History & Social Studies", "Physical Education & Health", "Music & Arts", "Computer Science & Technology", "Administration", "Counseling", "Special Education", "Foreign Language", "Business"] %}
                    {% for dept in departments %}
                    <div class="col-6 col-sm-4 col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="department" value="{{ dept }}"
                                   id="dept_{{ dept|replace(' ', '_')|replace('&', 'and')|replace('(', '')|replace(')', '')|replace('/', '_') }}"
                                   {% if staff_data and staff_data.department and dept in staff_data.department.split(', ') %}checked{% endif %}>
                            <label class="form-check-label" for="dept_{{ dept|replace(' ', '_')|replace('&', 'and')|replace('(', '')|replace(')', '')|replace('/', '_') }}">{{ dept }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="form-text">Select all applicable departments</div>
                <div class="invalid-feedback">Please select at least one department.</div>
            </div>
            <div class="col-12 col-md-6">
                <label for="position" class="form-label">Position</label>
                <input type="text" class="form-control" id="position" name="position"
                       value="{{ staff_data.position if staff_data else '' }}" placeholder="e.g., Lead Teacher, Assistant Principal">
                <div class="form-text">Optional position title within the department.</div>
            </div>
            
            <div class="col-12 col-md-6">
                <label for="subject" class="form-label">Primary Subject(s) Taught</label>
                <input type="text" class="form-control" id="subject" name="subject"
                       value="{{ staff_data.subject if staff_data else '' }}" placeholder="e.g., Algebra I, Chemistry">
                <div class="form-text">Relevant if teaching role is selected.</div>
            </div>

            <div class="col-12 col-md-6">
                <label class="form-label d-block">Employment Type <span class="text-danger">*</span></label>
                {% set emp_types = ["Full Time", "Part Time"] %}
                {% for emp_type in emp_types %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="employment_type" id="emp_{{ emp_type|lower|replace(' ', '_') }}"
                           value="{{ emp_type }}" {% if staff_data and staff_data.employment_type == emp_type %}checked{% endif %} required>
                    <label class="form-check-label" for="emp_{{ emp_type|lower|replace(' ', '_') }}">{{ emp_type }}</label>
                </div>
                {% endfor %}
                 <div class="invalid-feedback d-block">Please select employment type.</div>
            </div>

            <div class="col-12 col-md-6">
                <label for="resume" class="form-label">Resume (PDF, DOC, DOCX)</label>
                <input class="form-control" type="file" id="resume" name="resume" accept=".pdf,.doc,.docx">
                {% if edit_mode and staff_data and staff_data.resume_filename %}
                    <div class="form-text mt-1">Current resume: <a href="{{ url_for('static', filename='uploads/' + staff_data.resume_filename) }}" target="_blank">{{ staff_data.resume_filename }}</a>. Upload new to replace.</div>
                {% endif %}
            </div>
            
            <div class="col-12">
                <label class="form-label d-block">Grade(s) Taught/Overseeing</label>
                <div class="row g-2 px-2">
                    {% set grades = ["Kindergarten", "1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th", "9th", "10th", "11th", "12th", "N/A - Staff"] %}
                    {% for grade_option in grades %}
                    <div class="col-6 col-sm-4 col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="grades_taught" value="{{ grade_option }}"
                                   id="grade_teach_{{ grade_option|replace(' ', '_')|replace('(', '')|replace(')', '')|replace('/', '_') }}"
                                   {% if staff_data and staff_data.grade_taught and grade_option in staff_data.grade_taught %}checked{% endif %}>
                            <label class="form-check-label" for="grade_teach_{{ grade_option|replace(' ', '_')|replace('(', '')|replace(')', '')|replace('/', '_') }}">{{ grade_option }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="form-text">Select all applicable grades. Select "N/A - Staff" for non-teaching roles.</div>
            </div>

            <div class="col-12 mt-3">
                <label for="other_document" class="form-label">Other Relevant Documents</label>
                <input class="form-control" type="file" id="other_document" name="other_document" accept=".pdf,.doc,.docx,image/*">
                {% if edit_mode and staff_data and staff_data.other_document_filename %}
                    <div class="form-text mt-1">Current document: <a href="{{ url_for('static', filename='uploads/' + staff_data.other_document_filename) }}" target="_blank">{{ staff_data.other_document_filename }}</a>. Upload new to replace.</div>
                {% endif %}
                <div class="form-text">E.g., Certifications, Portfolio. Combine multiple into one PDF/ZIP if needed.</div>
            </div>
            </div>

        <hr class="my-4">

        <div class="d-flex flex-column flex-md-row gap-2">
            <button class="btn btn-primary btn-lg" type="submit">
                {% if edit_mode %}Update{% else %}Add Teacher/Staff{% endif %}
            </button>
            <a href="{{ url_for('management.teachers') }}" class="btn btn-secondary btn-lg">
                {% if edit_mode %}Cancel{% else %}Discard{% endif %}
            </a>
        </div>
    </form>

    <script>
    (function () { 'use strict'; var forms = document.querySelectorAll('.needs-validation'); Array.prototype.slice.call(forms).forEach(function (form) { form.addEventListener('submit', function (event) { if (!form.checkValidity()) { event.preventDefault(); event.stopPropagation(); } form.classList.add('was-validated'); }, false); }); })();
    
    // Auto-assign role and department for Tech users
    document.addEventListener('DOMContentLoaded', function() {
        // Check if current user is Tech role
                       const isTechUser = {{ 'true' if current_user.role in ['Tech', 'IT Support'] else 'false' }};
        
        if (isTechUser) {
            // Auto-select IT Support role
            const roleSelect = document.getElementById('assigned_role');
            if (roleSelect) {
                roleSelect.value = 'IT Support';
            }
            
            // Auto-check Administration department
            const adminDeptCheckbox = document.getElementById('dept_Administration');
            if (adminDeptCheckbox) {
                adminDeptCheckbox.checked = true;
            }
            
            // Disable role selection for Tech users
            if (roleSelect) {
                roleSelect.disabled = true;
                roleSelect.style.backgroundColor = '#f8f9fa';
            }
            
            // Disable department checkboxes for Tech users
            const deptCheckboxes = document.querySelectorAll('input[name="department"]');
            deptCheckboxes.forEach(checkbox => {
                checkbox.disabled = true;
                checkbox.style.backgroundColor = '#f8f9fa';
            });
            
            // Show info message
            const roleLabel = document.querySelector('label[for="assigned_role"]');
            if (roleLabel) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'alert alert-info mt-2';
                infoDiv.innerHTML = '<i class="bi bi-info-circle"></i> Tech users are automatically assigned IT Support role and Administration department.';
                roleLabel.parentNode.appendChild(infoDiv);
            }
        }
    });
    </script>
</div>
{% endblock %}