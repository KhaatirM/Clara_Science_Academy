{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Generate Custom Report Card PDF</h3>
    <div>
      <a href="{{ url_for(role_prefix ~ 'dashboard_section', section='report_cards') }}" class="btn btn-outline-secondary btn-sm me-2">Back to Report Cards List</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      Select Criteria for PDF Generation
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('report_card_generate_pdf_form', role_prefix_raw=role_prefix.replace('_', '')) }}">
        
        <div class="mb-3">
          <label for="student_id" class="form-label">Select Student</label>
          <select class="form-select" id="student_id" name="student_id" required>
            <option value="">-- Select a Student --</option>
            {% for student in all_students %}
              <option value="{{ student.id }}" {% if student.id == selected_student_id %}selected{% endif %}>
                  {{ student.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="school_year" class="form-label">School Year</label>
          <select class="form-select" id="school_year" name="school_year" required>
              {% for year in school_years %}
                  <option value="{{ year }}" {% if year == selected_school_year or (not selected_school_year and year == current_school_year) %}selected{% endif %}>
                      {{ year }}
                  </option>
              {% endfor %}
          </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Select Classes</label>
            <div class="checkbox-container">
                {% for class_item in all_classes %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="class_ids" value="{{ class_item.id }}" id="class_{{ class_item.id }}" {% if class_item.id in selected_class_ids %}checked{% endif %}>
                        <label class="form-check-label" for="class_{{ class_item.id }}">
                            {{ class_item.name }} ({{ class_item.subject }})
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Select Quarters</label>
            <div class="checkbox-container">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="All" id="quarter_all" {% if 'All' in selected_quarters %}checked{% endif %}>
                    <label class="form-check-label" for="quarter_all">
                        <strong>All Quarters</strong>
                    </label>
                </div>
                <hr class="my-1">
                {% for q in quarters %}
                    {% if q != 'All' %}
                        <div class="form-check">
                            <input class="form-check-input quarter-option" type="checkbox" name="quarters" value="{{ q }}" id="quarter_{{ q }}" {% if q in selected_quarters or 'All' in selected_quarters %}checked{% endif %}>
                            <label class="form-check-label" for="quarter_{{ q }}">
                                {{ q }}
                            </label>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Report Type</label>
          <div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="report_type" id="official_report" value="official" {% if selected_report_type == 'official' %}checked{% endif %}>
              <label class="form-check-label" for="official_report">Official</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="report_type" id="unofficial_report" value="unofficial" {% if selected_report_type == 'unofficial' %}checked{% endif %}>
              <label class="form-check-label" for="unofficial_report">Unofficial</label>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Generate PDF</button>
      </form>
    </div>
  </div>

  <style>
    .checkbox-container {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: .25rem;
        padding: .5rem .75rem;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const allQuartersCheckbox = document.getElementById('quarter_all');
        const quarterOptionCheckboxes = document.querySelectorAll('.quarter-option');

        function updateAllQuartersState() {
            let allChecked = true;
            quarterOptionCheckboxes.forEach(function(cb) {
                if (!cb.checked) {
                    allChecked = false;
                }
            });
            allQuartersCheckbox.checked = allChecked;
        }

        allQuartersCheckbox.addEventListener('change', function() {
            quarterOptionCheckboxes.forEach(function(checkbox) {
                checkbox.checked = allQuartersCheckbox.checked;
            });
            if (this.checked) {
                this.name = "quarters";
            } else {
                this.name = ""; // Remove name when unchecked so "All" isn't submitted
            }
        });

        quarterOptionCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                updateAllQuartersState();
            });
        });

        // Set initial state on page load
        updateAllQuartersState();
        if(allQuartersCheckbox.checked) {
            allQuartersCheckbox.name = "quarters";
        } else {
            allQuartersCheckbox.name = "";
        }
    });
  </script>

{% endblock %}