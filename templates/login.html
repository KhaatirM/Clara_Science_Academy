{% extends "base.html" %}

{% block content %}
<!-- Cache busting for security updates -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
/* Hide CSRF token from being visible */
input[name="csrf_token"] {
    display: none !important;
}

/* More aggressive approach to hide CSRF token text */
.card-body {
    position: relative;
    overflow: hidden;
}

/* Hide any text that appears between h2 and form */
.card-body h2 + *:not(form) {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    width: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: 0 !important;
    line-height: 0 !important;
}

/* Alternative approach - hide any text nodes */
.card-body > *:not(h2):not(form):not(div):not(script) {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
}

/* Target any text that might be rendered as plain text */
.card-body::after {
    content: '';
    position: absolute;
    top: 60px;
    left: 0;
    right: 0;
    height: 30px;
    background: white;
    z-index: 10;
}

/* More specific targeting for CSRF token text */
.card-body h2 ~ *:not(form) {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    width: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: 0 !important;
    line-height: 0 !important;
    overflow: hidden !important;
}

/* Hide any text nodes that might contain CSRF tokens */
.card-body > *:not(h2):not(form):not(div):not(script):not(style) {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    width: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: 0 !important;
    line-height: 0 !important;
    overflow: hidden !important;
}

/* Target any text that appears as a direct child of card-body */
.card-body > text {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    width: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: 0 !important;
    line-height: 0 !important;
    overflow: hidden !important;
}

/* Hide any text content that might be rendered */
.card-body {
    font-size: 0;
}

.card-body h2,
.card-body form,
.card-body div {
    font-size: initial;
}
</style>
<div class="row justify-content-center mt-3 mt-md-5 login-page">
  <div class="col-12 col-sm-8 col-md-6 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body p-3 p-md-4">
        <h2 class="text-center mb-4">ðŸ”’ SECURE LOGIN ðŸ”’</h2>
        <!-- Updated login form - Role selection removed for enhanced security -->
        <div class="alert alert-info text-center">
            <strong>Enhanced Security:</strong> Role selection removed - system auto-detects your role!
        </div>
        <!-- CSRF token will be automatically added here by Flask-WTF -->
        <form method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" name="username" id="username" class="form-control" autocomplete="username" required>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <div class="input-group">
              <input type="password" name="password" id="password" class="form-control" autocomplete="current-password" required>
              <button class="btn btn-outline-secondary" type="button" id="togglePassword" 
                      data-bs-toggle="tooltip" data-bs-placement="top" title="Show Password">
                <i class="bi bi-eye" id="passwordIcon"></i>
              </button>
            </div>
          </div>
          <div class="mb-3">
            <label for="user_id" class="form-label">ID Number <span class="text-muted small">(Required for Students & Staff)</span></label>
            <input type="text" name="user_id" id="user_id" class="form-control" autocomplete="off">
            <div class="form-text">Enter your student ID or staff ID number (optional for Tech users)</div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="mobileWarningModal" tabindex="-1" aria-labelledby="mobileWarningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mobileWarningModalLabel">Compatibility Notice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>For the best experience, we recommend using a desktop or laptop computer. This site is not fully optimized for mobile devices (Version 1.03).</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Password visibility toggle functionality
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    const passwordIcon = document.getElementById('passwordIcon');
    const tooltip = bootstrap.Tooltip.getInstance(togglePassword);

    togglePassword.addEventListener('click', function() {
      // Toggle password visibility
      const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
      password.setAttribute('type', type);
      
      // Toggle icon
      if (type === 'text') {
        passwordIcon.classList.remove('bi-eye');
        passwordIcon.classList.add('bi-eye-slash');
        tooltip.setContent({ '.tooltip-inner': 'Hide Password' });
      } else {
        passwordIcon.classList.remove('bi-eye-slash');
        passwordIcon.classList.add('bi-eye');
        tooltip.setContent({ '.tooltip-inner': 'Show Password' });
      }
    });

    // Mobile warning popup logic
    if (window.innerWidth < 768) {
        var myModal = new bootstrap.Modal(document.getElementById('mobileWarningModal'), {
            keyboard: false
        });
        myModal.show();
    }

    // ID input is now always required - no role-based toggling needed
    
    // Remove any CSRF token text that might appear
    function removeCSRFTokenText() {
      const cardBody = document.querySelector('.card-body');
      if (cardBody) {
        // Remove any text nodes that contain CSRF-like patterns
        const walker = document.createTreeWalker(
          cardBody,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        
        let node;
        while (node = walker.nextNode()) {
          if (node.textContent && node.textContent.match(/^[A-Za-z0-9+/=]+\.[A-Za-z0-9+/=]+\.[A-Za-z0-9+/=]+$/)) {
            node.remove();
          }
        }
      }
    }
    
    // Run immediately and after a short delay
    removeCSRFTokenText();
    setTimeout(removeCSRFTokenText, 100);
  });
</script>
{% endblock %}
