{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management_edit_class.css') }}">
{% endblock %}

{% block title %}Edit Class - {{ class_info.name }}{% endblock %}

{% block dashboard_content %}
<div class="edit-class-container">
    <!-- Modern Header -->
    <div class="edit-class-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">
                    <i class="bi bi-pencil-square"></i>
                </div>
                <div>
                    <h1 class="header-title">Edit Class</h1>
                    <p class="header-subtitle">{{ class_info.name }} â€¢ {{ class_info.subject }}</p>
                </div>
            </div>
            <a href="{{ url_for('management.view_class', class_id=class_info.id) }}" class="btn-back">
                <i class="bi bi-arrow-left"></i> Back to Class
            </a>
        </div>
    </div>

    <div class="edit-class-grid">
        <!-- Main Form Section -->
        <div class="form-section">
            <form method="POST" class="edit-class-form" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <!-- Basic Information Card -->
                <div class="form-card">
                    <div class="card-header-modern">
                        <div class="card-icon">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <h3>Basic Information</h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="name" class="form-label-modern">
                                    <i class="bi bi-mortarboard"></i>
                                    Class Name <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input-modern" id="name" name="name" 
                                       value="{{ class_info.name }}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="subject" class="form-label-modern">
                                    <i class="bi bi-book"></i>
                                    Subject <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input-modern" id="subject" name="subject" 
                                       value="{{ class_info.subject or '' }}" required>
                            </div>

                            <div class="form-group">
                                <label for="room_number" class="form-label-modern">
                                    <i class="bi bi-door-open"></i>
                                    Room Number
                                </label>
                                <input type="text" class="form-input-modern" id="room_number" name="room_number" 
                                       value="{{ class_info.room_number or '' }}" placeholder="e.g., Room 101">
                            </div>

                            <div class="form-group">
                                <label for="max_students" class="form-label-modern">
                                    <i class="bi bi-people-fill"></i>
                                    Maximum Students
                                </label>
                                <input type="number" class="form-input-modern" id="max_students" name="max_students" 
                                       value="{{ class_info.max_students or 30 }}" min="1" max="100">
                            </div>

                            <div class="form-group form-group-full">
                                <label class="form-label-modern">
                                    <i class="bi bi-clock"></i>
                                    Weekly Schedule
                                </label>
                                <div class="schedule-builder">
                                    <div class="schedule-table-wrapper">
                                        <table class="schedule-table">
                                            <thead>
                                                <tr>
                                                    <th class="time-header">Time</th>
                                                    <th class="day-header">Mon</th>
                                                    <th class="day-header">Tue</th>
                                                    <th class="day-header">Wed</th>
                                                    <th class="day-header">Thu</th>
                                                    <th class="day-header">Fri</th>
                                                    <th class="day-header disabled">Sat</th>
                                                    <th class="day-header disabled">Sun</th>
                                                </tr>
                                            </thead>
                                            <tbody id="scheduleGrid">
                                                <!-- Time slots will be generated by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <input type="hidden" id="schedule" name="schedule" value="{{ class_info.schedule or '' }}">
                                    <div class="schedule-actions">
                                        <button type="button" class="btn-schedule-clear" onclick="clearSchedule()">
                                            <i class="bi bi-x-circle"></i> Clear All
                                        </button>
                                        <small class="form-hint">Click time slots to mark class meetings. Saturday and Sunday are disabled.</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group form-group-full">
                                <label for="description" class="form-label-modern">
                                    <i class="bi bi-file-text"></i>
                                    Description
                                </label>
                                <textarea class="form-textarea-modern" id="description" name="description" rows="3" 
                                          placeholder="Optional description of the class...">{{ class_info.description or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Teacher Assignment Card -->
                <div class="form-card">
                    <div class="card-header-modern">
                        <div class="card-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <h3>Teacher Assignment</h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="teacher-section">
                            <div class="teacher-group">
                                <label for="teacher_id" class="form-label-modern">
                                    <i class="bi bi-person-fill"></i>
                                    Primary Teacher <span class="required">*</span>
                                </label>
                                <select class="form-select-modern" id="teacher_id" name="teacher_id" required>
                                    <option value="">Select a primary teacher...</option>
                                    {% for teacher in available_teachers %}
                                    <option value="{{ teacher.id }}" 
                                            {% if class_info.teacher_id == teacher.id %}selected{% endif %}>
                                        {{ teacher.first_name }} {{ teacher.last_name }}
                                        {% if teacher.user %}({{ teacher.user.username }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="teacher-grid">
                                <div class="teacher-group">
                                    <label for="substitute_teachers" class="form-label-modern">
                                        <i class="bi bi-person-clock"></i>
                                        Substitute Teachers
                                    </label>
                                    <select class="form-select-modern form-select-multiple" id="substitute_teachers" 
                                            name="substitute_teachers" multiple size="5">
                                        {% for teacher in available_teachers %}
                                        <option value="{{ teacher.id }}" 
                                                {% if teacher in class_info.substitute_teachers %}selected{% endif %}>
                                            {{ teacher.first_name }} {{ teacher.last_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-hint">Hold Ctrl/Cmd to select multiple</small>
                                </div>

                                <div class="teacher-group">
                                    <label for="additional_teachers" class="form-label-modern">
                                        <i class="bi bi-people"></i>
                                        Additional Teachers
                                    </label>
                                    <select class="form-select-modern form-select-multiple" id="additional_teachers" 
                                            name="additional_teachers" multiple size="5">
                                        {% for teacher in available_teachers %}
                                        <option value="{{ teacher.id }}" 
                                                {% if teacher in class_info.additional_teachers %}selected{% endif %}>
                                            {{ teacher.first_name }} {{ teacher.last_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-hint">Hold Ctrl/Cmd to select multiple</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grade Levels Card -->
                <div class="form-card">
                    <div class="card-header-modern">
                        <div class="card-icon">
                            <i class="bi bi-graduation-cap"></i>
                        </div>
                        <h3>Grade Levels</h3>
                    </div>
                    <div class="card-body-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-list-ol"></i>
                            Target Grade Levels
                        </label>
                        
                        <!-- Search Box -->
                        <div class="grade-search-box mb-3">
                            <i class="bi bi-search"></i>
                            <input type="text" id="gradeSearch" class="grade-search-input" placeholder="Search grade levels...">
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="mb-3">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllGrades()">
                                    <i class="bi bi-check-all me-1"></i>Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllGrades()">
                                    <i class="bi bi-x me-1"></i>Clear All
                                </button>
                                <span class="ms-auto text-muted small align-self-center" id="gradeSelectedCount">0 selected</span>
                            </div>
                        </div>
                        
                        <!-- Grade Levels List -->
                        <div class="grade-levels-list" id="gradeLevelsList">
                            {% for grade in range(1, 13) %}
                            <div class="grade-level-item" data-grade-name="grade {{ grade }}">
                                <input class="grade-checkbox" type="checkbox" 
                                       name="grade_levels" value="{{ grade }}" 
                                       id="grade_{{ grade }}"
                                       {% if class_info.get_grade_levels and grade in class_info.get_grade_levels() %}checked{% endif %}
                                       onchange="updateGradeSelectedCount()">
                                <label class="grade-level-label" for="grade_{{ grade }}">
                                    <div class="grade-level-avatar">
                                        {{ grade }}
                                    </div>
                                    <div class="grade-level-info">
                                        <div class="grade-level-name">Grade {{ grade }}</div>
                                        <div class="grade-level-meta">
                                            <span class="grade-meta-badge">
                                                <i class="bi bi-mortarboard"></i>
                                                {% if grade <= 5 %}Elementary{% elif grade <= 8 %}Middle School{% else %}High School{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="form-card">
                    <div class="card-header-modern">
                        <div class="card-icon">
                            <i class="bi bi-toggle-on"></i>
                        </div>
                        <h3>Class Status</h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="status-toggle">
                            <label class="toggle-label" for="is_active">
                                <input type="checkbox" class="toggle-input" id="is_active" name="is_active" 
                                       {% if class_info.is_active %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="toggle-text">
                                    <strong>Class is Active</strong>
                                    <small>When active, this class is available for enrollment and assignments</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <a href="{{ url_for('management.view_class', class_id=class_info.id) }}" class="btn-cancel">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                    <button type="submit" class="btn-submit">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar Info Panel -->
        <div class="sidebar-section">
            <div class="info-panel">
                <div class="panel-header">
                    <i class="bi bi-info-circle"></i>
                    <h3>Current Configuration</h3>
                </div>
                
                <div class="info-group">
                    <h4>Class Details</h4>
                    <div class="info-item">
                        <span class="info-label">Name</span>
                        <span class="info-value">{{ class_info.name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Subject</span>
                        <span class="info-value">{{ class_info.subject or 'Not set' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Room</span>
                        <span class="info-value">{{ class_info.room_number or 'Not set' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Schedule</span>
                        <span class="info-value">{{ class_info.schedule or 'Not set' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Max Students</span>
                        <span class="info-value">{{ class_info.max_students or 30 }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value">
                            {% if class_info.is_active %}
                                <span class="status-badge status-active">Active</span>
                            {% else %}
                                <span class="status-badge status-inactive">Inactive</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="info-group">
                    <h4>Teachers</h4>
                    <div class="info-item">
                        <span class="info-label">Primary</span>
                        <span class="info-value">
                            {% if class_info.teacher_id %}
                                {% for teacher in available_teachers %}
                                    {% if teacher.id == class_info.teacher_id %}
                                        {{ teacher.first_name }} {{ teacher.last_name }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Substitutes</span>
                        <span class="info-value">
                            {% set sub_count = class_info.substitute_teachers|list|length %}
                            {% if sub_count > 0 %}
                                {{ sub_count }} assigned
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Additional</span>
                        <span class="info-value">
                            {% set add_count = class_info.additional_teachers|list|length %}
                            {% if add_count > 0 %}
                                {{ add_count }} assigned
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="info-group">
                    <h4>Other Info</h4>
                    <div class="info-item">
                        <span class="info-label">Grade Levels</span>
                        <span class="info-value">
                            {% if class_info.get_grade_levels_display %}
                                {{ class_info.get_grade_levels_display() }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">School Year</span>
                        <span class="info-value">
                            {% if class_info.school_year %}
                                {{ class_info.school_year.name }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="panel-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p><strong>Note:</strong> Changes will affect all assignments and student records for this class.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Schedule Builder Functionality
(function() {
    const scheduleInput = document.getElementById('schedule');
    const scheduleGrid = document.getElementById('scheduleGrid');
    
    if (!scheduleGrid || !scheduleInput) return;
    
    // Generate time slots (8:30 AM to 3:30 PM, 30-minute intervals)
    const timeSlots = [];
    // Start at 8:30 AM (hour 8, minute 30)
    // End at 3:30 PM (hour 15, minute 30)
    for (let hour = 8; hour <= 15; hour++) {
        const startMinute = hour === 8 ? 30 : 0;
        const endMinute = hour === 15 ? 30 : 60;
        
        for (let minute = startMinute; minute < endMinute; minute += 30) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const displayTime = formatTime(hour, minute);
            timeSlots.push({ value: timeStr, display: displayTime });
        }
    }
    
    // Parse existing schedule
    let selectedSlots = parseSchedule(scheduleInput.value);
    
    // Generate table rows
    timeSlots.forEach(slot => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="time-cell">${slot.display}</td>
            <td class="schedule-cell" data-day="mon" data-time="${slot.value}"></td>
            <td class="schedule-cell" data-day="tue" data-time="${slot.value}"></td>
            <td class="schedule-cell" data-day="wed" data-time="${slot.value}"></td>
            <td class="schedule-cell" data-day="thu" data-time="${slot.value}"></td>
            <td class="schedule-cell" data-day="fri" data-time="${slot.value}"></td>
            <td class="schedule-cell disabled" data-day="sat" data-time="${slot.value}"></td>
            <td class="schedule-cell disabled" data-day="sun" data-time="${slot.value}"></td>
        `;
        scheduleGrid.appendChild(row);
    });
    
    // Add click handlers after a short delay to ensure DOM is ready
    setTimeout(() => {
        document.querySelectorAll('.schedule-cell:not(.disabled)').forEach(cell => {
            cell.addEventListener('click', function() {
                const day = this.dataset.day;
                const time = this.dataset.time;
                const key = `${day}-${time}`;
                
                if (this.classList.contains('active')) {
                    this.classList.remove('active');
                    delete selectedSlots[key];
                } else {
                    this.classList.add('active');
                    selectedSlots[key] = { day, time };
                }
                
                updateScheduleInput();
            });
            
            // Mark existing selections
            const day = cell.dataset.day;
            const time = cell.dataset.time;
            const key = `${day}-${time}`;
            if (selectedSlots[key]) {
                cell.classList.add('active');
            }
        });
    }, 100);
    
    function formatTime(hour, minute) {
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
    }
    
    function parseSchedule(scheduleStr) {
        const slots = {};
        if (!scheduleStr) return slots;
        
        // For now, we'll let users rebuild the schedule
        // In the future, we could parse formats like "Mon 9:00 AM, Wed 2:00 PM"
        return slots;
    }
    
    function updateScheduleInput() {
        const scheduleParts = [];
        const dayNames = ['mon', 'tue', 'wed', 'thu', 'fri'];
        const dayLabels = { 'mon': 'Mon', 'tue': 'Tue', 'wed': 'Wed', 'thu': 'Thu', 'fri': 'Fri' };
        
        // Group by day
        dayNames.forEach(day => {
            const daySlots = Object.keys(selectedSlots)
                .filter(key => selectedSlots[key].day === day)
                .map(key => selectedSlots[key].time)
                .sort();
            
            if (daySlots.length > 0) {
                // Group consecutive times
                const timeRanges = groupConsecutiveTimes(daySlots);
                timeRanges.forEach(range => {
                    const startTime = formatTimeForDisplay(range.start);
                    const endTime = formatTimeForDisplay(range.end);
                    if (range.start === range.end) {
                        scheduleParts.push(`${dayLabels[day]} ${startTime}`);
                    } else {
                        scheduleParts.push(`${dayLabels[day]} ${startTime}-${endTime}`);
                    }
                });
            }
        });
        
        scheduleInput.value = scheduleParts.join(', ') || '';
    }
    
    function groupConsecutiveTimes(times) {
        if (times.length === 0) return [];
        
        const ranges = [];
        let currentStart = times[0];
        let currentEnd = times[0];
        
        for (let i = 1; i < times.length; i++) {
            const prevTime = parseTime(currentEnd);
            const currTime = parseTime(times[i]);
            
            // Check if 30 minutes apart
            if (currTime - prevTime === 30) {
                currentEnd = times[i];
            } else {
                ranges.push({ start: currentStart, end: add30Minutes(currentEnd) });
                currentStart = times[i];
                currentEnd = times[i];
            }
        }
        
        ranges.push({ start: currentStart, end: add30Minutes(currentEnd) });
        return ranges;
    }
    
    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    function add30Minutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        let newMinutes = minutes + 30;
        let newHours = hours;
        if (newMinutes >= 60) {
            newMinutes = 0;
            newHours += 1;
        }
        return `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
    }
    
    function formatTimeForDisplay(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHour = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
        return `${displayHour}:${minutes.toString().padStart(2, '0')} ${period}`;
    }
    
    // Make clearSchedule available globally
    window.clearSchedule = function() {
        selectedSlots = {};
        document.querySelectorAll('.schedule-cell.active').forEach(cell => {
            cell.classList.remove('active');
        });
        updateScheduleInput();
    };
})();

// Grade Levels Selection Functions
(function() {
    // Search functionality
    const gradeSearchInput = document.getElementById('gradeSearch');
    if (gradeSearchInput) {
        gradeSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const gradeItems = document.querySelectorAll('.grade-level-item');
            
            gradeItems.forEach(item => {
                const gradeName = item.dataset.gradeName || '';
                const label = item.querySelector('.grade-level-name');
                const labelText = label ? label.textContent.toLowerCase() : '';
                
                if (gradeName.includes(searchTerm) || labelText.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateGradeSelectedCount();
        });
    }
    
    // Update selected count
    window.updateGradeSelectedCount = function() {
        const checkboxes = document.querySelectorAll('.grade-checkbox:not(:disabled)');
        const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
            const item = cb.closest('.grade-level-item');
            return item && item.style.display !== 'none';
        });
        const checked = visibleCheckboxes.filter(cb => cb.checked).length;
        const total = visibleCheckboxes.length;
        
        const countElement = document.getElementById('gradeSelectedCount');
        if (countElement) {
            countElement.textContent = `${checked} selected${total > 0 ? ` of ${total}` : ''}`;
        }
    };
    
    // Select all visible grades
    window.selectAllGrades = function() {
        const checkboxes = document.querySelectorAll('.grade-checkbox:not(:disabled)');
        const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
            const item = cb.closest('.grade-level-item');
            return item && item.style.display !== 'none';
        });
        
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateGradeSelectedCount();
    };
    
    // Clear all grades
    window.clearAllGrades = function() {
        const checkboxes = document.querySelectorAll('.grade-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        updateGradeSelectedCount();
    };
    
    // Initialize count on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateGradeSelectedCount);
    } else {
        updateGradeSelectedCount();
    }
})();
</script>
{% endblock %}
