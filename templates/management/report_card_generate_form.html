{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management_report_card_generate_form.css') }}">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1 fw-bold">
            <i class="bi bi-file-earmark-text-fill text-primary me-2"></i>Generate Report Card PDF
          </h2>
          <p class="text-muted mb-0">Fill out all the required information below to generate a downloadable PDF report card</p>
        </div>
        <a href="{{ url_for('management.report_cards') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back to Report Cards
        </a>
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white py-4" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
          <h4 class="mb-0">
            <i class="bi bi-file-earmark-pdf-fill me-2"></i>Report Card Information
          </h4>
        </div>
        <div class="card-body p-4 p-md-5">
          <form method="POST" action="{{ url_for('management.generate_report_card_form') }}" id="reportCardForm" class="needs-validation" novalidate target="_blank">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- Step 1: Student Info -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">1. Student Information</h5>
                  <p class="text-muted mb-0 small">Report card will be generated for this student</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8 mx-auto">
                  {% if pre_selected_student %}
                    <!-- Student pre-selected from category page -->
                    <input type="hidden" id="student_id" name="student_id" value="{{ pre_selected_student }}">
                    <div class="alert alert-info border-0 shadow-sm mb-0">
                      <div class="d-flex align-items-center">
                        <div class="student-icon me-3">
                          <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="flex-grow-1">
                          {% set selected_student = students|selectattr('id', 'equalto', pre_selected_student)|first %}
                          <h5 class="mb-1">{{ selected_student.first_name }} {{ selected_student.last_name }}</h5>
                          <p class="text-muted mb-0">
                            Grade {{ selected_student.grade_level }} 
                            {% if selected_student.student_id %} | ID: {{ selected_student.student_id }}{% endif %}
                          </p>
                        </div>
                        <a href="{{ url_for('management.report_cards') }}" class="btn btn-sm btn-outline-secondary">
                          <i class="bi bi-arrow-repeat me-1"></i>Change Student
                        </a>
                      </div>
                    </div>
                  {% else %}
                    <!-- Manual student selection -->
                    <div class="mb-4">
                      <label for="student_id" class="form-label fw-semibold">
                        <i class="bi bi-person me-2"></i>Student <span class="text-danger">*</span>
                      </label>
                      <select class="form-select form-select-lg" id="student_id" name="student_id" required>
                        <option value="">Choose a student...</option>
                        {% for student in students %}
                          <option value="{{ student.id }}">
                            {{ student.first_name }} {{ student.last_name }} - Grade {{ student.grade_level }}
                            {% if student.student_id %} (ID: {{ student.student_id }}){% endif %}
                          </option>
                        {% endfor %}
                      </select>
                      <div class="invalid-feedback">Please select a student.</div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <hr class="my-5">

            <!-- Step 1.5: Confirm Student & School Information -->
            <div class="form-section mb-5" id="confirmation-section" style="display: none;">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-check-circle"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">2. Confirm Information</h5>
                  <p class="text-muted mb-0 small">Please review and confirm the student and school information</p>
                </div>
              </div>
              <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                  <div class="row g-4">
                    <!-- Student Information -->
                    <div class="col-md-6">
                      <h6 class="fw-bold mb-3 text-primary">
                        <i class="bi bi-person me-2"></i>Student Information
                      </h6>
                      <div class="row g-3">
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student First & Last Name</label>
                          <input type="text" class="form-control" id="confirm_first_name" name="confirm_first_name" readonly>
                          <input type="text" class="form-control mt-2" id="confirm_last_name" name="confirm_last_name" readonly>
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student ID</label>
                          <input type="text" class="form-control" id="confirm_student_id" name="confirm_student_id" readonly>
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student Gender</label>
                          <select class="form-select" id="confirm_gender" name="confirm_gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                          </select>
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student Grade</label>
                          <input type="text" class="form-control" id="confirm_grade" name="confirm_grade" readonly>
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student Address</label>
                          <textarea class="form-control" id="confirm_address" name="confirm_address" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student DOB</label>
                          <input type="text" class="form-control" id="confirm_dob" name="confirm_dob" placeholder="MM/DD/YYYY">
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Student State ID</label>
                          <input type="text" class="form-control" id="confirm_state_id" name="confirm_state_id" readonly>
                        </div>
                      </div>
                    </div>
                    <!-- School Information -->
                    <div class="col-md-6">
                      <h6 class="fw-bold mb-3 text-primary">
                        <i class="bi bi-building me-2"></i>School Information
                      </h6>
                      <div class="row g-3">
                        <div class="col-12">
                          <label class="form-label fw-semibold">Entrance Date</label>
                          <input type="text" class="form-control" id="confirm_entrance_date" name="confirm_entrance_date" placeholder="MM/DD/YYYY">
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Expected to Graduate Date</label>
                          <input type="text" class="form-control" id="confirm_expected_grad_date" name="confirm_expected_grad_date" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-5" id="confirmation-separator" style="display: none;">

            <!-- Step 2: Select Classes -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-book"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">3. Select Classes</h5>
                  <p class="text-muted mb-0 small">Choose one or more classes to include in the report card</p>
                </div>
              </div>
              <div id="loading-classes" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading classes for selected student...</p>
              </div>
              <div id="classes-container" style="display: none;">
                <div class="row g-3 mb-4" id="classes-list">
                  <!-- Classes will be dynamically loaded here -->
                </div>
                <div class="alert alert-info border-0 shadow-sm">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Tip:</strong> Select at least one class to continue. You can choose multiple classes for a comprehensive report card.
                </div>
              </div>
              <div id="no-classes-message" class="alert alert-warning border-0" style="display: none;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Please select a student first to see their enrolled classes.
              </div>
            </div>

            <hr class="my-5">

            <!-- Step 3: Select School Year and Quarters -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-calendar3"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">4. Select School Year & Quarters</h5>
                  <p class="text-muted mb-0 small">Choose the school year and which quarters to include in the report card</p>
                </div>
              </div>
              <div class="row g-4">
                <div class="col-md-12">
                  <div class="form-floating">
                    <select class="form-select" id="school_year_id" name="school_year_id" required>
                      {% for year in school_years %}
                        <option value="{{ year.id }}" {% if year.is_active %}selected{% endif %}>{{ year.name }}</option>
                      {% endfor %}
                    </select>
                    <label for="school_year_id">
                      <i class="bi bi-calendar3 me-2"></i>School Year <span class="text-danger">*</span>
                    </label>
                    <small class="text-muted mt-1 d-block">Current year is pre-selected. Change to generate historical report cards.</small>
                  </div>
                </div>
              </div>
              
              <!-- Quarter Selection -->
              <div class="mt-4">
                <label class="form-label fw-bold mb-3">
                  <i class="bi bi-calendar-range me-2"></i>Select Quarters to Include <span class="text-danger">*</span>
                </label>
                <div class="row g-3" id="quarters-container">
                  <div class="col-md-3">
                    <div class="form-check form-check-lg p-3 border rounded">
                      <input class="form-check-input" type="checkbox" name="quarters" value="Q1" id="quarter_q1" checked>
                      <label class="form-check-label fw-semibold" for="quarter_q1">
                        <i class="bi bi-1-circle me-2"></i>Quarter 1 (Q1)
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check form-check-lg p-3 border rounded">
                      <input class="form-check-input" type="checkbox" name="quarters" value="Q2" id="quarter_q2" checked>
                      <label class="form-check-label fw-semibold" for="quarter_q2">
                        <i class="bi bi-2-circle me-2"></i>Quarter 2 (Q2)
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check form-check-lg p-3 border rounded">
                      <input class="form-check-input" type="checkbox" name="quarters" value="Q3" id="quarter_q3" checked>
                      <label class="form-check-label fw-semibold" for="quarter_q3">
                        <i class="bi bi-3-circle me-2"></i>Quarter 3 (Q3)
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check form-check-lg p-3 border rounded">
                      <input class="form-check-input" type="checkbox" name="quarters" value="Q4" id="quarter_q4" checked>
                      <label class="form-check-label fw-semibold" for="quarter_q4">
                        <i class="bi bi-4-circle me-2"></i>Quarter 4 (Q4)
                      </label>
                    </div>
                  </div>
                </div>
                <small class="text-muted mt-2 d-block">
                  <i class="bi bi-info-circle me-1"></i>
                  Select one or more quarters. The report period will reflect the selected quarters. Quarters without posted grades will show "N/A".
                </small>
              </div>
            </div>

            <hr class="my-5">

            <!-- Step 4: Select Options -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-gear"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">5. Select Options</h5>
                  <p class="text-muted mb-0 small">Configure report card settings and additional information</p>
                </div>
              </div>

              <div class="card border-0 shadow-sm mt-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <div class="card-body p-4">
                  <h6 class="mb-4 fw-bold">
                    <i class="bi bi-toggle-on me-2 text-primary"></i>Additional Options
                  </h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="option-card">
                        <label class="form-label fw-bold mb-3">
                          <i class="bi bi-file-earmark-text me-2 text-primary"></i>Report Card Type <span class="text-danger">*</span>
                        </label>
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="radio" name="report_type" id="official_report" value="official" checked required>
                          <label class="form-check-label" for="official_report">
                            <strong>Official</strong>
                            <small class="text-muted d-block">Official report card for official records</small>
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="report_type" id="unofficial_report" value="unofficial" required>
                          <label class="form-check-label" for="unofficial_report">
                            <strong>Unofficial</strong>
                            <small class="text-muted d-block">Unofficial report card with watermark</small>
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="option-card position-relative" style="opacity: 0.7; cursor: not-allowed;">
                        <span class="badge bg-warning text-dark position-absolute top-0 start-50 translate-middle-x" style="z-index: 10; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                          In Development
                        </span>
                        <div class="form-check form-switch form-switch-lg">
                          <input class="form-check-input" type="checkbox" id="include_attendance" name="include_attendance" disabled>
                          <label class="form-check-label" for="include_attendance" style="cursor: not-allowed;">
                            <div class="d-flex align-items-center">
                              <div class="option-icon me-3">
                                <i class="bi bi-calendar-check"></i>
                              </div>
                              <div>
                                <strong>Include Attendance</strong>
                                <small class="text-muted d-block">Add attendance statistics to the report card</small>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-md-6">
                      <div class="option-card position-relative" style="opacity: 0.7; cursor: not-allowed;">
                        <span class="badge bg-warning text-dark position-absolute top-0 start-50 translate-middle-x" style="z-index: 10; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                          In Development
                        </span>
                        <div class="form-check form-switch form-switch-lg">
                          <input class="form-check-input" type="checkbox" id="include_comments" name="include_comments" disabled>
                          <label class="form-check-label" for="include_comments" style="cursor: not-allowed;">
                            <div class="d-flex align-items-center">
                              <div class="option-icon me-3">
                                <i class="bi bi-chat-text"></i>
                              </div>
                              <div>
                                <strong>Include Comments</strong>
                                <small class="text-muted d-block">Add teacher comments to the report card</small>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-5">

            <!-- Generate Button -->
            <div class="text-center mt-5 pt-4 border-top">
              <button type="submit" class="btn btn-success btn-lg px-5 py-3" id="generateBtn">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i>Generate Report Card PDF
              </button>
              <p class="text-muted mt-3 small">
                <i class="bi bi-info-circle me-1"></i>
                The PDF will be generated and displayed in a new window for download.
              </p>
            </div>
          </form>
          
          <!-- Hidden iframe for PDF display -->
          <iframe id="pdfFrame" name="pdfFrame" style="display: none;"></iframe>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('reportCardForm');
  const studentSelect = document.getElementById('student_id');
  const classesContainer = document.getElementById('classes-container');
  const loadingClasses = document.getElementById('loading-classes');
  const noClassesMessage = document.getElementById('no-classes-message');
  const classesList = document.getElementById('classes-list');
  const generateBtn = document.getElementById('generateBtn');

  const confirmationSection = document.getElementById('confirmation-section');
  const confirmationSeparator = document.getElementById('confirmation-separator');

  // Load classes and student details when student is selected (or on page load if pre-selected)
  if (studentSelect) {
    studentSelect.addEventListener('change', function() {
      if (this.value) {
        loadStudentDetails(this.value);
        loadStudentClasses(this.value);
      } else {
        confirmationSection.style.display = 'none';
        confirmationSeparator.style.display = 'none';
        classesContainer.style.display = 'none';
        noClassesMessage.style.display = 'block';
        noClassesMessage.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Please select a student first to see their enrolled classes.';
        classesList.innerHTML = '';
      }
    });
  }
  
  // Auto-load student details and classes if student is pre-selected
  const studentIdField = document.getElementById('student_id');
  if (studentIdField && studentIdField.value) {
    loadStudentDetails(studentIdField.value);
    loadStudentClasses(studentIdField.value);
  }

  function loadStudentDetails(studentId) {
    fetch(`/management/api/student/${studentId}/details`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.student) {
          const student = data.student;
          
          // Populate readonly fields
          document.getElementById('confirm_first_name').value = student.first_name || '';
          document.getElementById('confirm_last_name').value = student.last_name || '';
          document.getElementById('confirm_student_id').value = student.student_id || 'N/A';
          document.getElementById('confirm_grade').value = student.grade_level || '';
          document.getElementById('confirm_state_id').value = student.state_id || 'N/A';
          document.getElementById('confirm_expected_grad_date').value = student.expected_grad_date || '';
          
          // Populate editable fields
          document.getElementById('confirm_gender').value = student.gender || '';
          document.getElementById('confirm_address').value = student.address || '';
          document.getElementById('confirm_dob').value = student.dob || '';
          document.getElementById('confirm_entrance_date').value = student.entrance_date || '';
          
          // Show confirmation section
          confirmationSection.style.display = 'block';
          confirmationSeparator.style.display = 'block';
        } else {
          console.error('Failed to load student details');
          confirmationSection.style.display = 'none';
          confirmationSeparator.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('Error loading student details:', error);
        confirmationSection.style.display = 'none';
        confirmationSeparator.style.display = 'none';
      });
  }

  function loadStudentClasses(studentId) {
    loadingClasses.style.display = 'block';
    classesContainer.style.display = 'none';
    noClassesMessage.style.display = 'none';
    classesList.innerHTML = '';

    fetch(`/management/api/student/${studentId}/classes`)
      .then(response => response.json())
      .then(data => {
        loadingClasses.style.display = 'none';
        
        if (data.success && data.classes.length > 0) {
          classesList.innerHTML = '';
          data.classes.forEach(classItem => {
            const classCard = document.createElement('div');
            classCard.className = 'col-md-6';
            classCard.innerHTML = `
              <div class="class-card" data-class-id="${classItem.id}">
                <div class="form-check d-flex align-items-center">
                  <input class="form-check-input" type="checkbox" name="class_ids" value="${classItem.id}" id="class_${classItem.id}" checked>
                  <label class="form-check-label flex-grow-1 class-card-content" for="class_${classItem.id}">
                    <h6>${classItem.name}</h6>
                    <small class="text-muted d-block">${classItem.subject} â€¢ ${classItem.teacher_name}</small>
                  </label>
                </div>
              </div>
            `;
            classesList.appendChild(classCard);
            
            // Add click handler
            const card = classCard.querySelector('.class-card');
            card.addEventListener('click', function(e) {
              if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                updateClassSelection();
              }
            });
          });
          
          classesList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateClassSelection);
          });
          
          classesContainer.style.display = 'block';
          // Select all classes by default
          updateClassSelection();
        } else {
          noClassesMessage.style.display = 'block';
          noClassesMessage.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>No classes found for this student.';
        }
      })
      .catch(error => {
        loadingClasses.style.display = 'none';
        classesList.innerHTML = '<div class="alert alert-danger">Error loading classes. Please try again.</div>';
        console.error('Error:', error);
      });
  }

  function updateClassSelection() {
    classesList.querySelectorAll('.class-card').forEach(card => {
      const checkbox = card.querySelector('input[type="checkbox"]');
      if (checkbox.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
  }

  // Form validation and submission
  form.addEventListener('submit', function(e) {
    console.log('Form submit event triggered');
    
    // First validate the form
    if (!form.checkValidity()) {
      console.log('Form validation failed');
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      
      // Scroll to first invalid field
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
      }
      
      return false;
    }
    
    // Check if student is selected
    const studentIdValue = document.getElementById('student_id').value;
    if (!studentIdValue) {
      console.log('No student selected');
      e.preventDefault();
      alert('Please select a student first.');
      return false;
    }
    
    // Check if at least one quarter is selected
    const selectedQuarters = Array.from(document.querySelectorAll('input[name="quarters"]:checked'));
    console.log('Selected quarters count:', selectedQuarters.length);
    
    if (selectedQuarters.length === 0) {
      console.log('No quarters selected');
      e.preventDefault();
      alert('Please select at least one quarter to include in the report card.');
      document.getElementById('quarters-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
      return false;
    }
    
    // Check if at least one class is selected
    const selectedClasses = Array.from(classesList.querySelectorAll('input[type="checkbox"]:checked'));
    console.log('Selected classes count:', selectedClasses.length);
    
    if (selectedClasses.length === 0) {
      // Check if classes section is visible (student selected and classes loaded)
      if (classesContainer.style.display !== 'none' && classesList.innerHTML.trim() !== '') {
        console.log('Classes loaded but none selected');
        e.preventDefault();
        alert('Please select at least one class to include in the report card.');
        classesContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
      } else {
        // Classes might still be loading or student has no classes
        console.log('Classes not loaded or student has no classes');
        e.preventDefault();
        alert('Please wait for classes to load, or the student may not be enrolled in any classes.');
        return false;
      }
    }
    
    // All validation passed
    console.log('All validation passed, submitting form...');
    console.log('Selected classes:', selectedClasses.map(cb => cb.value));
    console.log('Student ID:', studentIdValue);
    console.log('School Year:', document.getElementById('school_year_id').value);
    
    // Ensure form target is set to open in new window
    form.target = '_blank';
    
    // Disable button and show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Generating PDF...';
    
    // Allow form to submit normally (don't prevent default)
    // Browser will open PDF in new window/tab
    // Re-enable button after a delay in case of errors
    setTimeout(() => {
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="bi bi-file-earmark-pdf-fill me-2"></i>Generate Report Card PDF';
    }, 10000);
    
    console.log('Form submission allowed');
    return true; // Allow form submission
  });

  // Update button text on form validation
  form.addEventListener('input', function() {
    if (form.checkValidity()) {
      generateBtn.disabled = false;
    }
  });
});
</script>
{% endblock %}
