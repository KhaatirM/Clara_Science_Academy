{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1 fw-bold">
            <i class="bi bi-file-earmark-text-fill text-primary me-2"></i>Generate Report Card PDF
          </h2>
          <p class="text-muted mb-0">Fill out all the required information below to generate a downloadable PDF report card</p>
        </div>
        <a href="{{ url_for('management.report_cards') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back to Report Cards
        </a>
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white py-4" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
          <h4 class="mb-0">
            <i class="bi bi-file-earmark-pdf-fill me-2"></i>Report Card Information
          </h4>
        </div>
        <div class="card-body p-4 p-md-5">
          <form method="POST" action="{{ url_for('management.generate_report_card_form') }}" id="reportCardForm" class="needs-validation" novalidate target="_blank">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- Step 1: Select Student -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">1. Select Student</h5>
                  <p class="text-muted mb-0 small">Choose the student for whom you want to generate a report card</p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8 mx-auto">
                  <div class="mb-4">
                    <label for="student_id" class="form-label fw-semibold">
                      <i class="bi bi-person me-2"></i>Student <span class="text-danger">*</span>
                    </label>
                    <select class="form-select form-select-lg" id="student_id" name="student_id" required>
                      <option value="">Choose a student...</option>
                      {% for student in students %}
                        <option value="{{ student.id }}">
                          {{ student.first_name }} {{ student.last_name }} - Grade {{ student.grade_level }}
                          {% if student.student_id %} (ID: {{ student.student_id }}){% endif %}
                        </option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select a student.</div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-5">

            <!-- Step 2: Select Classes -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-book"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">2. Select Classes</h5>
                  <p class="text-muted mb-0 small">Choose one or more classes to include in the report card</p>
                </div>
              </div>
              <div id="loading-classes" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading classes for selected student...</p>
              </div>
              <div id="classes-container" style="display: none;">
                <div class="row g-3 mb-4" id="classes-list">
                  <!-- Classes will be dynamically loaded here -->
                </div>
                <div class="alert alert-info border-0 shadow-sm">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Tip:</strong> Select at least one class to continue. You can choose multiple classes for a comprehensive report card.
                </div>
              </div>
              <div id="no-classes-message" class="alert alert-warning border-0" style="display: none;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Please select a student first to see their enrolled classes.
              </div>
            </div>

            <hr class="my-5">

            <!-- Step 3: Select Options -->
            <div class="form-section mb-5">
              <div class="section-header mb-4">
                <div class="section-icon">
                  <i class="bi bi-gear"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">3. Select Options</h5>
                  <p class="text-muted mb-0 small">Configure report card settings and additional information</p>
                </div>
              </div>
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="school_year_id" name="school_year_id" required>
                      <option value="">Choose...</option>
                      {% for year in school_years %}
                        <option value="{{ year.id }}">{{ year.name }}</option>
                      {% endfor %}
                    </select>
                    <label for="school_year_id">
                      <i class="bi bi-calendar3 me-2"></i>School Year <span class="text-danger">*</span>
                    </label>
                    <div class="invalid-feedback">Please select a school year.</div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating">
                    <select class="form-select" id="quarter" name="quarter" required>
                      <option value="">Choose...</option>
                      <option value="Q1">Quarter 1</option>
                      <option value="Q2">Quarter 2</option>
                      <option value="Q3">Quarter 3</option>
                      <option value="Q4">Quarter 4</option>
                    </select>
                    <label for="quarter">
                      <i class="bi bi-calendar4-range me-2"></i>Quarter <span class="text-danger">*</span>
                    </label>
                    <div class="invalid-feedback">Please select a quarter.</div>
                  </div>
                </div>
              </div>

              <div class="card border-0 shadow-sm mt-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <div class="card-body p-4">
                  <h6 class="mb-4 fw-bold">
                    <i class="bi bi-toggle-on me-2 text-primary"></i>Additional Options
                  </h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="option-card">
                        <div class="form-check form-switch form-switch-lg">
                          <input class="form-check-input" type="checkbox" id="include_attendance" name="include_attendance">
                          <label class="form-check-label" for="include_attendance">
                            <div class="d-flex align-items-center">
                              <div class="option-icon me-3">
                                <i class="bi bi-calendar-check"></i>
                              </div>
                              <div>
                                <strong>Include Attendance</strong>
                                <small class="text-muted d-block">Add attendance statistics to the report card</small>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="option-card">
                        <div class="form-check form-switch form-switch-lg">
                          <input class="form-check-input" type="checkbox" id="include_comments" name="include_comments">
                          <label class="form-check-label" for="include_comments">
                            <div class="d-flex align-items-center">
                              <div class="option-icon me-3">
                                <i class="bi bi-chat-text"></i>
                              </div>
                              <div>
                                <strong>Include Comments</strong>
                                <small class="text-muted d-block">Add teacher comments to the report card</small>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-5">

            <!-- Generate Button -->
            <div class="text-center mt-5 pt-4 border-top">
              <button type="submit" class="btn btn-success btn-lg px-5 py-3" id="generateBtn">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i>Generate Report Card PDF
              </button>
              <p class="text-muted mt-3 small">
                <i class="bi bi-info-circle me-1"></i>
                The PDF will be generated and displayed in a new window for download.
              </p>
            </div>
          </form>
          
          <!-- Hidden iframe for PDF display -->
          <iframe id="pdfFrame" name="pdfFrame" style="display: none;"></iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Section Header */
.section-header {
  display: flex;
  align-items: center;
  gap: 20px;
}

.section-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  color: #0d6efd;
  flex-shrink: 0;
}

.form-section {
  position: relative;
}

.form-section::before {
  content: '';
  position: absolute;
  left: 30px;
  top: 0;
  bottom: 0;
  width: 3px;
  background: linear-gradient(180deg, #0d6efd 0%, #e9ecef 100%);
  opacity: 0.3;
}

.form-section:last-child::before {
  display: none;
}

/* Class Selection Cards */
.class-card {
  border: 2px solid #dee2e6;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  transition: all 0.3s ease;
  cursor: pointer;
  background: white;
}

.class-card:hover {
  border-color: #0d6efd;
  background: linear-gradient(135deg, #f8f9ff 0%, #e7f1ff 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(13, 110, 253, 0.1);
}

.class-card.selected {
  border-color: #0d6efd;
  background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
  box-shadow: 0 4px 20px rgba(13, 110, 253, 0.2);
}

.class-card input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin-right: 15px;
  cursor: pointer;
}

.class-card-content h6 {
  font-weight: 700;
  color: #212529;
  margin-bottom: 5px;
}

.class-card-content small {
  color: #6c757d;
}

/* Option Cards */
.option-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  height: 100%;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.option-card:hover {
  border-color: #0d6efd;
  box-shadow: 0 4px 15px rgba(13, 110, 253, 0.1);
}

.option-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: #0d6efd;
}

/* Form Switch Large */
.form-switch-lg .form-check-input {
  width: 3rem;
  height: 1.5rem;
  margin-right: 15px;
}

/* Generate Button */
#generateBtn {
  font-size: 1.1rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
  transition: all 0.3s ease;
}

#generateBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4);
}

#generateBtn:active {
  transform: translateY(0);
}

/* Responsive */
@media (max-width: 768px) {
  .section-header {
    flex-direction: column;
    text-align: center;
  }
  
  .section-icon {
    margin: 0 auto;
  }
  
  .form-section::before {
    display: none;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('reportCardForm');
  const studentSelect = document.getElementById('student_id');
  const classesContainer = document.getElementById('classes-container');
  const loadingClasses = document.getElementById('loading-classes');
  const noClassesMessage = document.getElementById('no-classes-message');
  const classesList = document.getElementById('classes-list');
  const generateBtn = document.getElementById('generateBtn');

  // Load classes when student is selected
  studentSelect.addEventListener('change', function() {
    if (this.value) {
      loadStudentClasses(this.value);
    } else {
      classesContainer.style.display = 'none';
      noClassesMessage.style.display = 'block';
      noClassesMessage.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Please select a student first to see their enrolled classes.';
      classesList.innerHTML = '';
    }
  });

  function loadStudentClasses(studentId) {
    loadingClasses.style.display = 'block';
    classesContainer.style.display = 'none';
    noClassesMessage.style.display = 'none';
    classesList.innerHTML = '';

    fetch(`/management/api/student/${studentId}/classes`)
      .then(response => response.json())
      .then(data => {
        loadingClasses.style.display = 'none';
        
        if (data.success && data.classes.length > 0) {
          classesList.innerHTML = '';
          data.classes.forEach(classItem => {
            const classCard = document.createElement('div');
            classCard.className = 'col-md-6';
            classCard.innerHTML = `
              <div class="class-card" data-class-id="${classItem.id}">
                <div class="form-check d-flex align-items-center">
                  <input class="form-check-input" type="checkbox" name="class_ids" value="${classItem.id}" id="class_${classItem.id}" checked>
                  <label class="form-check-label flex-grow-1 class-card-content" for="class_${classItem.id}">
                    <h6>${classItem.name}</h6>
                    <small class="text-muted d-block">${classItem.subject} â€¢ ${classItem.teacher_name}</small>
                  </label>
                </div>
              </div>
            `;
            classesList.appendChild(classCard);
            
            // Add click handler
            const card = classCard.querySelector('.class-card');
            card.addEventListener('click', function(e) {
              if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                updateClassSelection();
              }
            });
          });
          
          classesList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateClassSelection);
          });
          
          classesContainer.style.display = 'block';
          // Select all classes by default
          updateClassSelection();
        } else {
          noClassesMessage.style.display = 'block';
          noClassesMessage.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>No classes found for this student.';
        }
      })
      .catch(error => {
        loadingClasses.style.display = 'none';
        classesList.innerHTML = '<div class="alert alert-danger">Error loading classes. Please try again.</div>';
        console.error('Error:', error);
      });
  }

  function updateClassSelection() {
    classesList.querySelectorAll('.class-card').forEach(card => {
      const checkbox = card.querySelector('input[type="checkbox"]');
      if (checkbox.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
  }

  // Form validation and submission
  form.addEventListener('submit', function(e) {
    console.log('Form submit event triggered');
    
    // First validate the form
    if (!form.checkValidity()) {
      console.log('Form validation failed');
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      
      // Scroll to first invalid field
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
      }
      
      return false;
    }
    
    // Check if student is selected
    if (!studentSelect.value) {
      console.log('No student selected');
      e.preventDefault();
      alert('Please select a student first.');
      studentSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
      studentSelect.focus();
      return false;
    }
    
    // Check if at least one class is selected
    const selectedClasses = Array.from(classesList.querySelectorAll('input[type="checkbox"]:checked'));
    console.log('Selected classes count:', selectedClasses.length);
    
    if (selectedClasses.length === 0) {
      // Check if classes section is visible (student selected and classes loaded)
      if (classesContainer.style.display !== 'none' && classesList.innerHTML.trim() !== '') {
        console.log('Classes loaded but none selected');
        e.preventDefault();
        alert('Please select at least one class to include in the report card.');
        classesContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
      } else {
        // Classes might still be loading or student has no classes
        console.log('Classes not loaded or student has no classes');
        e.preventDefault();
        alert('Please wait for classes to load, or the student may not be enrolled in any classes.');
        return false;
      }
    }
    
    // All validation passed
    console.log('All validation passed, submitting form...');
    console.log('Selected classes:', selectedClasses.map(cb => cb.value));
    console.log('Student ID:', studentSelect.value);
    console.log('School Year:', document.getElementById('school_year_id').value);
    console.log('Quarter:', document.getElementById('quarter').value);
    
    // Ensure form target is set to open in new window
    form.target = '_blank';
    
    // Disable button and show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Generating PDF...';
    
    // Allow form to submit normally (don't prevent default)
    // Browser will open PDF in new window/tab
    // Re-enable button after a delay in case of errors
    setTimeout(() => {
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="bi bi-file-earmark-pdf-fill me-2"></i>Generate Report Card PDF';
    }, 10000);
    
    console.log('Form submission allowed');
    return true; // Allow form submission
  });

  // Update button text on form validation
  form.addEventListener('input', function() {
    if (form.checkValidity()) {
      generateBtn.disabled = false;
    }
  });
});
</script>
{% endblock %}
