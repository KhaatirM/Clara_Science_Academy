{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management_role_classes.css') }}">
{% endblock %}

{% set TEACHER_ROLES = [
    'History Teacher',
    'Science Teacher',
    'Physics Teacher',
    'English Language Arts Teacher',
    'Math Teacher',
    'Substitute Teacher',
    'School Counselor',
    'School Administrator',
    'Director'
] %}

{% block dashboard_content %}


<div class="container-fluid px-2 px-md-4">
    <!-- Enhanced Header -->
    <div class="classes-header">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div>
                <h2><i class="bi bi-mortarboard-fill me-3"></i>My Classes</h2>
                <p class="mb-0 opacity-90">Manage your classes and Google Classroom integration</p>
            </div>
            {% if current_user.role in ['Director', 'School Administrator'] %}
                <a href="{{ url_for('management.add_class') }}" class="add-class-btn">
                    <i class="bi bi-plus-circle-fill me-2"></i>Add New Class
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        {% for class in classes %}
        <div class="col-12 col-sm-6 col-xl-4">
            <div class="class-card">
                <div class="class-card-header d-flex justify-content-between align-items-center">
                    <h5 class="class-card-title">{{ class.name }}</h5>
                    <span class="grade-badge">{{ class.grade_level | display_grade }}</span>
                </div>
                <div class="class-card-body d-flex flex-column">
                    <!-- Class Information -->
                    <div class="flex-grow-1 mb-3">
                        <div class="class-info-item">
                            <div class="class-info-icon icon-teacher">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Teacher</small>
                                <strong>{{ (class.teacher.first_name + ' ' + class.teacher.last_name) if class.teacher else 'Not Assigned' }}</strong>
                            </div>
                        </div>
                        
                        <div class="class-info-item">
                            <div class="class-info-icon icon-subject">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Subject</small>
                                <strong>{{ class.subject or 'N/A' }}</strong>
                            </div>
                        </div>
                        
                        <div class="class-info-item">
                            <div class="class-info-icon icon-students">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Students</small>
                                <strong>{{ class.active_student_count if class.active_student_count is defined else 0 }} Students</strong>
                            </div>
                        </div>
                        
                        <div class="class-info-item">
                            <div class="class-info-icon icon-schedule">
                                <i class="bi bi-clock-fill"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Schedule</small>
                                <strong>{{ class.schedule or 'N/A' }}</strong>
                            </div>
                        </div>
                        
                        <!-- Google Classroom Status (for all users) -->
                        <div class="google-classroom-status {% if class.google_classroom_id %}linked{% endif %}">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <small class="text-muted d-block mb-1">
                                        <i class="bi bi-google"></i> Google Classroom
                                    </small>
                                    {% if class.google_classroom_id %}
                                        <span class="status-badge linked">
                                            <i class="bi bi-check-circle-fill"></i> Linked
                                        </span>
                                    {% else %}
                                        <span class="status-badge not-linked">
                                            <i class="bi bi-exclamation-circle-fill"></i> Not Linked
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        {% if current_user.role in ['Director', 'School Administrator'] %}
                            <div class="d-flex gap-2 mb-2">
                                <a href="{{ url_for('management.manage_class_roster', class_id=class.id) }}" class="action-btn btn-manage flex-fill">
                                    <i class="bi bi-people-fill me-2"></i>Manage Roster
                                </a>
                                <a href="{{ url_for('management.class_grades_view', class_id=class.id) }}" class="action-btn btn-grades flex-fill">
                                    <i class="bi bi-journal-check me-2"></i>View Grades
                                </a>
                            </div>
                            
                            <!-- Google Classroom Actions for Admins -->
                            {% if class.google_classroom_id %}
                                <div class="d-flex gap-2">
                                    <a href="https://classroom.google.com/c/{{ class.google_classroom_id }}" 
                                       target="_blank" 
                                       class="action-btn btn-google-open flex-fill"
                                       title="Open in Google Classroom">
                                        <i class="bi bi-google me-2"></i>Open Classroom
                                    </a>
                                    <a href="{{ url_for('management.unlink_classroom', class_id=class.id) }}" 
                                       class="action-btn btn-google-unlink flex-fill"
                                       onclick="return confirm('Are you sure you want to unlink this Google Classroom? The classroom will still exist in Google.');">
                                        <i class="bi bi-link-45deg me-2"></i>Unlink
                                    </a>
                                </div>
                            {% else %}
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('management.link_existing_classroom', class_id=class.id) }}" 
                                       class="action-btn btn-google-link flex-fill"
                                       title="Link to an existing Google Classroom">
                                        <i class="bi bi-link-45deg me-2"></i>Link Existing
                                    </a>
                                    <a href="{{ url_for('management.create_and_link_classroom', class_id=class.id) }}" 
                                       class="action-btn btn-google-create flex-fill"
                                       title="Create a new Google Classroom and link it">
                                        <i class="bi bi-plus-circle-fill me-2"></i>Create New
                                    </a>
                                </div>
                            {% endif %}
                        {% elif 'Teacher' in current_user.role and current_user.role not in ['Director', 'School Administrator'] %}
                            <div class="d-flex gap-2 mb-2">
                                <a href="{{ url_for('teacher.dashboard.view_class', class_id=class.id) }}" class="action-btn btn-view flex-fill">
                                    <i class="bi bi-eye-fill me-1"></i>View Class
                                </a>
                                <a href="{{ url_for('teacher.attendance.take_attendance', class_id=class.id) }}" class="action-btn btn-attendance flex-fill">
                                    <i class="bi bi-calendar-check me-1"></i>Attendance
                                </a>
                                <a href="{{ url_for('teacher.assignments.assignment_type_selector') }}?class_id={{ class.id }}" class="action-btn btn-assignment flex-fill">
                                    <i class="bi bi-plus-circle-fill me-1"></i>Assignment
                                </a>
                            </div>
                            
                            <!-- Google Classroom Actions -->
                            {% if class.google_classroom_id %}
                                <div class="d-flex gap-2">
                                    <a href="https://classroom.google.com/c/{{ class.google_classroom_id }}" 
                                       target="_blank" 
                                       class="action-btn btn-google-open flex-fill"
                                       title="Open in Google Classroom">
                                        <i class="bi bi-google me-2"></i>Open Classroom
                                    </a>
                                    <a href="{{ url_for('teacher.dashboard.unlink_classroom', class_id=class.id) }}" 
                                       class="action-btn btn-google-unlink flex-fill"
                                       onclick="return confirm('Are you sure you want to unlink this Google Classroom? The classroom will still exist in Google.');">
                                        <i class="bi bi-link-45deg me-2"></i>Unlink
                                    </a>
                                </div>
                            {% else %}
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('teacher.dashboard.link_existing_classroom', class_id=class.id) }}" 
                                       class="action-btn btn-google-link flex-fill"
                                       title="Link to an existing Google Classroom">
                                        <i class="bi bi-link-45deg me-2"></i>Link Existing
                                    </a>
                                    <a href="{{ url_for('teacher.dashboard.create_and_link_classroom', class_id=class.id) }}" 
                                       class="action-btn btn-google-create flex-fill"
                                       title="Create a new Google Classroom and link it">
                                        <i class="bi bi-plus-circle-fill me-2"></i>Create New
                                    </a>
                                </div>
                            {% endif %}
                        {% endif %}
                        
                        {% if current_user.role in ['Director', 'School Administrator'] %}
                            <button type="button" class="action-btn btn-remove remove-class-btn" 
                                    data-class-id="{{ class.id }}" data-class-name="{{ class.name }}">
                                <i class="bi bi-trash-fill me-2"></i>Remove Class
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="no-classes-alert">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #667eea;"></i>
                <h5>No Classes Found</h5>
                <p class="mb-4">There are currently no classes in the system.</p>
                {% if current_user.role in ['Director', 'School Administrator'] %}
                    <a href="{{ url_for('management.add_class') }}" class="add-class-btn">
                        <i class="bi bi-plus-circle-fill me-2"></i>Add First Class
                    </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const removeButtons = document.querySelectorAll('.remove-class-btn');
    const userRole = '{{ current_user.role }}';
    
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const classId = this.dataset.classId;
            const className = this.dataset.className;
            
            if (confirm(`Are you sure you want to remove ${className}? This action cannot be undone.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                
                if (userRole === 'Director' || userRole === 'School Administrator') {
                    form.action = `{{ url_for('management.remove_class', class_id=0) }}`.replace('0', classId);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    });
});
</script>
{% endblock %} 