{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management_role_dashboard.css') }}">
{% endblock %}

{% block dashboard_content %}
    <!-- DEBUG: Current section is "{{ section }}" -->
    {% if section == 'home' %}
        <!-- Home Dashboard -->
        <div class="container-fluid px-2 px-md-4">
            <!-- Modern Welcome Header -->
            <div class="admin-home-header mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="admin-home-title mb-1">
                            <i class="bi bi-house-heart-fill me-2"></i>Welcome Back, {{ current_user.first_name if current_user.first_name else current_user.username }}!
                        </h2>
                        <p class="admin-home-subtitle mb-0">
                            <i class="bi bi-calendar3 me-2"></i>Today's Administrative Dashboard
                        </p>
                    </div>
                    <div class="admin-home-role-badge">
                        {% if current_user.role == 'Director' %}
                        <span class="badge badge-admin-director"><i class="bi bi-award-fill me-1"></i>Director</span>
                        {% else %}
                        <span class="badge badge-admin-regular"><i class="bi bi-shield-fill me-1"></i>Administrator</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Statistics Overview -->
            <div class="row g-3 g-md-4 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="admin-stat-content">
                            <h3 class="admin-stat-number">{{ stats.students if stats else 0 }}</h3>
                            <p class="admin-stat-label">Total Students</p>
                            <div class="admin-stat-trend">
                                {% set change_percent = stats.students_change_percent if stats and stats.students_change_percent is defined else 0 %}
                                {% if change_percent > 0 %}
                                    <i class="bi bi-arrow-up text-success"></i>
                                    <span class="text-success">+{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% elif change_percent < 0 %}
                                    <i class="bi bi-arrow-down text-danger"></i>
                                    <span class="text-danger">{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% else %}
                                    <i class="bi bi-dash text-muted"></i>
                                    <span class="text-muted">No change this month</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon">
                            <i class="bi bi-person-badge-fill"></i>
                        </div>
                        <div class="admin-stat-content">
                            <h3 class="admin-stat-number">{{ stats.teachers if stats else 0 }}</h3>
                            <p class="admin-stat-label">Teachers & Staff</p>
                            <div class="admin-stat-trend">
                                {% set change_percent = stats.teachers_change_percent if stats and stats.teachers_change_percent is defined else 0 %}
                                {% if change_percent > 0 %}
                                    <i class="bi bi-arrow-up text-success"></i>
                                    <span class="text-success">+{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% elif change_percent < 0 %}
                                    <i class="bi bi-arrow-down text-danger"></i>
                                    <span class="text-danger">{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% else %}
                                    <i class="bi bi-dash text-muted"></i>
                                    <span class="text-muted">No change this month</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon">
                            <i class="bi bi-house-door-fill"></i>
                        </div>
                        <div class="admin-stat-content">
                            <h3 class="admin-stat-number">{{ stats.classes if stats else 0 }}</h3>
                            <p class="admin-stat-label">Total Classes</p>
                            <div class="admin-stat-trend">
                                {% set change_percent = stats.classes_change_percent if stats and stats.classes_change_percent is defined else 0 %}
                                {% if change_percent > 0 %}
                                    <i class="bi bi-arrow-up text-success"></i>
                                    <span class="text-success">+{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% elif change_percent < 0 %}
                                    <i class="bi bi-arrow-down text-danger"></i>
                                    <span class="text-danger">{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% else %}
                                    <i class="bi bi-dash text-muted"></i>
                                    <span class="text-muted">No change this month</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon">
                            <i class="bi bi-journal-check"></i>
                        </div>
                        <div class="admin-stat-content">
                            <h3 class="admin-stat-number">{{ stats.active_assignments if stats else 0 }}</h3>
                            <p class="admin-stat-label">Active Assignments</p>
                            <div class="admin-stat-trend">
                                {% set change_percent = stats.assignments_change_percent if stats and stats.assignments_change_percent is defined else 0 %}
                                {% if change_percent > 0 %}
                                    <i class="bi bi-arrow-up text-success"></i>
                                    <span class="text-success">+{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% elif change_percent < 0 %}
                                    <i class="bi bi-arrow-down text-danger"></i>
                                    <span class="text-danger">{{ "%.1f"|format(change_percent) }}% this month</span>
                                {% else %}
                                    <i class="bi bi-dash text-muted"></i>
                                    <span class="text-muted">No change this month</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Card & Quick Actions -->
            <div class="row g-3 g-md-4 mb-4">
                <div class="col-12 col-lg-4">
                    <div class="admin-profile-card">
                        <div class="admin-profile-header">
                            <div class="admin-profile-avatar">
                                {% if current_user.role == 'Director' %}
                                <i class="bi bi-award-fill"></i>
                                {% else %}
                                <i class="bi bi-person-badge-fill"></i>
                                {% endif %}
                            </div>
                            <div class="admin-profile-info">
                                <h4 class="admin-profile-name">{{ current_user.first_name if current_user.first_name else current_user.username }}</h4>
                                <p class="admin-profile-role">{{ current_user.role }}</p>
                            </div>
                        </div>
                        <div class="admin-profile-details">
                            <div class="admin-profile-item">
                                <i class="bi bi-person-badge me-2"></i>
                                <span>ID: {% if current_user.teacher_staff and current_user.teacher_staff.staff_id %}{{ current_user.teacher_staff.staff_id }}{% else %}STAFF-{{ current_user.id }}{% endif %}</span>
                            </div>
                            <div class="admin-profile-item">
                                <i class="bi bi-envelope me-2"></i>
                                <span>{{ current_user.email }}</span>
                            </div>
                            <div class="admin-profile-item">
                                <i class="bi bi-calendar3 me-2"></i>
                                <span>Last Login: Today</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-8">
                    <div class="admin-quick-actions">
                        <h5 class="admin-section-title">
                            <i class="bi bi-lightning-fill me-2"></i>Quick Actions
                        </h5>
                        <div class="admin-actions-grid">
                            <a href="{{ url_for('management.add_student') }}" class="admin-action-btn">
                                <i class="bi bi-person-plus-fill"></i>
                                <span>Add Student</span>
                            </a>
                            <a href="{{ url_for('management.add_teacher_staff') }}" class="admin-action-btn">
                                <i class="bi bi-person-badge"></i>
                                <span>Add Staff</span>
                            </a>
                            <a href="{{ url_for('management.add_class') }}" class="admin-action-btn">
                                <i class="bi bi-house-door"></i>
                                <span>Add Class</span>
                            </a>
                            <a href="{{ url_for('management.assignment_type_selector') }}" class="admin-action-btn">
                                <i class="bi bi-journal-plus"></i>
                                <span>Add Assignment</span>
                            </a>
                            <a href="{{ url_for('management.students') }}" class="admin-action-btn">
                                <i class="bi bi-people"></i>
                                <span>Manage Students</span>
                            </a>
                            <a href="{{ url_for('management.classes') }}" class="admin-action-btn">
                                <i class="bi bi-chalkboard"></i>
                                <span>Manage Classes</span>
                            </a>
                            <a href="{{ url_for('management.assignments_and_grades') }}" class="admin-action-btn">
                                <i class="bi bi-clipboard-data"></i>
                                <span>Grades & Assignments</span>
                            </a>
                            <a href="{{ url_for('management.unified_attendance') }}" class="admin-action-btn">
                                <i class="bi bi-calendar-check"></i>
                                <span>Attendance</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications & Recent Activity -->
            <div class="row g-3 g-md-4">
                <div class="col-12 col-lg-6">
                    <div class="admin-notifications">
                        <h5 class="admin-section-title">
                            <i class="bi bi-bell-fill me-2"></i>Notifications
                            {% if notifications %}
                                <span class="badge bg-danger rounded-pill ms-2">{{ notifications|length }}</span>
                            {% endif %}
                        </h5>
                        <div class="admin-notification-list">
                            {% if notifications %}
                                {% for notification in notifications %}
                                <div class="admin-notification-item">
                                    <div class="admin-notification-icon">
                                        {% if notification.notification_type == 'grade' %}
                                            <i class="bi bi-clipboard-check-fill text-success"></i>
                                        {% elif notification.notification_type == 'assignment' %}
                                            <i class="bi bi-journal-plus-fill text-primary"></i>
                                        {% elif notification.notification_type == 'attendance' %}
                                            <i class="bi bi-calendar-check-fill text-info"></i>
                                        {% elif notification.notification_type == 'submission' %}
                                            <i class="bi bi-file-earmark-check-fill text-warning"></i>
                                        {% elif notification.notification_type == 'alert' or notification.notification_type == 'warning' %}
                                            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-bell-fill text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="admin-notification-content">
                                        <h6 class="admin-notification-title">{{ notification.title }}</h6>
                                        <p class="admin-notification-text">{{ notification.message }}</p>
                                        <small class="admin-notification-time">
                                            {{ notification.timestamp.strftime('%b %d, %I:%M %p') if notification.timestamp else 'Recently' }}
                                        </small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="admin-notification-item text-center py-4">
                                    <i class="bi bi-bell-slash text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-0">No new notifications</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="admin-recent-activity">
                        <h5 class="admin-section-title">
                            <i class="bi bi-clock-history me-2"></i>Recent Activity
                        </h5>
                        <div class="admin-activity-timeline">
                            {% if recent_activity %}
                                {% for activity in recent_activity %}
                                <div class="admin-activity-item">
                                    <div class="admin-activity-dot"></div>
                                    <div class="admin-activity-content">
                                        <h6 class="admin-activity-title">
                                            {% if activity.type == 'grade' %}
                                                <i class="bi bi-clipboard-check text-success me-1"></i>
                                            {% elif activity.type == 'assignment' %}
                                                <i class="bi bi-journal-plus text-primary me-1"></i>
                                            {% elif activity.type == 'submission' %}
                                                <i class="bi bi-file-earmark-check text-warning me-1"></i>
                                            {% else %}
                                                <i class="bi bi-circle-fill text-secondary me-1"></i>
                                            {% endif %}
                                            {{ activity.title }}
                                        </h6>
                                        <p class="admin-activity-text">{{ activity.description }}</p>
                                        <small class="admin-activity-time">
                                            {{ activity.timestamp.strftime('%b %d, %I:%M %p') if activity.timestamp else 'Recently' }}
                                        </small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="admin-activity-item text-center py-4">
                                    <i class="bi bi-activity text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-0">No recent activity</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>


        </div>

    {% elif section == 'students' %}
        <!-- Students Management View -->
        <div class="container-fluid px-2 px-md-4">
            <!-- Modern Students Header -->
            <div class="students-admin-header mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="students-admin-title mb-1">
                            <i class="bi bi-people-fill me-2"></i>Students Management
                        </h2>
                        <p class="students-admin-subtitle mb-0">
                            <i class="bi bi-mortarboard me-2"></i>Manage student records, accounts, and information
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('management.add_student') }}" class="btn btn-students-add">
                            <i class="bi bi-plus-circle me-2"></i>Add New Student
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="students-stat-card">
                        <div class="students-stat-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="students-stat-content">
                            <h3 class="students-stat-number">{{ total_students }}</h3>
                            <p class="students-stat-label">Total Students</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="students-stat-card">
                        <div class="students-stat-icon">
                            <i class="bi bi-person-check-fill"></i>
                        </div>
                        <div class="students-stat-content">
                            <h3 class="students-stat-number">{{ students_with_accounts }}</h3>
                            <p class="students-stat-label">With Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="students-stat-card">
                        <div class="students-stat-icon">
                            <i class="bi bi-person-x-fill"></i>
                        </div>
                        <div class="students-stat-content">
                            <h3 class="students-stat-number">{{ total_students - students_with_accounts }}</h3>
                            <p class="students-stat-label">Without Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="students-stat-card">
                        <div class="students-stat-icon">
                            <i class="bi bi-trophy-fill"></i>
                        </div>
                        <div class="students-stat-content">
                            <h3 class="students-stat-number">{{ students|selectattr('gpa')|selectattr('gpa', 'ge', 3.5)|list|length }}</h3>
                            <p class="students-stat-label">GPA â‰¥ 3.5</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search & Filter Section -->
            <div class="students-search-card mb-4">
                <div class="students-search-header">
                    <h5 class="mb-0">
                        <i class="bi bi-search me-2"></i>Search & Filter Students
                    </h5>
                </div>
                <div class="students-search-body">
                <form method="GET" action="{{ url_for('management.students') }}" class="row g-3">
                    <!-- Search Query -->
                    <div class="col-md-4">
                        <label for="search" class="form-label">Search Term</label>
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               value="{{ search_query or '' }}" 
                               placeholder="Enter search term..."
                               autocomplete="off">
                    </div>
                    
                    <!-- Search Type -->
                    <div class="col-md-2">
                        <label for="search_type" class="form-label">Search In</label>
                        <select class="form-select" id="search_type" name="search_type">
                            <option value="all" {% if search_type == 'all' %}selected{% endif %}>All Fields</option>
                            <option value="name" {% if search_type == 'name' %}selected{% endif %}>Student Name</option>
                            <option value="contact" {% if search_type == 'contact' %}selected{% endif %}>Contact Info</option>
                            <option value="phone" {% if search_type == 'phone' %}selected{% endif %}>Phone Numbers</option>
                            <option value="address" {% if search_type == 'address' %}selected{% endif %}>Address</option>
                            <option value="parents" {% if search_type == 'parents' %}selected{% endif %}>Parent Names</option>
                        </select>
                    </div>
                    
                    <!-- Grade Level Filter -->
                    <div class="col-md-2">
                        <label for="grade_level" class="form-label">Grade Level</label>
                        <select class="form-select" id="grade_level" name="grade_level">
                            <option value="">All Grades</option>
                            <option value="1" {% if grade_filter == '1' %}selected{% endif %}>1st Grade</option>
                            <option value="2" {% if grade_filter == '2' %}selected{% endif %}>2nd Grade</option>
                            <option value="3" {% if grade_filter == '3' %}selected{% endif %}>3rd Grade</option>
                            <option value="4" {% if grade_filter == '4' %}selected{% endif %}>4th Grade</option>
                            <option value="5" {% if grade_filter == '5' %}selected{% endif %}>5th Grade</option>
                            <option value="6" {% if grade_filter == '6' %}selected{% endif %}>6th Grade</option>
                            <option value="7" {% if grade_filter == '7' %}selected{% endif %}>7th Grade</option>
                            <option value="8" {% if grade_filter == '8' %}selected{% endif %}>8th Grade</option>
                            <option value="9" {% if grade_filter == '9' %}selected{% endif %}>9th Grade</option>
                            <option value="10" {% if grade_filter == '10' %}selected{% endif %}>10th Grade</option>
                            <option value="11" {% if grade_filter == '11' %}selected{% endif %}>11th Grade</option>
                            <option value="12" {% if grade_filter == '12' %}selected{% endif %}>12th Grade</option>
                        </select>
                    </div>
                    
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label for="status" class="form-label">Account Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Students</option>
                            <option value="has_account" {% if status_filter == 'has_account' %}selected{% endif %}>Has Account</option>
                            <option value="no_account" {% if status_filter == 'no_account' %}selected{% endif %}>No Account</option>
                        </select>
                    </div>
                    
                    <!-- Academic Alert Filter -->
                    <div class="col-md-2">
                        <label for="alert_filter" class="form-label">Academic Alert</label>
                        <select class="form-select" id="alert_filter" name="alert_filter">
                            <option value="">All Students</option>
                            <option value="critical" {% if request.args.get('alert_filter') == 'critical' %}selected{% endif %}>Critical (&lt;2.0 GPA)</option>
                            <option value="warning" {% if request.args.get('alert_filter') == 'warning' %}selected{% endif %}>Warning (2.0-2.9 GPA)</option>
                            <option value="good" {% if request.args.get('alert_filter') == 'good' %}selected{% endif %}>Good Standing (3.0+)</option>
                        </select>
                    </div>
                    
                    <!-- Sort Options -->
                    <div class="col-md-2">
                        <label for="sort" class="form-label">Sort By</label>
                        <select class="form-select" id="sort" name="sort">
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                            <option value="grade" {% if sort_by == 'grade' %}selected{% endif %}>Grade Level</option>
                            <option value="id" {% if sort_by == 'id' %}selected{% endif %}>Student ID</option>
                            <option value="gpa" {% if sort_by == 'gpa' %}selected{% endif %}>GPA (Low to High)</option>
                            <option value="gpa_desc" {% if sort_by == 'gpa_desc' %}selected{% endif %}>GPA (High to Low)</option>
                        </select>
                    </div>
                    
                    <!-- View Mode -->
                    <div class="col-md-2">
                        <label for="view_mode" class="form-label">View Mode</label>
                        <select class="form-select" id="view_mode" name="view_mode" onchange="applyViewMode(this.value)">
                            <option value="list" {% if request.args.get('view_mode') == 'list' or not request.args.get('view_mode') %}selected{% endif %}>All Students</option>
                            <option value="grouped" {% if request.args.get('view_mode') == 'grouped' %}selected{% endif %}>Grouped by Grade</option>
                            <option value="alerts_only" {% if request.args.get('view_mode') == 'alerts_only' %}selected{% endif %}>Alerts Only</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-students-search">
                                <i class="bi bi-search me-2"></i>Search
                            </button>
                            <a href="{{ url_for('management.students') }}" class="btn btn-students-reset">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reset
                            </a>
                            <button type="button" class="btn btn-students-info" data-bs-toggle="collapse" data-bs-target="#searchTips">
                                <i class="bi bi-info-circle me-2"></i>Search Tips
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Search Tips -->
                <div class="collapse mt-3" id="searchTips">
                    <div class="students-info-box">
                        <h6><i class="bi bi-lightbulb me-2"></i>Search Tips:</h6>
                        <ul class="mb-0">
                            <li><strong>All Fields:</strong> Search across student names, contact info, addresses, and parent information</li>
                            <li><strong>Student Name:</strong> Search by first or last name</li>
                            <li><strong>Contact Info:</strong> Search by student or parent email addresses</li>
                            <li><strong>Phone Numbers:</strong> Search by parent or emergency contact phone numbers</li>
                            <li><strong>Address:</strong> Search by street, city, state, or zip code</li>
                            <li><strong>Parent Names:</strong> Search by parent first or last names</li>
                        </ul>
                    </div>
                </div>
                </div>
            </div>

            <!-- CSV Import/Export Section -->
            <div class="students-csv-card mb-4">
                <div class="students-csv-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV Import/Export
                    </h5>
                </div>
                <div class="students-csv-body">
                <div class="row g-3">
                    <!-- Download CSV -->
                    <div class="col-md-4">
                        <h6><i class="bi bi-download me-2"></i>Export Students</h6>
                        <p class="text-muted small mb-2">Download all student data as a CSV file</p>
                        <a href="{{ url_for('management.download_students_csv') }}" class="btn btn-success btn-sm">
                            <i class="bi bi-file-earmark-arrow-down me-1"></i>Download CSV
                        </a>
                    </div>
                    
                    <!-- Download Template -->
                    <div class="col-md-4">
                        <h6><i class="bi bi-file-earmark-text me-2"></i>CSV Template</h6>
                        <p class="text-muted small mb-2">Download a template with example data</p>
                        <a href="{{ url_for('management.download_students_template') }}" class="btn btn-info btn-sm">
                            <i class="bi bi-file-earmark-text me-1"></i>Download Template
                        </a>
                    </div>
                    
                    <!-- Upload CSV -->
                    <div class="col-md-4">
                        <h6><i class="bi bi-upload me-2"></i>Import Students</h6>
                        <p class="text-muted small mb-2">Upload a CSV file to add/update students</p>
                        <form method="POST" action="{{ url_for('management.upload_students_csv') }}" enctype="multipart/form-data" class="d-inline">
                            <div class="input-group input-group-sm">
                                <input type="file" class="form-control" name="csv_file" accept=".csv" required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload me-1"></i>Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- CSV Upload Instructions -->
                <div class="mt-3">
                    <div class="students-info-box mb-0">
                        <h6><i class="bi bi-info-circle me-2"></i>CSV Upload Instructions:</h6>
                        <ul class="mb-0 small">
                            <li><strong>Download the template</strong> to see the required format and example data</li>
                            <li><strong>Required fields:</strong> First Name and Last Name</li>
                            <li><strong>Student ID:</strong> Leave blank to auto-generate (requires State and Date of Birth)</li>
                            <li><strong>Date format:</strong> MM/DD/YYYY (e.g., 01/15/2010)</li>
                            <li><strong>Update existing students:</strong> Match by Student ID or by First Name + Last Name + Date of Birth</li>
                            <li><strong>Add new students:</strong> Simply omit Student ID or provide a unique one</li>
                        </ul>
                    </div>
                </div>
                </div>
            </div>

            <!-- Search Results Info -->
            {% if search_query or grade_filter or status_filter %}
            <div class="students-results-banner mb-4">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Search Results:</strong> Found {{ total_students }} student(s)
                {% if search_query %} matching "{{ search_query }}"{% endif %}
                {% if grade_filter %} in grade {{ grade_filter }}{% endif %}
                {% if status_filter == 'has_account' %} with accounts{% endif %}
                {% if status_filter == 'no_account' %} without accounts{% endif %}
            </div>
            {% endif %}

            <!-- Academic Alerts Summary -->
            {% set critical_students = [] %}
            {% set warning_students = [] %}
            {% for student in students %}
                {% if student.gpa %}
                    {% if student.gpa < 2.0 %}
                        {% set _ = critical_students.append(student) %}
                    {% elif student.gpa >= 2.0 and student.gpa < 3.0 %}
                        {% set _ = warning_students.append(student) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {% if critical_students|length > 0 or warning_students|length > 0 %}
            <div class="academic-alerts-banner mb-4">
                <div class="alert alert-danger alert-dismissible fade show mb-0" role="alert">
                    <div class="d-flex align-items-start gap-3">
                        <div class="alert-icon">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-2">
                                <i class="bi bi-bell-fill me-2"></i>Academic Performance Alerts
                            </h5>
                            <div class="row g-3">
                                {% if critical_students|length > 0 %}
                                <div class="col-md-6">
                                    <div class="alert-stat-box alert-critical">
                                        <div class="alert-stat-icon">
                                            <i class="bi bi-exclamation-octagon-fill"></i>
                                        </div>
                                        <div>
                                            <h4 class="mb-0">{{ critical_students|length }}</h4>
                                            <small>Critical Alert (GPA &lt; 2.0)</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if warning_students|length > 0 %}
                                <div class="col-md-6">
                                    <div class="alert-stat-box alert-warning-box">
                                        <div class="alert-stat-icon alert-warning-icon">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                        </div>
                                        <div>
                                            <h4 class="mb-0">{{ warning_students|length }}</h4>
                                            <small>Warning (GPA 2.0-2.9)</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Students Table -->
            <div class="students-table-card">
                <div class="students-table-header">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>Student Records
                        <span class="badge bg-primary ms-2">{{ students|length }} Total</span>
                    </h5>
                    <div class="students-table-view-toggle">
                        <button class="btn btn-sm btn-students-view active" onclick="switchStudentsView('table')">
                            <i class="bi bi-table"></i> Table
                        </button>
                        <button class="btn btn-sm btn-students-view" onclick="switchStudentsView('cards')">
                            <i class="bi bi-grid-3x3-gap-fill"></i> Cards
                        </button>
                        <button class="btn btn-sm btn-students-view" onclick="switchStudentsView('grouped')">
                            <i class="bi bi-grid"></i> By Grade
                        </button>
                    </div>
                </div>
                <div class="students-table-body" id="tableView">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>
                                    <i class="bi bi-bell me-1"></i>Alert
                                </th>
                                <th>Name</th>
                                <th>Grade Level</th>
                                <th>Student ID</th>
                                <th>GPA</th>
                                <th>Academic Status</th>
                                <th>Account</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                {% set alert_level = 'none' %}
                                {% if student.gpa %}
                                    {% if student.gpa < 2.0 %}
                                        {% set alert_level = 'critical' %}
                                    {% elif student.gpa < 3.0 %}
                                        {% set alert_level = 'warning' %}
                                    {% elif student.gpa >= 3.5 %}
                                        {% set alert_level = 'excellent' %}
                                    {% endif %}
                                {% endif %}
                                <tr class="student-row student-alert-{{ alert_level }}">
                                    <td class="text-center">
                                        {% if alert_level == 'critical' %}
                                            <span class="alert-indicator alert-critical" title="Critical: GPA below 2.0">
                                                <i class="bi bi-exclamation-octagon-fill"></i>
                                            </span>
                                        {% elif alert_level == 'warning' %}
                                            <span class="alert-indicator alert-warning" title="Warning: GPA below 3.0">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                            </span>
                                        {% elif alert_level == 'excellent' %}
                                            <span class="alert-indicator alert-excellent" title="Excellent: GPA 3.5+">
                                                <i class="bi bi-star-fill"></i>
                                            </span>
                                        {% else %}
                                            <span class="alert-indicator alert-none">
                                                <i class="bi bi-dash-circle"></i>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="student-avatar-mini">
                                                {{ student.first_name[0] if student.first_name else '?' }}{{ student.last_name[0] if student.last_name else '?' }}
                                            </div>
                                            <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary bg-opacity-20 text-dark border">
                                            Grade {{ student.grade_level | display_grade }}
                                        </span>
                                    </td>
                                    <td>
                                        <code class="student-id-code">{{ student.student_id or 'N/A' }}</code>
                                    </td>
                                    <td>
                                        {% if student.gpa %}
                                            <div class="gpa-display">
                                                <span class="gpa-badge gpa-{{ alert_level }}">
                                                    {{ "%.2f"|format(student.gpa) }}
                                                </span>
                                                <div class="gpa-progress-bar">
                                                    <div class="gpa-progress-fill gpa-progress-{{ alert_level }}" style="width: {{ (student.gpa / 4.0 * 100)|round }}%"></div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if student.gpa %}
                                            {% if student.gpa >= 3.5 %}
                                                <span class="badge bg-success bg-opacity-20 text-success border border-success">
                                                    <i class="bi bi-trophy-fill me-1"></i>Honors
                                                </span>
                                            {% elif student.gpa >= 3.0 %}
                                                <span class="badge bg-info bg-opacity-20 text-info border border-info">
                                                    <i class="bi bi-check-circle-fill me-1"></i>Good Standing
                                                </span>
                                            {% elif student.gpa >= 2.0 %}
                                                <span class="badge bg-warning bg-opacity-20 text-warning border border-warning">
                                                    <i class="bi bi-exclamation-circle-fill me-1"></i>Needs Improvement
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger bg-opacity-20 text-danger border border-danger">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>At Risk
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary bg-opacity-20">No Data</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if student.user %}
                                            <span class="badge bg-success text-white border border-success" style="font-weight: 500;">
                                                <i class="bi bi-check-circle me-1"></i>{{ student.user.username }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark border border-warning" style="font-weight: 500;">
                                                <i class="bi bi-x-circle me-1"></i>No Account
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-students-action-view" onclick="viewStudent({{ student.id }})" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-students-action-edit" onclick="editStudent({{ student.id }})" title="Edit Student">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-students-action-delete" onclick="removeStudent({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')" title="Remove Student">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-5">
                                        <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                                        No students found.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                </div>

                <!-- Cards View (Hidden by default) -->
                <div class="students-cards-body" id="cardsView" style="display: none;">
                    <div class="row g-3">
                        {% for student in students %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="student-card">
                                <div class="student-card-header">
                                    <div class="student-card-avatar">
                                        <i class="bi bi-person-fill"></i>
                                    </div>
                                    <div class="student-card-info">
                                        <h6 class="student-card-name">{{ student.first_name }} {{ student.last_name }}</h6>
                                        <p class="student-card-id">ID: {{ student.student_id or 'N/A' }}</p>
                                    </div>
                                </div>
                                <div class="student-card-body">
                                    <div class="student-card-detail">
                                        <i class="bi bi-mortarboard me-2"></i>
                                        <span>Grade: {{ student.grade_level | display_grade }}</span>
                                    </div>
                                    <div class="student-card-detail">
                                        <i class="bi bi-calendar3 me-2"></i>
                                        <span>DOB: {{ student.dob or 'N/A' }}</span>
                                    </div>
                                    <div class="student-card-detail">
                                        <i class="bi bi-trophy me-2"></i>
                                        <span>GPA: 
                                            {% if student.gpa %}
                                                <span class="badge {% if student.gpa >= 3.5 %}bg-success{% elif student.gpa >= 2.0 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ "%.2f"|format(student.gpa) }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">N/A</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="student-card-detail">
                                        <i class="bi bi-person-circle me-2"></i>
                                        <span>Account: 
                                            {% if student.user %}
                                                <span class="badge bg-success">{{ student.user.username }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">No Account</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="student-card-footer">
                                    <button type="button" class="btn btn-sm btn-students-card-action" onclick="viewStudent({{ student.id }})">
                                        <i class="bi bi-eye me-1"></i>View
                                    </button>
                                    <button type="button" class="btn btn-sm btn-students-card-action" onclick="editStudent({{ student.id }})">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-students-card-action-delete" onclick="removeStudent({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                        <i class="bi bi-trash me-1"></i>Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                            <p class="text-muted">No students found.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Grouped View (By Grade Level) -->
                <div class="students-grouped-body" id="groupedView" style="display: none;">
                    {% set students_by_grade = {} %}
                    {% for student in students %}
                        {% set grade = student.grade_level or 0 %}
                        {% if grade not in students_by_grade %}
                            {% set _ = students_by_grade.update({grade: []}) %}
                        {% endif %}
                        {% set _ = students_by_grade[grade].append(student) %}
                    {% endfor %}
                    
                    {% for grade in students_by_grade.keys()|sort %}
                        <div class="grade-group-section mb-4">
                            <div class="grade-group-header">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="grade-group-icon">
                                        <i class="bi bi-mortarboard-fill"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">{{ 'Grade %d'|format(grade) if grade > 0 else 'Unassigned Grade' }}</h5>
                                        <small class="text-muted">{{ students_by_grade[grade]|length }} Student{{ 's' if students_by_grade[grade]|length != 1 else '' }}</small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleGradeGroup({{ grade }})">
                                    <i class="bi bi-chevron-down" id="gradeChevron{{ grade }}"></i>
                                </button>
                            </div>
                            <div class="grade-group-body" id="gradeGroup{{ grade }}">
                                <div class="row g-3">
                                    {% for student in students_by_grade[grade]|sort(attribute='last_name') %}
                                        {% set alert_level = 'none' %}
                                        {% if student.gpa %}
                                            {% if student.gpa < 2.0 %}
                                                {% set alert_level = 'critical' %}
                                            {% elif student.gpa < 3.0 %}
                                                {% set alert_level = 'warning' %}
                                            {% elif student.gpa >= 3.5 %}
                                                {% set alert_level = 'excellent' %}
                                            {% endif %}
                                        {% endif %}
                                        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                                            <div class="student-grouped-card student-card-alert-{{ alert_level }}">
                                                <div class="student-grouped-alert">
                                                    {% if alert_level == 'critical' %}
                                                        <i class="bi bi-exclamation-octagon-fill text-danger"></i>
                                                    {% elif alert_level == 'warning' %}
                                                        <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                                    {% elif alert_level == 'excellent' %}
                                                        <i class="bi bi-star-fill text-success"></i>
                                                    {% else %}
                                                        <i class="bi bi-check-circle text-muted"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="student-grouped-header">
                                                    <div class="student-grouped-avatar">
                                                        {{ student.first_name[0] if student.first_name else '?' }}{{ student.last_name[0] if student.last_name else '?' }}
                                                    </div>
                                                    <div class="student-grouped-info">
                                                        <h6 class="mb-0">{{ student.first_name }} {{ student.last_name }}</h6>
                                                        <small class="text-muted">ID: {{ student.student_id or 'N/A' }}</small>
                                                    </div>
                                                </div>
                                                <div class="student-grouped-stats">
                                                    <div class="grouped-stat-item">
                                                        <div class="grouped-stat-icon">
                                                            <i class="bi bi-trophy"></i>
                                                        </div>
                                                        <div>
                                                            <div class="grouped-stat-value">
                                                                {% if student.gpa %}
                                                                    {{ "%.2f"|format(student.gpa) }}
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </div>
                                                            <div class="grouped-stat-label">GPA</div>
                                                        </div>
                                                    </div>
                                                    <div class="grouped-stat-item">
                                                        <div class="grouped-stat-icon">
                                                            <i class="bi bi-person-badge"></i>
                                                        </div>
                                                        <div>
                                                            <div class="grouped-stat-value">
                                                                {% if student.user %}
                                                                    <i class="bi bi-check-circle text-success"></i>
                                                                {% else %}
                                                                    <i class="bi bi-x-circle text-danger"></i>
                                                                {% endif %}
                                                            </div>
                                                            <div class="grouped-stat-label">Account</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="student-grouped-footer">
                                                    <button type="button" class="btn btn-sm btn-primary w-100" onclick="viewStudent({{ student.id }})">
                                                        <i class="bi bi-eye me-1"></i>View Details
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    {% if students_by_grade|length == 0 %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                        <p class="text-muted">No students found.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- View Student Modal -->
            <div class="modal fade" id="viewStudentModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content student-modal">
                        <div class="modal-header student-modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-person-circle me-2"></i>Student Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body student-modal-body">
                            <!-- Student Avatar Section -->
                            <div class="student-modal-avatar-section">
                                <div class="student-modal-avatar">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                                <div class="student-modal-name-section">
                                    <h4 id="viewStudentName" class="student-modal-name">Student Name</h4>
                                    <p id="viewStudentId" class="student-modal-id">ID: N/A</p>
                                </div>
                            </div>

                            <!-- Student Information Grid -->
                            <div class="student-info-grid">
                                <div class="student-info-card">
                                    <div class="student-info-icon">
                                        <i class="bi bi-mortarboard-fill"></i>
                                    </div>
                                    <div class="student-info-content">
                                        <label>Grade Level</label>
                                        <span id="viewStudentGrade">N/A</span>
                                    </div>
                                </div>
                                <div class="student-info-card">
                                    <div class="student-info-icon">
                                        <i class="bi bi-calendar3"></i>
                                    </div>
                                    <div class="student-info-content">
                                        <label>Date of Birth</label>
                                        <span id="viewStudentDob">N/A</span>
                                    </div>
                                </div>
                                <div class="student-info-card">
                                    <div class="student-info-icon">
                                        <i class="bi bi-trophy-fill"></i>
                                    </div>
                                    <div class="student-info-content">
                                        <label>GPA</label>
                                        <span id="viewStudentGpa">N/A</span>
                                    </div>
                                </div>
                                <div class="student-info-card">
                                    <div class="student-info-icon">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <div class="student-info-content">
                                        <label>Username</label>
                                        <span id="viewStudentUsername">N/A</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div class="student-details-section">
                                <h6 class="student-details-title">
                                    <i class="bi bi-envelope-fill me-2"></i>Contact Information
                                </h6>
                                <div class="student-details-grid">
                                    <div class="student-detail-item">
                                        <label>Email</label>
                                        <span id="viewStudentEmail">N/A</span>
                                    </div>
                                    <div class="student-detail-item">
                                        <label>Phone</label>
                                        <span id="viewStudentPhone">N/A</span>
                                    </div>
                                    <div class="student-detail-item">
                                        <label>Address</label>
                                        <span id="viewStudentAddress">N/A</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Parent Information -->
                            <div class="student-details-section">
                                <h6 class="student-details-title">
                                    <i class="bi bi-people-fill me-2"></i>Parent/Guardian Information
                                </h6>
                                <div class="student-details-grid">
                                    <div class="student-detail-item">
                                        <label>Parent Name</label>
                                        <span id="viewParentName">N/A</span>
                                    </div>
                                    <div class="student-detail-item">
                                        <label>Parent Email</label>
                                        <span id="viewParentEmail">N/A</span>
                                    </div>
                                    <div class="student-detail-item">
                                        <label>Parent Phone</label>
                                        <span id="viewParentPhone">N/A</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Academic Status -->
                            <div class="student-details-section">
                                <h6 class="student-details-title">
                                    <i class="bi bi-book-fill me-2"></i>Academic Status
                                </h6>
                                <div id="viewStudentClasses" class="student-classes-list">
                                    <!-- Classes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer student-modal-footer">
                            <button type="button" class="btn btn-student-edit" onclick="openEditFromView()">
                                <i class="bi bi-pencil me-2"></i>Edit Student
                            </button>
                            <button type="button" class="btn btn-student-close" data-bs-dismiss="modal">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Student Modal -->
            <div class="modal fade" id="editStudentModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content student-modal">
                        <div class="modal-header student-modal-header-edit">
                            <h5 class="modal-title">
                                <i class="bi bi-pencil-square me-2"></i>Edit Student
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form id="editStudentForm">
                            <div class="modal-body student-modal-body">
                                <input type="hidden" id="editStudentIdHidden" name="student_id">
                                
                                <!-- Personal Information -->
                                <div class="edit-section">
                                    <h6 class="edit-section-title">
                                        <i class="bi bi-person-fill me-2"></i>Personal Information
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control student-input" id="editFirstName" name="first_name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control student-input" id="editLastName" name="last_name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control student-input" id="editDob" name="dob">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Grade Level</label>
                                            <select class="form-select student-input" id="editGradeLevel" name="grade_level">
                                                <option value="">Select Grade</option>
                                                <option value="1">1st Grade</option>
                                                <option value="2">2nd Grade</option>
                                                <option value="3">3rd Grade</option>
                                                <option value="4">4th Grade</option>
                                                <option value="5">5th Grade</option>
                                                <option value="6">6th Grade</option>
                                                <option value="7">7th Grade</option>
                                                <option value="8">8th Grade</option>
                                                <option value="9">9th Grade</option>
                                                <option value="10">10th Grade</option>
                                                <option value="11">11th Grade</option>
                                                <option value="12">12th Grade</option>
                                            </select>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Student ID</label>
                                            <input type="text" class="form-control student-input" id="editStudentIdDisplay" name="student_id" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Information -->
                                <div class="edit-section">
                                    <h6 class="edit-section-title">
                                        <i class="bi bi-envelope-fill me-2"></i>Contact Information
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Personal Email</label>
                                            <input type="email" class="form-control student-input" id="editEmail" name="email">
                                            <small class="text-muted">For parent contact and personal communications</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">
                                                Google Workspace Email
                                                <i class="bi bi-google text-primary ms-1" data-bs-toggle="tooltip" title="For Google Sign-In authentication"></i>
                                            </label>
                                            <input type="email" class="form-control student-input" id="editGoogleWorkspaceEmail" name="google_workspace_email" placeholder="student@clarascienceacademy.org">
                                            <small class="text-muted">For Google Sign-In (e.g., firstname.lastname@clarascienceacademy.org)</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" class="form-control student-input" id="editPhone" name="phone">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Address</label>
                                            <textarea class="form-control student-input" id="editAddress" name="address" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Parent Information -->
                                <div class="edit-section">
                                    <h6 class="edit-section-title">
                                        <i class="bi bi-people-fill me-2"></i>Parent/Guardian Information
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Parent First Name</label>
                                            <input type="text" class="form-control student-input" id="editParentFirstName" name="parent_first_name">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Parent Last Name</label>
                                            <input type="text" class="form-control student-input" id="editParentLastName" name="parent_last_name">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Parent Email</label>
                                            <input type="email" class="form-control student-input" id="editParentEmail" name="parent_email">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Parent Phone</label>
                                            <input type="tel" class="form-control student-input" id="editParentPhone" name="parent_phone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer student-modal-footer">
                                <button type="button" class="btn btn-student-cancel" data-bs-dismiss="modal">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-student-save">
                                    <i class="bi bi-check-circle me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>

    {% elif section == 'teachers' %}
        <!-- Teachers & Staff Management View -->
        <div class="container-fluid px-2 px-md-4">
            <!-- Modern Teachers Header -->
            <div class="teachers-admin-header mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="teachers-admin-title mb-1">
                            <i class="bi bi-person-badge-fill me-2"></i>Teachers & Staff Management
                        </h2>
                        <p class="teachers-admin-subtitle mb-0">
                            <i class="bi bi-briefcase me-2"></i>Manage teachers, staff records, and account information
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('management.add_teacher_staff') }}" class="btn btn-teachers-add">
                            <i class="bi bi-plus-circle me-2"></i>Add New Staff
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="teachers-stat-card">
                        <div class="teachers-stat-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="teachers-stat-content">
                            <h3 class="teachers-stat-number">{{ total_teachers or teachers|length }}</h3>
                            <p class="teachers-stat-label">Total Staff</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="teachers-stat-card">
                        <div class="teachers-stat-icon">
                            <i class="bi bi-person-check-fill"></i>
                        </div>
                        <div class="teachers-stat-content">
                            <h3 class="teachers-stat-number">{{ teachers_with_accounts or 0 }}</h3>
                            <p class="teachers-stat-label">With Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="teachers-stat-card">
                        <div class="teachers-stat-icon">
                            <i class="bi bi-person-x-fill"></i>
                        </div>
                        <div class="teachers-stat-content">
                            <h3 class="teachers-stat-number">{{ teachers_without_accounts or 0 }}</h3>
                            <p class="teachers-stat-label">Without Accounts</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="teachers-stat-card">
                        <div class="teachers-stat-icon">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="teachers-stat-content">
                            <h3 class="teachers-stat-number">{{ teachers|selectattr('employment_type', 'equalto', 'Full Time')|list|length }}</h3>
                            <p class="teachers-stat-label">Full Time</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search & Filter Section -->
            <div class="teachers-search-card mb-4">
                <div class="teachers-search-header">
                    <h5 class="mb-0">
                        <i class="bi bi-search me-2"></i>Search & Filter Staff
                    </h5>
                </div>
                <div class="teachers-search-body">
                <form method="GET" action="{{ url_for('management.teachers') }}" id="teacherSearchForm">
                    <div class="row g-3">
                        <!-- Search Query -->
                        <div class="col-md-6">
                            <label for="search" class="form-label">Search Query</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="search" 
                                   name="search" 
                                   value="{{ search_query or '' }}" 
                                   placeholder="Enter search term..."
                                   autocomplete="off">
                        </div>
                        
                        <!-- Search Type -->
                        <div class="col-md-6">
                            <label for="search_type" class="form-label">Search In</label>
                            <select class="form-select" id="search_type" name="search_type">
                                <option value="all" {% if search_type == 'all' %}selected{% endif %}>All Fields</option>
                                <option value="name" {% if search_type == 'name' %}selected{% endif %}>Staff Name</option>
                                <option value="contact" {% if search_type == 'contact' %}selected{% endif %}>Contact Info</option>
                                <option value="role" {% if search_type == 'role' %}selected{% endif %}>Role & Position</option>
                                <option value="department" {% if search_type == 'department' %}selected{% endif %}>Department</option>
                                <option value="subject" {% if search_type == 'subject' %}selected{% endif %}>Subject</option>
                                <option value="address" {% if search_type == 'address' %}selected{% endif %}>Address</option>
                                <option value="emergency" {% if search_type == 'emergency' %}selected{% endif %}>Emergency Contact</option>
                                <option value="staff_id" {% if search_type == 'staff_id' %}selected{% endif %}>Staff ID</option>
                                <option value="employment" {% if search_type == 'employment' %}selected{% endif %}>Employment Type</option>
                            </select>
                        </div>
                        
                        <!-- Department Filter -->
                        <div class="col-md-4">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" name="department">
                                <option value="">All Departments</option>
                                <option value="Mathematics" {% if department_filter == 'Mathematics' %}selected{% endif %}>Mathematics</option>
                                <option value="Science" {% if department_filter == 'Science' %}selected{% endif %}>Science</option>
                                <option value="English" {% if department_filter == 'English' %}selected{% endif %}>English</option>
                                <option value="History & Social Studies" {% if department_filter == 'History & Social Studies' %}selected{% endif %}>History & Social Studies</option>
                                <option value="Physical Education & Health" {% if department_filter == 'Physical Education & Health' %}selected{% endif %}>Physical Education & Health</option>
                                <option value="Music & Arts" {% if department_filter == 'Music & Arts' %}selected{% endif %}>Music & Arts</option>
                                <option value="Computer Science & Technology" {% if department_filter == 'Computer Science & Technology' %}selected{% endif %}>Computer Science & Technology</option>
                                <option value="Administration" {% if department_filter == 'Administration' %}selected{% endif %}>Administration</option>
                                <option value="Counseling" {% if department_filter == 'Counseling' %}selected{% endif %}>Counseling</option>
                                <option value="Special Education" {% if department_filter == 'Special Education' %}selected{% endif %}>Special Education</option>
                                <option value="Foreign Language" {% if department_filter == 'Foreign Language' %}selected{% endif %}>Foreign Language</option>
                                <option value="Business" {% if department_filter == 'Business' %}selected{% endif %}>Business</option>
                            </select>
                        </div>
                        
                        <!-- Role Filter -->
                        <div class="col-md-4">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-select" id="role" name="role">
                                <option value="">All Roles</option>
                                <option value="Director" {% if role_filter == 'Director' %}selected{% endif %}>Director</option>
                                <option value="School Administrator" {% if role_filter == 'School Administrator' %}selected{% endif %}>School Administrator</option>
                                <option value="Math Teacher" {% if role_filter == 'Math Teacher' %}selected{% endif %}>Math Teacher</option>
                                <option value="Physics Teacher" {% if role_filter == 'Physics Teacher' %}selected{% endif %}>Physics Teacher</option>
                                <option value="English Language Arts Teacher" {% if role_filter == 'English Language Arts Teacher' %}selected{% endif %}>English Language Arts Teacher</option>
                                <option value="History Teacher" {% if role_filter == 'History Teacher' %}selected{% endif %}>History Teacher</option>
                                <option value="Science Teacher" {% if role_filter == 'Science Teacher' %}selected{% endif %}>Science Teacher</option>
                                <option value="Substitute Teacher" {% if role_filter == 'Substitute Teacher' %}selected{% endif %}>Substitute Teacher</option>
                                <option value="School Counselor" {% if role_filter == 'School Counselor' %}selected{% endif %}>School Counselor</option>
                                <option value="IT Support" {% if role_filter == 'IT Support' %}selected{% endif %}>IT Support</option>
                                <option value="Other Staff" {% if role_filter == 'Other Staff' %}selected{% endif %}>Other Staff</option>
                            </select>
                        </div>
                        
                        <!-- Employment Type Filter -->
                        <div class="col-md-4">
                            <label for="employment" class="form-label">Employment Type</label>
                            <select class="form-select" id="employment" name="employment">
                                <option value="">All Types</option>
                                <option value="Full Time" {% if employment_filter == 'Full Time' %}selected{% endif %}>Full Time</option>
                                <option value="Part Time" {% if employment_filter == 'Part Time' %}selected{% endif %}>Part Time</option>
                            </select>
                        </div>
                        
                        <!-- Sort Options -->
                        <div class="col-md-6">
                            <label for="sort" class="form-label">Sort By</label>
                            <select class="form-select" id="sort" name="sort">
                                <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                                <option value="role" {% if sort_by == 'role' %}selected{% endif %}>Role</option>
                                <option value="department" {% if sort_by == 'department' %}selected{% endif %}>Department</option>
                                <option value="hire_date" {% if sort_by == 'hire_date' %}selected{% endif %}>Hire Date</option>
                            </select>
                        </div>
                        
                        <!-- Sort Order -->
                        <div class="col-md-6">
                            <label for="order" class="form-label">Order</label>
                            <select class="form-select" id="order" name="order">
                                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                            </select>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-teachers-search">
                                    <i class="bi bi-search me-2"></i>Search
                                </button>
                                <a href="{{ url_for('management.teachers') }}" class="btn btn-teachers-reset">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Reset
                                </a>
                                <button type="button" class="btn btn-teachers-info" data-bs-toggle="collapse" data-bs-target="#searchTips">
                                    <i class="bi bi-info-circle me-2"></i>Search Tips
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Tips -->
                    <div class="collapse mt-3" id="searchTips">
                        <div class="teachers-info-box">
                            <h6><i class="bi bi-lightbulb me-2"></i>Search Tips:</h6>
                            <ul class="mb-0">
                                <li><strong>All Fields:</strong> Searches across all staff information including name, contact, role, department, address, emergency contacts, and employment details</li>
                                <li><strong>Staff Name:</strong> Search by first name, last name, or middle initial</li>
                                <li><strong>Contact Info:</strong> Search by email address or phone number</li>
                                <li><strong>Role & Position:</strong> Search by assigned role or position title</li>
                                <li><strong>Department:</strong> Search within specific departments</li>
                                <li><strong>Subject:</strong> Search by subjects taught</li>
                                <li><strong>Address:</strong> Search by street, apartment/unit, city, state, or zip code</li>
                                <li><strong>Emergency Contact:</strong> Search by emergency contact name, phone, email, or relationship</li>
                                <li><strong>Staff ID:</strong> Search by staff identification number</li>
                                <li><strong>Employment Type:</strong> Search by Full Time or Part Time employment status</li>
                                <li><strong>Keyboard Shortcuts:</strong> Ctrl/Cmd + F to focus search, Escape to clear</li>
                            </ul>
                        </div>
                    </div>
                </form>
                </div>
            </div>

            <!-- Search Results Info -->
            {% if search_query or department_filter or role_filter or employment_filter %}
            <div class="teachers-results-banner mb-4">
                <i class="bi bi-funnel me-2"></i>
                <strong>Active Filters:</strong>
                {% if search_query %}<span class="badge bg-primary me-1">Search: "{{ search_query }}"</span>{% endif %}
                {% if department_filter %}<span class="badge bg-secondary me-1">Dept: "{{ department_filter }}"</span>{% endif %}
                {% if role_filter %}<span class="badge bg-warning me-1">Role: "{{ role_filter }}"</span>{% endif %}
                {% if employment_filter %}<span class="badge bg-info me-1">Type: "{{ employment_filter }}"</span>{% endif %}
            </div>
            {% endif %}

            <!-- Teachers Table -->
            <div class="teachers-table-card">
                <div class="teachers-table-header">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>Staff Records
                    </h5>
                    <div class="teachers-table-view-toggle">
                        <button class="btn btn-sm btn-teachers-view active" onclick="switchTeachersView('table')">
                            <i class="bi bi-table"></i> Table
                        </button>
                        <button class="btn btn-sm btn-teachers-view" onclick="switchTeachersView('cards')">
                            <i class="bi bi-grid-3x3-gap-fill"></i> Cards
                        </button>
                    </div>
                </div>
                <div class="teachers-table-body" id="teachersTableView">
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle teachers-table">
                        <thead class="table-dark">
                            <tr>
                                <th style="min-width: 200px;">Name</th>
                                <th style="min-width: 120px;">Role</th>
                                <th style="min-width: 150px;">Department</th>
                                <th style="min-width: 180px;">Email</th>
                                <th style="min-width: 100px;">Username</th>
                                <th style="min-width: 100px;">Employment</th>
                                <th style="min-width: 80px;">Status</th>
                                <th style="min-width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for teacher in teachers %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if teacher.image %}
                                                    <img src="{{ url_for('static', filename='uploads/' + teacher.image) }}" 
                                                         alt="{{ teacher.first_name }} {{ teacher.last_name }}" 
                                                         class="rounded-circle" 
                                                         style="width: 40px; height: 40px; object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" 
                                                         style="width: 40px; height: 40px;">
                                                        <i class="bi bi-person-fill text-white"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">{{ teacher.first_name }}{% if teacher.middle_initial %} {{ teacher.middle_initial }}.{% endif %} {{ teacher.last_name }}</div>
                                                {% if teacher.staff_id %}
                                                    <small class="text-muted">ID: {{ teacher.staff_id }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if teacher.user %}
                                            {% set badge_class = 'bg-danger' if teacher.user.role == 'Director' else 'bg-warning' if teacher.user.role == 'School Administrator' else 'bg-info' if teacher.user.role == 'Teacher' else 'bg-secondary' if teacher.user.role == 'Tech' else 'bg-light text-dark' %}
                                            <span class="badge {{ badge_class }} mb-1 d-block">
                                                {{ teacher.user.role }}
                                            </span>
                                            {% if teacher.assigned_role and teacher.assigned_role != teacher.user.role %}
                                                <small class="text-muted d-block">{{ teacher.assigned_role }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-warning mb-1 d-block">No Account</span>
                                            {% if teacher.assigned_role %}
                                                <small class="text-muted d-block">{{ teacher.assigned_role }}</small>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if teacher.department %}
                                            {% set departments = teacher.department.split(',') %}
                                            {% for dept in departments %}
                                                <span class="badge bg-info mb-1 d-block text-wrap" style="max-width: 140px; white-space: normal; line-height: 1.2;">{{ dept.strip() }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 170px;" title="{{ teacher.email or 'N/A' }}">
                                            {{ teacher.email or 'N/A' }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if teacher.user %}
                                            <span class="badge bg-primary">{{ teacher.user.username }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">No Account</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if teacher.employment_type %}
                                            <span class="badge bg-secondary">{{ teacher.employment_type }}</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-teachers-action-view" onclick="viewTeacher({{ teacher.id }})">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-teachers-action-edit" onclick="editTeacher({{ teacher.id }})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-teachers-action-delete" onclick="removeTeacher({{ teacher.id }}, '{{ teacher.first_name }} {{ teacher.last_name }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                                        No teachers or staff found matching your criteria.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                </div>

                <!-- Cards View (Hidden by default) -->
                <div class="teachers-cards-body" id="teachersCardsView" style="display: none;">
                    <div class="row g-3">
                        {% for teacher in teachers %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="teacher-card">
                                <div class="teacher-card-header">
                                    <div class="teacher-card-avatar">
                                        {% if teacher.image %}
                                            <img src="{{ url_for('static', filename='uploads/' + teacher.image) }}" 
                                                 alt="{{ teacher.first_name }} {{ teacher.last_name }}">
                                        {% else %}
                                            <i class="bi bi-person-fill"></i>
                                        {% endif %}
                                    </div>
                                    <div class="teacher-card-info">
                                        <h6 class="teacher-card-name">{{ teacher.first_name }}{% if teacher.middle_initial %} {{ teacher.middle_initial }}.{% endif %} {{ teacher.last_name }}</h6>
                                        <p class="teacher-card-id">ID: {{ teacher.staff_id or 'N/A' }}</p>
                                    </div>
                                </div>
                                <div class="teacher-card-body">
                                    <div class="teacher-card-detail">
                                        <i class="bi bi-person-badge me-2"></i>
                                        <span>Role: 
                                            {% if teacher.user %}
                                                {% set badge_class = 'bg-danger' if teacher.user.role == 'Director' else 'bg-warning' if teacher.user.role == 'School Administrator' else 'bg-info' if teacher.user.role == 'Teacher' else 'bg-secondary' if teacher.user.role == 'Tech' else 'bg-light text-dark' %}
                                                <span class="badge {{ badge_class }}">{{ teacher.user.role }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">No Account</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="teacher-card-detail">
                                        <i class="bi bi-building me-2"></i>
                                        <span>Dept: 
                                            {% if teacher.department %}
                                                {% set departments = teacher.department.split(',') %}
                                                {% for dept in departments[:2] %}
                                                    <span class="badge bg-info">{{ dept.strip() }}</span>
                                                {% endfor %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="teacher-card-detail">
                                        <i class="bi bi-envelope me-2"></i>
                                        <span class="text-truncate" style="max-width: 200px;">{{ teacher.email or 'N/A' }}</span>
                                    </div>
                                    <div class="teacher-card-detail">
                                        <i class="bi bi-person-circle me-2"></i>
                                        <span>Username: 
                                            {% if teacher.user %}
                                                <span class="badge bg-primary">{{ teacher.user.username }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">No Account</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="teacher-card-detail">
                                        <i class="bi bi-calendar-check me-2"></i>
                                        <span>Type: 
                                            {% if teacher.employment_type %}
                                                <span class="badge bg-secondary">{{ teacher.employment_type }}</span>
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="teacher-card-footer">
                                    <button type="button" class="btn btn-sm btn-teachers-card-action" onclick="viewTeacher({{ teacher.id }})">
                                        <i class="bi bi-eye me-1"></i>View
                                    </button>
                                    <button type="button" class="btn btn-sm btn-teachers-card-action" onclick="editTeacher({{ teacher.id }})">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-teachers-card-action-delete" onclick="removeTeacher({{ teacher.id }}, '{{ teacher.first_name }} {{ teacher.last_name }}')">
                                        <i class="bi bi-trash me-1"></i>Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                            <p class="text-muted">No teachers or staff found.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

    {% elif section == 'classes' %}
        <!-- Classes Management View -->
        <div class="container-fluid px-2 px-md-4">
            <!-- Modern Classes Header -->
            <div class="classes-admin-header mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="classes-admin-title mb-1">
                            <i class="bi bi-house-door-fill me-2"></i>Classes Management
                        </h2>
                        <p class="classes-admin-subtitle mb-0">
                            <i class="bi bi-book me-2"></i>Manage classes, schedules, and enrollments
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('management.add_class') }}" class="btn btn-classes-add">
                            <i class="bi bi-plus-circle me-2"></i>Create New Class
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="classes-stat-card">
                        <div class="classes-stat-icon">
                            <i class="bi bi-house-door-fill"></i>
                        </div>
                        <div class="classes-stat-content">
                            <h3 class="classes-stat-number">{{ classes|length }}</h3>
                            <p class="classes-stat-label">Total Classes</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="classes-stat-card">
                        <div class="classes-stat-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="classes-stat-content">
                            <h3 class="classes-stat-number">{{ classes|map(attribute='enrollments')|map('selectattr', 'is_active')|map('list')|map('length')|sum }}</h3>
                            <p class="classes-stat-label">Total Enrollments</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="classes-stat-card">
                        <div class="classes-stat-icon">
                            <i class="bi bi-person-badge"></i>
                        </div>
                        <div class="classes-stat-content">
                            <h3 class="classes-stat-number">{{ classes|map(attribute='teacher')|select|unique|list|length }}</h3>
                            <p class="classes-stat-label">Active Teachers</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="classes-stat-card">
                        <div class="classes-stat-icon">
                            <i class="bi bi-journal-check"></i>
                        </div>
                        <div class="classes-stat-content">
                            <h3 class="classes-stat-number">{{ classes|map(attribute='assignments')|map('list')|map('length')|sum }}</h3>
                            <p class="classes-stat-label">Total Assignments</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classes Grid -->
            <div class="classes-grid-header mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-grid-3x3-gap-fill me-2"></i>All Classes
                </h5>
            </div>

            <div class="row g-4">
                {% for class in classes %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="class-card">
                        <div class="class-card-header">
                            <div class="class-card-icon">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <div class="class-card-title-section">
                                <h6 class="class-card-title">{{ class.name }}</h6>
                                <p class="class-card-subject">{{ class.subject or 'General' }}</p>
                            </div>
                        </div>
                        <div class="class-card-body">
                            <div class="class-card-detail">
                                <i class="bi bi-mortarboard me-2"></i>
                                <span>Grade: <strong>{{ class.grade_level or 'N/A' }}</strong></span>
                            </div>
                            <div class="class-card-detail">
                                <i class="bi bi-person-badge me-2"></i>
                                <span>Teacher: <strong>{{ class.teacher.first_name }} {{ class.teacher.last_name if class.teacher else 'N/A' }}</strong></span>
                            </div>
                            <div class="class-card-detail">
                                <i class="bi bi-people-fill me-2"></i>
                                <span>Students: <strong>{{ class.enrollments|selectattr('is_active')|list|length }}</strong></span>
                            </div>
                            <div class="class-card-detail">
                                <i class="bi bi-journal-check me-2"></i>
                                <span>Assignments: <strong>{{ class.assignments|list|length }}</strong></span>
                            </div>
                        </div>
                        <div class="class-card-footer">
                            <a href="{{ url_for('management.view_class', class_id=class.id) }}" class="btn btn-sm btn-class-action">
                                <i class="bi bi-eye me-1"></i>View
                            </a>
                            <a href="{{ url_for('management.edit_class', class_id=class.id) }}" class="btn btn-sm btn-class-action">
                                <i class="bi bi-pencil me-1"></i>Edit
                            </a>
                            <a href="{{ url_for('management.manage_class_roster', class_id=class.id) }}" class="btn btn-sm btn-class-action">
                                <i class="bi bi-people me-1"></i>Roster
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="classes-empty-state">
                        <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                        <h5 class="text-muted">No Classes Found</h5>
                        <p class="text-muted mb-3">Get started by creating your first class</p>
                        <a href="{{ url_for('management.add_class') }}" class="btn btn-classes-add">
                            <i class="bi bi-plus-circle me-2"></i>Create New Class
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>

    {% elif section == 'assignments' %}
        <!-- Assignments Management View -->
        <div class="container-fluid px-2 px-md-4">
            <!-- Modern Assignments Header -->
            <div class="assignments-admin-header mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="assignments-admin-title mb-1">
                            <i class="bi bi-journal-check me-2"></i>Assignments & Grades
                        </h2>
                        <p class="assignments-admin-subtitle mb-0">
                            <i class="bi bi-clipboard-data me-2"></i>Manage assignments, track submissions, and grade student work
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('management.add_assignment') }}" class="btn btn-assignments-add">
                            <i class="bi bi-plus-circle me-2"></i>Create Assignment
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="assignments-stat-card">
                        <div class="assignments-stat-icon">
                            <i class="bi bi-journal-check"></i>
                        </div>
                        <div class="assignments-stat-content">
                            <h3 class="assignments-stat-number">{{ assignments|length }}</h3>
                            <p class="assignments-stat-label">Total Assignments</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="assignments-stat-card">
                        <div class="assignments-stat-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="assignments-stat-content">
                            <h3 class="assignments-stat-number">{{ assignments|selectattr('due_date')|select('due_date', 'ge', today)|list|length }}</h3>
                            <p class="assignments-stat-label">Active</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="assignments-stat-card">
                        <div class="assignments-stat-icon">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="assignments-stat-content">
                            <h3 class="assignments-stat-number">{{ assignments|selectattr('due_date')|rejectattr('due_date', 'none')|list|length }}</h3>
                            <p class="assignments-stat-label">Due Today/Overdue</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="assignments-stat-card">
                        <div class="assignments-stat-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="assignments-stat-content">
                            <h3 class="assignments-stat-number">{{ assignments|selectattr('attachment_filename')|list|length }}</h3>
                            <p class="assignments-stat-label">With Attachments</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments Table -->
            <div class="assignments-table-card">
                <div class="assignments-table-header">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>All Assignments
                    </h5>
                    <div class="assignments-table-view-toggle">
                        <button class="btn btn-sm btn-assignments-view active" onclick="switchAssignmentsView('table')">
                            <i class="bi bi-table"></i> Table
                        </button>
                        <button class="btn btn-sm btn-assignments-view" onclick="switchAssignmentsView('cards')">
                            <i class="bi bi-grid-3x3-gap-fill"></i> Cards
                        </button>
                    </div>
                </div>
                <div class="assignments-table-body" id="assignmentsTableView">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Class</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.title }}</td>
                                    <td>{{ assignment.class_info.name if assignment.class_info else 'N/A' }}</td>
                                    <td>{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else 'N/A' }}</td>
                                    <td>
                                        {% if assignment.due_date and assignment.due_date.date() < today %}
                                            <span class="badge bg-danger">Past Due</span>
                                        {% elif assignment.due_date and assignment.due_date.date() == today %}
                                            <span class="badge bg-warning">Due Today</span>
                                        {% elif assignment.due_date %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">No Due Date</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            {% if assignment.attachment_filename %}
                                                <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" 
                                                   class="btn btn-sm btn-outline-info flex-fill" 
                                                   title="Download Attachment: {{ assignment.attachment_original_filename or assignment.attachment_filename }}">
                                                    <i class="bi bi-paperclip me-1"></i>Attachment
                                                </a>
                                            {% endif %}
                                            {% if current_user.role in ['Director', 'School Administrator', 'Teacher'] %}
                                                <div class="assignment-actions">
                                                    <!-- Primary Actions Row -->
                                                    <div class="d-flex gap-1 mb-1">
                                                        <a href="{{ url_for('management.view_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-primary" title="View Assignment">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                        <a href="{{ url_for('management.view_class', class_id=assignment.class_id) }}" class="btn btn-sm btn-outline-info" title="View Class">
                                                            <i class="bi bi-people"></i>
                                                        </a>
                                                    </div>
                                                    
                                                    <!-- Management Actions for Directors and School Administrators -->
                                                    {% if current_user.role in ['Director', 'School Administrator'] %}
                                                        <div class="d-flex gap-1 mb-1">
                                                            <a href="{{ url_for('management.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-success" title="Grade Assignment">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{{ url_for('management.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-warning" title="Edit Assignment">
                                                                <i class="bi bi-pencil-square"></i>
                                                            </a>
                                                        </div>
                                                        
                                                        <div class="d-flex gap-1">
                                                            <button type="button" class="btn btn-sm btn-outline-info change-status-btn" title="Change Status"
                                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}" 
                                                                    data-current-status="{{ assignment.status }}">
                                                                <i class="bi bi-gear"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-success manage-extensions-btn" title="Manage Extensions"
                                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}"
                                                                    data-class-id="{{ assignment.class_id }}">
                                                                <i class="bi bi-clock-history"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-danger remove-assignment-btn" title="Remove Assignment"
                                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                        
                                                    {% elif current_user.role == 'Teacher' %}
                                                        <div class="d-flex gap-1 mb-1">
                                                            <a href="{{ url_for('management.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-success" title="Grade Assignment">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{{ url_for('management.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-warning" title="Edit Assignment">
                                                                <i class="bi bi-pencil-square"></i>
                                                            </a>
                                                        </div>
                                                        
                                                        <div class="d-flex gap-1">
                                                            <button type="button" class="btn btn-sm btn-outline-info change-status-btn" title="Change Status"
                                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}" 
                                                                    data-current-status="{{ assignment.status }}">
                                                                <i class="bi bi-gear"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-success manage-extensions-btn" title="Manage Extensions"
                                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}"
                                                                    data-class-id="{{ assignment.class_id }}">
                                                                <i class="bi bi-clock-history"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-danger remove-assignment-btn" title="Remove Assignment"
                                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% elif current_user.role == 'Student' %}
                                                <a href="#" class="btn btn-sm btn-outline-primary">View Details</a>
                                                {% if assignment.due_date and assignment.due_date.date() >= today %}
                                                    <a href="#" class="btn btn-sm btn-outline-success">Submit Work</a>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-5">
                                        <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                                        No assignments found.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                </div>

                <!-- Cards View (Hidden by default) -->
                <div class="assignments-cards-body" id="assignmentsCardsView" style="display: none;">
                    <div class="row g-3">
                        {% for assignment in assignments %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="assignment-card">
                                <div class="assignment-card-header">
                                    <div class="assignment-card-icon">
                                        <i class="bi bi-journal-text"></i>
                                    </div>
                                    <div class="assignment-card-status">
                                        {% if assignment.due_date and assignment.due_date.date() < today %}
                                            <span class="badge bg-danger">Past Due</span>
                                        {% elif assignment.due_date and assignment.due_date.date() == today %}
                                            <span class="badge bg-warning">Due Today</span>
                                        {% elif assignment.due_date %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">No Due Date</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="assignment-card-body">
                                    <h6 class="assignment-card-title">{{ assignment.title }}</h6>
                                    <div class="assignment-card-detail">
                                        <i class="bi bi-house-door me-2"></i>
                                        <span>Class: <strong>{{ assignment.class_info.name if assignment.class_info else 'N/A' }}</strong></span>
                                    </div>
                                    <div class="assignment-card-detail">
                                        <i class="bi bi-calendar3 me-2"></i>
                                        <span>Due: <strong>{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else 'N/A' }}</strong></span>
                                    </div>
                                    {% if assignment.attachment_filename %}
                                    <div class="assignment-card-detail">
                                        <i class="bi bi-paperclip me-2"></i>
                                        <span>
                                            <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" class="text-decoration-none">
                                                <strong>Has Attachment</strong>
                                            </a>
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="assignment-card-footer">
                                    <a href="{{ url_for('management.view_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-assignment-action" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('management.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-assignment-action" title="Grade">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{{ url_for('management.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-assignment-action" title="Edit">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-assignment-action-delete remove-assignment-btn" 
                                            data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12">
                            <div class="assignments-empty-state">
                                <i class="bi bi-inbox display-1 text-muted d-block mb-3"></i>
                                <h5 class="text-muted">No Assignments Found</h5>
                                <p class="text-muted mb-3">Get started by creating your first assignment</p>
                                <a href="{{ url_for('management.add_assignment') }}" class="btn btn-assignments-add">
                                    <i class="bi bi-plus-circle me-2"></i>Create Assignment
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to remove "<span id="assignmentTitle"></span>"?</p>
                        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form id="deleteForm" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-danger">Delete Assignment</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const removeButtons = document.querySelectorAll('.remove-assignment-btn');
            
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const assignmentId = this.dataset.assignmentId;
                    const assignmentTitle = this.dataset.assignmentTitle;
                    
                    document.getElementById('assignmentTitle').textContent = assignmentTitle;
                    document.getElementById('deleteForm').action = `/management/assignment/remove/${assignmentId}`;
                    
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.show();
                });
            });
        });
        </script>

    {% elif section == 'attendance' %}
        <!-- Attendance Management View -->
        <div class="container-fluid px-2 px-md-4">
            <!-- Modern Attendance Header -->
            <div class="attendance-admin-header mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="attendance-admin-title mb-1">
                            <i class="bi bi-calendar-check me-2"></i>Attendance Management
                        </h2>
                        <p class="attendance-admin-subtitle mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>Track student attendance and generate comprehensive reports
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('management.unified_attendance') }}" class="btn btn-attendance-unified">
                            <i class="bi bi-calendar3 me-2"></i>View All Attendance
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="attendance-stat-card">
                        <div class="attendance-stat-icon">
                            <i class="bi bi-house-door-fill"></i>
                        </div>
                        <div class="attendance-stat-content">
                            <h3 class="attendance-stat-number">{{ classes|length }}</h3>
                            <p class="attendance-stat-label">Total Classes</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="attendance-stat-card">
                        <div class="attendance-stat-icon">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="attendance-stat-content">
                            <h3 class="attendance-stat-number">{{ classes|length }}</h3>
                            <p class="attendance-stat-label">Today's Classes</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="attendance-stat-card">
                        <div class="attendance-stat-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="attendance-stat-content">
                            <h3 class="attendance-stat-number">0</h3>
                            <p class="attendance-stat-label">Completed Today</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="attendance-stat-card">
                        <div class="attendance-stat-icon">
                            <i class="bi bi-percent"></i>
                        </div>
                        <div class="attendance-stat-content">
                            <h3 class="attendance-stat-number">95%</h3>
                            <p class="attendance-stat-label">Attendance Rate</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Take Attendance & Reports Section -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-lg-8">
                    <div class="attendance-classes-card">
                        <div class="attendance-classes-header">
                            <h5 class="mb-0">
                                <i class="bi bi-clipboard-check me-2"></i>Take Attendance by Class
                            </h5>
                        </div>
                        <div class="attendance-classes-body">
                            <div class="attendance-classes-grid">
                                {% for class in classes %}
                                <a href="{{ url_for('management.take_class_attendance', class_id=class.id) }}" class="attendance-class-item">
                                    <div class="attendance-class-icon">
                                        <i class="bi bi-book-fill"></i>
                                    </div>
                                    <div class="attendance-class-info">
                                        <h6 class="attendance-class-name">{{ class.name }}</h6>
                                        <p class="attendance-class-subject">{{ class.subject or 'General' }}</p>
                                        <div class="attendance-class-meta">
                                            <span class="badge bg-primary">{{ class.enrollments|selectattr('is_active')|list|length }} students</span>
                                            <span class="badge bg-success">{{ class.grade_level or 'N/A' }}</span>
                                        </div>
                                    </div>
                                    <div class="attendance-class-action">
                                        <i class="bi bi-chevron-right"></i>
                                    </div>
                                </a>
                                {% else %}
                                <div class="attendance-empty-message">
                                    <i class="bi bi-inbox display-4 text-muted d-block mb-3"></i>
                                    <p class="text-muted">No classes available for attendance.</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-4">
                    <div class="attendance-reports-card">
                        <div class="attendance-reports-header">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-bar-graph me-2"></i>Quick Reports
                            </h5>
                        </div>
                        <div class="attendance-reports-body">
                            <a href="#" class="attendance-report-btn">
                                <i class="bi bi-calendar-day me-2"></i>
                                <span>Daily Report</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                            <a href="#" class="attendance-report-btn">
                                <i class="bi bi-calendar-week me-2"></i>
                                <span>Weekly Report</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                            <a href="#" class="attendance-report-btn">
                                <i class="bi bi-calendar-month me-2"></i>
                                <span>Monthly Report</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                            <a href="#" class="attendance-report-btn">
                                <i class="bi bi-person-lines-fill me-2"></i>
                                <span>Student Report</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                            <a href="#" class="attendance-report-btn">
                                <i class="bi bi-graph-up me-2"></i>
                                <span>Analytics Dashboard</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    {% elif section == 'admissions' %}
        <!-- Admissions View -->
        <h2 class="mb-4">Admissions</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-person-plus-fill me-2"></i>Student Admissions</h5>
            <p>Manage student admissions and enrollment.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Add New Student</h5>
                    </div>
                    <div class="card-body">
                        <p>Register a new student in the system.</p>
                        <a href="{{ url_for('management.add_student') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Add Student
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Admissions Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">0</h4>
                                <small class="text-muted">Pending Applications</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">0</h4>
                                <small class="text-muted">Approved Applications</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-warning">0</h4>
                                <small class="text-muted">Under Review</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info">0</h4>
                                <small class="text-muted">Total Applications</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'attendance_reports' %}
        <!-- Attendance Reports View -->
        <h2 class="mb-4">Attendance Reports</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-file-earmark-bar-graph-fill me-2"></i>Attendance Reports</h5>
            <p>Generate and view detailed attendance reports.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Generate Reports</h5>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="{{ url_for('management.attendance_reports') }}">
                            <div class="mb-3">
                                <label for="student_filter" class="form-label">Filter by Student</label>
                                <select class="form-select" id="student_filter" name="student_id">
                                    <option value="">All Students</option>
                                    {% for student in all_students %}
                                        <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="class_filter" class="form-label">Filter by Class</label>
                                <select class="form-select" id="class_filter" name="class_id">
                                    <option value="">All Classes</option>
                                    {% for class in all_classes %}
                                        <option value="{{ class.id }}">{{ class.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="status_filter" class="form-label">Filter by Status</label>
                                <select class="form-select" id="status_filter" name="status">
                                    <option value="">All Statuses</option>
                                    {% for status in all_statuses %}
                                        <option value="{{ status }}">{{ status }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="start_date" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="end_date" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="end_date" name="end_date">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Summary Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">{{ summary_stats.total_records }}</h4>
                                <small class="text-muted">Total Records</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-danger">{{ summary_stats.unexcused_absences }}</h4>
                                <small class="text-muted">Unexcused Absences</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-warning">{{ summary_stats.excused_absences }}</h4>
                                <small class="text-muted">Excused Absences</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info">{{ summary_stats.tardies }}</h4>
                                <small class="text-muted">Tardies</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if records %}
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Attendance Records</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Class</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.date }}</td>
                                <td>{{ record.student_name }}</td>
                                <td>{{ record.class_name }}</td>
                                <td>
                                    {% set status_badge = 'bg-success' if record.status == 'Present' else 'bg-danger' if record.status == 'Absent' else 'bg-warning' if record.status == 'Tardy' else 'bg-secondary' %}
                                    <span class="badge {{ status_badge }}">
                                        {{ record.status }}
                                    </span>
                                </td>
                                <td>{{ record.notes or 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    {% elif section == 'report_cards' %}
        <!-- Report Cards Management View -->
        <h2 class="mb-4">Report Cards Management</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-mortarboard-fill me-2"></i>Report Card Generation</h5>
            <p>Generate and manage student report cards.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Generate Report Cards</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Use our enhanced multi-step wizard to generate report cards with custom class selection, attendance data, and more options.
                        </p>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('management.generate_report_card_form') }}" class="btn btn-warning btn-lg">
                                <i class="bi bi-plus-circle me-2"></i>Generate New Report Card
                            </a>
                        </div>
                        <hr class="my-4">
                        <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Features:</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check-circle text-success me-2"></i>Select specific classes to include</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Include attendance statistics</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Add teacher comments</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Multi-step wizard interface</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Report Cards</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% if recent_reports %}
                                {% for report in recent_reports %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ report.student.first_name }} {{ report.student.last_name }}</h6>
                                                <small class="text-muted">{{ report.school_year.name }} - {{ report.quarter }}</small>
                                            </div>
                                            <a href="{{ url_for('management.view_report_card', report_card_id=report.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye me-1"></i>View
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-muted text-center py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    <p class="mb-0">No recent report cards.</p>
                                    <small>Generate a new report card to get started.</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'billing' %}
        <!-- Billing & Financials View -->
        <h2 class="mb-4">Billing & Financials</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-currency-dollar me-2"></i>Financial Management</h5>
            <p>Manage tuition, fees, and financial records.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Tuition Management</h5>
                    </div>
                    <div class="card-body">
                        <p>Manage student tuition and payment plans.</p>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-success">View Tuition Records</a>
                            <a href="#" class="btn btn-outline-success">Generate Invoices</a>
                            <a href="#" class="btn btn-outline-success">Payment History</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Financial Reports</h5>
                    </div>
                    <div class="card-body">
                        <p>Generate financial reports and analytics.</p>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-warning">Revenue Report</a>
                            <a href="#" class="btn btn-outline-warning">Expense Report</a>
                            <a href="#" class="btn btn-outline-warning">Budget Analysis</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'calendar' %}
        <!-- School Calendar View -->
        <h2 class="mb-4">School Calendar</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-calendar-event-fill me-2"></i>Academic Calendar</h5>
            <p>View and manage school events, holidays, and important dates.</p>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Upcoming Events</h6>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Parent-Teacher Conference</h6>
                                        <small class="text-muted">October 15, 2024</small>
                                    </div>
                                    <span class="badge bg-primary">Event</span>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Thanksgiving Break</h6>
                                        <small class="text-muted">November 25-29, 2024</small>
                                    </div>
                                    <span class="badge bg-warning">Holiday</span>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Winter Break</h6>
                                        <small class="text-muted">December 23 - January 5, 2025</small>
                                    </div>
                                    <span class="badge bg-info">Break</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-primary">Add Event</a>
                            <a href="#" class="btn btn-outline-secondary">Export Calendar</a>
                            <a href="#" class="btn btn-outline-info">View Full Calendar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'communications' %}
        <!-- Communications View -->
        <h2 class="mb-4">Communications</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-chat-dots-fill me-2"></i>Communication Center</h5>
            <p>Send messages to students, parents, and staff members.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Send Message</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label for="recipient" class="form-label">Recipient</label>
                                <select class="form-select" id="recipient">
                                    <option value="">Select recipient...</option>
                                    <option value="all_students">All Students</option>
                                    <option value="all_parents">All Parents</option>
                                    <option value="all_teachers">All Teachers</option>
                                    <option value="specific">Specific Person</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" placeholder="Message subject">
                            </div>
                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" rows="4" placeholder="Enter your message"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Message</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Recent Messages</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">School Announcement</h6>
                                        <small class="text-muted">Sent to All Students - 2 hours ago</small>
                                    </div>
                                    <span class="badge bg-success">Sent</span>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Parent Update</h6>
                                        <small class="text-muted">Sent to All Parents - 1 day ago</small>
                                    </div>
                                    <span class="badge bg-success">Sent</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'settings' %}
        <!-- Settings View -->
        <h2 class="mb-4">Settings</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-gear-fill me-2"></i>System Settings</h5>
            <p>Configure system preferences and account settings.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Account Settings</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" value="{{ current_user.username }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="{{ current_user.email or '' }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Change Password</label>
                                <div>
                                    <a href="{{ url_for('auth.change_password') }}" class="btn btn-warning">
                                        <i class="bi bi-lock-fill me-2"></i>Change Password
                                    </a>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-secondary">Update Settings</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">System Preferences</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Notifications</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_notifications" checked>
                                <label class="form-check-label" for="email_notifications">
                                    Email Notifications
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sms_notifications">
                                <label class="form-check-label" for="sms_notifications">
                                    SMS Notifications
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="timezone" class="form-label">Timezone</label>
                            <select class="form-select" id="timezone">
                                <option value="EST">Eastern Standard Time</option>
                                <option value="CST">Central Standard Time</option>
                                <option value="MST">Mountain Standard Time</option>
                                <option value="PST">Pacific Standard Time</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning">Save Preferences</button>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Generic fallback content for other sections -->
        <div class="alert alert-warning">
            <h4>Debug Information:</h4>
            <p><strong>Section:</strong> "{{ section }}"</p>
            <p><strong>Active Tab:</strong> "{{ active_tab }}"</p>
            <p><strong>User Role:</strong> {{ current_user.role }}</p>
            <hr>
            <p>Content for the '{{ section }}' section is currently under development. Please check back later!</p>
        </div>
    {% endif %}
    <!-- Student/Teacher View Modal -->
    <div class="modal fade" id="profileViewModal" tabindex="-1" aria-labelledby="profileViewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="profileViewModalLabel">
              <i class="bi bi-person-circle me-2"></i>Profile Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body max-height-70vh" id="profileViewModalBody">
            <!-- Content will be loaded by JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle me-1"></i>Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Student/Teacher Edit Modal -->
    <div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="profileEditModalLabel">
              <i class="bi bi-pencil-square me-2"></i>Edit Profile
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="profileEditForm">
            <div class="modal-body max-height-70vh" id="profileEditModalBody">
              <!-- Form fields will be loaded by JS -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-1"></i>Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
{% endblock %} 

{% block scripts %}
    {{ super() }}
    {% raw %}
    <script>
    // Switch between different student view modes
    function switchStudentsView(view) {
        // Hide all views
        document.getElementById('tableView').style.display = 'none';
        document.getElementById('cardsView').style.display = 'none';
        document.getElementById('groupedView').style.display = 'none';
        
        // Show selected view
        if (view === 'table') {
            document.getElementById('tableView').style.display = 'block';
        } else if (view === 'cards') {
            document.getElementById('cardsView').style.display = 'block';
        } else if (view === 'grouped') {
            document.getElementById('groupedView').style.display = 'block';
        }
        
        // Update button states
        document.querySelectorAll('.btn-students-view').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.btn-students-view').classList.add('active');
    }
    
    // Toggle grade group expansion
    function toggleGradeGroup(grade) {
        const gradeBody = document.getElementById('gradeGroup' + grade);
        const chevron = document.getElementById('gradeChevron' + grade);
        
        if (gradeBody.style.display === 'none') {
            gradeBody.style.display = 'block';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-up');
        } else {
            gradeBody.style.display = 'none';
            chevron.classList.remove('bi-chevron-up');
            chevron.classList.add('bi-chevron-down');
        }
    }
    
    // Apply view mode from select dropdown
    function applyViewMode(mode) {
        if (mode === 'grouped') {
            switchStudentsView('grouped');
        } else if (mode === 'alerts_only') {
            // Filter to show only students with alerts
            const form = document.querySelector('form');
            const alertFilter = document.getElementById('alert_filter');
            if (alertFilter.value === '') {
                alertFilter.value = 'critical';
            }
            form.submit();
        } else {
            switchStudentsView('table');
        }
    }
    
    function viewStudent(studentId) {
        console.log('viewStudent called with', studentId);
        fetch(`/management/view-student/${studentId}`)
            .then(response => response.json())
            .then(data => {
                let safeData = data || {};
                let classes = (safeData.assigned_classes || []).map(c => `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-book me-2"></i>${c.name || 'Unknown'}</span>
                    <span class="badge bg-primary rounded-pill">${c.subject || 'Unknown'}</span>
                  </li>`).join('');
                let photo = safeData.photo_filename ? `<img src='/static/uploads/${safeData.photo_filename}' class='rounded mx-auto d-block mb-3' style='max-width:120px;'>` : '';
                
                // Format parent information
                let parent1Info = '';
                if (safeData.parent1_first_name || safeData.parent1_last_name) {
                    parent1Info = `
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person me-2 text-muted"></i>
                                <strong>Parent 1:</strong>
                                <span class="ms-2">${safeData.parent1_first_name || ''} ${safeData.parent1_last_name || ''}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-heart me-2 text-muted"></i>
                                <strong>Relationship:</strong>
                                <span class="ms-2">${safeData.parent1_relationship || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope me-2 text-muted"></i>
                                <strong>Email:</strong>
                                <span class="ms-2">${safeData.parent1_email || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-telephone me-2 text-muted"></i>
                                <strong>Phone:</strong>
                                <span class="ms-2">${safeData.parent1_phone || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }
                
                let parent2Info = '';
                if (safeData.parent2_first_name || safeData.parent2_last_name) {
                    parent2Info = `
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person me-2 text-muted"></i>
                                <strong>Parent 2:</strong>
                                <span class="ms-2">${safeData.parent2_first_name || ''} ${safeData.parent2_last_name || ''}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-heart me-2 text-muted"></i>
                                <strong>Relationship:</strong>
                                <span class="ms-2">${safeData.parent2_relationship || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope me-2 text-muted"></i>
                                <strong>Email:</strong>
                                <span class="ms-2">${safeData.parent2_email || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-telephone me-2 text-muted"></i>
                                <strong>Phone:</strong>
                                <span class="ms-2">${safeData.parent2_phone || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Format emergency contact
                let emergencyInfo = '';
                if (safeData.emergency_first_name || safeData.emergency_last_name) {
                    emergencyInfo = `
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
                                <strong>Emergency Contact:</strong>
                                <span class="ms-2">${safeData.emergency_first_name || ''} ${safeData.emergency_last_name || ''}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-heart me-2 text-muted"></i>
                                <strong>Relationship:</strong>
                                <span class="ms-2">${safeData.emergency_relationship || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope me-2 text-muted"></i>
                                <strong>Email:</strong>
                                <span class="ms-2">${safeData.emergency_email || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-telephone me-2 text-muted"></i>
                                <strong>Phone:</strong>
                                <span class="ms-2">${safeData.emergency_phone || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Format address
                let addressInfo = '';
                if (safeData.street || safeData.city || safeData.state) {
                    let fullAddress = [];
                    if (safeData.street) fullAddress.push(safeData.street);
                    if (safeData.apt_unit) fullAddress.push(safeData.apt_unit);
                    if (safeData.city || safeData.state || safeData.zip_code) {
                        let cityStateZip = [];
                        if (safeData.city) cityStateZip.push(safeData.city);
                        if (safeData.state) cityStateZip.push(safeData.state);
                        if (safeData.zip_code) cityStateZip.push(safeData.zip_code);
                        fullAddress.push(cityStateZip.join(', '));
                    }
                    addressInfo = `<div class="col-12">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-geo-alt me-2 text-muted mt-1"></i>
                            <div>
                                <strong>Address:</strong>
                                <div class="ms-2">${fullAddress.join(', ')}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                let html = `
                    <div class="container-fluid">
                        <!-- Header Section -->
                        <div class="row mb-4">
                            <div class="col-12 text-center">
                                ${photo}
                                <div class="position-relative d-inline-block">
                                    <i class="bi bi-person-circle text-primary" style="font-size: 4rem;"></i>
                                    <div class="position-absolute top-0 start-100 translate-middle">
                                        <span class="badge bg-success rounded-pill">Active</span>
                                    </div>
                                </div>
                                <h4 class="mt-2 mb-0">${safeData.first_name || ''} ${safeData.last_name || ''}</h4>
                                <p class="text-muted mb-0">Grade ${safeData.grade_level || 'N/A'}</p>
                            </div>
                        </div>

                        <!-- Basic Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-info-circle me-2 text-primary"></i>Basic Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-card-text me-2 text-muted"></i>
                                            <strong>Student ID:</strong>
                                            <span class="ms-2 badge bg-secondary">${safeData.student_id || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-event me-2 text-muted"></i>
                                            <strong>Date of Birth:</strong>
                                            <span class="ms-2">${safeData.dob || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person-badge me-2 text-muted"></i>
                                            <strong>Age:</strong>
                                            <span class="ms-2">${safeData.age || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-star me-2 text-muted"></i>
                                            <strong>GPA:</strong>
                                            <span class="ms-2 badge bg-success">${safeData.gpa || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-envelope me-2 text-muted"></i>
                                            <strong>Email:</strong>
                                            <span class="ms-2">${safeData.email || 'N/A'}</span>
                                        </div>
                                    </div>
                                    ${addressInfo}
                                </div>
                            </div>
                        </div>

                        <!-- Academic Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-book me-2 text-primary"></i>Academic Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-book me-2 text-muted mt-1"></i>
                                            <div>
                                                <strong>Assigned Classes:</strong>
                                                ${classes ? `<ul class="list-group list-group-flush mt-2">${classes}</ul>` : '<p class="text-muted mt-2"><i class="bi bi-info-circle me-2"></i>No classes assigned</p>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${parent1Info ? `
                        <!-- Parent 1 Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-person-heart me-2 text-primary"></i>Parent 1 Information
                                </h6>
                                <div class="row g-3">
                                    ${parent1Info}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        ${parent2Info ? `
                        <!-- Parent 2 Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-person-heart me-2 text-primary"></i>Parent 2 Information
                                </h6>
                                <div class="row g-3">
                                    ${parent2Info}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        ${emergencyInfo ? `
                        <!-- Emergency Contact Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-exclamation-triangle me-2 text-warning"></i>Emergency Contact
                                </h6>
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-person-heart me-2"></i>
                                    ${safeData.emergency_first_name || ''} ${safeData.emergency_last_name || ''} (${safeData.emergency_relationship || 'N/A'})
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('profileViewModalLabel').innerText = 'Student Details';
                document.getElementById('profileViewModalBody').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('profileViewModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching student details:', error);
                alert('Could not load student details.');
            });
    }

    function viewTeacher(teacherId) {
        console.log('viewTeacher called with', teacherId);
        fetch(`/management/view-teacher/${teacherId}`)
            .then(response => response.json())
            .then(data => {
                // Safely handle null/undefined values
                const safeData = {
                    first_name: data.first_name || 'N/A',
                    last_name: data.last_name || 'N/A',
                    age: data.age || 'N/A',
                    dob: data.dob || 'N/A',
                    id: data.id || 'N/A',
                    role: data.role || 'N/A',
                    total_students: data.total_students || 'N/A',
                    username: data.username || 'N/A',
                    emergency_contact: data.emergency_contact || 'N/A',
                    assigned_classes: data.assigned_classes || [],
                    staff_id: data.staff_id || 'N/A',
                    department: data.department || 'N/A',
                    position: data.position || 'N/A',
                    hire_date: data.hire_date || 'N/A',
                    email: data.email || 'N/A',
                    phone: data.phone || 'N/A',
                    address: data.address || 'N/A'
                };
                
                let classes = safeData.assigned_classes.length > 0 
                    ? safeData.assigned_classes.map(c => `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-book me-2"></i>${c.name || 'Unknown'}</span>
                        <span class="badge bg-primary rounded-pill">${c.subject || 'Unknown'}</span>
                      </li>`).join('')
                    : '<li class="list-group-item text-muted"><i class="bi bi-info-circle me-2"></i>No classes assigned</li>';
                    
                let html = `
                    <div class="container-fluid">
                        <!-- Header Section -->
                        <div class="row mb-4">
                            <div class="col-12 text-center">
                                <div class="position-relative d-inline-block">
                                    <i class="bi bi-person-circle text-primary" style="font-size: 4rem;"></i>
                                    <div class="position-absolute top-0 start-100 translate-middle">
                                        <span class="badge bg-success rounded-pill">Active</span>
                                    </div>
                                </div>
                                <h4 class="mt-2 mb-0">${safeData.first_name} ${safeData.last_name}</h4>
                                <p class="text-muted mb-0">${safeData.position || 'Staff Member'}</p>
                            </div>
                        </div>

                        <!-- Basic Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-info-circle me-2 text-primary"></i>Basic Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-card-text me-2 text-muted"></i>
                                            <strong>Staff ID:</strong>
                                            <span class="ms-2 badge bg-secondary">${safeData.staff_id}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person-badge me-2 text-muted"></i>
                                            <strong>Role:</strong>
                                            <span class="ms-2 badge bg-info">${safeData.role}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-building me-2 text-muted mt-1"></i>
                                            <div>
                                                <strong>Department(s):</strong>
                                                <div class="ms-2" id="department-badges">
                                                    ${safeData.department || 'N/A'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-event me-2 text-muted"></i>
                                            <strong>Hire Date:</strong>
                                            <span class="ms-2">${safeData.hire_date}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-envelope me-2 text-primary"></i>Contact Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-envelope me-2 text-muted"></i>
                                            <strong>Email:</strong>
                                            <span class="ms-2">${safeData.email}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-telephone me-2 text-muted"></i>
                                            <strong>Phone:</strong>
                                            <span class="ms-2">${safeData.phone}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person me-2 text-muted"></i>
                                            <strong>Username:</strong>
                                            <span class="ms-2 badge bg-light text-dark">${safeData.username}</span>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-geo-alt me-2 text-muted mt-1"></i>
                                            <div>
                                                <strong>Address:</strong>
                                                <div class="ms-2">${safeData.address}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency Contact Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-exclamation-triangle me-2 text-warning"></i>Emergency Contact
                                </h6>
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-person-heart me-2"></i>
                                    ${safeData.emergency_contact}
                                </div>
                            </div>
                        </div>

                        <!-- Professional Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-briefcase me-2 text-primary"></i>Professional Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-people me-2 text-muted"></i>
                                            <strong>Students:</strong>
                                            <span class="ms-2 badge bg-success">${safeData.total_students}</span>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-book me-2 text-muted mt-1"></i>
                                            <div>
                                                <strong>Assigned Classes:</strong>
                                                <ul class="list-group list-group-flush mt-2">
                                                    ${classes}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('profileViewModalLabel').innerText = `${safeData.first_name} ${safeData.last_name} (Teacher/Staff)`;
                document.getElementById('profileViewModalBody').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('profileViewModal'));
                modal.show();
                
                // Process department badges after modal is shown
                setTimeout(() => {
                    const departmentBadges = document.getElementById('department-badges');
                    if (departmentBadges && safeData.department && safeData.department !== 'N/A') {
                        const departments = safeData.department.split(', ');
                        const badgeHtml = departments.map(dept => 
                            `<span class="badge bg-primary me-1 mb-1">${dept.trim()}</span>`
                        ).join('');
                        departmentBadges.innerHTML = badgeHtml;
                    }
                }, 100);
            })
            .catch(err => {
                console.error('Error fetching teacher:', err);
                alert('Could not load teacher/staff details.');
            });
    }

    function editStudent(studentId) {
        fetch(`/management/view-student/${studentId}`)
            .then(response => response.json())
            .then(data => {
                // Populate the edit modal form fields
                document.getElementById('profileEditModalLabel').innerText = 'Edit Student';
                let form = document.getElementById('profileEditForm');
                let body = document.getElementById('profileEditModalBody');
                body.innerHTML = `
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>First Name</label>
                      <input type='text' class='form-control' name='first_name' value='${data.first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Last Name</label>
                      <input type='text' class='form-control' name='last_name' value='${data.last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Date of Birth</label>
                      <input type='date' class='form-control' name='dob' value='${data.dob || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Grade Level</label>
                      <input type='text' class='form-control' name='grade_level' value='${data.grade_level || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Student ID</label>
                      <input type='text' class='form-control' name='student_id' value='${data.student_id || ''}' disabled>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'><i class='bi bi-envelope me-2'></i>Contact & Authentication</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Personal Email</label>
                      <input type='email' class='form-control' name='email' value='${data.email || ''}' placeholder='student@example.com'>
                      <small class='text-muted'>For parent contact and communications</small>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>
                        Google Workspace Email
                        <i class='bi bi-google text-primary ms-1' title='For Google Sign-In'></i>
                      </label>
                      <input type='email' class='form-control' name='google_workspace_email' value='${data.google_workspace_email || ''}' placeholder='student@clarascienceacademy.org'>
                      <small class='text-muted'>For Google Sign-In authentication</small>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'>Parent Information</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 First Name</label>
                      <input type='text' class='form-control' name='parent1_first_name' value='${data.parent1_first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Last Name</label>
                      <input type='text' class='form-control' name='parent1_last_name' value='${data.parent1_last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Email</label>
                      <input type='email' class='form-control' name='parent1_email' value='${data.parent1_email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Phone</label>
                      <input type='tel' class='form-control' name='parent1_phone' value='${data.parent1_phone || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Relationship</label>
                      <select class='form-control' name='parent1_relationship'>
                        <option value='Mother' ${(data.parent1_relationship || '') === 'Mother' ? 'selected' : ''}>Mother</option>
                        <option value='Father' ${(data.parent1_relationship || '') === 'Father' ? 'selected' : ''}>Father</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 First Name</label>
                      <input type='text' class='form-control' name='parent2_first_name' value='${data.parent2_first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Last Name</label>
                      <input type='text' class='form-control' name='parent2_last_name' value='${data.parent2_last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Email</label>
                      <input type='email' class='form-control' name='parent2_email' value='${data.parent2_email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Phone</label>
                      <input type='tel' class='form-control' name='parent2_phone' value='${data.parent2_phone || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Relationship</label>
                      <select class='form-control' name='parent2_relationship'>
                        <option value='Mother' ${(data.parent2_relationship || '') === 'Mother' ? 'selected' : ''}>Mother</option>
                        <option value='Father' ${(data.parent2_relationship || '') === 'Father' ? 'selected' : ''}>Father</option>
                      </select>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'>Emergency Contact</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact First Name</label>
                      <input type='text' class='form-control' name='emergency_first_name' value='${data.emergency_first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Last Name</label>
                      <input type='text' class='form-control' name='emergency_last_name' value='${data.emergency_last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Email</label>
                      <input type='email' class='form-control' name='emergency_email' value='${data.emergency_email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Phone</label>
                      <input type='tel' class='form-control' name='emergency_phone' value='${data.emergency_phone || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Relationship</label>
                      <select class='form-control' name='emergency_relationship'>
                        <option value='Parent' ${(data.emergency_relationship || '') === 'Parent' ? 'selected' : ''}>Parent</option>
                        <option value='Guardian' ${(data.emergency_relationship || '') === 'Guardian' ? 'selected' : ''}>Guardian</option>
                        <option value='Grandparent' ${(data.emergency_relationship || '') === 'Grandparent' ? 'selected' : ''}>Grandparent</option>
                        <option value='Aunt/Uncle' ${(data.emergency_relationship || '') === 'Aunt/Uncle' ? 'selected' : ''}>Aunt/Uncle</option>
                        <option value='Sibling' ${(data.emergency_relationship || '') === 'Sibling' ? 'selected' : ''}>Sibling</option>
                        <option value='Other' ${(data.emergency_relationship || '') === 'Other' ? 'selected' : ''}>Other</option>
                      </select>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'>Address</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Street Address</label>
                      <input type='text' class='form-control' name='street' value='${data.street || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Apt, Unit, Suite, etc.</label>
                      <input type='text' class='form-control' name='apt_unit' value='${data.apt_unit || ''}'>
                    </div>
                    <div class='col-md-4 mb-3'>
                      <label>City</label>
                      <input type='text' class='form-control' name='city' value='${data.city || ''}'>
                    </div>
                    <div class='col-md-4 mb-3'>
                      <label>State</label>
                      <input type='text' class='form-control' name='state' value='${data.state || ''}'>
                    </div>
                    <div class='col-md-4 mb-3'>
                      <label>Zip Code</label>
                      <input type='text' class='form-control' name='zip_code' value='${data.zip_code || ''}'>
                    </div>
                  </div>
                `;
                form.onsubmit = function(e) {
                  e.preventDefault();
                  let formData = new FormData(form);
                  fetch(`/management/edit-student/${studentId}`, {
                    method: 'POST',
                    body: formData
                  })
                  .then(response => response.json())
                  .then(result => {
                    if (result.success) {
                      location.reload();
                    } else {
                      alert('Error: ' + result.message);
                    }
                  })
                  .catch(() => alert('Could not update student.'));
                };
                var modal = new bootstrap.Modal(document.getElementById('profileEditModal'));
                modal.show();
            })
            .catch(() => alert('Could not load student details.'));
    }

    function editTeacher(teacherId) {
        fetch(`/management/view-teacher/${teacherId}`)
            .then(response => response.json())
            .then(data => {
                // Populate the edit modal form fields
                document.getElementById('profileEditModalLabel').innerText = 'Edit Teacher/Staff';
                let form = document.getElementById('profileEditForm');
                let body = document.getElementById('profileEditModalBody');
                body.innerHTML = `
                    <div class="container-fluid">
                        <!-- Basic Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-info-circle me-2 text-primary"></i>Basic Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="first_name" value="${data.first_name || ''}" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">M.I.</label>
                                        <input type="text" class="form-control" name="middle_initial" value="${data.middle_initial || ''}" maxlength="1">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="last_name" value="${data.last_name || ''}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Date of Birth</label>
                                        <input type="date" class="form-control" name="dob" value="${data.dob || ''}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">SSN</label>
                                        <input type="text" class="form-control" name="staff_ssn" value="${data.staff_ssn || ''}" placeholder="XXX-XX-XXXX">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Personal Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" name="email" value="${data.email || ''}" required>
                                        <small class="text-muted">For personal communications</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Google Workspace Email
                                            <i class="bi bi-google text-primary ms-1" title="For Google Sign-In"></i>
                                        </label>
                                        <input type="email" class="form-control" name="google_workspace_email" value="${data.google_workspace_email || ''}" placeholder="teacher@clarascienceacademy.org">
                                        <small class="text-muted">For Google Sign-In authentication</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" name="phone" value="${data.phone || ''}" placeholder="e.g., 555-123-4567">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-briefcase me-2 text-primary"></i>Professional Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Assigned Role <span class="text-danger">*</span></label>
                                        <select class="form-select" name="assigned_role" required>
                                            <option value="">Choose role...</option>
                                            <option value="Director" ${(data.assigned_role || '') === 'Director' ? 'selected' : ''}>Director</option>
                                            <option value="School Administrator" ${(data.assigned_role || '') === 'School Administrator' ? 'selected' : ''}>School Administrator</option>
                                            <option value="Math Teacher" ${(data.assigned_role || '') === 'Math Teacher' ? 'selected' : ''}>Math Teacher</option>
                                            <option value="Physics Teacher" ${(data.assigned_role || '') === 'Physics Teacher' ? 'selected' : ''}>Physics Teacher</option>
                                            <option value="English Language Arts Teacher" ${(data.assigned_role || '') === 'English Language Arts Teacher' ? 'selected' : ''}>English Language Arts Teacher</option>
                                            <option value="History Teacher" ${(data.assigned_role || '') === 'History Teacher' ? 'selected' : ''}>History Teacher</option>
                                            <option value="Science Teacher" ${(data.assigned_role || '') === 'Science Teacher' ? 'selected' : ''}>Science Teacher</option>
                                            <option value="Substitute Teacher" ${(data.assigned_role || '') === 'Substitute Teacher' ? 'selected' : ''}>Substitute Teacher</option>
                                            <option value="School Counselor" ${(data.assigned_role || '') === 'School Counselor' ? 'selected' : ''}>School Counselor</option>
                                            <option value="IT Support" ${(data.assigned_role || '') === 'IT Support' ? 'selected' : ''}>IT Support</option>
                                            <option value="Other Staff" ${(data.assigned_role || '') === 'Other Staff' ? 'selected' : ''}>Other Staff</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label d-block">Department(s) <span class="text-danger">*</span></label>
                                        <div class="row g-3 px-2">
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Mathematics" id="dept_math_edit" ${(data.department || '').includes('Mathematics') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_math_edit">Mathematics</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Science" id="dept_science_edit" ${(data.department || '').includes('Science') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_science_edit">Science</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="English" id="dept_english_edit" ${(data.department || '').includes('English') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_english_edit">English</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="History & Social Studies" id="dept_history_edit" ${(data.department || '').includes('History & Social Studies') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_history_edit">History & Social Studies</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Physical Education & Health" id="dept_pe_edit" ${(data.department || '').includes('Physical Education & Health') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_pe_edit">Physical Education & Health</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Music & Arts" id="dept_arts_edit" ${(data.department || '').includes('Music & Arts') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_arts_edit">Music & Arts</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Computer Science & Technology" id="dept_tech_edit" ${(data.department || '').includes('Computer Science & Technology') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_tech_edit">Computer Science & Technology</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Administration" id="dept_admin_edit" ${(data.department || '').includes('Administration') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_admin_edit">Administration</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Counseling" id="dept_counsel_edit" ${(data.department || '').includes('Counseling') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_counsel_edit">Counseling</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Special Education" id="dept_sped_edit" ${(data.department || '').includes('Special Education') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_sped_edit">Special Education</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Foreign Language" id="dept_lang_edit" ${(data.department || '').includes('Foreign Language') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_lang_edit">Foreign Language</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="department" value="Business" id="dept_business_edit" ${(data.department || '').includes('Business') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="dept_business_edit">Business</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Position</label>
                                        <input type="text" class="form-control" name="position" value="${data.position || ''}" placeholder="e.g., Lead Teacher, Assistant Principal">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Primary Subject(s) Taught</label>
                                        <input type="text" class="form-control" name="subject" value="${data.subject || ''}" placeholder="e.g., Algebra I, Chemistry">
                                </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Employment Type</label>
                                        <select class="form-select" name="employment_type">
                                            <option value="">Choose...</option>
                                            <option value="Full Time" ${(data.employment_type || '') === 'Full Time' ? 'selected' : ''}>Full Time</option>
                                            <option value="Part Time" ${(data.employment_type || '') === 'Part Time' ? 'selected' : ''}>Part Time</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Hire Date</label>
                                        <input type="date" class="form-control" name="hire_date" value="${data.hire_date || ''}">
                                    </div>
                                </div>
                                
                                <!-- Grades Taught Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="border-bottom pb-2 mb-3">
                                            <i class="bi bi-mortarboard me-2 text-primary"></i>Grades Taught
                                        </h6>
                                        <div class="row g-2 px-2">
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="Kindergarten" id="grade_k_edit" ${(data.grades_taught || '').includes('Kindergarten') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_k_edit">Kindergarten</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="1st" id="grade_1_edit" ${(data.grades_taught || '').includes('1st') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_1_edit">1st</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="2nd" id="grade_2_edit" ${(data.grades_taught || '').includes('2nd') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_2_edit">2nd</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="3rd" id="grade_3_edit" ${(data.grades_taught || '').includes('3rd') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_3_edit">3rd</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="4th" id="grade_4_edit" ${(data.grades_taught || '').includes('4th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_4_edit">4th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="5th" id="grade_5_edit" ${(data.grades_taught || '').includes('5th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_5_edit">5th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="6th" id="grade_6_edit" ${(data.grades_taught || '').includes('6th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_6_edit">6th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="7th" id="grade_7_edit" ${(data.grades_taught || '').includes('7th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_7_edit">7th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="8th" id="grade_8_edit" ${(data.grades_taught || '').includes('8th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_8_edit">8th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="9th" id="grade_9_edit" ${(data.grades_taught || '').includes('9th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_9_edit">9th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="10th" id="grade_10_edit" ${(data.grades_taught || '').includes('10th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_10_edit">10th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="11th" id="grade_11_edit" ${(data.grades_taught || '').includes('11th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_11_edit">11th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="12th" id="grade_12_edit" ${(data.grades_taught || '').includes('12th') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_12_edit">12th</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="grades_taught" value="N/A - Staff" id="grade_na_edit" ${(data.grades_taught || '').includes('N/A - Staff') ? 'checked' : ''}>
                                                    <label class="form-check-label" for="grade_na_edit">N/A - Staff</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Address Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-geo-alt me-2 text-primary"></i>Address Information
                                </h6>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">Street Address</label>
                                        <input type="text" class="form-control" name="street_address" value="${data.street || ''}" placeholder="123 Main Street">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Apt, Unit, Suite, etc.</label>
                                        <input type="text" class="form-control" name="apt_unit_suite" value="${data.apt_unit || ''}" placeholder="Apt 4B">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" name="city" value="${data.city || ''}" placeholder="Springfield">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">State</label>
                                        <select class="form-select" name="state">
                                            <option value="">Choose state...</option>
                                            <option value="AL" ${(data.state || '') === 'AL' ? 'selected' : ''}>Alabama</option>
                                            <option value="AK" ${(data.state || '') === 'AK' ? 'selected' : ''}>Alaska</option>
                                            <option value="AZ" ${(data.state || '') === 'AZ' ? 'selected' : ''}>Arizona</option>
                                            <option value="AR" ${(data.state || '') === 'AR' ? 'selected' : ''}>Arkansas</option>
                                            <option value="CA" ${(data.state || '') === 'CA' ? 'selected' : ''}>California</option>
                                            <option value="CO" ${(data.state || '') === 'CO' ? 'selected' : ''}>Colorado</option>
                                            <option value="CT" ${(data.state || '') === 'CT' ? 'selected' : ''}>Connecticut</option>
                                            <option value="DE" ${(data.state || '') === 'DE' ? 'selected' : ''}>Delaware</option>
                                            <option value="FL" ${(data.state || '') === 'FL' ? 'selected' : ''}>Florida</option>
                                            <option value="GA" ${(data.state || '') === 'GA' ? 'selected' : ''}>Georgia</option>
                                            <option value="HI" ${(data.state || '') === 'HI' ? 'selected' : ''}>Hawaii</option>
                                            <option value="ID" ${(data.state || '') === 'ID' ? 'selected' : ''}>Idaho</option>
                                            <option value="IL" ${(data.state || '') === 'IL' ? 'selected' : ''}>Illinois</option>
                                            <option value="IN" ${(data.state || '') === 'IN' ? 'selected' : ''}>Indiana</option>
                                            <option value="IA" ${(data.state || '') === 'IA' ? 'selected' : ''}>Iowa</option>
                                            <option value="KS" ${(data.state || '') === 'KS' ? 'selected' : ''}>Kansas</option>
                                            <option value="KY" ${(data.state || '') === 'KY' ? 'selected' : ''}>Kentucky</option>
                                            <option value="LA" ${(data.state || '') === 'LA' ? 'selected' : ''}>Louisiana</option>
                                            <option value="ME" ${(data.state || '') === 'ME' ? 'selected' : ''}>Maine</option>
                                            <option value="MD" ${(data.state || '') === 'MD' ? 'selected' : ''}>Maryland</option>
                                            <option value="MA" ${(data.state || '') === 'MA' ? 'selected' : ''}>Massachusetts</option>
                                            <option value="MI" ${(data.state || '') === 'MI' ? 'selected' : ''}>Michigan</option>
                                            <option value="MN" ${(data.state || '') === 'MN' ? 'selected' : ''}>Minnesota</option>
                                            <option value="MS" ${(data.state || '') === 'MS' ? 'selected' : ''}>Mississippi</option>
                                            <option value="MO" ${(data.state || '') === 'MO' ? 'selected' : ''}>Missouri</option>
                                            <option value="MT" ${(data.state || '') === 'MT' ? 'selected' : ''}>Montana</option>
                                            <option value="NE" ${(data.state || '') === 'NE' ? 'selected' : ''}>Nebraska</option>
                                            <option value="NV" ${(data.state || '') === 'NV' ? 'selected' : ''}>Nevada</option>
                                            <option value="NH" ${(data.state || '') === 'NH' ? 'selected' : ''}>New Hampshire</option>
                                            <option value="NJ" ${(data.state || '') === 'NJ' ? 'selected' : ''}>New Jersey</option>
                                            <option value="NM" ${(data.state || '') === 'NM' ? 'selected' : ''}>New Mexico</option>
                                            <option value="NY" ${(data.state || '') === 'NY' ? 'selected' : ''}>New York</option>
                                            <option value="NC" ${(data.state || '') === 'NC' ? 'selected' : ''}>North Carolina</option>
                                            <option value="ND" ${(data.state || '') === 'ND' ? 'selected' : ''}>North Dakota</option>
                                            <option value="OH" ${(data.state || '') === 'OH' ? 'selected' : ''}>Ohio</option>
                                            <option value="OK" ${(data.state || '') === 'OK' ? 'selected' : ''}>Oklahoma</option>
                                            <option value="OR" ${(data.state || '') === 'OR' ? 'selected' : ''}>Oregon</option>
                                            <option value="PA" ${(data.state || '') === 'PA' ? 'selected' : ''}>Pennsylvania</option>
                                            <option value="RI" ${(data.state || '') === 'RI' ? 'selected' : ''}>Rhode Island</option>
                                            <option value="SC" ${(data.state || '') === 'SC' ? 'selected' : ''}>South Carolina</option>
                                            <option value="SD" ${(data.state || '') === 'SD' ? 'selected' : ''}>South Dakota</option>
                                            <option value="TN" ${(data.state || '') === 'TN' ? 'selected' : ''}>Tennessee</option>
                                            <option value="TX" ${(data.state || '') === 'TX' ? 'selected' : ''}>Texas</option>
                                            <option value="UT" ${(data.state || '') === 'UT' ? 'selected' : ''}>Utah</option>
                                            <option value="VT" ${(data.state || '') === 'VT' ? 'selected' : ''}>Vermont</option>
                                            <option value="VA" ${(data.state || '') === 'VA' ? 'selected' : ''}>Virginia</option>
                                            <option value="WA" ${(data.state || '') === 'WA' ? 'selected' : ''}>Washington</option>
                                            <option value="WV" ${(data.state || '') === 'WV' ? 'selected' : ''}>West Virginia</option>
                                            <option value="WI" ${(data.state || '') === 'WI' ? 'selected' : ''}>Wisconsin</option>
                                            <option value="WY" ${(data.state || '') === 'WY' ? 'selected' : ''}>Wyoming</option>
                                            <option value="DC" ${(data.state || '') === 'DC' ? 'selected' : ''}>District of Columbia</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Zip Code</label>
                                        <input type="text" class="form-control" name="zip_code" value="${data.zip_code || ''}" placeholder="62701">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency Contact Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-exclamation-triangle me-2 text-warning"></i>Emergency Contact
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="emergency_contact_name" value="${data.emergency_first_name || ''}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="emergency_contact_last_name" value="${data.emergency_last_name || ''}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Relationship</label>
                                        <select class="form-select" name="emergency_contact_relationship">
                                            <option value="">Choose relationship...</option>
                                            <option value="Spouse" ${(data.emergency_relationship || '') === 'Spouse' ? 'selected' : ''}>Spouse</option>
                                            <option value="Parent" ${(data.emergency_relationship || '') === 'Parent' ? 'selected' : ''}>Parent</option>
                                            <option value="Sibling" ${(data.emergency_relationship || '') === 'Sibling' ? 'selected' : ''}>Sibling</option>
                                            <option value="Partner" ${(data.emergency_relationship || '') === 'Partner' ? 'selected' : ''}>Partner</option>
                                            <option value="Friend" ${(data.emergency_relationship || '') === 'Friend' ? 'selected' : ''}>Friend</option>
                                            <option value="Other" ${(data.emergency_relationship || '') === 'Other' ? 'selected' : ''}>Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" name="emergency_contact_phone" value="${data.emergency_phone || ''}" required placeholder="e.g., 555-123-4567">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" name="emergency_contact_email" value="${data.emergency_email || ''}" placeholder="emergency@example.com">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                form.onsubmit = function(e) {
                    e.preventDefault();
                    let formData = new FormData(form);
                    fetch(`/management/edit-teacher-staff/${teacherId}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + result.message);
                        }
                    })
                    .catch(() => alert('Could not update teacher/staff.'));
                };
                var modal = new bootstrap.Modal(document.getElementById('profileEditModal'));
                modal.show();
            })
            .catch(() => alert('Could not load teacher details.'));
    }

    function removeTeacher(teacherId, teacherName) {
        if (confirm(`Are you sure you want to remove ${teacherName}? This action cannot be undone.`)) {
            fetch(`/management/remove-teacher-staff/${teacherId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error removing teacher/staff member.');
                }
            })
            .catch(() => alert('Could not remove teacher/staff member.'));
        }
    }

    function removeStudent(studentId, studentName) {
        if (confirm(`Are you sure you want to remove ${studentName}? This action cannot be undone.`)) {
            // Create a form and submit it to match the route's expectations
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/management/remove-student/${studentId}`;
            
            // Add CSRF token
            const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                             document.querySelector('input[name=csrf_token]')?.value;
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // Enhanced Search JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.querySelector('form[action*="students"]');
        if (searchForm) {
            const filterSelects = searchForm.querySelectorAll('select[name="search_type"], select[name="grade_level"], select[name="status"], select[name="sort"], select[name="order"]');
            
            filterSelects.forEach(select => {
                select.addEventListener('change', function() {
                    searchForm.submit();
                });
            });
            
            // Add search suggestions
            const searchInput = document.getElementById('search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        this.style.borderColor = '#28a745';
                    } else {
                        this.style.borderColor = '';
                    }
                });
            }
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                const searchInput = document.getElementById('search');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            
            // Escape to clear search
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('search');
                if (searchInput && searchInput.value) {
                    searchInput.value = '';
                    const searchForm = document.querySelector('form[action*="students"]');
                    if (searchForm) {
                        searchForm.submit();
                    }
                }
            }
        });
    });
    </script>
    {% endraw %}

    <!-- Enhanced Teacher Search JavaScript -->
    {% if section == 'teachers' %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const teacherSearchForm = document.getElementById('teacherSearchForm');
        const searchInput = document.getElementById('search');
        const searchTypeSelect = document.getElementById('search_type');
        const departmentSelect = document.getElementById('department');
        const roleSelect = document.getElementById('role');
        const employmentSelect = document.getElementById('employment');
        const sortSelect = document.getElementById('sort');
        const orderSelect = document.getElementById('order');

        // Auto-submit form when filter dropdowns change
        [searchTypeSelect, departmentSelect, roleSelect, employmentSelect, sortSelect, orderSelect].forEach(element => {
            if (element) {
                element.addEventListener('change', function() {
                    teacherSearchForm.submit();
                });
            }
        });

        // Visual feedback for search input
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    this.style.borderColor = '#28a745';
                    this.style.borderWidth = '2px';
                } else {
                    this.style.borderColor = '';
                    this.style.borderWidth = '';
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + F to focus search input
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Escape to clear search and re-submit
            if (e.key === 'Escape') {
                if (searchInput && searchInput.value) {
                    searchInput.value = '';
                    const teacherSearchForm = document.querySelector('form[action*="teachers"]');
                    if (teacherSearchForm) {
                        teacherSearchForm.submit();
                    }
                }
            }
        });
    });
    </script>
    {% endif %}

    <!-- Enhanced Dashboard JavaScript -->
    <script>
    // Real-time clock functionality
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }

    // Update time immediately and then every second
    updateTime();
    setInterval(updateTime, 1000);

    // Add smooth animations to stats cards
    document.addEventListener('DOMContentLoaded', function() {
        const statsCards = document.querySelectorAll('.stats-card');
        
        // Animate cards on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, index * 100);
                }
            });
        }, { threshold: 0.1 });
        
        statsCards.forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s ease';
            observer.observe(card);
        });
    });
    </script>

    <!-- Custom CSS for Admin Home Dashboard -->
    

    <!-- JavaScript for Students Tab -->
    <script>
    // Store current student ID for edit operations
    let currentStudentId = null;

    function switchStudentsView(view) {
        const tableView = document.getElementById('tableView');
        const cardsView = document.getElementById('cardsView');
        const buttons = document.querySelectorAll('.btn-students-view');
        
        if (view === 'table') {
            tableView.style.display = 'block';
            cardsView.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
        } else {
            tableView.style.display = 'none';
            cardsView.style.display = 'block';
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
        }
    }

    // View, Edit, and Remove Student functions are defined earlier in the script
    // Removed duplicate definitions

    // Switch Teachers View Function
    function switchTeachersView(view) {
        const tableView = document.getElementById('teachersTableView');
        const cardsView = document.getElementById('teachersCardsView');
        const buttons = document.querySelectorAll('.btn-teachers-view');
        
        if (view === 'table') {
            tableView.style.display = 'block';
            cardsView.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
        } else {
            tableView.style.display = 'none';
            cardsView.style.display = 'block';
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
        }
    }

    // (Duplicate placeholder teacher actions removed; real implementations are defined earlier in this file.)

    // Switch Assignments View Function
    function switchAssignmentsView(view) {
        const tableView = document.getElementById('assignmentsTableView');
        const cardsView = document.getElementById('assignmentsCardsView');
        const buttons = document.querySelectorAll('.btn-assignments-view');
        
        if (view === 'table') {
            tableView.style.display = 'block';
            cardsView.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
        } else {
            tableView.style.display = 'none';
            cardsView.style.display = 'block';
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
        }
    }
    </script>

{% if at_risk_alerts %}
<!-- Bottom-right notification toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
  <div id="academicAlertToast" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
    <div class="toast-header bg-warning text-dark">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong class="me-auto">Academic Alert</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      <p class="mb-2">
        <strong>{{ at_risk_alerts|length }} student{% if at_risk_alerts|length != 1 %}s{% endif %}</strong> 
        {% if at_risk_alerts|length == 1 %}is raising{% else %}are raising{% endif %} flags for academic concern.
      </p>
      <button type="button" class="btn btn-primary btn-sm w-100" onclick="showAcademicDetailsModal()">
        <i class="bi bi-info-circle me-1"></i>View Details
      </button>
    </div>
  </div>
</div>

<!-- Detailed Academic Concerns Modal -->
<div class="modal fade" id="academicDetailsModal" tabindex="-1" aria-labelledby="academicDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content academic-concerns-modal">
      <div class="modal-header academic-concerns-header">
        <div class="academic-concerns-header-content">
          <div class="academic-concerns-icon-circle">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <div>
            <h5 class="modal-title mb-1" id="academicDetailsModalLabel">
              Student Academic Concerns
            </h5>
            <p class="academic-concerns-subtitle mb-0">Review and address student performance issues</p>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body academic-concerns-body">
        <!-- Concerns Toolbar -->
        <div class="concerns-toolbar mb-4">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="concerns-search">
                <i class="bi bi-search search-icon-concerns"></i>
                <input type="text" 
                       id="concernsSearchInput" 
                       class="form-control concerns-search-input" 
                       placeholder="Search by student name, class, or assignment..."
                       oninput="filterConcerns()">
              </div>
            </div>
            <div class="col-md-3">
              <select class="form-select concerns-filter" id="concernsTypeFilter" onchange="filterConcerns()">
                <option value="">All Alert Types</option>
                <option value="failing">Failing Only</option>
                <option value="missing">Missing Only</option>
                <option value="overdue">Overdue Only</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select concerns-filter" id="concernsGPAFilter" onchange="filterConcerns()">
                <option value="">All GPAs</option>
                <option value="critical">Critical (&lt;2.0)</option>
                <option value="warning">Warning (2.0-2.9)</option>
                <option value="low">Below 3.0</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select concerns-filter" id="concernsSortOrder" onchange="filterConcerns()">
                <option value="student-asc">Student Name (A-Z)</option>
                <option value="student-desc">Student Name (Z-A)</option>
                <option value="gpa-asc">GPA (Low to High)</option>
                <option value="gpa-desc">GPA (High to Low)</option>
                <option value="assignments-desc">Most Assignments First</option>
              </select>
            </div>
          </div>
          <div class="concerns-stats mt-3">
            <span class="concerns-count-badge">
              <i class="bi bi-exclamation-triangle-fill me-1"></i>
              <span id="visibleConcernsCount">{{ at_risk_alerts|length }}</span> of {{ at_risk_alerts|length }} students shown
            </span>
            <button class="btn btn-sm btn-concerns-reset" onclick="resetConcernsFilters()">
              <i class="bi bi-arrow-clockwise me-1"></i>Reset Filters
            </button>
          </div>
        </div>

        <!-- Students List -->
        <div class="concerns-students-container" id="concernsStudentsContainer">
          {% for alert in at_risk_alerts %}
          <div class="academic-concern-card" 
               data-student-id="{{ alert.student_user_id }}"
               data-student-name="{{ alert.student_name }}"
               data-alert-type="{{ alert.alert_reason.lower() }}">
            <div class="academic-concern-header">
              <div class="d-flex align-items-center gap-3">
                <div class="academic-concern-avatar">
                  {{ alert.student_name[0] if alert.student_name else '?' }}
                </div>
                <div class="flex-grow-1">
                  <h5 class="academic-concern-name mb-1">{{ alert.student_name }}</h5>
                  <div class="academic-concern-badges">
                    <span class="academic-concern-badge badge-{{ 'danger' if 'failing' in alert.alert_reason.lower() else 'warning' }}">
                      <i class="bi bi-{{ 'exclamation-octagon' if 'failing' in alert.alert_reason.lower() else 'exclamation-triangle' }}-fill me-1"></i>
                      {{ alert.alert_reason|title }}
                    </span>
                  </div>
                </div>
                <button class="btn-dismiss-student" 
                        onclick="dismissStudentConcern({{ alert.student_user_id }})"
                        title="Dismiss this student's concerns">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
            <div class="academic-concern-body">
              <div id="student-details-{{ alert.student_user_id }}" class="student-details-placeholder">
                <div class="loading-container">
                  <div class="loading-spinner"></div>
                  <p class="loading-text">Loading student details...</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- No Results Message -->
        <div id="noConcernsMessage" class="no-concerns-filtered" style="display: none;">
          <i class="bi bi-filter-circle"></i>
          <h5>No students match your filters</h5>
          <p>Try adjusting your search criteria or reset filters</p>
          <button class="btn btn-primary" onclick="resetConcernsFilters()">
            <i class="bi bi-arrow-clockwise me-2"></i>Reset Filters
          </button>
        </div>
      </div>
      <div class="modal-footer academic-concerns-footer">
        <button type="button" class="btn btn-academic-close" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function showAcademicDetailsModal() {
    // Close the toast
    var toastElement = document.getElementById('academicAlertToast');
    var toast = bootstrap.Toast.getInstance(toastElement);
    if (toast) {
      toast.hide();
    }
    
    // Show the detailed modal
    var modal = new bootstrap.Modal(document.getElementById('academicDetailsModal'));
    modal.show();
    
    // Load detailed student information for each alert
    {% for alert in at_risk_alerts %}
    loadStudentAcademicDetails({{ alert.student_user_id }});
    {% endfor %}
  }
  
  function loadStudentAcademicDetails(studentId) {
    // Fetch detailed student information via AJAX
    fetch(`/management/student/${studentId}/details/data`)
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById(`student-details-${studentId}`);
        if (data.success) {
          container.innerHTML = formatStudentDetails(data.student);
        } else {
          container.innerHTML = '<div class="alert alert-danger">Error loading student details.</div>';
        }
      })
      .catch(error => {
        console.error('Error loading student details:', error);
        const container = document.getElementById(`student-details-${studentId}`);
        container.innerHTML = '<div class="alert alert-danger">Error loading student details.</div>';
      });
  }
  
  function formatStudentDetails(student) {
    let html = '<div class="academic-details-container">';
    
    // Overall GPA Summary with modern cards
    html += '<div class="gpa-summary-section">';
    html += '<div class="gpa-summary-header">';
    html += '<i class="bi bi-graph-up-arrow"></i>';
    html += '<h6>Academic Performance Overview</h6>';
    html += '</div>';
    html += '<div class="gpa-cards-grid">';
    
    // Current GPA Card
    html += '<div class="gpa-stat-card gpa-current">';
    html += '<div class="gpa-stat-icon"><i class="bi bi-trophy"></i></div>';
    html += '<div class="gpa-stat-content">';
    html += '<div class="gpa-stat-label">Current GPA</div>';
    html += `<div class="gpa-stat-value">${student.current_gpa !== null ? student.current_gpa.toFixed(2) : 'N/A'}</div>`;
    html += '</div></div>';
    
    // Potential GPA Card
    html += '<div class="gpa-stat-card gpa-potential">';
    html += '<div class="gpa-stat-icon"><i class="bi bi-star-fill"></i></div>';
    html += '<div class="gpa-stat-content">';
    html += '<div class="gpa-stat-label">Potential GPA</div>';
    html += `<div class="gpa-stat-value gpa-potential-value">${student.hypothetical_gpa !== null ? student.hypothetical_gpa.toFixed(2) : 'N/A'}</div>';`;
    html += '<div class="gpa-stat-note">If issues resolved</div>';
    html += '</div></div>';
    
    // GPA Improvement
    if (student.current_gpa && student.hypothetical_gpa) {
      const improvement = (student.hypothetical_gpa - student.current_gpa).toFixed(2);
      html += '<div class="gpa-stat-card gpa-improvement">';
      html += '<div class="gpa-stat-icon"><i class="bi bi-arrow-up-circle-fill"></i></div>';
      html += '<div class="gpa-stat-content">';
      html += '<div class="gpa-stat-label">Potential Gain</div>';
      html += `<div class="gpa-stat-value gpa-gain-value">+${improvement}</div>`;
      html += '<div class="gpa-stat-note">Points possible</div>';
      html += '</div></div>';
    }
    
    html += '</div></div>';
    
    // Missing & Failing Assignments by Class
    html += '<div class="assignments-section">';
    html += '<div class="assignments-section-header">';
    html += '<i class="bi bi-exclamation-diamond-fill"></i>';
    html += '<h6>Assignments Requiring Attention</h6>';
    html += '</div>';
    
    if (student.missing_assignments && Object.keys(student.missing_assignments).length > 0) {
      for (const [className, assignments] of Object.entries(student.missing_assignments)) {
        html += '<div class="class-assignments-group">';
        html += `<div class="class-name-header">${className}</div>`;
        
        // Class GPA indicator
        if (student.class_gpa && student.class_gpa[className]) {
          const classGpa = student.class_gpa[className];
          html += '<div class="class-gpa-indicator">';
          html += '<span class="class-gpa-label">Class GPA:</span>';
          html += `<span class="class-gpa-current">${classGpa.current !== null ? classGpa.current.toFixed(2) : 'N/A'}</span>`;
          if (classGpa.hypothetical !== null) {
            html += '<i class="bi bi-arrow-right mx-2"></i>';
            html += `<span class="class-gpa-potential">${classGpa.hypothetical.toFixed(2)}</span>`;
            html += '<span class="class-gpa-badge">potential</span>';
          }
          html += '</div>';
        }
        
        // Assignment cards
        html += '<div class="assignment-cards-grid">';
        assignments.forEach((assignment, idx) => {
          const isFailing = assignment.score !== null && assignment.score <= 69;
          const isMissing = assignment.status === 'missing';
          const assignmentId = `assignment-${student.student_id || 'unknown'}-${className.replace(/\s+/g, '-')}-${idx}`;
          
                          html += `<div class="assignment-concern-card ${isFailing ? 'card-failing' : 'card-warning'}" id="${assignmentId}">`;
                          html += '<div class="assignment-concern-header">';
                          html += `<div class="assignment-concern-icon ${isFailing ? 'icon-danger' : 'icon-warning'}">`;
                          html += `<i class="bi bi-${isFailing ? 'x-circle' : 'exclamation-circle'}-fill"></i>`;
                          html += '</div>';
                          html += '<div class="assignment-concern-info">';
                          html += `<div class="assignment-concern-title">${assignment.title}</div>`;
                          html += `<div class="assignment-concern-due">`;
                          html += `<i class="bi bi-calendar-event"></i> Due: ${assignment.due_date}`;
                          html += '</div></div>';
                          html += '<div class="d-flex gap-1">';
                          // Add Quick Redo button for PDF/Paper assignments
                          if (assignment.assignment_type && (assignment.assignment_type.toLowerCase() === 'pdf' || assignment.assignment_type.toLowerCase() === 'paper')) {
                            html += `<button class="btn btn-sm btn-warning" onclick="quickGrantRedo(${student.student_id}, ${assignment.assignment_id}, '${assignment.title}')" title="Grant Redo Opportunity">`;
                            html += '<i class="bi bi-arrow-repeat"></i>';
                            html += '</button>';
                          }
                          html += `<button class="btn-dismiss-assignment" onclick="dismissAssignment('${assignmentId}')" title="Dismiss this assignment">`;
                          html += '<i class="bi bi-x-lg"></i>';
                          html += '</button>';
                          html += '</div>';
                          html += '</div>';
          
          html += '<div class="assignment-concern-footer">';
          if (assignment.status) {
            html += `<span class="assignment-status-pill status-${assignment.status}">`;
            html += `<i class="bi bi-${assignment.status === 'missing' ? 'dash-circle' : 'exclamation-triangle'}-fill"></i>`;
            html += `${assignment.status}`;
            html += '</span>';
          }
          if (assignment.score !== null && assignment.score !== undefined) {
            html += `<span class="assignment-score-badge ${assignment.score <= 69 ? 'score-failing' : 'score-warning'}">`;
            html += `${assignment.score}%`;
            html += '</span>';
          } else {
            html += '<span class="assignment-score-badge score-missing">Not Graded</span>';
          }
          html += '</div></div>';
        });
        html += '</div></div>';
      }
    } else {
      html += '<div class="no-concerns-message">';
      html += '<i class="bi bi-check-circle-fill"></i>';
      html += '<p>No missing or failing assignments found!</p>';
      html += '</div>';
    }
    
    html += '</div></div>';
    
    return html;
  }
  
  // Dismiss individual assignment from concerns
  function dismissAssignment(assignmentId) {
    const assignmentCard = document.getElementById(assignmentId);
    if (assignmentCard && confirm('Are you sure you want to dismiss this assignment concern?')) {
      assignmentCard.style.animation = 'fadeOutRight 0.5s ease-out';
      setTimeout(() => {
        assignmentCard.remove();
        checkEmptyAssignments();
      }, 500);
    }
  }
  
  // Quick Grant Redo from Academic Concerns
  function quickGrantRedo(studentId, assignmentId, assignmentTitle) {
    const deadline = prompt(`Grant redo for "${assignmentTitle}"?\n\nEnter redo deadline (YYYY-MM-DD):`);
    
    if (!deadline) return;
    
    // Validate date format
    if (!/^\d{4}-\d{2}-\d{2}$/.test(deadline)) {
      alert('Invalid date format. Please use YYYY-MM-DD (e.g., 2025-11-20)');
      return;
    }
    
    const reason = prompt('Reason for redo (optional):') || 'Redo granted from Academic Concerns';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('student_ids[]', studentId);
    formData.append('redo_deadline', deadline);
    formData.append('reason', reason);
    formData.append('csrf_token', '{{ csrf_token() }}');
    
    // Send request
    fetch(`/management/grant-redo/${assignmentId}`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('âœ… ' + data.message + '\n\nStudent will be notified of this redo opportunity.');
        // Optionally dismiss the assignment from concerns
        const assignmentCard = document.querySelector(`[id*="assignment-${studentId}"]`);
        if (assignmentCard && confirm('Dismiss this assignment from concerns list?')) {
          assignmentCard.remove();
        }
      } else {
        alert('âŒ Error: ' + data.message);
      }
    })
    .catch(error => {
      alert('âŒ Error granting redo: ' + error);
    });
  }
  
  // Dismiss entire student concern
  function dismissStudentConcern(studentId) {
    const studentCard = document.querySelector(`[data-student-id="${studentId}"]`);
    if (studentCard && confirm('Are you sure you want to dismiss all concerns for this student?')) {
      studentCard.style.animation = 'fadeOutRight 0.5s ease-out';
      setTimeout(() => {
        studentCard.remove();
        updateConcernsCount();
      }, 500);
    }
  }
  
  // Check if all assignments in a section are dismissed
  function checkEmptyAssignments() {
    const assignmentGrids = document.querySelectorAll('.assignment-cards-grid');
    assignmentGrids.forEach(grid => {
      if (grid.children.length === 0) {
        const classGroup = grid.closest('.class-assignments-group');
        if (classGroup) {
          classGroup.innerHTML = '<div class="all-resolved-message"><i class="bi bi-check-circle-fill"></i> All assignments in this class have been addressed!</div>';
        }
      }
    });
  }
  
  // Filter concerns based on search, type, GPA, and sort
  function filterConcerns() {
    const searchTerm = document.getElementById('concernsSearchInput').value.toLowerCase();
    const typeFilter = document.getElementById('concernsTypeFilter').value;
    const gpaFilter = document.getElementById('concernsGPAFilter').value;
    const sortOrder = document.getElementById('concernsSortOrder').value;
    
    const studentCards = Array.from(document.querySelectorAll('.academic-concern-card'));
    let visibleCount = 0;
    
    // Filter and collect visible cards
    const visibleCards = [];
    studentCards.forEach(card => {
      const studentName = card.getAttribute('data-student-name').toLowerCase();
      const alertType = card.getAttribute('data-alert-type');
      let shouldShow = true;
      
      // Search filter
      if (searchTerm) {
        const detailsDiv = card.querySelector('.student-details-placeholder');
        const detailsText = detailsDiv ? detailsDiv.textContent.toLowerCase() : '';
        if (!studentName.includes(searchTerm) && !detailsText.includes(searchTerm)) {
          shouldShow = false;
        }
      }
      
      // Type filter
      if (typeFilter) {
        if (!alertType.includes(typeFilter)) {
          shouldShow = false;
        }
      }
      
      // Show/hide card
      if (shouldShow) {
        card.style.display = 'block';
        visibleCards.push(card);
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });
    
    // Sort visible cards
    if (sortOrder && visibleCards.length > 0) {
      sortStudentCards(visibleCards, sortOrder);
    }
    
    // Update count
    document.getElementById('visibleConcernsCount').textContent = visibleCount;
    
    // Show/hide no results message
    const noResultsMsg = document.getElementById('noConcernsMessage');
    const container = document.getElementById('concernsStudentsContainer');
    if (visibleCount === 0) {
      noResultsMsg.style.display = 'block';
      container.style.display = 'none';
    } else {
      noResultsMsg.style.display = 'none';
      container.style.display = 'block';
    }
  }
  
  // Sort student cards
  function sortStudentCards(cards, order) {
    const container = document.getElementById('concernsStudentsContainer');
    
    cards.sort((a, b) => {
      const nameA = a.getAttribute('data-student-name');
      const nameB = b.getAttribute('data-student-name');
      
      if (order === 'student-asc') {
        return nameA.localeCompare(nameB);
      } else if (order === 'student-desc') {
        return nameB.localeCompare(nameA);
      }
      // More complex sorts would require additional data attributes
      return 0;
    });
    
    // Reorder in DOM
    cards.forEach(card => {
      container.appendChild(card);
    });
  }
  
  // Reset all filters
  function resetConcernsFilters() {
    document.getElementById('concernsSearchInput').value = '';
    document.getElementById('concernsTypeFilter').value = '';
    document.getElementById('concernsGPAFilter').value = '';
    document.getElementById('concernsSortOrder').value = 'student-asc';
    filterConcerns();
  }
  
  // Update concerns count after dismissal
  function updateConcernsCount() {
    const visibleCards = document.querySelectorAll('.academic-concern-card[style*="display: block"], .academic-concern-card:not([style*="display: none"])');
    const totalCards = document.querySelectorAll('.academic-concern-card');
    document.getElementById('visibleConcernsCount').textContent = visibleCards.length;
  }
</script>


{% endif %}
{% endblock %} 