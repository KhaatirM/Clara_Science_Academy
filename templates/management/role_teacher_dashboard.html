{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management_role_teacher_dashboard.css') }}">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <!-- DEBUG: Current section is "{{ section }}" -->
    {% if section == 'home' %}
        <!-- Home Dashboard -->
        <!-- Welcome Header -->
        <div class="home-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="home-title mb-1">
                        <i class="bi bi-house-heart-fill me-2"></i>Welcome Back, {{ teacher.first_name if teacher else current_user.username }}!
                    </h2>
                    <p class="home-subtitle mb-0">
                        <i class="bi bi-calendar3 me-2"></i>Today's Dashboard
                    </p>
                </div>
                <div class="home-role-badge">
                    {% if is_admin %}
                    <span class="badge badge-home-admin"><i class="bi bi-shield-fill me-1"></i>Administrator</span>
                    {% else %}
                    <span class="badge badge-home-teacher"><i class="bi bi-mortarboard-fill me-1"></i>Teacher</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="home-stat-card home-stat-primary">
                    <div class="home-stat-icon">
                        <i class="bi bi-house-door-fill"></i>
                    </div>
                    <div class="home-stat-content">
                        <div class="home-stat-value">{{ classes|length if classes else 0 }}</div>
                        <div class="home-stat-label">My Classes</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="home-stat-card home-stat-success">
                    <div class="home-stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="home-stat-content">
                        <div class="home-stat-value">{{ total_students if total_students else 0 }}</div>
                        <div class="home-stat-label">Total Students</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="home-stat-card home-stat-warning">
                    <div class="home-stat-icon">
                        <i class="bi bi-journal-text"></i>
                    </div>
                    <div class="home-stat-content">
                        <div class="home-stat-value">{{ active_assignments if active_assignments else 0 }}</div>
                        <div class="home-stat-label">Active Assignments</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="home-stat-card home-stat-info">
                    <div class="home-stat-icon">
                        <i class="bi bi-bell-fill"></i>
                    </div>
                    <div class="home-stat-content">
                        <div class="home-stat-value">{{ notifications|length if notifications else 0 }}</div>
                        <div class="home-stat-label">Notifications</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left Column -->
            <div class="col-12 col-lg-4">
                <!-- Profile Card -->
                <div class="home-profile-card mb-4">
                    <div class="home-profile-header">
                        <div class="home-profile-avatar">
                            {% if teacher %}
                            {{ teacher.first_name[0] }}{{ teacher.last_name[0] }}
                            {% else %}
                            {{ current_user.username[0]|upper }}
                            {% endif %}
                        </div>
                        <div class="home-profile-info">
                            <h5 class="home-profile-name mb-1">
                                {% if teacher %}
                                {{ teacher.first_name }} {{ teacher.last_name }}
                                {% else %}
                                {{ current_user.username }}
                                {% endif %}
                            </h5>
                            <p class="home-profile-role mb-0">
                                <i class="bi bi-briefcase me-1"></i>{{ current_user.role }}
                            </p>
                        </div>
                    </div>
                    <div class="home-profile-body">
                        {% if teacher %}
                        <div class="home-profile-item">
                            <i class="bi bi-envelope"></i>
                            <span>{{ teacher.email or 'N/A' }}</span>
                        </div>
                        <div class="home-profile-item">
                            <i class="bi bi-telephone"></i>
                            <span>{{ teacher.phone or 'N/A' }}</span>
                        </div>
                        {% endif %}
                        <div class="home-profile-item">
                            <i class="bi bi-house-door"></i>
                            <span>{{ classes|length }} Assigned Classes</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="home-quick-actions mb-4">
                    <h6 class="home-quick-actions-title">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions
                    </h6>
                    <div class="home-quick-actions-grid">
                        <a href="{{ url_for('teacher.dashboard.my_classes') }}" class="home-quick-action home-qa-classes">
                            <div class="home-qa-icon">
                                <i class="bi bi-house-door-fill"></i>
                            </div>
                            <span>My Classes</span>
                        </a>
                        <a href="{{ url_for('teacher.dashboard.assignments_and_grades') }}" class="home-quick-action home-qa-assignments">
                            <div class="home-qa-icon">
                                <i class="bi bi-journal-check"></i>
                            </div>
                            <span>Assignments</span>
                        </a>
                        <a href="{{ url_for('teacher.grading.my_grades') }}" class="home-quick-action home-qa-grades">
                            <div class="home-qa-icon">
                                <i class="bi bi-mortarboard-fill"></i>
                            </div>
                            <span>Grades</span>
                        </a>
                        <a href="{{ url_for('teacher.attendance.attendance_hub') }}" class="home-quick-action home-qa-attendance">
                            <div class="home-qa-icon">
                                <i class="bi bi-calendar-check-fill"></i>
                            </div>
                            <span>Attendance</span>
                        </a>
                        <a href="#" onclick="handleReportsClick(event); return false;" class="home-quick-action home-qa-reports">
                            <div class="home-qa-icon">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <span>Reports</span>
                        </a>
                        <a href="{{ url_for('teacher.dashboard.my_students') }}" class="home-quick-action home-qa-students">
                            <div class="home-qa-icon">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <span>Students</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-8">
                <!-- Notifications Card -->
                <div class="home-notifications mb-4">
                    <div class="home-notifications-header">
                        <h6 class="mb-0">
                            <i class="bi bi-bell-fill me-2"></i>Notifications
                            {% if notifications and notifications|length > 0 %}
                            <span class="badge bg-danger ms-2">{{ notifications|length }}</span>
                            {% endif %}
                        </h6>
                    </div>
                    <div class="home-notifications-body">
                        {% if notifications and notifications|length > 0 %}
                            {% for notification in notifications[:5] %}
                            <div class="home-notification-item {% if not notification.is_read %}unread{% endif %}">
                                <div class="home-notif-icon">
                                    {% if not notification.is_read %}
                                    <i class="bi bi-circle-fill text-danger"></i>
                                    {% else %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    {% endif %}
                                </div>
                                <div class="home-notif-content">
                                    <h6 class="home-notif-title">{{ notification.title }}</h6>
                                    <p class="home-notif-message">{{ notification.message }}</p>
                                    <small class="home-notif-time">
                                        <i class="bi bi-clock me-1"></i>{{ notification.timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                    </small>
                                </div>
                                <div class="home-notif-actions">
                                    {% if notification.link %}
                                    <a href="{{ notification.link }}" class="btn btn-sm btn-outline-primary">View</a>
                                    {% endif %}
                                    {% if not notification.is_read %}
                                    <form method="POST" action="{{ url_for('teacher.mark_notification_read', notification_id=notification.id) }}" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">Mark Read</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            {% if notifications|length > 5 %}
                            <div class="text-center mt-3">
                                <a href="#" class="btn btn-sm btn-outline-primary">View All Notifications</a>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="home-empty-state">
                                <i class="bi bi-bell-slash"></i>
                                <p>No new notifications at this time.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="home-activity">
                    <div class="home-activity-header">
                        <h6 class="mb-0">
                            <i class="bi bi-activity me-2"></i>Recent Activity
                        </h6>
                    </div>
                    <div class="home-activity-body">
                        {% if recent_activity and recent_activity|length > 0 %}
                            <div class="home-activity-timeline">
                                {% for activity in recent_activity[:5] %}
                                <div class="home-activity-item">
                                    <div class="home-activity-icon">
                                        {% if activity.type == 'submission' %}
                                        <i class="bi bi-file-earmark-check-fill text-primary"></i>
                                        {% elif activity.type == 'grade' %}
                                        <i class="bi bi-star-fill text-success"></i>
                                        {% elif activity.type == 'assignment' %}
                                        <i class="bi bi-journal-plus text-info"></i>
                                        {% else %}
                                        <i class="bi bi-circle-fill text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="home-activity-content">
                                        <h6 class="home-activity-title">{{ activity.title }}</h6>
                                        <p class="home-activity-desc">{{ activity.description }}</p>
                                        <small class="home-activity-time">
                                            <i class="bi bi-clock me-1"></i>{{ activity.timestamp.strftime('%b %d, %Y %I:%M %p') }}
                                        </small>
                                        {% if activity.link %}
                                        <a href="{{ activity.link }}" class="btn btn-sm btn-outline-primary mt-2">View Details</a>
                                        {% endif %}
                                    </div>
                                    <div class="home-activity-badge">
                                        {% if activity.type == 'submission' %}
                                        <span class="badge bg-primary">Submission</span>
                                        {% elif activity.type == 'grade' %}
                                        <span class="badge bg-success">Grade</span>
                                        {% elif activity.type == 'assignment' %}
                                        <span class="badge bg-info">Assignment</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ activity.type|title }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="home-empty-state">
                                <i class="bi bi-clock-history"></i>
                                <p>No recent activity to display. Start by creating assignments or grading student work!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'classes' %}
        <!-- My Classes View -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-house-door-fill text-primary me-2"></i>
                    My Classes
                </h2>
                <p class="text-muted mb-0">Manage your assigned classes and view class information</p>
            </div>
            <div class="d-flex gap-2">
                <span class="badge bg-primary fs-6">{{ classes|length }} Classes</span>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-primary">
                    <div class="stat-icon">
                        <i class="bi bi-house-door-fill"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ classes|length }}</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-success">
                    <div class="stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ classes|map(attribute='enrollments')|map('selectattr', 'is_active')|map('list')|map('length')|sum }}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-warning">
                    <div class="stat-icon">
                        <i class="bi bi-journal-text"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ classes|map(attribute='assignments')|map('list')|map('length')|sum if classes else 0 }}</div>
                        <div class="stat-label">Assignments</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-info">
                    <div class="stat-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ classes|length }}</div>
                        <div class="stat-label">Active Classes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classes Grid -->
        <div class="row g-4">
            {% for class in classes %}
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="class-card h-100">
                        <div class="class-card-header">
                            <div class="class-icon">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <div class="class-info">
                                <h5 class="class-name">{{ class.name }}</h5>
                                <p class="class-subject">{{ class.subject or 'General' }}</p>
                            </div>
                            <div class="class-badge">
                                <span class="badge bg-primary">{{ class.get_grade_levels_display() if class.get_grade_levels_display() else 'N/A' }}</span>
                            </div>
                        </div>
                        
                        <div class="class-card-body">
                            <div class="class-details">
                                <div class="detail-item">
                                    <i class="bi bi-people-fill text-primary"></i>
                                    <span>{{ class.enrollments|selectattr('is_active')|list|length }} Students</span>
                                </div>
                                <div class="detail-item">
                                    <i class="bi bi-journal-text text-success"></i>
                                    <span>{{ class.assignments|list|length }} Assignments</span>
                                </div>
                                <div class="detail-item">
                                    <i class="bi bi-calendar text-info"></i>
                                    <span>{{ class.school_year.name if class.school_year else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="class-card-footer">
                            <div class="class-actions">
                                <a href="{{ url_for('teacher.dashboard.view_class', class_id=class.id) }}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Class
                                </a>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('teacher.assignments.assignment_type_selector') }}" class="btn btn-outline-success btn-sm" title="Add Assignment">
                                        <i class="bi bi-plus-circle"></i>
                                    </a>
                                    <a href="{{ url_for('teacher.attendance.take_attendance', class_id=class.id) }}" class="btn btn-outline-warning btn-sm" title="Take Attendance">
                                        <i class="bi bi-clipboard-check"></i>
                                    </a>
                                    <a href="{{ url_for('teacher.dashboard.view_class', class_id=class.id) }}" class="btn btn-outline-info btn-sm" title="View Class">
                                        <i class="bi bi-graph-up"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-house-door"></i>
                        </div>
                        <h4>No Classes Assigned</h4>
                        <p class="text-muted">You don't have any classes assigned to you yet. Please contact the school administrator.</p>
                        <a href="{{ url_for('teacher.dashboard.teacher_dashboard') }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% elif section == 'assignments' %}
        <!-- Assignments View -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-journal-text text-primary me-2"></i>
                    My Assignments
                </h2>
                <p class="text-muted mb-0">Manage and track your class assignments</p>
            </div>
            <div class="d-flex gap-2">
                <span class="badge bg-primary fs-6">{{ assignments|length }} Assignments</span>
            </div>
        </div>

        <!-- Assignment Stats -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-success">
                    <div class="stat-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ assignments|selectattr('due_date', 'ge', today)|list|length }}</div>
                        <div class="stat-label">Active</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-danger">
                    <div class="stat-icon">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ assignments|selectattr('due_date', 'lt', today)|list|length }}</div>
                        <div class="stat-label">Past Due</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-warning">
                    <div class="stat-icon">
                        <i class="bi bi-clock-fill"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ assignments|length }}</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-info">
                    <div class="stat-icon">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ assignments|map(attribute='class_id')|unique|list|length }}</div>
                        <div class="stat-label">Classes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assignments Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Assignment Overview</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleView('table')">
                            <i class="bi bi-table me-1"></i>Table View
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleView('cards')">
                            <i class="bi bi-grid me-1"></i>Card View
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" id="tableView">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Assignment</th>
                                <th>Class</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                {% set is_overdue = assignment.due_date < today %}
                                <tr class="{% if is_overdue %}table-warning{% endif %}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="assignment-icon me-3">
                                                <i class="bi bi-journal-text text-primary"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ assignment.title }}</h6>
                                                <small class="text-muted">{{ assignment.description[:50] }}{% if assignment.description|length > 50 %}...{% endif %}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ assignment.class_info.name }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-medium">{{ assignment.due_date.strftime('%b %d, %Y') }}</span>
                                            <small class="text-muted">{{ assignment.due_date.strftime('%I:%M %p') }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        {% if is_overdue %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Past Due
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>Active
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="width: 80px; height: 8px;">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 75%"></div>
                                        </div>
                                        <small class="text-muted">75%</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('teacher.view_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-secondary" title="View">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-primary" title="Grade">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>
                                            <a href="{{ url_for('teacher.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-warning" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-assignment-btn" 
                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}" title="Remove">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">
                                                <i class="bi bi-journal-text"></i>
                                            </div>
                                            <h5>No Assignments Yet</h5>
                                            <p class="text-muted">Create your first assignment to get started.</p>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Card View (Hidden by default) -->
                <div id="cardView" style="display: none;" class="p-4">
                    <div class="row g-3">
                        {% for assignment in assignments %}
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="assignment-card">
                                    <div class="assignment-card-header">
                                        <div class="assignment-icon">
                                            <i class="bi bi-journal-text"></i>
                                        </div>
                                        <div class="assignment-status">
                                            {% if assignment.due_date < today %}
                                                <span class="badge bg-danger">Past Due</span>
                                            {% else %}
                                                <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="assignment-card-body">
                                        <h6 class="assignment-title">{{ assignment.title }}</h6>
                                        <p class="assignment-description">{{ assignment.description[:100] }}{% if assignment.description|length > 100 %}...{% endif %}</p>
                                        <div class="assignment-details">
                                            <div class="detail-item">
                                                <i class="bi bi-house-door text-primary"></i>
                                                <span>{{ assignment.class_info.name }}</span>
                                            </div>
                                            <div class="detail-item">
                                                <i class="bi bi-calendar text-info"></i>
                                                <span>{{ assignment.due_date.strftime('%b %d, %Y') }}</span>
                                            </div>
                                        </div>
                                        <div class="progress mb-3">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 75%"></div>
                                        </div>
                                    </div>
                                    <div class="assignment-card-footer">
                                        <div class="btn-group w-100" role="group">
                                            <a href="{{ url_for('teacher.view_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-primary btn-sm">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>
                                            <a href="{{ url_for('teacher.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-warning btn-sm">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-sm remove-assignment-btn"
                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'grades' %}
        <!-- Grades View -->
        <h2 class="mb-4">Grade Management</h2>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Assignment</th>
                                <th>Class</th>
                                <th>Due Date</th>
                                <th>Students</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.title }}</td>
                                    <td>{{ assignment.class_info.name }}</td>
                                    <td>{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ assignment.students|length if assignment.students else 0 }}</td>
                                    <td>
                                        <a href="{{ url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-primary">
                                            Grade Assignment
                                        </a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No assignments available for grading.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'student-grades' %}
        <!-- Student Grades View -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="bi bi-mortarboard-fill text-primary me-2"></i>
                Student Grades Overview
            </h2>
            <div class="d-flex gap-2">
                <a href="{{ url_for('teacher.grading.my_grades') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Grade Management
                </a>
            </div>
        </div>

        <!-- Class Filter -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('teacher.grading.student_grades') }}" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="class_filter" class="form-label">Filter by Class:</label>
                        <select class="form-select" id="class_filter" name="class_id">
                            <option value="">All Classes</option>
                            {% for class in classes %}
                                <option value="{{ class.id }}" {% if class_filter == class.id %}selected{% endif %}>
                                    {{ class.name }} - {{ class.subject }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel me-1"></i>Apply Filter
                        </button>
                        <a href="{{ url_for('teacher.grading.student_grades') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Student Grades by Class -->
        {% for class in classes %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>
                        {{ class.name }} - {{ class.subject }}
                    </h5>
                </div>
                <div class="card-body">
                    {% set class_students = students_by_class.get(class.id, []) %}
                    {% if class_students %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Email</th>
                                        <th>Overall GPA</th>
                                        <th>Assignments</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in class_students %}
                                        {% set student_grades = grades_by_student.get(student.id, {}) %}
                                        {% set student_gpa = student_gpas_by_class.get(class.id, {}).get(student.id, 0.0) %}
                                        {% set class_assignments = assignments|selectattr('class_id', 'equalto', class.id)|list %}
                                        {% set class_assignment_ids = class_assignments|map(attribute='id')|list %}
                                        {% set completed_assignments = 0 %}
                                        {% for assignment_id in class_assignment_ids %}
                                            {% if assignment_id in student_grades %}
                                                {% set completed_assignments = completed_assignments + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                        {% set total_assignments = class_assignments|length %}
                                        
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm me-3">
                                                        <i class="bi bi-person-circle fs-4 text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                                        <br><small class="text-muted">{{ student.student_id }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if student.email %}
                                                    <a href="mailto:{{ student.email }}" class="text-decoration-none">
                                                        {{ student.email }}
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge {% if student_gpa >= 3.5 %}bg-success
                                                               {% elif student_gpa >= 3.0 %}bg-primary
                                                               {% elif student_gpa >= 2.0 %}bg-warning text-dark
                                                               {% else %}bg-danger{% endif %} fs-6">
                                                    {{ "%.2f"|format(student_gpa) }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {{ completed_assignments }}/{{ total_assignments }}
                                                </span>
                                                <br><small class="text-muted">Completed</small>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                                            data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-gear me-1"></i>Actions
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" href="#" 
                                                               onclick="viewStudentGrades({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                                                <i class="bi bi-eye me-2"></i>View Grades
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" 
                                                               onclick="viewStudentAssignments({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                                                <i class="bi bi-journal-text me-2"></i>View Assignments
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" 
                                                               onclick="viewStudentProgress({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                                                <i class="bi bi-graph-up me-2"></i>View Progress
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-people fs-1 text-muted"></i>
                            <p class="mt-2">No students enrolled in this class.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No classes available for viewing student grades.
            </div>
        {% endfor %}

        <!-- Student Details Modal -->
        <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="True">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="studentDetailsContent">
                        <!-- Content will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
        function viewStudentGrades(studentId, studentName) {
            // Implementation for viewing individual student grades
            document.getElementById('studentDetailsModalLabel').textContent = `Grades - ${studentName}`;
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="text-center">
                    <h6>Grades for ${studentName}</h6>
                    <p class="text-muted">Detailed grade breakdown will be implemented here.</p>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
        }

        function viewStudentAssignments(studentId, studentName) {
            // Implementation for viewing student assignments
            document.getElementById('studentDetailsModalLabel').textContent = `Assignments - ${studentName}`;
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="text-center">
                    <h6>Assignments for ${studentName}</h6>
                    <p class="text-muted">Assignment list will be implemented here.</p>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
        }

        function viewStudentProgress(studentId, studentName) {
            // Implementation for viewing student progress
            document.getElementById('studentDetailsModalLabel').textContent = `Progress - ${studentName}`;
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="text-center">
                    <h6>Progress Report for ${studentName}</h6>
                    <p class="text-muted">Progress charts will be implemented here.</p>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
        }
        </script>

    {% elif section == 'attendance' %}
        <!-- Attendance View -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-calendar-check-fill text-primary me-2"></i>
                    Attendance Management
                </h2>
                <p class="text-muted mb-0">Track and manage attendance for your classes</p>
            </div>
            <div class="d-flex gap-2">
                <span class="badge bg-primary fs-6">{{ classes|length }} Your Classes</span>
            </div>
        </div>

        <!-- Attendance Stats -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-primary">
                    <div class="stat-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ classes|length }}</div>
                        <div class="stat-label">Your Classes</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-success">
                    <div class="stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ classes|map(attribute='enrollments')|map('selectattr', 'is_active')|map('list')|map('length')|sum }}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-warning">
                    <div class="stat-icon">
                        <i class="bi bi-calendar-day"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">Today</div>
                        <div class="stat-label">Date</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card stat-card-info">
                    <div class="stat-icon">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">95%</div>
                        <div class="stat-label">Avg Rate</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h6 class="mb-1">Quick Actions</h6>
                        <small class="text-muted">Take attendance for today or manage past records</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="markAllPresent()">
                            <i class="bi bi-check-all me-1"></i>Mark All Present
                        </button>
                        <a href="{{ url_for('teacher.attendance.attendance_hub') }}" class="btn btn-primary btn-sm">
                            <i class="bi bi-calendar-plus me-1"></i>Take Attendance
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classes Grid -->
        <div class="row g-4">
            {% for class in all_classes %}
                {% set is_assigned = class in classes %}
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="attendance-class-card {% if is_assigned %}assigned{% else %}not-assigned{% endif %}">
                        <div class="attendance-card-header">
                            <div class="class-icon">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <div class="class-info">
                                <h5 class="class-name">{{ class.name }}</h5>
                                <p class="class-subject">{{ class.subject or 'General' }}</p>
                            </div>
                            <div class="attendance-badge">
                                {% if is_assigned %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Your Class
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-lock me-1"></i>Not Assigned
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="attendance-card-body">
                            <div class="attendance-stats">
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="bi bi-people-fill text-primary"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-number">{{ class.enrollments|selectattr('is_active')|list|length }}</span>
                                        <span class="stat-label">Students</span>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="bi bi-calendar-check text-success"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-number">95%</span>
                                        <span class="stat-label">Attendance</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="attendance-progress">
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 95%"></div>
                                </div>
                                <small class="text-muted">Today's attendance rate</small>
                            </div>
                        </div>
                        
                        <div class="attendance-card-footer">
                            {% if is_assigned %}
                                <a href="{{ url_for('teacher.attendance.take_attendance', class_id=class.id) }}" class="btn btn-primary w-100">
                                    <i class="bi bi-clipboard-check me-1"></i>Take Attendance
                                </a>
                            {% else %}
                                <button class="btn btn-secondary w-100" disabled>
                                    <i class="bi bi-lock me-1"></i>Not Assigned
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <h4>No Classes Available</h4>
                        <p class="text-muted">There are no classes in the system for attendance tracking.</p>
                        <a href="{{ url_for('teacher.dashboard.teacher_dashboard') }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% elif section == 'students' %}
        <!-- Students Directory View -->
        <!-- Header Section -->
        <div class="students-dir-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="header-title-dir mb-1">
                        <i class="bi bi-people-fill me-2"></i>Students Directory
                    </h2>
                    <p class="header-subtitle-dir mb-0">
                        <span class="badge bg-white text-primary me-2">{{ students|length }} Students</span>
                        <span class="text-white-50">Browse and search all enrolled students</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card-dir stat-card-dir-primary">
                    <div class="stat-icon-dir">
                        <i class="bi bi-person-check-fill"></i>
                    </div>
                    <div class="stat-content-dir">
                        <div class="stat-value-dir">{{ students|length }}</div>
                        <div class="stat-label-dir">Total Students</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card-dir stat-card-dir-success">
                    <div class="stat-icon-dir">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <div class="stat-content-dir">
                        <div class="stat-value-dir">{{ students|selectattr('is_active')|list|length }}</div>
                        <div class="stat-label-dir">Active</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card-dir stat-card-dir-info">
                    <div class="stat-icon-dir">
                        <i class="bi bi-mortarboard-fill"></i>
                    </div>
                    <div class="stat-content-dir">
                        <div class="stat-value-dir">{{ students|map(attribute='grade_level')|unique|list|length }}</div>
                        <div class="stat-label-dir">Grade Levels</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card-dir stat-card-dir-warning">
                    <div class="stat-icon-dir">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <div class="stat-content-dir">
                        <div class="stat-value-dir">{{ students|selectattr('is_active')|list|length }}</div>
                        <div class="stat-label-dir">Enrolled</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Search & Filter Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Search & Filter</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('teacher.dashboard.my_students') }}" id="studentSearchForm" class="row g-3">
                    <!-- Search Query -->
                    <div class="col-md-4">
                        <label for="search" class="form-label fw-semibold">
                            <i class="bi bi-search me-1"></i>Search
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               value="{{ search_query or '' }}" 
                               placeholder="Search by name or ID..."
                               autocomplete="off">
                    </div>
                    
                    <!-- Grade Filter -->
                    <div class="col-md-2">
                        <label for="grade_filter" class="form-label fw-semibold">
                            <i class="bi bi-mortarboard me-1"></i>Grade
                        </label>
                        <select class="form-select" id="grade_filter" name="grade_filter">
                            <option value="">All</option>
                            <option value="Kindergarten" {% if grade_filter == 'Kindergarten' %}selected{% endif %}>K</option>
                            <option value="1st" {% if grade_filter == '1st' %}selected{% endif %}>1st</option>
                            <option value="2nd" {% if grade_filter == '2nd' %}selected{% endif %}>2nd</option>
                            <option value="3rd" {% if grade_filter == '3rd' %}selected{% endif %}>3rd</option>
                            <option value="4th" {% if grade_filter == '4th' %}selected{% endif %}>4th</option>
                            <option value="5th" {% if grade_filter == '5th' %}selected{% endif %}>5th</option>
                            <option value="6th" {% if grade_filter == '6th' %}selected{% endif %}>6th</option>
                            <option value="7th" {% if grade_filter == '7th' %}selected{% endif %}>7th</option>
                            <option value="8th" {% if grade_filter == '8th' %}selected{% endif %}>8th</option>
                            <option value="9th" {% if grade_filter == '9th' %}selected{% endif %}>9th</option>
                            <option value="10th" {% if grade_filter == '10th' %}selected{% endif %}>10th</option>
                            <option value="11th" {% if grade_filter == '11th' %}selected{% endif %}>11th</option>
                            <option value="12th" {% if grade_filter == '12th' %}selected{% endif %}>12th</option>
                        </select>
                    </div>
                    
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label for="status_filter" class="form-label fw-semibold">
                            <i class="bi bi-toggle-on me-1"></i>Status
                        </label>
                        <select class="form-select" id="status_filter" name="status_filter">
                            <option value="">All</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                    
                    <!-- Sort By -->
                    <div class="col-md-2">
                        <label for="sort_by" class="form-label fw-semibold">
                            <i class="bi bi-sort-down me-1"></i>Sort By
                        </label>
                        <select class="form-select" id="sort_by" name="sort_by">
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                            <option value="grade" {% if sort_by == 'grade' %}selected{% endif %}>Grade</option>
                            <option value="gpa" {% if sort_by == 'gpa' %}selected{% endif %}>GPA</option>
                        </select>
                    </div>
                    
                    <!-- Sort Order -->
                    <div class="col-md-2">
                        <label for="sort_order" class="form-label fw-semibold">
                            <i class="bi bi-arrow-down-up me-1"></i>Order
                        </label>
                        <select class="form-select" id="sort_order" name="sort_order">
                            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>A-Z</option>
                            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Z-A</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Apply Filters
                            </button>
                            <a href="{{ url_for('teacher.dashboard.my_students') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results Info -->
        {% if search_query or grade_filter or status_filter %}
            <div class="alert alert-info border-0 shadow-sm mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong>Search Results:</strong> Found {{ students|length }} student(s)
                        <div class="mt-1">
                            {% if search_query %}<span class="badge bg-primary me-1">Search: "{{ search_query }}"</span>{% endif %}
                            {% if grade_filter %}<span class="badge bg-secondary me-1">Grade: "{{ grade_filter }}"</span>{% endif %}
                            {% if status_filter %}<span class="badge bg-warning text-dark me-1">Status: "{{ status_filter }}"</span>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Students Cards Grid -->
        {% if students %}
        <div class="row g-3">
            {% for student in students %}
            <div class="col-12 col-md-6 col-xl-4">
                <div class="student-card-dir">
                    <div class="student-card-header-dir">
                        <div class="student-avatar-dir">
                            {{ student.first_name[0] }}{{ student.last_name[0] }}
                        </div>
                        <div class="student-info-dir">
                            <h6 class="student-name-dir mb-1">{{ student.first_name }} {{ student.last_name }}</h6>
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="badge badge-grade-dir">Grade {{ student.grade_level | display_grade }}</span>
                                {% if student.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="student-card-body-dir">
                        <div class="info-row-dir">
                            <div class="info-icon-dir">
                                <i class="bi bi-card-text"></i>
                            </div>
                            <div class="info-content-dir">
                                <small class="text-muted">Student ID</small>
                                <div class="fw-semibold">{{ student.student_id }}</div>
                            </div>
                        </div>
                        
                        <div class="info-row-dir">
                            <div class="info-icon-dir">
                                <i class="bi bi-envelope"></i>
                            </div>
                            <div class="info-content-dir">
                                <small class="text-muted">Email</small>
                                {% if student.email %}
                                <div class="fw-semibold text-truncate">
                                    <a href="mailto:{{ student.email }}" class="text-decoration-none">{{ student.email }}</a>
                                </div>
                                {% else %}
                                <div class="text-muted">N/A</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="info-row-dir">
                            <div class="info-icon-dir">
                                <i class="bi bi-telephone"></i>
                            </div>
                            <div class="info-content-dir">
                                <small class="text-muted">Phone</small>
                                <div class="fw-semibold">{{ student.phone or 'N/A' }}</div>
                            </div>
                        </div>
                        
                        <div class="info-row-dir">
                            <div class="info-icon-dir">
                                <i class="bi bi-trophy"></i>
                            </div>
                            <div class="info-content-dir">
                                <small class="text-muted">GPA</small>
                                {% set student_gpa = student_gpas.get(student.id, 0.0) %}
                                <span class="badge {% if student_gpa >= 3.5 %}bg-success
                                               {% elif student_gpa >= 3.0 %}bg-primary
                                               {% elif student_gpa >= 2.0 %}bg-warning text-dark
                                               {% else %}bg-danger{% endif %}">
                                    {{ "%.2f"|format(student_gpa) }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="student-card-footer-dir">
                        <button class="btn btn-primary btn-sm w-100" onclick="showInfoUnavailableModal()">
                            <i class="bi bi-eye me-1"></i>View Full Details
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center border-0 shadow-sm">
            <div class="mb-3">
                <i class="bi bi-person-x" style="font-size: 3rem; color: #0d6efd;"></i>
            </div>
            <h5>No Students Found</h5>
            <p class="mb-0">Try adjusting your search filters or reset to view all students.</p>
        </div>
        {% endif %}

    {% elif section == 'teachers-staff' %}
        <!-- Teachers & Staff Directory View -->
        <!-- Header Section -->
        <div class="staff-dir-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="header-title-staff mb-1">
                        <i class="bi bi-person-badge-fill me-2"></i>Teachers & Staff Directory
                    </h2>
                    <p class="header-subtitle-staff mb-0">
                        <span class="badge bg-white text-primary me-2">{{ teachers_staff|length }} Members</span>
                        <span class="text-white-50">Connect with colleagues and staff</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card-staff stat-card-staff-primary">
                    <div class="stat-icon-staff">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-content-staff">
                        <div class="stat-value-staff">{{ teachers_staff|length }}</div>
                        <div class="stat-label-staff">Total Staff</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card-staff stat-card-staff-success">
                    <div class="stat-icon-staff">
                        <i class="bi bi-mortarboard-fill"></i>
                    </div>
                    <div class="stat-content-staff">
                        <div class="stat-value-staff">{{ teachers_staff|selectattr('role', 'in', ['Math Teacher', 'Science Teacher', 'English Teacher', 'History Teacher', 'PE Teacher', 'Art Teacher', 'Music Teacher'])|list|length }}</div>
                        <div class="stat-label-staff">Teachers</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card-staff stat-card-staff-info">
                    <div class="stat-icon-staff">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="stat-content-staff">
                        <div class="stat-value-staff">{{ teachers_staff|selectattr('role', 'in', ['Director', 'School Administrator'])|list|length }}</div>
                        <div class="stat-label-staff">Admins</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card-staff stat-card-staff-warning">
                    <div class="stat-icon-staff">
                        <i class="bi bi-wrench-adjustable"></i>
                    </div>
                    <div class="stat-content-staff">
                        <div class="stat-value-staff">{{ teachers_staff|rejectattr('role', 'in', ['Math Teacher', 'Science Teacher', 'English Teacher', 'History Teacher', 'PE Teacher', 'Art Teacher', 'Music Teacher', 'Director', 'School Administrator'])|list|length }}</div>
                        <div class="stat-label-staff">Support</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Filter Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-gradient-staff text-white">
                <h5 class="mb-0"><i class="bi bi-search me-2"></i>Search Staff</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('teacher.dashboard.teachers_staff') }}" class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label for="search" class="form-label fw-semibold">
                            <i class="bi bi-search me-1"></i>Search
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               value="{{ search_query or '' }}" 
                               placeholder="Search by name, email, or role..."
                               autocomplete="off">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('teacher.dashboard.teachers_staff') }}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results Info -->
        {% if search_query %}
            <div class="alert alert-info border-0 shadow-sm mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong>Search Results:</strong> Found {{ teachers_staff|length }} staff member(s) matching "{{ search_query }}"
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Staff Cards Grid -->
        {% if teachers_staff %}
        <div class="row g-3">
            {% for staff in teachers_staff %}
            <div class="col-12 col-md-6 col-xl-4">
                <div class="staff-card-dir">
                    <div class="staff-card-header-dir">
                        <div class="staff-avatar-dir">
                            {{ staff.first_name[0] }}{{ staff.last_name[0] }}
                        </div>
                        <div class="staff-info-dir">
                            <h6 class="staff-name-dir mb-1">{{ staff.first_name }} {{ staff.last_name }}</h6>
                            <div class="d-flex gap-2 flex-wrap">
                                {% if staff.role in ['Director', 'School Administrator'] %}
                                <span class="badge badge-admin-dir">
                                    <i class="bi bi-shield-fill me-1"></i>{{ staff.role }}
                                </span>
                                {% elif 'Teacher' in staff.role %}
                                <span class="badge badge-teacher-dir">
                                    <i class="bi bi-mortarboard-fill me-1"></i>{{ staff.role }}
                                </span>
                                {% else %}
                                <span class="badge badge-staff-dir">
                                    <i class="bi bi-person-fill me-1"></i>{{ staff.role }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="staff-card-body-dir">
                        <div class="info-row-staff">
                            <div class="info-icon-staff">
                                <i class="bi bi-envelope-fill"></i>
                            </div>
                            <div class="info-content-staff">
                                <small class="text-muted">Email Address</small>
                                <div class="fw-semibold text-truncate">
                                    {% if staff.email %}
                                    <a href="mailto:{{ staff.email }}" class="text-decoration-none">{{ staff.email }}</a>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {% if staff.phone %}
                        <div class="info-row-staff">
                            <div class="info-icon-staff">
                                <i class="bi bi-telephone-fill"></i>
                            </div>
                            <div class="info-content-staff">
                                <small class="text-muted">Phone Number</small>
                                <div class="fw-semibold">{{ staff.phone }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if staff.assigned_role %}
                        <div class="info-row-staff">
                            <div class="info-icon-staff">
                                <i class="bi bi-briefcase"></i>
                            </div>
                            <div class="info-content-staff">
                                <small class="text-muted">Position</small>
                                <div class="fw-semibold">{{ staff.assigned_role }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if staff.department %}
                        <div class="info-row-staff">
                            <div class="info-icon-staff">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="info-content-staff">
                                <small class="text-muted">Department</small>
                                <div class="fw-semibold">{{ staff.department }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="staff-card-footer-dir">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm flex-fill" onclick="showInfoUnavailableModal()">
                                <i class="bi bi-eye me-1"></i>View Details
                            </button>
                            {% if staff.email %}
                            <a href="mailto:{{ staff.email }}" class="btn btn-outline-primary btn-sm" title="Send Email">
                                <i class="bi bi-envelope"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center border-0 shadow-sm">
            <div class="mb-3">
                <i class="bi bi-person-x" style="font-size: 3rem; color: #f093fb;"></i>
            </div>
            <h5>No Staff Members Found</h5>
            <p class="mb-0">Try adjusting your search or reset to view all staff members.</p>
        </div>
        {% endif %}

    {% elif section == 'calendar' %}
        <!-- Calendar View -->
        <h2 class="mb-4">School Calendar</h2>
        
        {% if calendar_data %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ calendar_data.month_name }} {{ calendar_data.year }}</h5>
                        <div>
                            <a href="{{ url_for('teacher.calendar', month=prev_month.month, year=prev_month.year) }}" class="btn btn-sm btn-outline-light me-2">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                            <a href="{{ url_for('teacher.calendar', month=next_month.month, year=next_month.year) }}" class="btn btn-sm btn-outline-light">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="row text-center">
                                <div class="col">Mon</div>
                                <div class="col">Tue</div>
                                <div class="col">Wed</div>
                                <div class="col">Thu</div>
                                <div class="col">Fri</div>
                                <div class="col">Sat</div>
                                <div class="col">Sun</div>
                            </div>
                        </div>
                        <div class="calendar-body">
                            {% for week in calendar_data.weeks %}
                                <div class="row calendar-week">
                                    {% for day in week %}
                                        <div class="col calendar-day {% if not day.is_current_month %}empty{% endif %} {% if day.is_today %}today{% endif %}">
                                            {% if day.is_current_month %}
                                                <div class="day-number">{{ day.day_num }}</div>
                                                {% if day.events %}
                                                    <div class="day-events">
                                                        {% for event in day.events %}
                                                            <div class="calendar-event event-{{ event.category|lower|replace(' ', '_') if event.category else 'default' }}" title="{{ event.title }}">
                                                                <small class="event-title">{{ event.title }}</small>
                                                                {% if event.category %}
                                                                    <small class="event-category">{{ event.category }}</small>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Calendar Information -->
            <div class="row g-3 g-md-4 mt-4">
                <div class="col-12 col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Upcoming Events</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <p>No upcoming events scheduled.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary btn-sm me-2 mb-2">
                                <i class="bi bi-plus-circle me-1"></i>Add Event
                            </button>
                            <button class="btn btn-outline-success btn-sm me-2 mb-2">
                                <i class="bi bi-download me-1"></i>Export Calendar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Calendar Unavailable</h5>
                <p>The school calendar is currently unavailable. Please check back later.</p>
            </div>
        {% endif %}

    {% elif section == 'schedule' or show_schedule %}
        <!-- Schedule View -->
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px; background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h2 class="mb-1 text-white" style="font-weight: 600;">
                            <i class="bi bi-calendar-week-fill me-2"></i>My Schedule
                        </h2>
                        <p class="mb-0 text-white" style="opacity: 0.9;">
                            <i class="bi bi-calendar3 me-2"></i>Weekly class schedule
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Schedule Card -->
        {% if today_schedule %}
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
            <div class="card-header border-0 bg-white pb-0 pt-3">
                <h5 class="mb-0 fw-bold" style="color: #1f2937;">
                    <i class="bi bi-calendar-day me-2 text-primary"></i>
                    Today's Schedule
                </h5>
            </div>
            <div class="card-body pt-3">
                <div class="row g-3">
                    {% for item in today_schedule %}
                        {% if item and item.class %}
                        <div class="col-12">
                            <div class="card border h-100" style="border-radius: 10px; border-color: #e5e7eb !important; border-left: 4px solid #4A90E2;">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-2 fw-bold" style="color: #1f2937;">{{ item.class.name if item.class else 'Unknown Class' }}</h6>
                                            <div class="d-flex flex-wrap gap-3 mb-2">
                                                {% if item.start_time and item.end_time %}
                                                <small class="text-muted">
                                                    <i class="bi bi-clock me-1"></i>{{ item.start_time.strftime('%I:%M %p') }} - {{ item.end_time.strftime('%I:%M %p') }}
                                                </small>
                                                {% endif %}
                                                <small class="text-muted">
                                                    <i class="bi bi-geo-alt me-1"></i>{{ item.room or 'TBD' }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-people me-1"></i>{{ item.enrollment_count or 0 }} students
                                                </small>
                                            </div>
                                            <span class="badge bg-primary bg-opacity-10 text-primary">{{ item.class.subject if item.class and item.class.subject else 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Weekly Schedule -->
        <div class="card border-0 shadow-sm" style="border-radius: 12px;">
            <div class="card-header border-0 bg-white pb-0 pt-3">
                <h5 class="mb-0 fw-bold" style="color: #1f2937;">
                    <i class="bi bi-calendar-week me-2 text-primary"></i>
                    Weekly Schedule
                </h5>
            </div>
            <div class="card-body pt-3">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0" style="table-layout: fixed;">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 12%;" class="text-center">Time</th>
                                <th style="width: 12.5%;" class="text-center">Monday</th>
                                <th style="width: 12.5%;" class="text-center">Tuesday</th>
                                <th style="width: 12.5%;" class="text-center">Wednesday</th>
                                <th style="width: 12.5%;" class="text-center">Thursday</th>
                                <th style="width: 12.5%;" class="text-center">Friday</th>
                                <th style="width: 12.5%;" class="text-center">Saturday</th>
                                <th style="width: 12.5%;" class="text-center">Sunday</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if time_slots and time_slots|length > 0 %}
                                {% for time_slot in time_slots %}
                                    {% if time_slot and time_slot is string and '-' in time_slot %}
                                        {% set time_parts = time_slot.split('-') %}
                                        {% set start_time_str = time_parts[0] if time_parts|length > 0 else '' %}
                                        {% set end_time_str = time_parts[1] if time_parts|length > 1 else '' %}
                                        {% if start_time_str and end_time_str %}
                                        <tr>
                                            <td class="text-center fw-semibold" style="background-color: #f9fafb;">
                                                {{ start_time_str }}<br>
                                                <small class="text-muted">{{ end_time_str }}</small>
                                            </td>
                                            {% for day in range(7) %}
                                                <td class="align-top" style="min-height: 80px;">
                                                    {% if schedules_by_day and schedules_by_day.get(day) %}
                                                        {% for schedule_item in schedules_by_day.get(day, []) %}
                                                            {% if schedule_item and schedule_item.start_time and schedule_item.end_time and schedule_item.class %}
                                                                {% set schedule_time_key = schedule_item.start_time.strftime('%H:%M') ~ '-' ~ schedule_item.end_time.strftime('%H:%M') %}
                                                                {% if schedule_time_key == time_slot %}
                                                                    <div class="card border-0 mb-2" style="background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%); border-radius: 8px;">
                                                                        <div class="card-body p-2 text-white">
                                                                            <h6 class="mb-1 fw-bold" style="font-size: 0.85rem;">{{ schedule_item.class.name if schedule_item.class else 'Unknown Class' }}</h6>
                                                                            <small class="d-block mb-1" style="opacity: 0.9;">{{ schedule_item.class.subject if schedule_item.class and schedule_item.class.subject else 'N/A' }}</small>
                                                                            <small class="d-block mb-1">
                                                                                <i class="bi bi-geo-alt me-1"></i>{{ schedule_item.room or 'TBD' }}
                                                                            </small>
                                                                            <small class="d-block">
                                                                                <i class="bi bi-people me-1"></i>{{ schedule_item.enrollment_count or 0 }} students
                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="bi bi-calendar-x display-4 d-block mb-3"></i>
                                        <p>No schedule has been set for your classes yet.</p>
                                        <p class="small">Contact your school administrator to set up your class schedule.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'communications' %}
        <!-- Communications View -->
        <h2 class="mb-4">Communications</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-chat-dots-fill me-2"></i>Communications Center</h5>
            <p>The communications center is currently under development. This will allow you to send messages to students, parents, and other staff members.</p>
        </div>

    {% elif section == 'settings' %}
        <!-- Settings View -->
        <h2 class="mb-4">Settings</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-gear-fill me-2"></i>Account Settings</h5>
            <p>Account settings and preferences are currently under development.</p>
        </div>

    {% else %}
        <!-- Generic fallback content for other sections -->
        <div class="alert alert-warning">
            <h4>Debug Information:</h4>
            <p><strong>Section:</strong> "{{ section }}"</p>
            <p><strong>Active Tab:</strong> "{{ active_tab }}"</p>
            <p><strong>Teacher:</strong> {{ teacher.first_name }} {{ teacher.last_name if teacher else 'NONE' }}</p>
            <hr>
            <p>Content for the '{{ section }}' section for teachers is currently under development. Please check back later!</p>
        </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="True">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the assignment "<span id="assignmentTitle"></span>"?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Assignment</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} 

{% block scripts %}
{{ super() }}
<script>
  // Handle Reports button click - Must be global and available before page load
  window.handleReportsClick = function(event) {
    try {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      // Get classes data from template (use classes_json if available, fallback to classes)
      const classesData = {{ classes_json|tojson|safe if classes_json is defined else classes|tojson|safe }};
      const classes = Array.isArray(classesData) ? classesData : [];
      const classCount = classes.length;
      const analyticsBaseUrl = "{{ url_for('teacher.analytics.class_analytics', class_id=0) }}";
      
      console.log('Reports clicked. Classes:', classes, 'Count:', classCount);
      
      if (classCount === 0) {
        alert('You do not have any classes assigned. Please contact an administrator.');
        return false;
      }
      
      if (classCount === 1) {
        // Single class - redirect directly
        const classId = classes[0].id;
        const analyticsUrl = analyticsBaseUrl.replace('/0', '/' + classId);
        console.log('Redirecting to:', analyticsUrl);
        window.location.href = analyticsUrl;
        return false;
      } else {
        // Multiple classes - show modal
        const modalElement = document.getElementById('selectClassModal');
        if (!modalElement) {
          console.error('Modal element not found');
          alert('Error: Modal not found. Please refresh the page.');
          return false;
        }
        
        // Check if Bootstrap is available
        if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
          console.error('Bootstrap not available');
          alert('Error: Bootstrap not loaded. Please refresh the page.');
          return false;
        }
        
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Populate class list
        const classList = document.getElementById('classSelectList');
        if (!classList) {
          console.error('Class list element not found');
          return false;
        }
        
        classList.innerHTML = '';
        
        classes.forEach(classItem => {
          const listItem = document.createElement('a');
          listItem.href = '#';
          listItem.className = 'list-group-item list-group-item-action';
          listItem.style.cursor = 'pointer';
          listItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${escapeHtml(classItem.name || 'Unnamed Class')}</h6>
            </div>
            <p class="mb-1 text-muted">${escapeHtml(classItem.subject || 'N/A')}</p>
          `;
          listItem.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            modal.hide();
            const analyticsUrl = analyticsBaseUrl.replace('/0', '/' + classItem.id);
            window.location.href = analyticsUrl;
            return false;
          };
          classList.appendChild(listItem);
        });
        
        return false;
      }
    } catch (error) {
      console.error('Error in handleReportsClick:', error);
      alert('An error occurred. Please try again or contact support.');
      return false;
    }
  };
  
  // Helper function to escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

function showInfoUnavailableModal() {
    let modalEl = document.getElementById('infoUnavailableModal');
    if (!modalEl) {
        const modalHtml = `
        <div class="modal fade" id="infoUnavailableModal" tabindex="-1" aria-labelledby="infoUnavailableModalLabel" aria-hidden="True">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="infoUnavailableModalLabel">Information Unavailable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Information is currently unavailable. Please contact either the School Administrator or Director for more information.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('infoUnavailableModal'));
    modal.show();
}

// Enhanced Search Functionality for Students
{% if section == 'students' %}
document.addEventListener('DOMContentLoaded', function() {
    const studentSearchForm = document.getElementById('studentSearchForm');
    const searchInput = document.getElementById('search');
    const searchTypeSelect = document.getElementById('search_type');
    const gradeFilterSelect = document.getElementById('grade_filter');
    const statusFilterSelect = document.getElementById('status_filter');
    const sortBySelect = document.getElementById('sort_by');
    const sortOrderSelect = document.getElementById('sort_order');

    // Auto-submit form when filter dropdowns change
    [searchTypeSelect, gradeFilterSelect, statusFilterSelect, sortBySelect, sortOrderSelect].forEach(element => {
        if (element) {
            element.addEventListener('change', function() {
                studentSearchForm.submit();
            });
        }
    });

    // Visual feedback for search input
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            if (this.value.length >= 2) {
                this.style.borderColor = '#0d6efd';
            } else {
                this.style.borderColor = '';
            }
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            if (searchInput) {
                searchInput.focus();
            }
        }
        if (e.key === 'Escape' && searchInput) {
            searchInput.value = '';
            searchInput.style.borderColor = '';
        }
    });
});
{% endif %}



// Handle remove assignment button clicks
document.addEventListener('DOMContentLoaded', function() {
    const removeButtons = document.querySelectorAll('.remove-assignment-btn');
    const deleteModal = document.getElementById('deleteModal');
    const assignmentTitleSpan = document.getElementById('assignmentTitle');
    const deleteForm = document.getElementById('deleteForm');
    
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.getAttribute('data-assignment-id');
            const assignmentTitle = this.getAttribute('data-assignment-title');
            
            // Update modal content
            assignmentTitleSpan.textContent = assignmentTitle;
            
            // Update form action with proper URL construction
            deleteForm.action = `/teacher/assignment/remove/${assignmentId}`;
            
            // Show modal
            const modal = new bootstrap.Modal(deleteModal);
            modal.show();
        });
    });
});

// Toggle view between table and cards for assignments
function toggleView(viewType) {
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');
    const tableBtn = document.querySelector('button[onclick="toggleView(\'table\')"]');
    const cardBtn = document.querySelector('button[onclick="toggleView(\'cards\')"]');
    
    if (viewType === 'table') {
        tableView.style.display = 'block';
        cardView.style.display = 'none';
        tableBtn.classList.remove('btn-outline-primary');
        tableBtn.classList.add('btn-primary');
        cardBtn.classList.remove('btn-primary');
        cardBtn.classList.add('btn-outline-secondary');
    } else {
        tableView.style.display = 'none';
        cardView.style.display = 'block';
        cardBtn.classList.remove('btn-outline-secondary');
        cardBtn.classList.add('btn-primary');
        tableBtn.classList.remove('btn-primary');
        tableBtn.classList.add('btn-outline-primary');
    }
}

// Mark all students as present (placeholder function)
function markAllPresent() {
    alert('Mark all present functionality will be implemented');
}
</script>



{% if at_risk_alerts %}
<!-- Bottom-right notification toast -->
<div class="toast-container academic-alert-toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
  <div id="academicAlertToast" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
    <div class="toast-header bg-warning text-dark">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong class="me-auto">Academic Alert</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      <p class="mb-2">
        <strong>{{ at_risk_alerts|length }} student{% if at_risk_alerts|length != 1 %}s{% endif %}</strong> 
        {% if at_risk_alerts|length == 1 %}is raising{% else %}are raising{% endif %} flags for academic concern.
      </p>
      <button type="button" class="btn btn-primary btn-sm w-100" onclick="showAcademicDetailsModal()">
        <i class="bi bi-info-circle me-1"></i>View Details
      </button>
    </div>
  </div>
</div>

<!-- Detailed Academic Concerns Modal -->
<div class="modal fade" id="academicDetailsModal" tabindex="-1" aria-labelledby="academicDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content academic-concerns-modal">
      <div class="modal-header academic-concerns-header">
        <div class="academic-concerns-header-content">
          <div class="academic-concerns-icon-circle">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <div>
            <h5 class="modal-title mb-1" id="academicDetailsModalLabel">
              Student Academic Concerns
            </h5>
            <p class="academic-concerns-subtitle mb-0">Review and address student performance issues in your classes</p>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body academic-concerns-body">
        <!-- Summary Stats -->
        <div class="academic-alerts-summary mb-4">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="summary-stat-card">
                <div class="summary-stat-icon bg-warning">
                  <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div class="summary-stat-content">
                  <div class="summary-stat-value">{{ at_risk_alerts|length }}</div>
                  <div class="summary-stat-label">Student{{ 's' if at_risk_alerts|length != 1 else '' }} with Concerns</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="summary-stat-card">
                <div class="summary-stat-icon bg-danger">
                  <i class="bi bi-x-circle-fill"></i>
                </div>
                <div class="summary-stat-content">
                  <div class="summary-stat-value">{{ failing_count|default(0) }}</div>
                  <div class="summary-stat-label">Failing Assignment{{ 's' if failing_count|default(0) != 1 else '' }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="summary-stat-card">
                <div class="summary-stat-icon bg-info">
                  <i class="bi bi-clock-history"></i>
                </div>
                <div class="summary-stat-content">
                  <div class="summary-stat-value">{{ overdue_count|default(0) }}</div>
                  <div class="summary-stat-label">Overdue Assignment{{ 's' if overdue_count|default(0) != 1 else '' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Students List -->
        <div class="concerns-students-container" id="concernsStudentsContainer">
          {% for alert in at_risk_alerts %}
          <div class="academic-concern-card" 
               data-student-id="{{ alert.student_user_id }}"
               data-student-name="{{ alert.student_name }}"
               data-alert-type="{{ alert.alert_reason.lower() }}">
            <div class="academic-concern-header">
              <div class="d-flex align-items-center gap-3">
                <div class="academic-concern-avatar">
                  {{ alert.student_name[0] if alert.student_name else '?' }}
                </div>
                <div class="flex-grow-1">
                  <h5 class="academic-concern-name mb-1">{{ alert.student_name }}</h5>
                  <div class="academic-concern-meta mb-2">
                    <span class="text-muted">
                      <i class="bi bi-book me-1"></i>{{ alert.class_name }}
                    </span>
                  </div>
                  <div class="academic-concern-badges">
                    <span class="academic-concern-badge badge-{{ 'danger' if 'failing' in alert.alert_reason.lower() else 'warning' }}">
                      <i class="bi bi-{{ 'exclamation-octagon' if 'failing' in alert.alert_reason.lower() else 'exclamation-triangle' }}-fill me-1"></i>
                      {{ alert.alert_reason|title }}
                    </span>
                    {% if alert.assignment_type %}
                    <span class="academic-concern-badge badge-info" title="Assignment Type">
                      <i class="bi bi-{{ 'question-circle' if alert.assignment_type.lower() == 'quiz' else 'chat-dots' if alert.assignment_type.lower() == 'discussion' else 'file-earmark' }} me-1"></i>
                      {{ alert.assignment_type.upper() if alert.assignment_type.startswith('group_') else alert.assignment_type.upper() }}
                    </span>
                    {% endif %}
                    {% if alert.score is not none %}
                    <span class="academic-concern-badge badge-{{ 'danger' if alert.score <= 69 else 'warning' }}">
                      <i class="bi bi-percent me-1"></i>
                      Score: {{ alert.score }}%
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            <div class="academic-concern-body">
              <div id="student-details-{{ alert.student_user_id }}" class="student-details-placeholder">
                <div class="loading-container">
                  <div class="loading-spinner"></div>
                  <p class="loading-text">Loading student details...</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="modal-footer academic-concerns-footer">
        <button type="button" class="btn btn-academic-close" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Define function globally - must be accessible from onclick handler
  function showAcademicDetailsModal() {
    // Close the toast
    var toastElement = document.getElementById('academicAlertToast');
    if (toastElement) {
      var toast = bootstrap.Toast.getInstance(toastElement);
      if (toast) {
        toast.hide();
      }
    }
    
    // Show the detailed modal
    var modalElement = document.getElementById('academicDetailsModal');
    if (!modalElement) {
      alert('Academic details modal not found. Please refresh the page.');
      return;
    }
    
    var modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Load detailed student information for each alert
    {% for alert in at_risk_alerts %}
    if (typeof loadStudentAcademicDetails === 'function') {
      loadStudentAcademicDetails({{ alert.student_user_id }});
    }
    {% endfor %}
  }
  
  // Make function globally accessible
  function loadStudentAcademicDetails(studentId) {
    // Fetch detailed student information via AJAX (Teacher Version)
    fetch(`/teacher/student/${studentId}/details/data`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        const container = document.getElementById(`student-details-${studentId}`);
        if (data.success) {
          container.innerHTML = formatStudentDetails(data.student);
        } else {
          container.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown error'}</div>`;
        }
      })
      .catch(error => {
        console.error('Error loading student details:', error);
        const container = document.getElementById(`student-details-${studentId}`);
        container.innerHTML = `<div class="alert alert-danger">Error loading student details: ${error.message}</div>`;
      });
  }
  
  function formatStudentDetails(student) {
    let html = '<div class="academic-details-container">';
    
    // Overall GPA Summary with modern cards
    html += '<div class="gpa-summary-section">';
    html += '<div class="gpa-summary-header">';
    html += '<i class="bi bi-graph-up-arrow"></i>';
    html += '<h6>Academic Performance Overview</h6>';
    html += '</div>';
    html += '<div class="gpa-cards-grid">';
    
    // Current GPA Card
    html += '<div class="gpa-stat-card gpa-current">';
    html += '<div class="gpa-stat-icon"><i class="bi bi-trophy"></i></div>';
    html += '<div class="gpa-stat-content">';
    html += '<div class="gpa-stat-label">Current GPA</div>';
    html += `<div class="gpa-stat-value">${student.current_gpa !== null ? student.current_gpa.toFixed(2) : 'N/A'}</div>`;
    html += '</div></div>';
    
    // Potential GPA Card
    html += '<div class="gpa-stat-card gpa-potential">';
    html += '<div class="gpa-stat-icon"><i class="bi bi-star-fill"></i></div>';
    html += '<div class="gpa-stat-content">';
    html += '<div class="gpa-stat-label">Potential GPA</div>';
    html += `<div class="gpa-stat-value gpa-potential-value">${student.hypothetical_gpa !== null ? student.hypothetical_gpa.toFixed(2) : 'N/A'}</div>`;
    html += '<div class="gpa-stat-note">If issues resolved</div>';
    html += '</div></div>';
    
    // GPA Improvement
    if (student.current_gpa && student.hypothetical_gpa) {
      const improvement = (student.hypothetical_gpa - student.current_gpa).toFixed(2);
      html += '<div class="gpa-stat-card gpa-improvement">';
      html += '<div class="gpa-stat-icon"><i class="bi bi-arrow-up-circle-fill"></i></div>';
      html += '<div class="gpa-stat-content">';
      html += '<div class="gpa-stat-label">Potential Gain</div>';
      html += `<div class="gpa-stat-value gpa-gain-value">+${improvement}</div>`;
      html += '<div class="gpa-stat-note">Points possible</div>';
      html += '</div></div>';
    }
    
    html += '</div></div>';
    
    // Missing & Failing Assignments by Class
    html += '<div class="assignments-section">';
    html += '<div class="assignments-section-header">';
    html += '<i class="bi bi-exclamation-diamond-fill"></i>';
    html += '<h6>Assignments Requiring Attention</h6>';
    html += '</div>';
    
    if (student.missing_assignments && Object.keys(student.missing_assignments).length > 0) {
      for (const [className, assignments] of Object.entries(student.missing_assignments)) {
        html += '<div class="class-assignments-group">';
        html += `<div class="class-name-header">${className}</div>`;
        
        // Class GPA indicator
        if (student.class_gpa && student.class_gpa[className]) {
          const classGpa = student.class_gpa[className];
          html += '<div class="class-gpa-indicator">';
          html += '<span class="class-gpa-label">Class GPA:</span>';
          html += `<span class="class-gpa-current">${classGpa.current !== null ? classGpa.current.toFixed(2) : 'N/A'}</span>`;
          if (classGpa.hypothetical !== null) {
            html += '<i class="bi bi-arrow-right mx-2"></i>';
            html += `<span class="class-gpa-potential">${classGpa.hypothetical.toFixed(2)}</span>`;
            html += '<span class="class-gpa-badge">potential</span>';
          }
          html += '</div>';
        }
        
        // Assignment cards
        html += '<div class="assignment-cards-grid">';
        assignments.forEach((assignment, idx) => {
          const isFailing = assignment.score !== null && assignment.score !== undefined && assignment.score !== 'N/A' && assignment.score <= 69;
          const isMissing = assignment.status === 'missing';
          const assignmentId = `assignment-${student.student_id || 'unknown'}-${idx}-${Date.now()}`;
          
          html += `<div class="assignment-concern-card ${isFailing ? 'card-failing' : 'card-warning'}" id="${assignmentId}">`;
          html += '<div class="assignment-concern-header">';
          html += `<div class="assignment-concern-icon ${isFailing ? 'icon-danger' : 'icon-warning'}">`;
          html += `<i class="bi bi-${isFailing ? 'x-circle' : 'exclamation-circle'}-fill"></i>`;
          html += '</div>';
          html += '<div class="assignment-concern-info">';
          html += `<div class="assignment-concern-title">${assignment.title}</div>`;
          html += `<div class="assignment-concern-due">`;
          html += `<i class="bi bi-calendar-event"></i> Due: ${assignment.due_date}`;
          html += '</div></div>';
          html += '</div>';
          
          html += '<div class="assignment-concern-footer">';
          // Assignment type badge
          if (assignment.assignment_type) {
            const typeLabels = {
              'pdf': 'PDF',
              'quiz': 'Quiz',
              'discussion': 'Discussion',
              'paper': 'Paper',
              'group_pdf': 'Group PDF',
              'group_quiz': 'Group Quiz',
              'group_discussion': 'Group Discussion'
            };
            const typeLabel = typeLabels[assignment.assignment_type.toLowerCase()] || assignment.assignment_type.toUpperCase();
            html += `<span class="assignment-type-badge" title="Assignment Type">`;
            html += `<i class="bi bi-${assignment.assignment_type.toLowerCase() === 'quiz' ? 'question-circle' : assignment.assignment_type.toLowerCase() === 'discussion' ? 'chat-dots' : 'file-earmark'}"></i>`;
            html += `${typeLabel}`;
            html += '</span>';
          }
          if (assignment.status) {
            html += `<span class="assignment-status-pill status-${assignment.status}">`;
            html += `<i class="bi bi-${assignment.status === 'missing' ? 'dash-circle' : 'exclamation-triangle'}-fill"></i>`;
            html += `${assignment.status}`;
            html += '</span>';
          }
          if (assignment.score !== null && assignment.score !== undefined && assignment.score !== 'N/A') {
            html += `<span class="assignment-score-badge ${assignment.score <= 69 ? 'score-failing' : 'score-warning'}">`;
            html += `${assignment.score}%`;
            html += '</span>';
          } else {
            html += '<span class="assignment-score-badge score-missing">Not Graded</span>';
          }
          html += '</div></div>';
        });
        html += '</div></div>';
      }
    } else {
      html += '<div class="no-assignments-message">';
      html += '<i class="bi bi-check-circle-fill"></i>';
      html += '<p>No assignments requiring attention at this time.</p>';
      html += '</div>';
    }
    
    html += '</div></div>';
    
    return html;
  }
</script>

<!-- Class Selection Modal -->
<div class="modal fade" id="selectClassModal" tabindex="-1" aria-labelledby="selectClassModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectClassModalLabel">
          <i class="bi bi-graph-up me-2"></i>Select a Class for Reports & Analytics
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Please select a class to view its Reports & Analytics:</p>
        <div class="list-group" id="classSelectList">
          <!-- Classes will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

{% endif %}
{% endblock %} 