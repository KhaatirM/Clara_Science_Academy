{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/management_role_teachers_staff.css') }}">
{% endblock %}

{% block dashboard_content %}


<div class="container-fluid px-2 px-md-4 py-4">
    <!-- Header Section -->
    <div class="staff-directory-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="header-title-staff mb-1">
                    <i class="bi bi-person-badge-fill me-2"></i>Teachers & Staff Directory
                </h2>
                <p class="header-subtitle-staff mb-0">
                    <span class="badge bg-white text-primary me-2">{{ teachers_staff|length }} Members</span>
                    <span class="text-white">Connect with colleagues and staff members</span>
                </p>
      </div>
          {% if current_user.role in ['Director', 'School Administrator'] %}
            <a href="{{ url_for('management.add_teacher_staff') }}" class="btn-add-staff">
                <i class="bi bi-person-plus-fill"></i>Add Teacher/Staff
            </a>
          {% endif %}
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stat-card-staff teachers">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon-staff icon-teachers">
                        <i class="bi bi-person-workspace"></i>
                    </div>
                    <div>
                        <div class="text-muted small fw-semibold">TEACHERS</div>
                        <div class="fs-4 fw-bold">
                            {% set teacher_count = namespace(value=0) %}
                            {% for staff in teachers_staff %}
                                {% if (staff.assigned_role and 'Teacher' in staff.assigned_role) or (staff.user and staff.user.role and 'Teacher' in staff.user.role) %}
                                    {% set teacher_count.value = teacher_count.value + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ teacher_count.value }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card-staff admins">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon-staff icon-admins">
                        <i class="bi bi-shield-fill-check"></i>
                    </div>
                    <div>
                        <div class="text-muted small fw-semibold">ADMINISTRATORS</div>
                        <div class="fs-4 fw-bold">
                            {% set admin_count = namespace(value=0) %}
                            {% for staff in teachers_staff %}
                                {% set role = staff.assigned_role if staff.assigned_role else (staff.user.role if staff.user else '') %}
                                {% if 'Administrator' in role or 'Director' in role %}
                                    {% set admin_count.value = admin_count.value + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ admin_count.value }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card-staff support">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon-staff icon-support">
                        <i class="bi bi-headset"></i>
                    </div>
                    <div>
                        <div class="text-muted small fw-semibold">SUPPORT STAFF</div>
                        <div class="fs-4 fw-bold">
                            {% set support_count = namespace(value=0) %}
                            {% for staff in teachers_staff %}
                                {% set role = staff.assigned_role if staff.assigned_role else (staff.user.role if staff.user else '') %}
                                {% if 'Support' in role or 'IT' in role %}
                                    {% set support_count.value = support_count.value + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ support_count.value }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Card -->
    <div class="search-card-staff">
        <form method="GET" action="{{ url_for('management.teachers') }}" class="row g-3 align-items-end">
            <div class="col-md-8">
                <label for="search_query" class="form-label fw-semibold">
                    <i class="bi bi-search me-1"></i>Search Staff Directory
                </label>
                <input type="text" 
                       class="form-control form-control-modern" 
                       id="search_query" 
                       name="search_query" 
                       value="{{ search_query or '' }}" 
                       placeholder="Search by name, email, role, or department..."
                       autocomplete="off">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-search-modern w-100">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('management.teachers') }}" class="btn btn-reset-modern w-100">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                </a>
            </div>
        </form>
    </div>
    
    <!-- Search Results Info -->
    {% if search_query %}
    <div class="alert alert-info border-0 shadow-sm mb-4" style="border-left: 4px solid #667eea !important;">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
            <div>
                <strong>Search Results:</strong> Found {{ teachers_staff|length }} staff member(s) matching "{{ search_query }}"
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Staff Cards Grid -->
    <div class="row g-4">
        {% for staff in teachers_staff %}
        {% set staff_role = staff.assigned_role if staff.assigned_role else (staff.user.role if staff.user else 'Staff Member') %}
        {% set staff_id = staff.staff_id if staff.staff_id else 'N/A' %}
        {% set staff_username = staff.user.username if staff.user else 'N/A' %}
        {% set staff_department = staff.department if staff.department else 'N/A' %}
        {% set employment_type = staff.employment_type if staff.employment_type else 'N/A' %}
        
        <div class="col-12 col-md-6 col-xl-4">
            <div class="staff-full-card">
                <!-- Card Header -->
                <div class="staff-full-card-header">
                    <div class="d-flex align-items-center gap-3">
                        <div class="staff-card-photo">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="staff-card-name mb-1">{{ staff.first_name }} {{ staff.last_name }}</h5>
                            <p class="staff-card-id mb-0">ID: {{ staff_id }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Card Body -->
                <div class="staff-full-card-body">
                    <!-- Role -->
                    <div class="staff-info-row">
                        <div class="staff-info-icon icon-role">
                            <i class="bi bi-award-fill"></i>
                        </div>
                        <div class="staff-info-content">
                            <div class="staff-info-label">Role</div>
                            <div class="staff-info-value">
                                {% if 'Director' in staff_role %}
                                    <span class="badge-role director">{{ staff_role }}</span>
                                {% elif 'Administrator' in staff_role %}
                                    <span class="badge-role admin">{{ staff_role }}</span>
                                {% elif 'Teacher' in staff_role %}
                                    <span class="badge-role teacher">{{ staff_role }}</span>
                                {% elif 'Support' in staff_role or 'IT' in staff_role %}
                                    <span class="badge-role support">{{ staff_role }}</span>
                                {% else %}
                                    <span class="badge-role default">{{ staff_role }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Department -->
                    <div class="staff-info-row">
                        <div class="staff-info-icon icon-dept">
                            <i class="bi bi-building"></i>
                        </div>
                        <div class="staff-info-content">
                            <div class="staff-info-label">Department</div>
                            <div class="staff-info-value">
                                <span class="badge-dept">{{ staff_department }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email -->
                    <div class="staff-info-row">
                        <div class="staff-info-icon icon-email">
                            <i class="bi bi-envelope-fill"></i>
                        </div>
                        <div class="staff-info-content">
                            <div class="staff-info-label">Email</div>
                            <div class="staff-info-value">{{ staff.email or 'N/A' }}</div>
                        </div>
                    </div>
                    
                    <!-- Username -->
                    <div class="staff-info-row">
                        <div class="staff-info-icon icon-username">
                            <i class="bi bi-person-badge"></i>
                        </div>
                        <div class="staff-info-content">
                            <div class="staff-info-label">Username</div>
                            <div class="staff-info-value">
                                <span class="badge-username">{{ staff_username }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employment Type -->
                    <div class="staff-info-row">
                        <div class="staff-info-icon icon-type">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="staff-info-content">
                            <div class="staff-info-label">Type</div>
                            <div class="staff-info-value">
                                <span class="badge-type">{{ employment_type }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Card Footer with Actions -->
                <div class="staff-full-card-footer">
                    <button class="btn-staff-action btn-staff-view" onclick="alert('View profile coming soon!')">
                        <i class="bi bi-eye"></i><span>View</span>
                    </button>
                    {% if current_user.role in ['Director', 'School Administrator'] %}
                    <a href="{{ url_for('management.edit_teacher_staff', staff_id=staff.id) }}" class="btn-staff-action btn-staff-edit">
                        <i class="bi bi-pencil-square"></i><span>Edit</span>
                    </a>
                    <button class="btn-staff-action btn-staff-remove remove-staff-btn" 
                            data-staff-id="{{ staff.id }}" 
                            data-staff-name="{{ staff.first_name }} {{ staff.last_name }}">
                        <i class="bi bi-trash"></i><span>Remove</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="text-center py-5" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 20px; padding: 4rem;">
                <i class="bi bi-person-x" style="font-size: 5rem; color: #667eea; opacity: 0.7;"></i>
                <h4 class="mt-4 mb-3 fw-bold">
                    {% if search_query %}
                        No Staff Members Found
                    {% else %}
                        No Staff Members Listed
                    {% endif %}
                </h4>
                <p class="text-muted">
                    {% if search_query %}
                        No teachers or staff found matching your search: "{{ search_query }}"
                    {% else %}
                        No teachers or staff are currently listed in the system.
                    {% endif %}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages and total_pages > 1 %}
    <nav aria-label="Teacher Staff navigation" class="mt-5">
        <ul class="pagination justify-content-center">
            {% set pagination_params = {'section': 'teachers_staff'} %}
            {% if search_query %}{% set _ = pagination_params.update({'search_query': search_query}) %}{% endif %}
            
            {% if current_user.role in ['Director', 'School Administrator'] %}
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link rounded-start" href="{{ url_for('management.teachers', page=page-1, **pagination_params) }}">
                        <i class="bi bi-chevron-left"></i> Previous
                    </a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('management.teachers', page=p, **pagination_params) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link rounded-end" href="{{ url_for('management.teachers', page=page+1, **pagination_params) }}">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    <!-- Results Summary -->
    {% if total_teachers_staff and (total_teachers_staff > 0 or search_query) %}
    <p class="text-center text-muted mt-3">
        <i class="bi bi-info-circle me-1"></i>
        Showing <strong>{{ teachers_staff|length }}</strong> 
        {% if search_query and teachers_staff|length != total_teachers_staff %}
            of <strong>{{ total_teachers_staff }}</strong> matching teachers/staff
        {% elif teachers_staff|length == total_teachers_staff and total_teachers_staff > 0 %}
            of <strong>{{ total_teachers_staff }}</strong> total teachers/staff
        {% else %}
            matching teachers/staff
        {% endif %}
    </p>
    {% endif %}
</div>

  {# Bootstrap Modal for Staff Credentials #}
  <div class="modal fade" id="staffCredentialsModal" tabindex="-1" aria-labelledby="staffCredentialsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staffCredentialsModalLabel">Staff Credentials</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Name:</strong> <span id="modal_staff_name"></span></p>
          <p><strong>Staff ID:</strong> <span id="modal_staff_id"></span></p> 
          <p><strong>Assigned Role:</strong> <span id="modal_staff_assigned_role"></span></p> 
          <p><strong>SSN:</strong> <span id="modal_staff_ssn"></span> <small class="text-muted">(Masked)</small></p>
          <p><strong>Email:</strong> <span id="modal_staff_email"></span></p>
          <hr>
          <h6 class="text-danger small">System Access (Confidential - For Admin Use)</h6>
          <p class="mb-1"><small><strong>Username:</strong> <span id="modal_staff_username"></span></small></p>
          <p class="mb-0"><small><strong>Generated Password:</strong> <span id="modal_staff_password"></span></small></p>
          <p class="mt-2 text-danger small"><strong>Security Warning:</strong> This generated password is shown for initial setup only. The staff member should be instructed to change it upon their first login if a self-service password change system were implemented. Storing or displaying plaintext passwords is a security risk.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const removeButtons = document.querySelectorAll('.remove-staff-btn');
      removeButtons.forEach(button => {
        button.addEventListener('click', function() {
          const staffId = this.dataset.staffId;
          const staffName = this.dataset.staffName;
          
          if (confirm(`Are you sure you want to remove ${staffName}? This action cannot be undone.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            
            {% if current_user.role in ['Director', 'School Administrator'] %}
              form.action = `{{ url_for('management.remove_teacher_staff', staff_id=0) }}`.replace('0', staffId);
            {% endif %}
            
            document.body.appendChild(form);
            form.submit();
          }
        });
      });
    });

    function maskSSN(ssn) {
        if (!ssn || typeof ssn !== 'string' || ssn.length < 4) { return "N/A"; }
        const lastFour = ssn.slice(-4);
        return `***-**-${lastFour}`;
    }

    function showStaffCredentials(staff) {
        console.log("Showing credentials for:", staff);
        if (!staff || typeof staff !== 'object') {
            console.error("Invalid staff data for credentials modal.");
            return;
        }

        document.getElementById('modal_staff_name').innerText = staff.name || 'N/A';
        document.getElementById('modal_staff_id').innerText = staff.staff_id || 'N/A'; 
        document.getElementById('modal_staff_assigned_role').innerText = staff.assigned_role || 'N/A';
        document.getElementById('modal_staff_ssn').innerText = maskSSN(staff.ssn);
        document.getElementById('modal_staff_email').innerText = staff.email || 'N/A';
        document.getElementById('modal_staff_username').innerText = staff.username || 'N/A'; 
        document.getElementById('modal_staff_password').innerText = staff.password || 'N/A'; 
    }
  </script>
{% endblock %} 