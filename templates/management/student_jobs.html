{% extends "shared/dashboard_layout.html" %}

{% block title %}Student Jobs Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-briefcase-fill me-2"></i>Student Jobs Management
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="exportToSheets()">
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export to Sheets
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inspectionModal">
                        <i class="bi bi-clipboard-check me-1"></i>Conduct Inspection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Point System Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-star-fill me-2"></i>Cleaning Crew Point System
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success mb-1">100</h4>
                                <small class="text-muted">Starting Points</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning mb-1">60</h4>
                                <small class="text-muted">Re-do Threshold</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info mb-1">+15</h4>
                                <small class="text-muted">Max Bonus Points</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-danger mb-1">-10/-5/-2</h4>
                                <small class="text-muted">Deduction Levels</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cleaning Teams Side by Side -->
    <div class="row mb-4">
        <!-- Cleanup Team 1 -->
        <div class="col-md-6 mb-3">
            <div class="card h-100 cleaning-team-card team-1-card shadow-sm">
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center position-relative overflow-hidden">
                    <div class="d-flex align-items-center">
                        <div class="team-icon-container me-3">
                            <i class="bi bi-people-fill team-icon"></i>
                        </div>
        <div>
            <h5 class="card-title mb-0">Cleanup Team 1</h5>
            <small class="opacity-75">Mondays, Wednesdays, 2nd & 4th Fridays</small>
        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="score-display me-3">
                            <span class="score-number" id="team1Score">100</span>
                            <small class="score-label">Points</small>
                        </div>
                        <button class="btn btn-sm btn-light btn-toggle" onclick="toggleTeam1()">
                            <i class="bi bi-chevron-down" id="team1Chevron"></i>
                        </button>
                    </div>
                    <div class="team-decoration"></div>
                </div>
                <div class="card-body" id="team1Content">
                    <div class="team-stats mb-4">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">8</div>
                                    <div class="stat-label">Members</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">4</div>
                                    <div class="stat-label">Classrooms</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">3</div>
                                    <div class="stat-label">Common Areas</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">2</div>
                                    <div class="stat-label">Weeks/Month</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cleaning-areas mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-geo-alt me-2"></i>Cleaning Areas
                        </h6>
                        <div class="areas-list">
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>4 Classrooms</li>
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Main Hallway</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Girls Bathroom</li>
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Boys Bathroom</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="team-members mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-people-fill me-2"></i>Team Members & Assignments
                        </h6>
                        <div class="clean-team-grid" id="team1Members">
                            {% if team_data %}
                                {% for team_entry in team_data.values() %}
                                    {% if team_entry.team.team_name == "Team 1" %}
                                        {% if team_entry.members %}
                                            {% for member in team_entry.members %}
                                <div class="team-member-card">
                                    <div class="member-header">
                                        <span class="member-name">{{ member.name }}</span>
                                        <span class="job-badge sweeping">{{ member.role }}</span>
                                    </div>
                                    <div class="job-details">Member of Cleanup Team 1</div>
                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="bi bi-people fs-1 mb-3"></i>
                                                <p>No members assigned yet</p>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="col-12 text-center text-muted py-4">
                                    <i class="bi bi-people fs-1 mb-3"></i>
                                    <p>No members assigned yet</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="team-actions">
                        <button class="btn btn-success btn-inspect" onclick="recordInspection('team1')">
                            <i class="bi bi-clipboard-check me-2"></i>Record Inspection
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="viewTeamHistory('team1')">
                            <i class="bi bi-clock-history me-1"></i>History
                        </button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMembersModal" onclick="openAddMembersModal(1)">
                            <i class="bi bi-person-plus me-1"></i>Add Members
                        </button>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#removeMembersModal" onclick="openRemoveMembersModal(1)">
                            <i class="bi bi-person-dash me-1"></i>Remove Members
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cleanup Team 2 -->
        <div class="col-md-6 mb-3">
            <div class="card h-100 cleaning-team-card team-2-card shadow-sm">
                <div class="card-header bg-gradient-secondary text-white d-flex justify-content-between align-items-center position-relative overflow-hidden">
                    <div class="d-flex align-items-center">
                        <div class="team-icon-container me-3">
                            <i class="bi bi-people-fill team-icon"></i>
                        </div>
        <div>
            <h5 class="card-title mb-0">Cleanup Team 2</h5>
            <small class="opacity-75">Tuesdays, Thursdays, 1st & 3rd Fridays</small>
        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="score-display me-3">
                            <span class="score-number" id="team2Score">100</span>
                            <small class="score-label">Points</small>
                        </div>
                        <button class="btn btn-sm btn-light btn-toggle" onclick="toggleTeam2()">
                            <i class="bi bi-chevron-down" id="team2Chevron"></i>
                        </button>
                    </div>
                    <div class="team-decoration"></div>
                </div>
                <div class="card-body" id="team2Content">
                    <div class="team-stats mb-4">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">8</div>
                                    <div class="stat-label">Members</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">4</div>
                                    <div class="stat-label">Classrooms</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">3</div>
                                    <div class="stat-label">Common Areas</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number">2</div>
                                    <div class="stat-label">Weeks/Month</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cleaning-areas mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-geo-alt me-2"></i>Cleaning Areas
                        </h6>
                        <div class="areas-list">
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>4 Classrooms</li>
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Main Hallway</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Girls Bathroom</li>
                                        <li><i class="bi bi-check-circle-fill text-success me-2"></i>Boys Bathroom</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="team-members mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-people-fill me-2"></i>Team Members & Assignments
                        </h6>
                        <div class="clean-team-grid" id="team2Members">
                            {% if team_data %}
                                {% for team_entry in team_data.values() %}
                                    {% if team_entry.team.team_name == "Team 2" %}
                                        {% if team_entry.members %}
                                            {% for member in team_entry.members %}
                                <div class="team-member-card">
                                    <div class="member-header">
                                        <span class="member-name">{{ member.name }}</span>
                                        <span class="job-badge sweeping">{{ member.role }}</span>
                                    </div>
                                    <div class="job-details">Member of Cleanup Team 2</div>
                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="bi bi-people fs-1 mb-3"></i>
                                                <p>No members assigned yet</p>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="col-12 text-center text-muted py-4">
                                    <i class="bi bi-people fs-1 mb-3"></i>
                                    <p>No members assigned yet</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="team-actions">
                        <button class="btn btn-success btn-inspect" onclick="recordInspection('team2')">
                            <i class="bi bi-clipboard-check me-2"></i>Record Inspection
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="viewTeamHistory('team2')">
                            <i class="bi bi-clock-history me-1"></i>History
                        </button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMembersModal" onclick="openAddMembersModal(2)">
                            <i class="bi bi-person-plus me-1"></i>Add Members
                        </button>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#removeMembersModal" onclick="openRemoveMembersModal(2)">
                            <i class="bi bi-person-dash me-1"></i>Remove Members
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Computer Cleanup & Setup Team -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-laptop me-2"></i>Computer Cleanup & Setup Team
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2" id="computerTeamScore">100 Points</span>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleComputerTeam()">
                            <i class="bi bi-chevron-down" id="computerTeamChevron"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="computerTeamContent">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6><i class="bi bi-person-check me-1"></i>Team Members:</h6>
                            <p class="mb-2">Muaci Ajuwa, Godanse Ajuwa, Zawadi Ajuwa, Deborah Ajuwa, Manasseh Ajuwa, Jeannette Ajuwa</p>
                            <small class="text-muted">Responsible for setting up and putting up all laptops</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-info" onclick="recordComputerInspection()">
                                <i class="bi bi-clipboard-check me-1"></i>Record Inspection
                            </button>
                        </div>
                    </div>
                    
                    <!-- Computer Team Point System -->
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-calculator me-1"></i>Point Deduction System</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="bi bi-laptop text-danger me-1"></i>Computer left out</span>
                                        <span class="badge bg-danger">-10 points</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="bi bi-tablet text-warning me-1"></i>Tablet left out</span>
                                        <span class="badge bg-warning">-8 points</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="bi bi-lightning text-info me-1"></i>Charger left out</span>
                                        <span class="badge bg-info">-5 points</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="bi bi-headphones text-primary me-1"></i>Headphones left out</span>
                                        <span class="badge bg-primary">-5 points</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="bi bi-plug text-secondary me-1"></i>Extension cord left out</span>
                                        <span class="badge bg-secondary">-3 points</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold">Starting Points</span>
                                        <span class="badge bg-success">100 points</span>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Stacking:</strong> Multiple items can be left out and points will be deducted for each item.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Team Management System -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>Dynamic Team Management
                    </h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                        <i class="bi bi-plus-circle me-1"></i>Create New Team
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="dynamicTeamsContainer">
                        <!-- Teams will be dynamically added here -->
                        <div class="col-12 text-center text-muted py-4">
                            <i class="bi bi-people fs-1 mb-3"></i>
                            <h5>No Teams Created Yet</h5>
                            <p>Click "Create New Team" to start building custom teams for experiments or special projects.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inspection History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>Inspection History
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Team</th>
                                    <th>Score</th>
                                    <th>Deductions</th>
                                    <th>Bonuses</th>
                                    <th>Status</th>
                                    <th>Inspector</th>
                                </tr>
                            </thead>
                            <tbody id="inspectionHistory">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No inspections recorded yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Members Modal -->
<div class="modal fade" id="addMembersModal" tabindex="-1" aria-labelledby="addMembersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addMembersModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Add Members to Cleanup Team
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="addMemberSearch" class="form-label">Search Students</label>
                    <input type="text" class="form-control" id="addMemberSearch" placeholder="Search by name..." onkeyup="filterAddMembers(this.value)">
                </div>
                <div id="addMembersContainer" class="row" style="max-height: 400px; overflow-y: auto;">
                    <!-- Students will be dynamically loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedMembers()">
                    <i class="bi bi-check-circle me-1"></i>Add Selected Members
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Members Modal -->
<div class="modal fade" id="removeMembersModal" tabindex="-1" aria-labelledby="removeMembersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="removeMembersModalLabel">
                    <i class="bi bi-person-dash me-2"></i>Remove Members from Cleanup Team
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="removeMemberSearch" class="form-label">Search Team Members</label>
                    <input type="text" class="form-control" id="removeMemberSearch" placeholder="Search by name..." onkeyup="filterRemoveMembers(this.value)">
                </div>
                <div id="removeMembersContainer" class="row" style="max-height: 400px; overflow-y: auto;">
                    <!-- Current team members will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="removeSelectedMembers()">
                    <i class="bi bi-trash me-1"></i>Remove Selected Members
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Team Modal -->
<div class="modal fade" id="createTeamModal" tabindex="-1" aria-labelledby="createTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createTeamModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Create New Team
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createTeamForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="teamName" class="form-label">Team Name</label>
                            <input type="text" class="form-control" id="teamName" required placeholder="e.g., Experiment Team A">
                        </div>
                        <div class="col-md-6">
                            <label for="teamType" class="form-label">Team Type</label>
                            <select class="form-select" id="teamType" required>
                                <option value="">Select team type...</option>
                                <option value="experiment">Experiment Team</option>
                                <option value="project">Project Team</option>
                                <option value="special">Special Assignment</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="teamDescription" class="form-label">Team Description</label>
                        <textarea class="form-control" id="teamDescription" rows="2" placeholder="Brief description of the team's purpose..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Team Members</label>
                        <div class="row" id="studentSelectionContainer">
                            <!-- Students will be dynamically loaded here -->
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading students...</span>
                                </div>
                                <p class="mt-2">Loading students...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Note:</strong> You can always add or remove members from teams later using the team management tools.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewTeam()">
                    <i class="bi bi-plus-circle me-1"></i>Create Team
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Inspection Modal -->
<div class="modal fade" id="inspectionModal" tabindex="-1" aria-labelledby="inspectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="inspectionModalLabel">
                    <i class="bi bi-clipboard-check me-2"></i>Conduct Cleaning Crew Inspection
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inspectionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="teamSelect" class="form-label">Select Team</label>
                            <select class="form-select" id="teamSelect" required>
                                <option value="">Choose a team...</option>
                                <option value="team1">Cleanup Team 1</option>
                                <option value="team2">Cleanup Team 2</option>
                                <option value="computer">Computer Cleanup & Setup Team</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="inspectionDate" class="form-label">Inspection Date</label>
                            <input type="date" class="form-control" id="inspectionDate" required>
                        </div>
                    </div>

                    <!-- Computer Team Deductions -->
                    <div class="card mb-3 border-info" id="computerTeamDeductions" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-laptop me-1"></i>Computer Team Deductions (Stackable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="computerLeftOut">
                                        <label class="form-check-label" for="computerLeftOut">
                                            Computer left out (-10 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="tabletLeftOut">
                                        <label class="form-check-label" for="tabletLeftOut">
                                            Tablet left out (-8 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="chargerLeftOut">
                                        <label class="form-check-label" for="chargerLeftOut">
                                            Charger left out (-5 points)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="headphonesLeftOut">
                                        <label class="form-check-label" for="headphonesLeftOut">
                                            Headphones left out (-5 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="extensionCordLeftOut">
                                        <label class="form-check-label" for="extensionCordLeftOut">
                                            Extension cord left out (-3 points)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-2 mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Note:</strong> Multiple items can be selected and points will be deducted for each item.
                            </div>
                        </div>
                    </div>

                    <!-- Cleanup Team Deductions -->
                    <div class="card mb-3 border-danger" id="cleanupTeamDeductions">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1"></i>Cleanup Team Deductions (Stackable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="bathroomNotRestocked">
                                        <label class="form-check-label" for="bathroomNotRestocked">
                                            Bathrooms not restocked (no paper towels or soap) (-10 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="trashCanLeftFull">
                                        <label class="form-check-label" for="trashCanLeftFull">
                                            Trash can left full (liner not replaced) (-10 points)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="floorNotSwept">
                                        <label class="form-check-label" for="floorNotSwept">
                                            Classroom floor not swept (large debris remains) (-10 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="materialsLeftOut">
                                        <label class="form-check-label" for="materialsLeftOut">
                                            Cleaning materials left out in area (-10 points)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-2 mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Note:</strong> Multiple items can be selected and points will be deducted for each item.
                            </div>
                        </div>
                    </div>

                    <!-- Moderate Deductions (-5 Points) -->
                    <div class="card mb-3 border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-exclamation-circle me-1"></i>Moderate Deductions (-5 Points each)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="tablesMissed">
                                        <label class="form-check-label" for="tablesMissed">
                                            Tables/desks missed or left sticky/dirty
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="classroomTrashFull">
                                        <label class="form-check-label" for="classroomTrashFull">
                                            Classroom trash can left full
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="bathroomFloorPoor">
                                        <label class="form-check-label" for="bathroomFloorPoor">
                                            Bathroom floor swept poorly (debris in corners)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="notFinishedOnTime">
                                        <label class="form-check-label" for="notFinishedOnTime">
                                            Team not finished by deadline
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Minor Deductions (-2 Points) -->
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-1"></i>Minor Deductions (-2 Points each)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="smallDebrisLeft">
                                        <label class="form-check-label" for="smallDebrisLeft">
                                            Small debris left in classroom flow areas
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="trashSpilled">
                                        <label class="form-check-label" for="trashSpilled">
                                            Trash spilled near cans
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="dispensersHalfFilled">
                                        <label class="form-check-label" for="dispensersHalfFilled">
                                            Paper towel/soap dispensers only half-filled
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bonus Points -->
                    <div class="card mb-3 border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-star-fill me-1"></i>Bonus Points (+15 Max)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="exceptionalFinish">
                                        <label class="form-check-label" for="exceptionalFinish">
                                            Exceptional finish - completely spotless (+5 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="speedEfficiency">
                                        <label class="form-check-label" for="speedEfficiency">
                                            Finished 15 minutes early (+5 points)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="goingAboveBeyond">
                                        <label class="form-check-label" for="goingAboveBeyond">
                                            Cleaned unassigned area (+3 points)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="teamworkAward">
                                        <label class="form-check-label" for="teamworkAward">
                                            Exceptional teamwork observed (+2 points)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="inspectorNotes" class="form-label">Inspector Notes</label>
                            <textarea class="form-control" id="inspectorNotes" rows="3" placeholder="Additional comments about the inspection..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="inspectorName" class="form-label">Inspector Name</label>
                            <input type="text" class="form-control" id="inspectorName" required placeholder="Your name">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitInspection()">
                    <i class="bi bi-check-circle me-1"></i>Submit Inspection
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Team toggle functionality
function toggleTeam1() {
    const content = document.getElementById('team1Content');
    const chevron = document.getElementById('team1Chevron');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
    } else {
        content.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
    }
}

function toggleTeam2() {
    const content = document.getElementById('team2Content');
    const chevron = document.getElementById('team2Chevron');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
    } else {
        content.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
    }
}

function toggleComputerTeam() {
    const content = document.getElementById('computerTeamContent');
    const chevron = document.getElementById('computerTeamChevron');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
    } else {
        content.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
    }
}

// Show/hide team-specific inspection sections
function toggleInspectionSections() {
    const teamSelect = document.getElementById('teamSelect');
    const computerDeductions = document.getElementById('computerTeamDeductions');
    const cleanupDeductions = document.getElementById('cleanupTeamDeductions');
    
    if (teamSelect.value === 'computer') {
        computerDeductions.style.display = 'block';
        cleanupDeductions.style.display = 'none';
    } else {
        computerDeductions.style.display = 'none';
        cleanupDeductions.style.display = 'block';
    }
}

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inspectionDate').value = today;
});

// Calculate and display score
function calculateScore() {
    const team = document.getElementById('teamSelect').value;
    if (!team) return;
    
    let score = 100;
    
    if (team === 'computer') {
        // Computer team deductions (stackable)
        if (document.getElementById('computerLeftOut').checked) score -= 10;
        if (document.getElementById('tabletLeftOut').checked) score -= 8;
        if (document.getElementById('chargerLeftOut').checked) score -= 5;
        if (document.getElementById('headphonesLeftOut').checked) score -= 5;
        if (document.getElementById('extensionCordLeftOut').checked) score -= 3;
    } else {
        // Cleanup team deductions (stackable)
        const cleanupDeductions = [
            'bathroomNotRestocked', 'trashCanLeftFull', 'floorNotSwept', 'materialsLeftOut'
        ];
        cleanupDeductions.forEach(id => {
            if (document.getElementById(id).checked) {
                score -= 10;
            }
        });
        
        // Moderate deductions (-5 points each)
        const moderateDeductions = [
            'tablesMissed', 'classroomTrashFull', 'bathroomFloorPoor', 'notFinishedOnTime'
        ];
        moderateDeductions.forEach(id => {
            if (document.getElementById(id).checked) {
                score -= 5;
            }
        });
        
        // Minor deductions (-2 points each)
        const minorDeductions = [
            'smallDebrisLeft', 'trashSpilled', 'dispensersHalfFilled'
        ];
        minorDeductions.forEach(id => {
            if (document.getElementById(id).checked) {
                score -= 2;
            }
        });
    }
    
    // Bonus points (+15 max) - applies to all teams
    let bonus = 0;
    if (document.getElementById('exceptionalFinish').checked) bonus += 5;
    if (document.getElementById('speedEfficiency').checked) bonus += 5;
    if (document.getElementById('goingAboveBeyond').checked) bonus += 3;
    if (document.getElementById('teamworkAward').checked) bonus += 2;
    
    score += bonus;
    
    // Display calculated score
    const scoreDisplay = document.getElementById('calculatedScore');
    if (scoreDisplay) {
        scoreDisplay.textContent = `${score} Points`;
        scoreDisplay.className = score <= 60 ? 'text-danger' : score < 80 ? 'text-warning' : 'text-success';
    }
}

// Submit inspection
function submitInspection() {
    const team = document.getElementById('teamSelect').value;
    const date = document.getElementById('inspectionDate').value;
    const inspector = document.getElementById('inspectorName').value;
    const notes = document.getElementById('inspectorNotes').value;
    
    if (!team || !date || !inspector) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Calculate final score
    let score = 100;
    let deductions = 0;
    let bonuses = 0;
    
    if (team === 'computer') {
        // Computer team deductions (stackable)
        if (document.getElementById('computerLeftOut').checked) {
            score -= 10;
            deductions += 10;
        }
        if (document.getElementById('tabletLeftOut').checked) {
            score -= 8;
            deductions += 8;
        }
        if (document.getElementById('chargerLeftOut').checked) {
            score -= 5;
            deductions += 5;
        }
        if (document.getElementById('headphonesLeftOut').checked) {
            score -= 5;
            deductions += 5;
        }
        if (document.getElementById('extensionCordLeftOut').checked) {
            score -= 3;
            deductions += 3;
        }
    } else {
        // Cleanup team deductions (stackable)
        const cleanupDeductions = [
            'bathroomNotRestocked', 'trashCanLeftFull', 'floorNotSwept', 'materialsLeftOut'
        ];
        cleanupDeductions.forEach(id => {
            if (document.getElementById(id).checked) {
                score -= 10;
                deductions += 10;
            }
        });
        
        // Moderate deductions
        const moderateDeductions = [
            'tablesMissed', 'classroomTrashFull', 'bathroomFloorPoor', 'notFinishedOnTime'
        ];
        moderateDeductions.forEach(id => {
            if (document.getElementById(id).checked) {
                score -= 5;
                deductions += 5;
            }
        });
        
        // Minor deductions
        const minorDeductions = [
            'smallDebrisLeft', 'trashSpilled', 'dispensersHalfFilled'
        ];
        minorDeductions.forEach(id => {
            if (document.getElementById(id).checked) {
                score -= 2;
                deductions += 2;
            }
        });
    }
    
    // Bonus points
    if (document.getElementById('exceptionalFinish').checked) bonuses += 5;
    if (document.getElementById('speedEfficiency').checked) bonuses += 5;
    if (document.getElementById('goingAboveBeyond').checked) bonuses += 3;
    if (document.getElementById('teamworkAward').checked) bonuses += 2;
    
    score += bonuses;
    
    // Update team score display
    let teamScoreElement, teamName;
    if (team === 'computer') {
        teamScoreElement = document.getElementById('computerTeamScore');
        teamName = 'Computer Cleanup & Setup Team';
    } else {
        teamScoreElement = document.getElementById(`${team}Score`);
        teamName = team === 'team1' ? 'Cleanup Team 1' : 'Cleanup Team 2';
    }
    
    teamScoreElement.textContent = `${score} Points`;
    teamScoreElement.className = score <= 60 ? 'badge bg-danger' : score < 80 ? 'badge bg-warning' : 'badge bg-success';
    
    // Collect detailed inspection data
    const inspectionData = {
        team_id: team === 'team1' ? 1 : team === 'team2' ? 2 : 3,
        inspection_date: date,
        inspector_name: inspector,
        inspector_notes: notes,
        final_score: score,
        major_deductions: deductions,
        bonus_points: bonuses,
        // Detailed flags
        bathroom_not_restocked: document.getElementById('bathroomNotRestocked').checked,
        trash_can_left_full: document.getElementById('trashCanLeftFull').checked,
        floor_not_swept: document.getElementById('floorNotSwept').checked,
        materials_left_out: document.getElementById('materialsLeftOut').checked,
        tables_missed: document.getElementById('tablesMissed').checked,
        classroom_trash_full: document.getElementById('classroomTrashFull').checked,
        bathroom_floor_poor: document.getElementById('bathroomFloorPoor').checked,
        not_finished_on_time: document.getElementById('notFinishedOnTime').checked,
        small_debris_left: document.getElementById('smallDebrisLeft').checked,
        trash_spilled: document.getElementById('trashSpilled').checked,
        dispensers_half_filled: document.getElementById('dispensersHalfFilled').checked,
        exceptional_finish: document.getElementById('exceptionalFinish').checked,
        speed_efficiency: document.getElementById('speedEfficiency').checked,
        going_above_beyond: document.getElementById('goingAboveBeyond').checked,
        teamwork_award: document.getElementById('teamworkAward').checked
    };
    
    // Save inspection to database
    fetch('/management/api/save-inspection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(inspectionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to inspection history UI
            addInspectionToHistory(date, teamName, score, deductions, bonuses, score <= 60 ? 'Failed - Re-do Required' : 'Passed', inspector);
            
            // Show result alert
            const status = score <= 60 ? 'FAILED' : 'PASSED';
            const alertType = score <= 60 ? 'danger' : 'success';
            const message = score <= 60 ? 
                `${teamName} scored ${score} points and must redo cleaning next week.` :
                `${teamName} scored ${score} points and passed inspection.`;
            
            showAlert(message, alertType);
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('inspectionModal'));
            modal.hide();
            document.getElementById('inspectionForm').reset();
            document.getElementById('inspectionDate').value = new Date().toISOString().split('T')[0];
        } else {
            showAlert('Failed to save inspection: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving inspection:', error);
        showAlert('Error saving inspection. Please try again.', 'danger');
    });
}

// Add inspection to history table
function addInspectionToHistory(date, team, score, deductions, bonuses, status, inspector) {
    const tbody = document.getElementById('inspectionHistory');
    
    // Remove "No inspections" row if it exists
    const noDataRow = tbody.querySelector('td[colspan="7"]');
    if (noDataRow) {
        noDataRow.parentElement.remove();
    }
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${date}</td>
        <td>${team}</td>
        <td><span class="badge ${score <= 60 ? 'bg-danger' : score < 80 ? 'bg-warning' : 'bg-success'}">${score}</span></td>
        <td>${deductions}</td>
        <td>${bonuses}</td>
        <td><span class="badge ${status.includes('Failed') ? 'bg-danger' : 'bg-success'}">${status}</span></td>
        <td>${inspector}</td>
    `;
    
    tbody.insertBefore(row, tbody.firstChild);
}

// Show alert message
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// Export to sheets functionality
function exportToSheets() {
    // This would integrate with Google Sheets API in a real implementation
    alert('Export to Sheets functionality would be implemented here. This would send the current team data and inspection history to a Google Sheet.');
}

// Record inspection button functionality
function recordInspection(team) {
    document.getElementById('teamSelect').value = team;
    toggleInspectionSections();
    const modal = new bootstrap.Modal(document.getElementById('inspectionModal'));
    modal.show();
}

function recordComputerInspection() {
    document.getElementById('teamSelect').value = 'computer';
    toggleInspectionSections();
    const modal = new bootstrap.Modal(document.getElementById('inspectionModal'));
    modal.show();
}

function viewTeamHistory(teamId) {
    // This would show team inspection history
    const teamName = teamId === 'team1' ? 'Cleanup Team 1' : 'Cleanup Team 2';
    showAlert(`Viewing inspection history for ${teamName}. This feature will show past inspections, scores, and trends.`, 'info');
}

// Dynamic Team Management Functions
let allStudents = [];
let dynamicTeams = [];

// Load students when modal opens
document.getElementById('createTeamModal').addEventListener('show.bs.modal', function() {
    loadStudents();
});

function loadStudents() {
    // Fetch students from the backend
    fetch('/management/api/students')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allStudents = data.students.map(student => ({
                    id: student.id,
                    name: `${student.first_name} ${student.last_name}`
                }));
                renderStudentSelection();
            } else {
                console.error('Failed to load students:', data.error);
                showAlert('Failed to load students from database.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading students:', error);
            showAlert('Error loading students. Please try again.', 'danger');
        });
}

function renderStudentSelection() {
    const container = document.getElementById('studentSelectionContainer');
    container.innerHTML = '';
    
    allStudents.forEach(student => {
        const col = document.createElement('div');
        col.className = 'col-md-4 col-sm-6 mb-2';
        col.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="student_${student.id}" value="${student.id}">
                <label class="form-check-label" for="student_${student.id}">
                    ${student.name}
                </label>
            </div>
        `;
        container.appendChild(col);
    });
}

function createNewTeam() {
    const teamName = document.getElementById('teamName').value;
    const teamType = document.getElementById('teamType').value;
    const teamDescription = document.getElementById('teamDescription').value;
    
    if (!teamName || !teamType) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Get selected students
    const selectedStudents = [];
    document.querySelectorAll('#studentSelectionContainer input[type="checkbox"]:checked').forEach(checkbox => {
        const studentId = parseInt(checkbox.value);
        const student = allStudents.find(s => s.id === studentId);
        if (student) {
            selectedStudents.push(student);
        }
    });
    
    if (selectedStudents.length === 0) {
        alert('Please select at least one team member.');
        return;
    }
    
    // Prepare team data for backend
    const teamData = {
        name: teamName,
        type: teamType,
        description: teamDescription,
        members: selectedStudents.map(student => student.id)
    };
    
    // Save team to backend
    fetch('/management/api/dynamic-teams', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(teamData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create team object for frontend
            const newTeam = {
                id: data.team_id,
                name: teamName,
                type: teamType,
                description: teamDescription,
                members: selectedStudents,
                score: 100,
                created: new Date()
            };
            
            // Add to teams array
            dynamicTeams.push(newTeam);
            
            // Render the new team
            renderDynamicTeams();
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTeamModal'));
            modal.hide();
            document.getElementById('createTeamForm').reset();
            
            showAlert(`Team "${teamName}" created successfully with ${selectedStudents.length} members!`, 'success');
        } else {
            console.error('Failed to create team:', data.error);
            showAlert('Failed to create team. Please try again.', 'danger');
        }
    })
    .catch(error => {
        console.error('Error creating team:', error);
        showAlert('Error creating team. Please try again.', 'danger');
    });
}

function renderDynamicTeams() {
    const container = document.getElementById('dynamicTeamsContainer');
    
    if (dynamicTeams.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <i class="bi bi-people fs-1 mb-3"></i>
                <h5>No Teams Created Yet</h5>
                <p>Click "Create New Team" to start building custom teams for experiments or special projects.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    dynamicTeams.forEach(team => {
        const col = document.createElement('div');
        col.className = 'col-lg-4 col-md-6 mb-3';
        
        const typeColors = {
            'experiment': 'border-success',
            'project': 'border-info',
            'special': 'border-warning',
            'other': 'border-secondary'
        };
        
        const typeIcons = {
            'experiment': 'bi-flask',
            'project': 'bi-briefcase',
            'special': 'bi-star',
            'other': 'bi-people'
        };
        
        col.innerHTML = `
            <div class="card h-100 ${typeColors[team.type] || 'border-secondary'}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="${typeIcons[team.type] || 'bi-people'} me-2"></i>${team.name}
                    </h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="editTeam(${team.id})"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                            <li><a class="dropdown-item" href="#" onclick="recordTeamInspection(${team.id})"><i class="bi bi-clipboard-check me-2"></i>Inspect</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteTeam(${team.id})"><i class="bi bi-trash me-2"></i>Delete</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text small text-muted mb-3">${team.description || 'No description provided'}</p>
                    <h6 class="small mb-2">Members (${team.members.length}):</h6>
                    <div class="mb-3">
                        ${team.members.map(member => `<span class="badge bg-light text-dark me-1 mb-1">${member.name}</span>`).join('')}
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-${team.score >= 80 ? 'success' : team.score >= 60 ? 'warning' : 'danger'}">${team.score} Points</span>
                        <small class="text-muted">Created: ${team.created.toLocaleDateString()}</small>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

function editTeam(teamId) {
    const team = dynamicTeams.find(t => t.id === teamId);
    if (team) {
        // Populate form with team data
        document.getElementById('teamName').value = team.name;
        document.getElementById('teamType').value = team.type;
        document.getElementById('teamDescription').value = team.description;
        
        // Check selected students
        document.querySelectorAll('#studentSelectionContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = team.members.some(member => member.id === parseInt(checkbox.value));
        });
        
        // Show modal for editing
        const modal = new bootstrap.Modal(document.getElementById('createTeamModal'));
        modal.show();
        
        // Change button text
        document.querySelector('#createTeamModal .btn-primary').innerHTML = '<i class="bi bi-check-circle me-1"></i>Update Team';
        document.querySelector('#createTeamModal .btn-primary').onclick = () => updateTeam(teamId);
    }
}

function updateTeam(teamId) {
    const teamIndex = dynamicTeams.findIndex(t => t.id === teamId);
    if (teamIndex !== -1) {
        const teamName = document.getElementById('teamName').value;
        const teamType = document.getElementById('teamType').value;
        const teamDescription = document.getElementById('teamDescription').value;
        
        // Get selected students
        const selectedStudents = [];
        document.querySelectorAll('#studentSelectionContainer input[type="checkbox"]:checked').forEach(checkbox => {
            const studentId = parseInt(checkbox.value);
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                selectedStudents.push(student);
            }
        });
        
        // Prepare team data for backend
        const teamData = {
            name: teamName,
            type: teamType,
            description: teamDescription,
            members: selectedStudents.map(student => student.id)
        };
        
        // Update team in backend
        fetch(`/management/api/dynamic-teams/${teamId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(teamData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update team in frontend
                dynamicTeams[teamIndex] = {
                    ...dynamicTeams[teamIndex],
                    name: teamName,
                    type: teamType,
                    description: teamDescription,
                    members: selectedStudents
                };
                
                renderDynamicTeams();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('createTeamModal'));
                modal.hide();
                
                // Reset button
                document.querySelector('#createTeamModal .btn-primary').innerHTML = '<i class="bi bi-plus-circle me-1"></i>Create Team';
                document.querySelector('#createTeamModal .btn-primary').onclick = createNewTeam;
                
                showAlert(`Team "${teamName}" updated successfully!`, 'success');
            } else {
                console.error('Failed to update team:', data.error);
                showAlert('Failed to update team. Please try again.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error updating team:', error);
            showAlert('Error updating team. Please try again.', 'danger');
        });
    }
}

function deleteTeam(teamId) {
    if (confirm('Are you sure you want to delete this team? This action cannot be undone.')) {
        // Delete team from backend
        fetch(`/management/api/dynamic-teams/${teamId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove team from frontend
                dynamicTeams = dynamicTeams.filter(t => t.id !== teamId);
                renderDynamicTeams();
                showAlert('Team deleted successfully!', 'info');
            } else {
                console.error('Failed to delete team:', data.error);
                showAlert('Failed to delete team. Please try again.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting team:', error);
            showAlert('Error deleting team. Please try again.', 'danger');
        });
    }
}

function recordTeamInspection(teamId) {
    const team = dynamicTeams.find(t => t.id === teamId);
    if (team) {
        document.getElementById('teamSelect').value = 'team1'; // Use existing inspection system
        toggleInspectionSections();
        const modal = new bootstrap.Modal(document.getElementById('inspectionModal'));
        modal.show();
    }
}

// Add event listeners for score calculation
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('#inspectionModal input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', calculateScore);
    });
    
    // Add event listener for team selection changes
    const teamSelect = document.getElementById('teamSelect');
    if (teamSelect) {
        teamSelect.addEventListener('change', toggleInspectionSections);
    }
    
    // Initialize dynamic teams display
    loadExistingTeams();
});

// Member Management Functions
let currentTeamId = null;
let allAvailableStudents = [];
let currentTeamMembers = [];

function openAddMembersModal(teamId) {
    currentTeamId = teamId;
    
    // Load all students from database
    fetch('/management/api/students')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allAvailableStudents = data.students;
                
                // Get current team members to exclude them
                fetchTeamMembers(teamId).then(members => {
                    const memberIds = members.map(m => m.id);
                    renderAddMembers(allAvailableStudents.filter(s => !memberIds.includes(s.id)));
                });
            } else {
                console.error('Failed to load students');
            }
        })
        .catch(error => {
            console.error('Error loading students:', error);
        });
}

function fetchTeamMembers(teamId) {
    return fetch(`/management/api/team-members/${teamId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                return data.members;
            }
            return [];
        })
        .catch(error => {
            console.error('Error loading team members:', error);
            return [];
        });
}

function renderAddMembers(students) {
    const container = document.getElementById('addMembersContainer');
    container.innerHTML = '';
    
    students.forEach(student => {
        const col = document.createElement('div');
        col.className = 'col-md-6 mb-2';
        col.innerHTML = `
            <div class="form-check p-2 border rounded">
                <input class="form-check-input" type="checkbox" id="add_student_${student.id}" value="${student.id}">
                <label class="form-check-label" for="add_student_${student.id}">
                    ${student.first_name} ${student.last_name}
                </label>
            </div>
        `;
        container.appendChild(col);
    });
}

function filterAddMembers(searchTerm) {
    const allRows = document.querySelectorAll('#addMembersContainer .col-md-6');
    allRows.forEach(row => {
        const label = row.querySelector('label').textContent.toLowerCase();
        if (label.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function addSelectedMembers() {
    const selectedIds = [];
    document.querySelectorAll('#addMembersContainer input[type="checkbox"]:checked').forEach(checkbox => {
        selectedIds.push(parseInt(checkbox.value));
    });
    
    if (selectedIds.length === 0) {
        alert('Please select at least one member to add.');
        return;
    }
    
    // Send to backend
    fetch(`/management/api/team-members/${currentTeamId}/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({student_ids: selectedIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Members added successfully!', 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addMembersModal'));
            modal.hide();
            // Reload page to reflect changes
            location.reload();
        } else {
            showAlert('Failed to add members: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error adding members:', error);
        showAlert('Error adding members. Please try again.', 'danger');
    });
}

function openRemoveMembersModal(teamId) {
    currentTeamId = teamId;
    
    // Load current team members
    fetchTeamMembers(teamId).then(members => {
        currentTeamMembers = members;
        renderRemoveMembers(members);
    });
}

function renderRemoveMembers(members) {
    const container = document.getElementById('removeMembersContainer');
    container.innerHTML = '';
    
    if (members.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">No members in this team.</div>';
        return;
    }
    
    members.forEach(member => {
        const col = document.createElement('div');
        col.className = 'col-md-6 mb-2';
        col.innerHTML = `
            <div class="form-check p-2 border rounded">
                <input class="form-check-input" type="checkbox" id="remove_student_${member.id}" value="${member.id}">
                <label class="form-check-label" for="remove_student_${member.id}">
                    ${member.name}
                    ${member.role ? '<span class="badge bg-secondary ms-2">' + member.role + '</span>' : ''}
                </label>
            </div>
        `;
        container.appendChild(col);
    });
}

function filterRemoveMembers(searchTerm) {
    const allRows = document.querySelectorAll('#removeMembersContainer .col-md-6');
    allRows.forEach(row => {
        const label = row.querySelector('label').textContent.toLowerCase();
        if (label.includes(searchTerm.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function removeSelectedMembers() {
    const selectedIds = [];
    document.querySelectorAll('#removeMembersContainer input[type="checkbox"]:checked').forEach(checkbox => {
        selectedIds.push(parseInt(checkbox.value));
    });
    
    if (selectedIds.length === 0) {
        alert('Please select at least one member to remove.');
        return;
    }
    
    // Send to backend
    fetch(`/management/api/team-members/${currentTeamId}/remove`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({student_ids: selectedIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Members removed successfully!', 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('removeMembersModal'));
            modal.hide();
            // Reload page to reflect changes
            location.reload();
        } else {
            showAlert('Failed to remove members: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error removing members:', error);
        showAlert('Error removing members. Please try again.', 'danger');
    });
}

function loadExistingTeams() {
    // Load existing dynamic teams from backend
    fetch('/management/api/dynamic-teams')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                dynamicTeams = data.teams.map(team => ({
                    id: team.id,
                    name: team.name,
                    type: team.type,
                    description: team.description,
                    members: team.members,
                    score: team.score || 100,
                    created: new Date(team.created_at)
                }));
                renderDynamicTeams();
            } else {
                console.error('Failed to load teams:', data.error);
                dynamicTeams = [];
                renderDynamicTeams();
            }
        })
        .catch(error => {
            console.error('Error loading teams:', error);
            dynamicTeams = [];
            renderDynamicTeams();
        });
}
</script>

<style>
/* Enhanced Cleaning Team Cards */
.cleaning-team-card {
    border: none;
    border-radius: 15px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.cleaning-team-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
}

.team-1-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.team-2-card .card-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.team-icon-container {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.team-icon {
    font-size: 1.5rem;
    color: white;
}

.team-decoration {
    position: absolute;
    top: -20px;
    right: -20px;
    width: 100px;
    height: 100px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    z-index: 1;
}

.score-display {
    text-align: center;
    z-index: 2;
    position: relative;
}

.score-number {
    display: block;
    font-size: 1.8rem;
    font-weight: bold;
    line-height: 1;
}

.score-label {
    font-size: 0.75rem;
    opacity: 0.8;
}

.btn-toggle {
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    position: relative;
}

/* Team Stats */
.team-stats {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 1.5rem 1rem;
    margin: 0 -0.75rem 1.5rem -0.75rem;
}

.stat-item {
    padding: 0.5rem;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #495057;
    line-height: 1;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 0.25rem;
}

/* Section Titles */
.section-title {
    color: #495057;
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

/* Cleaning Areas */
.cleaning-areas {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 1.5rem 1rem;
    margin: 0 -0.75rem 1.5rem -0.75rem;
}

.areas-list ul li {
    padding: 0.25rem 0;
    font-size: 0.9rem;
    color: #495057;
}

/* Member Badges */
.members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
}

.member-badge {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-align: center;
    border: 1px solid rgba(21, 101, 192, 0.2);
    transition: all 0.2s ease;
}

.member-badge:hover {
    background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
    color: white;
    transform: scale(1.05);
}

/* Team Actions */
.team-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}

.btn-inspect {
    border-radius: 25px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
}

.btn-inspect:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

/* General Styles */
.card-header {
    font-weight: 600;
    border: none;
}

.badge {
    font-size: 0.875rem;
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
}

.form-check-label {
    font-size: 0.9rem;
}

.btn-group .btn {
    border-radius: 0.375rem;
}

.btn-group .btn:not(:last-child) {
    margin-right: 0.5rem;
}

/* Animation for team content */
#team1Content, #team2Content {
    transition: all 0.3s ease;
}

/* Responsive Design */
@media (max-width: 768px) {
    .card-body .row > div {
        margin-bottom: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
        margin-right: 0;
    }
    
    .members-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.4rem;
    }
    
    .member-badge {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
    }
    
    .team-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .team-stats {
        margin: 0 -0.5rem 1.5rem -0.5rem;
        padding: 1rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .team-icon-container {
        width: 40px;
        height: 40px;
    }
    
    .team-icon {
        font-size: 1.2rem;
    }
    
    .score-number {
        font-size: 1.5rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}
