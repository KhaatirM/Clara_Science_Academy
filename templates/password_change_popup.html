<!-- Password Change Popup Modal -->
<style>
.password-change-popup-modal .modal-content {
    background-color: white !important;
    color: #333 !important;
}

.password-change-popup-modal .modal-body {
    background-color: white !important;
    color: #333 !important;
}

.password-change-popup-modal .form-label {
    color: #333 !important;
}

.password-change-popup-modal .form-text {
    color: #6c757d !important;
}

.password-change-popup-modal .modal-header {
    background-color: #ffc107 !important;
    color: #000 !important;
}

.password-change-popup-modal .modal-header.bg-success {
    background-color: #198754 !important;
    color: white !important;
}
</style>

<div class="modal fade password-change-popup-modal" id="passwordChangePopupModal" tabindex="-1" aria-labelledby="passwordChangePopupModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: white; color: #333;">
            <!-- Phase 1: Password Change Form -->
            <div id="passwordChangePhase" class="password-change-phase">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="passwordChangePopupModalLabel">
                        <i class="bi bi-shield-exclamation me-2"></i>Password Change Required
                    </h5>
                </div>
                <div class="modal-body" style="background-color: white; color: #333;">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Security Notice:</strong> 
                        <span id="passwordChangeReason">
                            <!-- This will be populated by JavaScript based on the reason -->
                        </span>
                    </div>
                    
                    <form id="passwordChangePopupForm">
                        <div class="mb-3">
                            <label for="newPasswordPopup" class="form-label" style="color: #333;">New Password</label>
                            <input type="password" class="form-control" id="newPasswordPopup" name="new_password" required minlength="8">
                            <div class="form-text">Password must be at least 8 characters long</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirmPasswordPopup" class="form-label" style="color: #333;">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPasswordPopup" name="confirm_password" required>
                            <div class="form-text">Re-enter your new password</div>
                        </div>
                        
                        <!-- Password strength indicator -->
                        <div class="mb-3">
                            <label class="form-label" style="color: #333;">Password Strength</label>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" id="passwordStrengthBarPopup" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="passwordStrengthTextPopup" class="form-text text-muted">Enter a password to see strength</small>
                        </div>
                        
                        <!-- Password requirements -->
                        <div class="mb-3">
                            <small class="form-text text-muted">
                                <strong>Password Requirements:</strong>
                                <ul class="mb-0 mt-1">
                                    <li id="req-length-popup">At least 8 characters</li>
                                    <li id="req-uppercase-popup">One uppercase letter</li>
                                    <li id="req-lowercase-popup">One lowercase letter</li>
                                    <li id="req-number-popup">One number</li>
                                </ul>
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submitPasswordChangePopup">
                        <i class="bi bi-check-circle me-1"></i>Change Password
                    </button>
                </div>
            </div>

            <!-- Phase 2: Credentials Display -->
            <div id="credentialsDisplayPhase" class="credentials-display-phase" style="display: none;">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle me-2"></i>Password Changed Successfully
                    </h5>
                </div>
                <div class="modal-body" style="background-color: white; color: #333;">
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-shield-check me-2"></i>
                        <strong>Success!</strong> Your password has been changed successfully. Please save your login information.
                    </div>
                    
                    <div class="credentials-display">
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #333;">Username:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="displayUsername" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copyUsername">
                                    <i class="bi bi-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #333;">Password:</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="displayPassword" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordVisibility">
                                    <i class="bi bi-eye" id="passwordToggleIcon"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="copyPassword">
                                    <i class="bi bi-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #333;">ID:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="displayId" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copyId">
                                    <i class="bi bi-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="closeCredentialsModal">
                        <i class="bi bi-check-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('passwordChangePopupModal'));
    const form = document.getElementById('passwordChangePopupForm');
    const newPasswordInput = document.getElementById('newPasswordPopup');
    const confirmPasswordInput = document.getElementById('confirmPasswordPopup');
    const strengthBar = document.getElementById('passwordStrengthBarPopup');
    const strengthText = document.getElementById('passwordStrengthTextPopup');
    const submitBtn = document.getElementById('submitPasswordChangePopup');
    const passwordChangePhase = document.getElementById('passwordChangePhase');
    const credentialsDisplayPhase = document.getElementById('credentialsDisplayPhase');
    
    // Show modal immediately when page loads
    modal.show();
    
    // Set the reason for password change
    const isFirstLogin = {{ 'true' if current_user.login_count == 1 else 'false' }};
    const isTemporaryPassword = {{ 'true' if current_user.is_temporary_password else 'false' }};
    
    // Debug logging
    console.log('Popup debug info:');
    console.log('isFirstLogin:', isFirstLogin);
    console.log('isTemporaryPassword:', isTemporaryPassword);
    console.log('login_count:', {{ current_user.login_count }});
    console.log('is_temporary_password:', {{ 'true' if current_user.is_temporary_password else 'false' }});
    
    let reasonText = '';
    if (isFirstLogin && isTemporaryPassword) {
        reasonText = 'This is your first login and you are using a temporary password. Please change it to a secure password for your account safety.';
    } else if (isFirstLogin) {
        reasonText = 'This is your first login. Please set a secure password for your account safety.';
    } else if (isTemporaryPassword) {
        reasonText = 'You are using a temporary password. Please change it to a secure password for your account safety.';
    }
    
    document.getElementById('passwordChangeReason').textContent = reasonText;
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password)
        };
        
        // Update requirement indicators
        document.getElementById('req-length-popup').style.color = requirements.length ? '#28a745' : '#dc3545';
        document.getElementById('req-uppercase-popup').style.color = requirements.uppercase ? '#28a745' : '#dc3545';
        document.getElementById('req-lowercase-popup').style.color = requirements.lowercase ? '#28a745' : '#dc3545';
        document.getElementById('req-number-popup').style.color = requirements.number ? '#28a745' : '#dc3545';
        
        // Calculate strength
        Object.values(requirements).forEach(met => {
            if (met) strength += 25;
        });
        
        // Update strength bar
        strengthBar.style.width = strength + '%';
        
        if (strength < 25) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Very Weak';
        } else if (strength < 50) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Weak';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
        }
        
        return strength >= 50; // Minimum 50% strength required
    }
    
    // Real-time password strength checking
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });
    
    // Form validation
    function validateForm() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (!newPassword || !confirmPassword) {
            return false;
        }
        
        if (newPassword !== confirmPassword) {
            return false;
        }
        
        if (!checkPasswordStrength(newPassword)) {
            return false;
        }
        
        return true;
    }
    
    // Update submit button state
    function updateSubmitButton() {
        const isValid = validateForm();
        submitBtn.disabled = !isValid;
        
        if (isValid) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        } else {
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-secondary');
        }
    }
    
    // Add event listeners for form validation
    form.addEventListener('input', updateSubmitButton);
    
    // Password confirmation matching
    confirmPasswordInput.addEventListener('input', function() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = this.value;
        
        if (confirmPassword && newPassword !== confirmPassword) {
            this.setCustomValidity('Passwords do not match');
            this.classList.add('is-invalid');
        } else {
            this.setCustomValidity('');
            this.classList.remove('is-invalid');
        }
        updateSubmitButton();
    });
    
    // Form submission
    submitBtn.addEventListener('click', function() {
        if (!validateForm()) {
            alert('Please fill in all fields correctly and ensure passwords match.');
            return;
        }
        
        const formData = new FormData(form);
        
        // Debug: Log form data
        console.log('Form data being sent:');
        for (let [key, value] of formData.entries()) {
            console.log(key + ': ' + value);
        }
        
        // Disable submit button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Changing...';
        
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        fetch('/change-password-popup', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            signal: controller.signal
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            clearTimeout(timeoutId);
            console.log('Response data:', data);
            if (data.success) {
                // Switch to credentials display phase
                passwordChangePhase.style.display = 'none';
                credentialsDisplayPhase.style.display = 'block';
                
                // Populate credentials
                document.getElementById('displayUsername').value = data.username;
                document.getElementById('displayPassword').value = data.password;
                document.getElementById('displayId').value = data.user_id;
                
            } else {
                // Show error message
                alert('Error: ' + (data.message || 'Failed to change password. Please try again.'));
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error:', error);
            console.error('Error details:', error.message);
            alert('An error occurred: ' + error.message + '. Please try again.');
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
        });
    });
    
    // Credentials display functionality
    let passwordVisible = false;
    document.getElementById('togglePasswordVisibility').addEventListener('click', function() {
        const passwordInput = document.getElementById('displayPassword');
        const icon = document.getElementById('passwordToggleIcon');
        
        if (passwordVisible) {
            passwordInput.type = 'password';
            icon.className = 'bi bi-eye';
            passwordVisible = false;
        } else {
            passwordInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
            passwordVisible = true;
        }
    });
    
    // Copy functionality
    document.getElementById('copyUsername').addEventListener('click', function() {
        const usernameInput = document.getElementById('displayUsername');
        usernameInput.select();
        document.execCommand('copy');
        this.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-copy"></i>';
        }, 2000);
    });
    
    document.getElementById('copyPassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('displayPassword');
        passwordInput.select();
        document.execCommand('copy');
        this.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-copy"></i>';
        }, 2000);
    });
    
    document.getElementById('copyId').addEventListener('click', function() {
        const idInput = document.getElementById('displayId');
        idInput.select();
        document.execCommand('copy');
        this.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-copy"></i>';
        }, 2000);
    });
    
    // Close modal
    document.getElementById('closeCredentialsModal').addEventListener('click', function() {
        modal.hide();
        // Redirect to dashboard after closing
        window.location.href = '{{ url_for("auth.dashboard") }}';
    });
    
    // Prevent modal from being closed during password change phase
    document.getElementById('passwordChangePopupModal').addEventListener('hide.bs.modal', function(e) {
        if (credentialsDisplayPhase.style.display === 'none') {
            e.preventDefault();
            return false;
        }
    });
    
    // Initial validation
    updateSubmitButton();
});
</script>

<style>
#passwordChangePopupModal .modal-header {
    border-bottom: 2px solid #ffc107;
}

#passwordChangePopupModal .modal-content {
    border: 2px solid #ffc107;
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
}

.credentials-display-phase .modal-header {
    border-bottom: 2px solid #28a745;
}

.credentials-display-phase .modal-content {
    border: 2px solid #28a745;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
}

.password-requirement {
    transition: color 0.3s ease;
}

.progress {
    background-color: #e9ecef;
}

.progress-bar {
    transition: width 0.3s ease, background-color 0.3s ease;
}

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.credentials-display .form-control {
    background-color: #f8f9fa;
    font-family: 'Courier New', monospace;
}

.input-group .btn {
    border-left: none;
}

.input-group .btn:first-child {
    border-left: 1px solid #ced4da;
}
</style>
