{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
    <!-- DEBUG: Current section is "{{ section }}" -->
    {% if section == 'home' %}
        <!-- Home Dashboard -->
        <div class="container-fluid px-2 px-md-4">
            <h2 class="mb-4">Dashboard - {{ current_user.role }}</h2>

            <!-- Role-specific welcome message -->
            <div class="alert alert-info">
                {% if current_user.role == 'Director' %}
                    <h5>Welcome, Director!</h5>
                    <p>You have full administrative access to manage students, teachers, classes, and system settings.</p>
                {% elif current_user.role == 'School Administrator' %}
                    <h5>Welcome, School Administrator!</h5>
                    <p>You can manage students, teachers, classes, and oversee academic operations.</p>
                {% elif current_user.role == 'Teacher' %}
                    <h5>Welcome, Teacher!</h5>
                    <p>Manage your classes, assignments, grades, and student interactions.</p>
                {% elif current_user.role == 'Student' %}
                    <h5>Welcome, Student!</h5>
                    <p>View your classes, assignments, grades, and academic progress.</p>
                {% elif current_user.role == 'Tech' %}
                    <h5>Welcome, Tech Support!</h5>
                    <p>Manage system maintenance, user accounts, and technical support.</p>
                {% endif %}
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 g-md-4 mb-4">
                {% if current_user.role in ['Director', 'School Administrator'] %}
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-people-fill fs-1"></i>
                                <h3 class="card-title">{{ stats.students if stats else 0 }}</h3>
                                <p class="card-text">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="card text-white bg-success h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-person-badge-fill fs-1"></i>
                                <h3 class="card-title">{{ stats.teachers if stats else 0 }}</h3>
                                <p class="card-text">Total Teachers & Staff</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="card text-white bg-warning h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-house-door-fill fs-1"></i>
                                <h3 class="card-title">{{ stats.classes if stats else 0 }}</h3>
                                <p class="card-text">Total Classes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="card text-white bg-info h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-journal-check fs-1"></i>
                                <h3 class="card-title">{{ stats.assignments if stats else 0 }}</h3>
                                <p class="card-text">Active Assignments</p>
                            </div>
                        </div>
                    </div>
                {% elif current_user.role == 'Teacher' %}
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-house-door-fill fs-1"></i>
                                <h3 class="card-title">{{ teacher_data.classes|length if teacher_data else 0 }}</h3>
                                <p class="card-text">My Classes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-success h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-people-fill fs-1"></i>
                                <h3 class="card-title">{{ teacher_data.total_students if teacher_data else 0 }}</h3>
                                <p class="card-text">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-warning h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-journal-check fs-1"></i>
                                <h3 class="card-title">{{ teacher_data.active_assignments if teacher_data else 0 }}</h3>
                                <p class="card-text">Active Assignments</p>
                            </div>
                        </div>
                    </div>
                {% elif current_user.role == 'Student' %}
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-house-door-fill fs-1"></i>
                                <h3 class="card-title">{{ student_data.classes|length if student_data else 0 }}</h3>
                                <p class="card-text">My Classes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-success h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-journal-check fs-1"></i>
                                <h3 class="card-title">{{ student_data.active_assignments if student_data else 0 }}</h3>
                                <p class="card-text">Active Assignments</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-warning h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-mortarboard-fill fs-1"></i>
                                <h3 class="card-title">{{ student_data.average_grade if student_data else 'N/A' }}</h3>
                                <p class="card-text">Average Grade</p>
                            </div>
                        </div>
                    </div>
                {% elif current_user.role == 'Tech' %}
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-danger h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-bug-fill fs-1"></i>
                                <h3 class="card-title">{{ tech_data.error_reports if tech_data else 0 }}</h3>
                                <p class="card-text">Error Reports</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-warning h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-people-fill fs-1"></i>
                                <h3 class="card-title">{{ tech_data.total_users if tech_data else 0 }}</h3>
                                <p class="card-text">Total Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card text-white bg-info h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-arrow-up-circle-fill fs-1"></i>
                                <h3 class="card-title">{{ tech_data.system_updates if tech_data else 0 }}</h3>
                                <p class="card-text">System Updates</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2">
                                {% if current_user.role in ['Director', 'School Administrator'] %}
                                    <a href="{{ url_for('management.add_student') }}" class="btn btn-outline-primary">Add New Student</a>
                                    <a href="{{ url_for('management.add_teacher_staff') }}" class="btn btn-outline-success">Add New Staff</a>
                                    <a href="{{ url_for('management.add_class') }}" class="btn btn-outline-info">Add New Class</a>
                                    <a href="{{ url_for('management.add_assignment') }}" class="btn btn-outline-warning">Add New Assignment</a>
                                {% elif current_user.role == 'Teacher' %}
                                    <a href="{{ url_for('teacher.my_assignments') }}" class="btn btn-outline-primary">View Assignments</a>
                                    <a href="{{ url_for('teacher.my_classes') }}" class="btn btn-outline-success">View My Classes</a>
                                    <a href="{{ url_for('teacher.my_grades') }}" class="btn btn-outline-info">View Grades</a>
                                    <a href="{{ url_for('teacher.attendance') }}" class="btn btn-outline-warning">Take Attendance</a>
                                {% elif current_user.role == 'Student' %}
                                    <a href="{{ url_for('student.student_classes') }}" class="btn btn-outline-primary">View My Classes</a>
                                    <a href="{{ url_for('student.student_assignments') }}" class="btn btn-outline-success">View Assignments</a>
                                    <a href="{{ url_for('student.student_dashboard') }}" class="btn btn-outline-info">View My Grades</a>
                                    <a href="{{ url_for('student.student_dashboard') }}" class="btn btn-outline-warning">Submit Work</a>
                                {% elif current_user.role == 'Tech' %}
                                    <a href="{{ url_for('tech.error_reports') }}" class="btn btn-outline-danger">View Error Reports</a>
                                    <a href="{{ url_for('tech.system_status') }}" class="btn btn-outline-warning">System Status</a>
                                    <a href="{{ url_for('tech.user_management') }}" class="btn btn-outline-info">User Management</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row g-3 g-md-4">
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            {% if recent_activity %}
                                <ul class="list-group list-group-flush">
                                    {% for activity in recent_activity %}
                                        <li class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ activity.title }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ activity.description }}</small>
                                                </div>
                                                <small class="text-muted">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') if activity.timestamp else 'N/A' }}</small>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">No recent activity to display.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Quick Stats</h5>
                        </div>
                        <div class="card-body">
                            {% if current_user.role in ['Director', 'School Administrator'] %}
                                <p><strong>New Students This Month:</strong> {{ monthly_stats.new_students if monthly_stats else 0 }}</p>
                                <p><strong>Assignments Due This Week:</strong> {{ weekly_stats.due_assignments if weekly_stats else 0 }}</p>
                                <p><strong>Attendance Rate:</strong> {{ monthly_stats.attendance_rate if monthly_stats else 'N/A' }}%</p>
                                <p><strong>Average Grade:</strong> {{ monthly_stats.average_grade if monthly_stats else 'N/A' }}</p>
                            {% elif current_user.role == 'Teacher' %}
                                <p><strong>Classes Teaching:</strong> {{ teacher_data.classes|length if teacher_data else 0 }}</p>
                                <p><strong>Students Total:</strong> {{ teacher_data.total_students if teacher_data else 0 }}</p>
                                <p><strong>Assignments Created:</strong> {{ teacher_data.total_assignments if teacher_data else 0 }}</p>
                                <p><strong>Grades Entered:</strong> {{ teacher_data.grades_entered if teacher_data else 0 }}</p>
                            {% elif current_user.role == 'Student' %}
                                <p><strong>Classes Enrolled:</strong> {{ student_data.classes|length if student_data else 0 }}</p>
                                <p><strong>Assignments Due:</strong> {{ student_data.due_assignments if student_data else 0 }}</p>
                                <p><strong>Completed Assignments:</strong> {{ student_data.completed_assignments if student_data else 0 }}</p>
                                <p><strong>Attendance Rate:</strong> {{ student_data.attendance_rate if student_data else 'N/A' }}%</p>
                            {% elif current_user.role == 'Tech' %}
                                <p><strong>System Status:</strong> <span class="badge bg-success">Online</span></p>
                                <p><strong>Last Backup:</strong> {{ tech_data.last_backup if tech_data else 'N/A' }}</p>
                                <p><strong>Active Users:</strong> {{ tech_data.active_users if tech_data else 0 }}</p>
                                <p><strong>System Load:</strong> {{ tech_data.system_load if tech_data else 'N/A' }}%</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

        </div>

    {% elif section == 'students' %}
        <!-- Students Management View -->
        <h2 class="mb-4">Students Management</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>All Students</h5>
                    <a href="{{ url_for('management.add_student') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Student
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Grade Level</th>
                                <th>Date of Birth</th>
                                <th>Student ID</th>
                                <th>Username</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                <tr>
                                    <td>{{ student.first_name }} {{ student.last_name }}</td>
                                    <td>{{ student.grade_level or 'N/A' }}</td>
                                    <td>{{ student.dob or 'N/A' }}</td>
                                    <td>{{ student.student_id or 'N/A' }}</td>
                                    <td>
                                        {% if student.user %}
                                            <span class="badge bg-info">{{ student.user.username }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">No Account</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewStudent({{ student.id }})">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editStudent({{ student.id }})">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No students found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'teachers' %}
        <!-- Teachers & Staff Management View -->
        <h2 class="mb-4">Teachers & Staff Management</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i>All Teachers & Staff</h5>
                    <a href="{{ url_for('management.add_teacher_staff') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Staff
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Email</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for teacher in teachers %}
                                <tr>
                                    <td>{{ teacher.first_name }} {{ teacher.last_name }}</td>
                                    <td>
                                        {% if teacher.user %}
                                            <span class="badge 
                                                {% if teacher.user.role == 'Director' %}bg-danger
                                                {% elif teacher.user.role == 'School Administrator' %}bg-warning
                                                {% elif teacher.user.role == 'Teacher' %}bg-info
                                                {% elif teacher.user.role == 'Tech' %}bg-secondary
                                                {% else %}bg-light text-dark{% endif %}">
                                                {{ teacher.user.role }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">No Account</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ teacher.email or 'N/A' }}</td>
                                    <td>
                                        {% if teacher.user %}
                                            <span class="badge bg-info">{{ teacher.user.username }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">No Account</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewTeacher({{ teacher.id }})">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editTeacher({{ teacher.id }})">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No teachers or staff found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'classes' %}
        <!-- Classes Management View -->
        <h2 class="mb-4">Classes Management</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-house-door-fill me-2"></i>All Classes</h5>
                    <a href="{{ url_for('management.add_class') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Class
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for class in classes %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">{{ class.name }}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <strong>Subject:</strong> {{ class.subject or 'N/A' }}<br>
                                        <strong>Grade Level:</strong> {{ class.grade_level or 'N/A' }}<br>
                                        <strong>Teacher:</strong> {{ class.teacher.first_name }} {{ class.teacher.last_name if class.teacher else 'N/A' }}
                                    </p>
                                    <div class="btn-group w-100" role="group">
                                        <a href="{{ url_for('management.view_class', class_id=class.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                                        <a href="{{ url_for('management.edit_class', class_id=class.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                        <a href="{{ url_for('management.manage_class_roster', class_id=class.id) }}" class="btn btn-sm btn-outline-info">Roster</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col">
                            <div class="alert alert-info">
                                No classes found.
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    {% elif section == 'assignments' %}
        <!-- Assignments Management View -->
        <h2 class="mb-4">Assignments Management</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-journal-check me-2"></i>All Assignments</h5>
                    <a href="{{ url_for('management.add_assignment') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Assignment
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Class</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.title }}</td>
                                    <td>{{ assignment.class_assigned.name }}</td>
                                    <td>{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if assignment.due_date < today %}
                                            <span class="badge bg-danger">Past Due</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="#" class="btn btn-sm btn-outline-primary">View</a>
                                            <a href="#" class="btn btn-sm btn-outline-secondary">Edit</a>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No assignments found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'attendance' %}
        <!-- Attendance Management View -->
        <h2 class="mb-4">Attendance Management</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-calendar-check-fill me-2"></i>Attendance Tracking</h5>
            <p>Manage attendance for all classes and generate reports.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Take Attendance</h5>
                    </div>
                    <div class="card-body">
                        <p>Select a class to take attendance:</p>
                        <div class="list-group">
                            {% for class in classes %}
                                <a href="{{ url_for('teacher.take_attendance', class_id=class.id) }}" class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ class.name }}</h6>
                                            <small class="text-muted">{{ class.subject }}</small>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">{{ class.students|length if class.students else 0 }} students</span>
                                    </div>
                                </a>
                            {% else %}
                                <div class="list-group-item text-muted">No classes available for attendance.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Attendance Reports</h5>
                    </div>
                    <div class="card-body">
                        <p>Generate and view attendance reports:</p>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-success">Daily Report</a>
                            <a href="#" class="btn btn-outline-success">Weekly Report</a>
                            <a href="#" class="btn btn-outline-success">Monthly Report</a>
                            <a href="#" class="btn btn-outline-success">Student Report</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'admissions' %}
        <!-- Admissions View -->
        <h2 class="mb-4">Admissions</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-person-plus-fill me-2"></i>Student Admissions</h5>
            <p>Manage student admissions and enrollment.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Add New Student</h5>
                    </div>
                    <div class="card-body">
                        <p>Register a new student in the system.</p>
                        <a href="{{ url_for('management.add_student') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Add Student
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Admissions Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">0</h4>
                                <small class="text-muted">Pending Applications</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success">0</h4>
                                <small class="text-muted">Approved Applications</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-warning">0</h4>
                                <small class="text-muted">Under Review</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info">0</h4>
                                <small class="text-muted">Total Applications</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'attendance_reports' %}
        <!-- Attendance Reports View -->
        <h2 class="mb-4">Attendance Reports</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-file-earmark-bar-graph-fill me-2"></i>Attendance Reports</h5>
            <p>Generate and view detailed attendance reports.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Generate Reports</h5>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="{{ url_for('management.attendance_reports') }}">
                            <div class="mb-3">
                                <label for="student_filter" class="form-label">Filter by Student</label>
                                <select class="form-select" id="student_filter" name="student_id">
                                    <option value="">All Students</option>
                                    {% for student in all_students %}
                                        <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="class_filter" class="form-label">Filter by Class</label>
                                <select class="form-select" id="class_filter" name="class_id">
                                    <option value="">All Classes</option>
                                    {% for class in all_classes %}
                                        <option value="{{ class.id }}">{{ class.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="status_filter" class="form-label">Filter by Status</label>
                                <select class="form-select" id="status_filter" name="status">
                                    <option value="">All Statuses</option>
                                    {% for status in all_statuses %}
                                        <option value="{{ status }}">{{ status }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="start_date" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="end_date" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="end_date" name="end_date">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Summary Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">{{ summary_stats.total_records }}</h4>
                                <small class="text-muted">Total Records</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-danger">{{ summary_stats.unexcused_absences }}</h4>
                                <small class="text-muted">Unexcused Absences</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-warning">{{ summary_stats.excused_absences }}</h4>
                                <small class="text-muted">Excused Absences</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info">{{ summary_stats.tardies }}</h4>
                                <small class="text-muted">Tardies</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if records %}
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Attendance Records</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Class</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.date }}</td>
                                <td>{{ record.student_name }}</td>
                                <td>{{ record.class_name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if record.status == 'Present' %}bg-success
                                        {% elif record.status == 'Absent' %}bg-danger
                                        {% elif record.status == 'Tardy' %}bg-warning
                                        {% else %}bg-secondary{% endif %}">
                                        {{ record.status }}
                                    </span>
                                </td>
                                <td>{{ record.notes or 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    {% elif section == 'report_cards' %}
        <!-- Report Cards Management View -->
        <h2 class="mb-4">Report Cards Management</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-mortarboard-fill me-2"></i>Report Card Generation</h5>
            <p>Generate and manage student report cards.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Generate Report Cards</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('management.generate_report_card_form') }}">
                            <div class="mb-3">
                                <label for="student_id" class="form-label">Select Student</label>
                                <select class="form-select" id="student_id" name="student_id" required>
                                    <option value="">Choose a student...</option>
                                    {% for student in students %}
                                        <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }} - Grade {{ student.grade_level }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="school_year" class="form-label">School Year</label>
                                <select class="form-select" id="school_year" name="school_year" required>
                                    <option value="">Choose school year...</option>
                                    {% for year in school_years %}
                                        <option value="{{ year.id }}">{{ year.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="quarter" class="form-label">Quarter</label>
                                <select class="form-select" id="quarter" name="quarter" required>
                                    <option value="">Choose quarter...</option>
                                    <option value="1">Q1</option>
                                    <option value="2">Q2</option>
                                    <option value="3">Q3</option>
                                    <option value="4">Q4</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning">Generate Report Card</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Recent Report Cards</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% for report in recent_reports %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ report.student.first_name }} {{ report.student.last_name }}</h6>
                                            <small class="text-muted">{{ report.school_year.name }} - Q{{ report.quarter }}</small>
                                        </div>
                                        <a href="{{ url_for('management.view_report_card', report_id=report.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-muted">No recent report cards.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'billing' %}
        <!-- Billing & Financials View -->
        <h2 class="mb-4">Billing & Financials</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-currency-dollar me-2"></i>Financial Management</h5>
            <p>Manage tuition, fees, and financial records.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Tuition Management</h5>
                    </div>
                    <div class="card-body">
                        <p>Manage student tuition and payment plans.</p>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-success">View Tuition Records</a>
                            <a href="#" class="btn btn-outline-success">Generate Invoices</a>
                            <a href="#" class="btn btn-outline-success">Payment History</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Financial Reports</h5>
                    </div>
                    <div class="card-body">
                        <p>Generate financial reports and analytics.</p>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-warning">Revenue Report</a>
                            <a href="#" class="btn btn-outline-warning">Expense Report</a>
                            <a href="#" class="btn btn-outline-warning">Budget Analysis</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'calendar' %}
        <!-- School Calendar View -->
        <h2 class="mb-4">School Calendar</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-calendar-event-fill me-2"></i>Academic Calendar</h5>
            <p>View and manage school events, holidays, and important dates.</p>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Upcoming Events</h6>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Parent-Teacher Conference</h6>
                                        <small class="text-muted">October 15, 2024</small>
                                    </div>
                                    <span class="badge bg-primary">Event</span>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Thanksgiving Break</h6>
                                        <small class="text-muted">November 25-29, 2024</small>
                                    </div>
                                    <span class="badge bg-warning">Holiday</span>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Winter Break</h6>
                                        <small class="text-muted">December 23 - January 5, 2025</small>
                                    </div>
                                    <span class="badge bg-info">Break</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <a href="#" class="btn btn-outline-primary">Add Event</a>
                            <a href="#" class="btn btn-outline-secondary">Export Calendar</a>
                            <a href="#" class="btn btn-outline-info">View Full Calendar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'communications' %}
        <!-- Communications View -->
        <h2 class="mb-4">Communications</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-chat-dots-fill me-2"></i>Communication Center</h5>
            <p>Send messages to students, parents, and staff members.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Send Message</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label for="recipient" class="form-label">Recipient</label>
                                <select class="form-select" id="recipient">
                                    <option value="">Select recipient...</option>
                                    <option value="all_students">All Students</option>
                                    <option value="all_parents">All Parents</option>
                                    <option value="all_teachers">All Teachers</option>
                                    <option value="specific">Specific Person</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" placeholder="Message subject">
                            </div>
                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea class="form-control" id="message" rows="4" placeholder="Enter your message"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Message</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Recent Messages</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">School Announcement</h6>
                                        <small class="text-muted">Sent to All Students - 2 hours ago</small>
                                    </div>
                                    <span class="badge bg-success">Sent</span>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Parent Update</h6>
                                        <small class="text-muted">Sent to All Parents - 1 day ago</small>
                                    </div>
                                    <span class="badge bg-success">Sent</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'settings' %}
        <!-- Settings View -->
        <h2 class="mb-4">Settings</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-gear-fill me-2"></i>System Settings</h5>
            <p>Configure system preferences and account settings.</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Account Settings</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" value="{{ current_user.username }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="{{ current_user.email or '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="current_password" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="current_password">
                            </div>
                            <div class="mb-3">
                                <label for="new_password" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="new_password">
                            </div>
                            <button type="submit" class="btn btn-secondary">Update Settings</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">System Preferences</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Notifications</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_notifications" checked>
                                <label class="form-check-label" for="email_notifications">
                                    Email Notifications
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sms_notifications">
                                <label class="form-check-label" for="sms_notifications">
                                    SMS Notifications
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="timezone" class="form-label">Timezone</label>
                            <select class="form-select" id="timezone">
                                <option value="EST">Eastern Standard Time</option>
                                <option value="CST">Central Standard Time</option>
                                <option value="MST">Mountain Standard Time</option>
                                <option value="PST">Pacific Standard Time</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning">Save Preferences</button>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Generic fallback content for other sections -->
        <div class="alert alert-warning">
            <h4>Debug Information:</h4>
            <p><strong>Section:</strong> "{{ section }}"</p>
            <p><strong>Active Tab:</strong> "{{ active_tab }}"</p>
            <p><strong>User Role:</strong> {{ current_user.role }}</p>
            <hr>
            <p>Content for the '{{ section }}' section is currently under development. Please check back later!</p>
        </div>
    {% endif %}
    <!-- Student/Teacher View Modal -->
    <div class="modal fade" id="profileViewModal" tabindex="-1" aria-labelledby="profileViewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileViewModalLabel">Profile Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="profileViewModalBody">
            <!-- Content will be loaded by JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Student/Teacher Edit Modal -->
    <div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileEditModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="profileEditForm">
            <div class="modal-body" id="profileEditModalBody">
              <!-- Form fields will be loaded by JS -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
{% endblock %} 

{% block scripts %}
    {{ super() }}
    <script>
    function viewStudent(studentId) {
        console.log('viewStudent called with', studentId);
        fetch(`/management/view-student/${studentId}`)
            .then(response => response.json())
            .then(data => {
                let safeData = data || {};
                let classes = (safeData.assigned_classes || []).map(c => `<li>${c.name} (${c.subject})</li>`).join('');
                let photo = safeData.photo_filename ? `<img src='/static/uploads/${safeData.photo_filename}' class='rounded mx-auto d-block mb-3' style='max-width:120px;'>` : '';
                
                // Format parent information
                let parent1Info = '';
                if (safeData.parent1_first_name || safeData.parent1_last_name) {
                    parent1Info = `
                        <div class='col-md-6'><strong>Parent 1:</strong> ${safeData.parent1_first_name || ''} ${safeData.parent1_last_name || ''}</div>
                        <div class='col-md-6'><strong>Relationship:</strong> ${safeData.parent1_relationship || 'N/A'}</div>
                        <div class='col-md-6'><strong>Email:</strong> ${safeData.parent1_email || 'N/A'}</div>
                        <div class='col-md-6'><strong>Phone:</strong> ${safeData.parent1_phone || 'N/A'}</div>
                    `;
                }
                
                let parent2Info = '';
                if (safeData.parent2_first_name || safeData.parent2_last_name) {
                    parent2Info = `
                        <div class='col-md-6'><strong>Parent 2:</strong> ${safeData.parent2_first_name || ''} ${safeData.parent2_last_name || ''}</div>
                        <div class='col-md-6'><strong>Relationship:</strong> ${safeData.parent2_relationship || 'N/A'}</div>
                        <div class='col-md-6'><strong>Email:</strong> ${safeData.parent2_email || 'N/A'}</div>
                        <div class='col-md-6'><strong>Phone:</strong> ${safeData.parent2_phone || 'N/A'}</div>
                    `;
                }
                
                // Format emergency contact
                let emergencyInfo = '';
                if (safeData.emergency_first_name || safeData.emergency_last_name) {
                    emergencyInfo = `
                        <div class='col-md-6'><strong>Emergency Contact:</strong> ${safeData.emergency_first_name || ''} ${safeData.emergency_last_name || ''}</div>
                        <div class='col-md-6'><strong>Relationship:</strong> ${safeData.emergency_relationship || 'N/A'}</div>
                        <div class='col-md-6'><strong>Email:</strong> ${safeData.emergency_email || 'N/A'}</div>
                        <div class='col-md-6'><strong>Phone:</strong> ${safeData.emergency_phone || 'N/A'}</div>
                    `;
                }
                
                // Format address
                let addressInfo = '';
                if (safeData.street || safeData.city || safeData.state) {
                    let fullAddress = [];
                    if (safeData.street) fullAddress.push(safeData.street);
                    if (safeData.apt_unit) fullAddress.push(safeData.apt_unit);
                    if (safeData.city || safeData.state || safeData.zip_code) {
                        let cityStateZip = [];
                        if (safeData.city) cityStateZip.push(safeData.city);
                        if (safeData.state) cityStateZip.push(safeData.state);
                        if (safeData.zip_code) cityStateZip.push(safeData.zip_code);
                        fullAddress.push(cityStateZip.join(', '));
                    }
                    addressInfo = `<div class='col-md-12'><strong>Address:</strong> ${fullAddress.join(', ')}</div>`;
                }
                
                let html = `
                    ${photo}
                    <div class='row'>
                      <div class='col-md-6'><strong>Age:</strong> ${safeData.age || 'N/A'}</div>
                      <div class='col-md-6'><strong>DOB:</strong> ${safeData.dob || 'N/A'}</div>
                      <div class='col-md-6'><strong>ID:</strong> ${safeData.id}</div>
                      <div class='col-md-6'><strong>Grade:</strong> ${safeData.grade_level || 'N/A'}</div>
                      <div class='col-md-6'><strong>Student ID:</strong> ${safeData.student_id || 'N/A'}</div>
                      <div class='col-md-6'><strong>GPA:</strong> ${safeData.gpa || 'N/A'}</div>
                      ${addressInfo}
                    </div>
                    
                    <div class='row mt-3'>
                      <div class='col-md-12'>
                        <strong>Assigned Classes:</strong>
                        ${classes ? `<ul class='list-unstyled mt-2'>${classes}</ul>` : '<p class="text-muted">No classes assigned</p>'}
                      </div>
                    </div>
                    
                    ${parent1Info ? `<div class='row mt-3'>${parent1Info}</div>` : ''}
                    ${parent2Info ? `<div class='row mt-3'>${parent2Info}</div>` : ''}
                    ${emergencyInfo ? `<div class='row mt-3'>${emergencyInfo}</div>` : ''}
                `;
                
                document.getElementById('profileViewModalLabel').innerText = 'Student Details';
                document.getElementById('profileViewModalBody').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('profileViewModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching student details:', error);
                alert('Could not load student details.');
            });
    }

    function viewTeacher(teacherId) {
        console.log('viewTeacher called with', teacherId);
        fetch(`/management/view-teacher/${teacherId}`)
            .then(response => response.json())
            .then(data => {
                // Safely handle null/undefined values
                const safeData = {
                    first_name: data.first_name || 'N/A',
                    last_name: data.last_name || 'N/A',
                    age: data.age || 'N/A',
                    dob: data.dob || 'N/A',
                    id: data.id || 'N/A',
                    role: data.role || 'N/A',
                    total_students: data.total_students || 'N/A',
                    username: data.username || 'N/A',
                    emergency_contact: data.emergency_contact || 'N/A',
                    assigned_classes: data.assigned_classes || []
                };
                
                let classes = safeData.assigned_classes.length > 0 
                    ? safeData.assigned_classes.map(c => `<li>${c.name || 'Unknown'} (${c.subject || 'Unknown'})</li>`).join('')
                    : '<li>None</li>';
                    
                let html = `
                    <div class='row'>
                      <div class='col-md-12 text-center'><i class='bi bi-person-circle' style='font-size:4rem;'></i></div>
                      <div class='col-md-6'><strong>Age:</strong> ${safeData.age}</div>
                      <div class='col-md-6'><strong>DOB:</strong> ${safeData.dob}</div>
                      <div class='col-md-6'><strong>ID:</strong> ${safeData.id}</div>
                      <div class='col-md-6'><strong>Role:</strong> ${safeData.role}</div>
                      <div class='col-md-12'><strong>Assigned Class(s):</strong><ul>${classes}</ul></div>
                      <div class='col-md-6'><strong>Number of Student(s):</strong> ${safeData.total_students}</div>
                      <div class='col-md-6'><strong>Username:</strong> ${safeData.username}</div>
                      <div class='col-md-12'><strong>Emergency Contact:</strong> ${safeData.emergency_contact}</div>
                    </div>
                `;
                document.getElementById('profileViewModalLabel').innerText = `${safeData.first_name} ${safeData.last_name} (Teacher/Staff)`;
                document.getElementById('profileViewModalBody').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('profileViewModal'));
                modal.show();
            })
            .catch(err => {
                console.error('Error fetching teacher:', err);
                alert('Could not load teacher/staff details.');
            });
    }

    function editStudent(studentId) {
        fetch(`/management/view-student/${studentId}`)
            .then(response => response.json())
            .then(data => {
                // Populate the edit modal form fields
                document.getElementById('profileEditModalLabel').innerText = 'Edit Student';
                let form = document.getElementById('profileEditForm');
                let body = document.getElementById('profileEditModalBody');
                body.innerHTML = `
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>First Name</label>
                      <input type='text' class='form-control' name='first_name' value='${data.first_name || ''}' disabled>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Last Name</label>
                      <input type='text' class='form-control' name='last_name' value='${data.last_name || ''}' disabled>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Date of Birth</label>
                      <input type='date' class='form-control' name='dob' value='${data.dob || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Grade Level</label>
                      <input type='text' class='form-control' name='grade_level' value='${data.grade_level || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Student ID</label>
                      <input type='text' class='form-control' name='student_id' value='${data.student_id || ''}' disabled>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'>Parent Information</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 First Name</label>
                      <input type='text' class='form-control' name='parent1_first_name' value='${data.parent1_first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Last Name</label>
                      <input type='text' class='form-control' name='parent1_last_name' value='${data.parent1_last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Email</label>
                      <input type='email' class='form-control' name='parent1_email' value='${data.parent1_email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Phone</label>
                      <input type='tel' class='form-control' name='parent1_phone' value='${data.parent1_phone || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 1 Relationship</label>
                      <select class='form-control' name='parent1_relationship'>
                        <option value='Mother' ${(data.parent1_relationship || '') === 'Mother' ? 'selected' : ''}>Mother</option>
                        <option value='Father' ${(data.parent1_relationship || '') === 'Father' ? 'selected' : ''}>Father</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 First Name</label>
                      <input type='text' class='form-control' name='parent2_first_name' value='${data.parent2_first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Last Name</label>
                      <input type='text' class='form-control' name='parent2_last_name' value='${data.parent2_last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Email</label>
                      <input type='email' class='form-control' name='parent2_email' value='${data.parent2_email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Phone</label>
                      <input type='tel' class='form-control' name='parent2_phone' value='${data.parent2_phone || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Parent 2 Relationship</label>
                      <select class='form-control' name='parent2_relationship'>
                        <option value='Mother' ${(data.parent2_relationship || '') === 'Mother' ? 'selected' : ''}>Mother</option>
                        <option value='Father' ${(data.parent2_relationship || '') === 'Father' ? 'selected' : ''}>Father</option>
                      </select>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'>Emergency Contact</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact First Name</label>
                      <input type='text' class='form-control' name='emergency_first_name' value='${data.emergency_first_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Last Name</label>
                      <input type='text' class='form-control' name='emergency_last_name' value='${data.emergency_last_name || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Email</label>
                      <input type='email' class='form-control' name='emergency_email' value='${data.emergency_email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Phone</label>
                      <input type='tel' class='form-control' name='emergency_phone' value='${data.emergency_phone || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Emergency Contact Relationship</label>
                      <select class='form-control' name='emergency_relationship'>
                        <option value='Parent' ${(data.emergency_relationship || '') === 'Parent' ? 'selected' : ''}>Parent</option>
                        <option value='Guardian' ${(data.emergency_relationship || '') === 'Guardian' ? 'selected' : ''}>Guardian</option>
                        <option value='Grandparent' ${(data.emergency_relationship || '') === 'Grandparent' ? 'selected' : ''}>Grandparent</option>
                        <option value='Aunt/Uncle' ${(data.emergency_relationship || '') === 'Aunt/Uncle' ? 'selected' : ''}>Aunt/Uncle</option>
                        <option value='Sibling' ${(data.emergency_relationship || '') === 'Sibling' ? 'selected' : ''}>Sibling</option>
                        <option value='Other' ${(data.emergency_relationship || '') === 'Other' ? 'selected' : ''}>Other</option>
                      </select>
                    </div>
                  </div>
                  
                  <h6 class='mt-4 mb-3'>Address</h6>
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>Street Address</label>
                      <input type='text' class='form-control' name='street' value='${data.street || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Apt, Unit, Suite, etc.</label>
                      <input type='text' class='form-control' name='apt_unit' value='${data.apt_unit || ''}'>
                    </div>
                    <div class='col-md-4 mb-3'>
                      <label>City</label>
                      <input type='text' class='form-control' name='city' value='${data.city || ''}'>
                    </div>
                    <div class='col-md-4 mb-3'>
                      <label>State</label>
                      <input type='text' class='form-control' name='state' value='${data.state || ''}'>
                    </div>
                    <div class='col-md-4 mb-3'>
                      <label>Zip Code</label>
                      <input type='text' class='form-control' name='zip_code' value='${data.zip_code || ''}'>
                    </div>
                  </div>
                `;
                form.onsubmit = function(e) {
                  e.preventDefault();
                  let formData = new FormData(form);
                  fetch(`/management/edit-student/${studentId}`, {
                    method: 'POST',
                    body: formData
                  })
                  .then(response => response.json())
                  .then(result => {
                    if (result.success) {
                      location.reload();
                    } else {
                      alert('Error: ' + result.message);
                    }
                  })
                  .catch(() => alert('Could not update student.'));
                };
                var modal = new bootstrap.Modal(document.getElementById('profileEditModal'));
                modal.show();
            })
            .catch(() => alert('Could not load student details.'));
    }

    function editTeacher(teacherId) {
        fetch(`/management/view-teacher/${teacherId}`)
            .then(response => response.json())
            .then(data => {
                // Populate the edit modal form fields
                document.getElementById('profileEditModalLabel').innerText = 'Edit Teacher/Staff';
                let form = document.getElementById('profileEditForm');
                let body = document.getElementById('profileEditModalBody');
                body.innerHTML = `
                  <div class='row'>
                    <div class='col-md-6 mb-3'>
                      <label>First Name</label>
                      <input type='text' class='form-control' name='first_name' value='${data.first_name || ''}' disabled>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Last Name</label>
                      <input type='text' class='form-control' name='last_name' value='${data.last_name || ''}' disabled>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Email</label>
                      <input type='email' class='form-control' name='email' value='${data.email || ''}'>
                    </div>
                    <div class='col-md-6 mb-3'>
                      <label>Role</label>
                      <select class='form-control' name='role'>
                        <option value='Teacher' ${(data.role || '') === 'Teacher' ? 'selected' : ''}>Teacher</option>
                        <option value='School Administrator' ${(data.role || '') === 'School Administrator' ? 'selected' : ''}>School Administrator</option>
                        <option value='Director' ${(data.role || '') === 'Director' ? 'selected' : ''}>Director</option>
                        <option value='Staff' ${(data.role || '') === 'Staff' ? 'selected' : ''}>Staff</option>
                      </select>
                    </div>
                  </div>
                `;
                form.onsubmit = function(e) {
                  e.preventDefault();
                  let formData = new FormData(form);
                  fetch(`/management/edit-teacher/${teacherId}`, {
                    method: 'POST',
                    body: formData
                  })
                  .then(response => response.json())
                  .then(result => {
                    if (result.success) {
                      location.reload();
                    } else {
                      alert('Error: ' + result.message);
                    }
                  })
                  .catch(() => alert('Could not update teacher/staff.'));
                };
                var modal = new bootstrap.Modal(document.getElementById('profileEditModal'));
                modal.show();
            })
            .catch(() => alert('Could not load teacher details.'));
    }
    </script>
{% endblock %} 