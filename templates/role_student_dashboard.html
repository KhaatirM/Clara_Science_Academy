{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<style>
/* Discord-like Chat Styles */
.chat-container {
    height: calc(100vh - 200px);
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
}

.chat-header {
    background: #5865f2;
    color: white;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.chat-layout {
    display: flex;
    height: calc(100% - 80px);
}

.chat-sidebar {
    width: 280px;
    background: #2f3136;
    color: #dcddde;
    border-right: 1px solid #202225;
    overflow-y: auto;
}

.sidebar-header {
    padding: 1rem;
    border-bottom: 1px solid #40444b;
    font-weight: 600;
    color: #fff;
}

.sidebar-section {
    border-bottom: 1px solid #40444b;
}

.section-header {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
}

.section-header:hover {
    background: #40444b;
}

.section-content {
    max-height: 300px;
    overflow-y: auto;
}

.chat-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
    border-bottom: 1px solid #40444b;
}

.chat-item:hover {
    background: #40444b;
}

.chat-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #5865f2;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    color: white;
    font-size: 1.2rem;
}

.group-avatar {
    background: #57f287;
}

.announcement-avatar {
    background: #faa61a;
}

.chat-info {
    flex: 1;
    min-width: 0;
}

.chat-name {
    font-weight: 500;
    color: #fff;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-preview {
    font-size: 0.875rem;
    color: #b9bbbe;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-meta {
    text-align: right;
    min-width: 60px;
}

.unread-indicator {
    width: 8px;
    height: 8px;
    background: #ed4245;
    border-radius: 50%;
    display: inline-block;
    margin-left: 0.5rem;
}

.no-chats {
    padding: 1rem;
    text-align: center;
    color: #72767d;
}

.chat-main {
    flex: 1;
    background: #36393f;
    display: flex;
    flex-direction: column;
}

.chat-welcome {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #dcddde;
}

.welcome-content {
    text-align: center;
}

.welcome-actions {
    margin-top: 1.5rem;
}

.active-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chat-header-bar {
    background: #2f3136;
    padding: 1rem;
    border-bottom: 1px solid #40444b;
    color: #fff;
}

.chat-status {
    font-size: 0.875rem;
    color: #b9bbbe;
}

.chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #36393f;
}

.chat-input-area {
    padding: 1rem;
    background: #2f3136;
    border-top: 1px solid #40444b;
}

.chat-input-area .form-control {
    background: #40444b;
    border: 1px solid #202225;
    color: #dcddde;
}

.chat-input-area .form-control:focus {
    background: #40444b;
    border-color: #5865f2;
    color: #fff;
    box-shadow: 0 0 0 0.2rem rgba(88, 101, 242, 0.25);
}

.chat-input-area .btn {
    background: #5865f2;
    border-color: #5865f2;
}

.chat-input-area .btn:hover {
    background: #4752c4;
    border-color: #4752c4;
}

        .badge-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        /* Message styling */
        .message-item {
            margin-bottom: 1rem;
        }

        .message-item.own-message .message-content {
            background: #5865f2;
            color: white;
            padding: 0.75rem;
            border-radius: 18px 18px 4px 18px;
            max-width: 70%;
            margin-left: auto;
        }

        .message-item:not(.own-message) .message-content {
            background: #40444b;
            color: white;
            padding: 0.75rem;
            border-radius: 18px 18px 18px 4px;
            max-width: 70%;
        }

        .message-header {
            margin-bottom: 0.5rem;
        }

        .message-author {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-text {
            line-height: 1.4;
            word-wrap: break-word;
        }

        .own-avatar {
            background: #57f287 !important;
        }

        /* Enhanced sidebar styling */
        .sidebar-section {
            border-bottom: 1px solid #40444b;
        }

        .section-header {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .section-header:hover {
            background: #40444b;
        }

        .section-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            border-bottom: 1px solid #40444b;
        }

        .chat-item:hover {
            background: #40444b;
        }

        .chat-item.active {
            background: #5865f2;
        }

        .new-chat-avatar {
            background: #5865f2 !important;
        }

        .new-chat-item:hover {
            background: #5865f2;
        }

        .new-chat-item .chat-name {
            color: #fff !important;
        }

        /* Typing indicator */
        .typing-indicator {
            padding: 0.5rem 1rem;
            background: #2f3136;
            border-top: 1px solid #40444b;
            font-style: italic;
        }

        /* Enhanced chat experience */
        .chat-messages {
            padding: 1rem;
            overflow-y: auto;
            background: #36393f;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #2f3136;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #40444b;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #5865f2;
        }

        /* Message animations */
        .message-item {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced input area */
        .chat-input-area .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(88, 101, 242, 0.25);
            border-color: #5865f2;
        }

        .chat-input-area .btn:disabled {
            background: #40444b;
            border-color: #40444b;
            opacity: 0.6;
        }

        /* Modal styling for non-Bootstrap fallback */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: block;
        }

        .modal-dialog {
            position: relative;
            width: auto;
            margin: 1.75rem auto;
            max-width: 500px;
        }

        .modal-content {
            background: #2f3136;
            border: 1px solid #40444b;
            border-radius: 8px;
            color: #dcddde;
        }

        .modal-header {
            border-bottom: 1px solid #40444b;
            padding: 1rem;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            border-top: 1px solid #40444b;
            padding: 1rem;
        }

        .modal-title {
            color: #fff;
            margin: 0;
        }

        .btn-close {
            background: none;
            border: none;
            color: #dcddde;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .btn-close:hover {
            color: #fff;
        }

/* Responsive adjustments */
@media (max-width: 768px) {
    .chat-layout {
        flex-direction: column;
    }
    
    .chat-sidebar {
        width: 100%;
        height: 200px;
    }
    
    .chat-main {
        height: calc(100% - 200px);
    }
}
</style>

<div class="container-fluid px-2 px-md-4">
    <!-- DEBUG: Current section is "{{ section }}" -->
    {% if section == 'home' %}
        <!-- Home Dashboard -->
        <h2 class="mb-4">Student Dashboard <span class="text-muted fs-6">(Student View)</span></h2>

        <!-- GPA and Academic Overview -->
        <div class="row g-3 g-md-4 mb-4">
            <div class="col-12 col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Academic Overview</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="display-4 text-primary">{{ "%.2f"|format(gpa) }}</h2>
                        <p class="text-muted mb-0">Current GPA</p>
                        <div class="mt-3">
                            <span class="badge bg-success">On Track</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-12 col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Today's Schedule</h5>
                    </div>
                    <div class="card-body">
                        {% if today_schedule %}
                            <div class="list-group list-group-flush">
                                {% for item in today_schedule %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ item.class.name }}</h6>
                                            <small class="text-muted">{{ item.teacher }}</small>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold">{{ item.time }}</div>
                                            <small class="text-muted">{{ item.room }}</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">No classes scheduled for today.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 g-md-4">
            <!-- Left Column -->
            <div class="col-12 col-lg-5">
                <!-- Student Information Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-fill me-2"></i>Student Information</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Name:</strong>
                                <span>{{ student.first_name }} {{ student.last_name }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Grade:</strong>
                                <span>{{ student.grade_level or 'N/A' }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Date of Birth:</strong>
                                <span>{{ student.dob or 'N/A' }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Student ID:</strong>
                                <span>{{ student.state_id or 'N/A' }}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Academic Goals Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-target me-2"></i>Academic Goals</h5>
                    </div>
                    <div class="card-body">
                        {% if student.enrollments %}
                            {% set active_enrollments = student.enrollments|selectattr('is_active')|list %}
                            {% for enrollment in active_enrollments[:5] %}
                                {% set class = enrollment.class_info %}
                                {% set goal = goals.get(class.id) %}
                                {% set current_grade = grades.get(class.name, 0) %}
                                <div class="mb-3">
                                    <h6>{{ class.name }}</h6>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Current: {{ "%.1f"|format(current_grade) }}%</span>
                                        {% if goal %}
                                            <span>Goal: {{ "%.1f"|format(goal.target_grade) }}%</span>
                                        {% endif %}
                                    </div>
                                    {% if goal %}
                                        <div class="progress mb-2">
                                            {% set progress = (current_grade / goal.target_grade * 100) if goal.target_grade > 0 else 0 %}
                                            <div class="progress-bar {% if progress >= 100 %}bg-success{% elif progress >= 80 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ [progress, 100]|min }}%">
                                                {{ "%.1f"|format(progress) }}%
                                            </div>
                                        </div>
                                                        <form method="POST" action="{{ url_for('student.delete_goal', goal_id=goal.id) }}"
                      style="display: inline;" onsubmit="return confirm('Delete this goal?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Remove Goal</button>
                                        </form>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('student.set_goal') }}" class="d-inline">
                                            <input type="hidden" name="class_id" value="{{ class.id }}">
                                            <div class="input-group input-group-sm">
                                                <input type="number" name="target_grade" class="form-control" 
                                                       placeholder="Target %" min="0" max="100" step="0.1" required>
                                                <button type="submit" class="btn btn-outline-primary">Set Goal</button>
                                            </div>
                                        </form>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">You are not yet enrolled in any classes.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Links Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Quick Links</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {% if student.enrollments %}
                                {% set active_enrollments = student.enrollments|selectattr('is_active')|list %}
                                {% for enrollment in active_enrollments[:5] %}
                                    {% set class = enrollment.class_info %}
                                    <a href="{{ url_for('student.view_class', class_id=class.id) }}" class="btn btn-outline-success">{{ class.name }}</a>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">You are not yet enrolled in any classes.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-7">
                <!-- Grade Trends Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Grade Trends</h5>
                    </div>
                    <div class="card-body">
                        {% if grade_trends %}
                            {% for class_id, trends in grade_trends.items() %}
                                {% if trends %}
                                    <h6>{{ trends[0].assignment.split(' - ')[0] if trends else 'Class' }}</h6>
                                    <canvas id="gradeChart{{ class_id }}" width="400" height="200"></canvas>
                                    <script>
                                        const ctx{{ class_id }} = document.getElementById('gradeChart{{ class_id }}').getContext('2d');
                                        new Chart(ctx{{ class_id }}, {
                                            type: 'line',
                                            data: {
                                                labels: [{% for trend in trends %}'{{ trend.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                                                datasets: [{
                                                    label: 'Grade %',
                                                    data: [{% for trend in trends %}{{ trend.grade }}{% if not loop.last %}, {% endif %}{% endfor %}],
                                                    borderColor: 'rgb(75, 192, 192)',
                                                    tension: 0.1
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                scales: {
                                                    y: {
                                                        beginAtZero: true,
                                                        max: 100
                                                    }
                                                }
                                            }
                                        });
                                    </script>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No grade trends available yet.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Notifications Card -->
                <div class="card shadow-sm mb-4">
                     <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-bell-fill me-2"></i>Notifications</h5>
                    </div>
                    <div class="card-body">
                        {% if notifications and notifications|length > 0 %}
                            <div class="list-group mb-3">
                                {% for notification in notifications %}
                                    <div class="list-group-item list-group-item-action {% if not notification.is_read %}list-group-item-primary{% endif %}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ notification.title }}</strong>
                                                <p class="mb-1">{{ notification.message }}</p>
                                                <small class="text-muted">{{ notification.timestamp.strftime('%b %d, %Y %I:%M %p') }}</small>
                                            </div>
                                            <div class="ms-2">
                                                {% if not notification.is_read %}
                                                    <span class="badge bg-primary">New</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            {% if notification.link %}
                                                <a href="{{ notification.link }}" class="btn btn-sm btn-outline-primary me-2">View Details</a>
                                            {% endif %}
                                            {% if not notification.is_read %}
                                                <form method="POST" action="{{ url_for('student.mark_notification_read', notification_id=notification.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">Mark as Read</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if announcements and announcements|length > 0 %}
                            <h6 class="text-primary">Announcements</h6>
                            <div class="list-group mb-3">
                                {% for ann in announcements %}
                                    <div class="list-group-item list-group-item-action">
                                        <strong>{{ ann.title }}</strong>
                                        <p class="mb-1">{{ ann.message }}</p>
                                        <small class="text-muted">From: {{ ann.sender.username if ann.sender else 'Admin' }} | {{ ann.timestamp.strftime('%b %d, %Y %I:%M %p') }}</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if past_due_assignments %}
                            <h6 class="text-danger">Past Due Assignments</h6>
                            <div class="list-group mb-3">
                                {% for assignment in past_due_assignments %}
                                    <a href="#" class="list-group-item list-group-item-action list-group-item-danger">
                                        <strong>{{ assignment.title }}</strong> ({{ assignment.class_info.name }})
                                        <small class="d-block">Due: {{ assignment.due_date.strftime('%b %d, %Y') }}</small>
                                    </a>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if upcoming_assignments %}
                            <h6 class="text-warning">Upcoming Assignments</h6>
                            <div class="list-group">
                                {% for assignment in upcoming_assignments %}
                                     <a href="#" class="list-group-item list-group-item-action list-group-item-warning">
                                        <strong>{{ assignment.title }}</strong> ({{ assignment.class_info.name }})
                                        <small class="d-block">Due: {{ assignment.due_date.strftime('%b %d, %Y') }}</small>
                                    </a>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if not notifications and not announcements and not past_due_assignments and not upcoming_assignments %}
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle-fill me-2"></i>You have no immediate notifications. Great job staying on top of your work!
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Grades Card -->
                <div class="card shadow-sm">
                     <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Recent Grades</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Assignment</th>
                                    <th>Class</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if recent_grades %}
                                    {% for grade in recent_grades %}
                                    <tr>
                                        <td>{{ grade.assignment.title }}</td>
                                        <td>{{ grade.class_name }}</td>
                                        <td><strong>{{ grade.score }}%</strong></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No grades have been posted recently.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'classes' %}
        <!-- My Classes View -->
        <h2 class="mb-4">My Enrolled Classes <span class="text-muted fs-6">(Student View)</span></h2>

        <div class="row">
            {% for class in my_classes %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ class.name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ class.subject }} - Grade {{ class.grade_level }}</h6>
                            <p class="card-text">
                                <strong>Teacher:</strong> {{ class.teacher.first_name }} {{ class.teacher.last_name if class.teacher else 'N/A' }}<br>
                                <strong>Subject:</strong> {{ class.subject or 'N/A' }}
                            </p>
                            <div class="d-flex flex-column gap-2">
                                <a href="{{ url_for('student.view_class', class_id=class.id) }}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Class
                                </a>
                                <a href="{{ url_for('student.view_class_assignments', class_id=class.id) }}" class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-journal-text me-1"></i>View Assignments
                                </a>
                                <a href="{{ url_for('student.view_class_teacher', class_id=class.id) }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-person me-1"></i>Teacher Info
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col">
                    <div class="alert alert-info">
                        You are not currently enrolled in any classes.
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Class Assignments View (when show_assignments is True) -->
        {% if show_assignments and class_obj %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="bi bi-journal-text text-info me-2"></i>
                        Assignments for {{ class_obj.name }}
                    </h3>
                    <a href="{{ url_for('student.student_classes') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Classes
                    </a>
                </div>
                
                {% if assignments %}
                    <div class="row g-3">
                        {% for assignment in assignments %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ assignment.title }}</h6>
                                        <p class="card-text small text-muted">
                                            {{ assignment.description or 'No description provided.' }}
                                        </p>
                                        
                                        <div class="mb-2">
                                            <strong>Due:</strong> 
                                            {% if assignment.due_date %}
                                                {{ assignment.due_date.strftime('%B %d, %Y at %I:%M %p') }}
                                                {% set days_remaining = (assignment.due_date.date() - today.date()).days %}
                                                {% if days_remaining > 0 %}
                                                    <span class="badge bg-success ms-2">{{ days_remaining }} days remaining</span>
                                                {% elif days_remaining == 0 %}
                                                    <span class="badge bg-warning ms-2">Due today</span>
                                                {% else %}
                                                    <span class="badge bg-danger ms-2">{{ abs(days_remaining) }} days overdue</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">No due date</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-2">
                                            <strong>Quarter:</strong> Q{{ assignment.quarter }}
                                        </div>
                                        
                                        {% if assignment.attachment_filename %}
                                        <div class="mb-2">
                                            <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-download me-1"></i>Download Assignment
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Submission Status -->
                                        {% set submission = submissions.get(assignment.id) %}
                                        {% set grade = grades.get(assignment.id) %}
                                        <div class="mt-2">
                                            {% if submission %}
                                                <span class="badge bg-success">Submitted</span>
                                                {% if grade %}
                                                    <span class="badge bg-info ms-1">Graded: {{ grade.score }}%</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-warning">Not Submitted</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No assignments have been posted for this class yet.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Teacher Info View (when show_teacher is True) -->
        {% if show_teacher and class_obj %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="bi bi-person text-secondary me-2"></i>
                        Teacher Information for {{ class_obj.name }}
                    </h3>
                    <a href="{{ url_for('student.student_classes') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Classes
                    </a>
                </div>
                
                {% if teacher %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-person-circle me-2"></i>
                                        {{ teacher.first_name }} {{ teacher.last_name }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <strong>Position:</strong> {{ teacher.position or 'Teacher' }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Email:</strong> 
                                            {% if teacher.email %}
                                                <a href="mailto:{{ teacher.email }}" class="text-decoration-none">
                                                    {{ teacher.email }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">Not available</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-12">
                                            <strong>Phone:</strong> 
                                            {% if teacher.phone %}
                                                <a href="tel:{{ teacher.phone }}" class="text-decoration-none">
                                                    {{ teacher.phone }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">Not available</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-12">
                                            <strong>Subject:</strong> {{ class_obj.subject }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Class:</strong> {{ class_obj.name }} - Grade {{ class_obj.grade_level }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Class Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <strong>Class Name:</strong> {{ class_obj.name }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Subject:</strong> {{ class_obj.subject }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Grade Level:</strong> {{ class_obj.grade_level }}
                                        </div>
                                        <div class="col-12">
                                            <strong>School Year:</strong> 
                                            {% if class_obj.school_year %}
                                                {{ class_obj.school_year.name }}
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No teacher has been assigned to this class yet.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

    {% elif section == 'grades' %}
        <!-- Grades View -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="bi bi-graph-up-arrow text-primary me-2"></i>
                    My Academic Performance
                </h2>
                
                <!-- Overall GPA Summary Card -->
                <div class="card bg-gradient-primary text-white shadow-lg mb-4 gpa-display">
                    <div class="card-body text-center py-4">
                        <h3 class="card-title mb-2">
                            <i class="bi bi-star-fill me-2"></i>
                            Overall Academic Standing
                        </h3>
                        <div class="display-4 fw-bold mb-2">{{ "%.2f"|format(gpa) }}</div>
                        <p class="card-text fs-5 mb-0">Collective GPA</p>
                        <div class="mt-3">
                            {% if gpa >= 3.5 %}
                                <span class="badge bg-success fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-award me-1"></i>Honor Roll
                                </span>
                            {% elif gpa >= 3.0 %}
                                <span class="badge bg-primary fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-check-circle me-1"></i>Good Standing
                                </span>
                            {% elif gpa >= 2.0 %}
                                <span class="badge bg-warning text-dark fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-exclamation-triangle me-1"></i>Needs Improvement
                                </span>
                            {% else %}
                                <span class="badge bg-danger fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-x-circle me-1"></i>Academic Warning
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if grades_by_class %}
            <!-- Academic Period Summary -->
            <div class="row g-4 mb-4">
                <!-- Quarters Summary -->
                {% if quarters %}
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-week me-2"></i>
                                Quarter Performance Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for quarter in quarters %}
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <h6 class="text-muted mb-2">{{ quarter.name }}</h6>
                                        {% set quarter_grades = [] %}
                                        {% for class_name, data in grades_by_class.items() %}
                                            {% if data.quarter_grades and data.quarter_grades.get(quarter.name) %}
                                                {% set _ = quarter_grades.append(data.quarter_grades[quarter.name].average) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if quarter_grades %}
                                            {% set quarter_avg = (quarter_grades | sum) / (quarter_grades | length) %}
                                            {% set quarter_gpa = calculate_gpa(quarter_grades) %}
                                            <div class="h4 fw-bold 
                                                {% if quarter_avg >= 90 %}text-success
                                                {% elif quarter_avg >= 80 %}text-primary
                                                {% elif quarter_avg >= 70 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ "%.1f"|format(quarter_avg) }}%
                                            </div>
                                            <div class="small text-muted">GPA: {{ "%.2f"|format(quarter_gpa) }}</div>
                                            <div class="small text-muted">{{ quarter_grades | length }} classes</div>
                                        {% else %}
                                            <div class="h4 text-muted">N/A</div>
                                            <div class="small text-muted">No grades</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Semesters Summary -->
                {% if semesters %}
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-month me-2"></i>
                                Semester Performance Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for semester in semesters %}
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <h6 class="text-muted mb-2">{{ semester.name }}</h6>
                                        {% set semester_grades = [] %}
                                        {% for class_name, data in grades_by_class.items() %}
                                            {% if data.semester_grades and data.semester_grades.get(semester.name) %}
                                                {% set _ = semester_grades.append(data.semester_grades[semester.name].average) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if semester_grades %}
                                            {% set semester_avg = (semester_grades | sum) / (semester_grades | length) %}
                                            {% set semester_gpa = calculate_gpa(semester_grades) %}
                                            <div class="h4 fw-bold 
                                                {% if semester_avg >= 90 %}text-success
                                                {% elif semester_avg >= 80 %}text-primary
                                                {% elif semester_avg >= 70 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ "%.1f"|format(semester_avg) }}%
                                            </div>
                                            <div class="small text-muted">GPA: {{ "%.2f"|format(semester_gpa) }}</div>
                                            <div class="small text-muted">{{ semester_grades | length }} classes</div>
                                        {% else %}
                                            <div class="h4 text-muted">N/A</div>
                                            <div class="small text-muted">No grades</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="row g-4">
                {% for class_name, data in grades_by_class.items() %}
                <div class="col-12 col-lg-6 col-xl-4">
                    <div class="card h-100 shadow-sm border-0 grade-card performance-indicator">
                        <div class="card-header bg-gradient-{{ 'success' if data.final_grade.percentage >= 90 else 'primary' if data.final_grade.percentage >= 80 else 'warning' if data.final_grade.percentage >= 70 else 'danger' }} text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-book me-2"></i>{{ class_name }}
                                </h5>
                                <span class="badge bg-white text-dark fs-6 px-2 py-1">
                                    {{ data.final_grade.letter }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <!-- Class GPA and Overall Grade -->
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="border-end">
                                        <div class="h4 text-primary fw-bold mb-1 gpa-display">{{ "%.2f"|format(data.class_gpa) }}</div>
                                        <small class="text-muted">Class GPA</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="h4 fw-bold mb-1 
                                        {% if data.final_grade.percentage >= 90 %}text-success
                                        {% elif data.final_grade.percentage >= 80 %}text-primary
                                        {% elif data.final_grade.percentage >= 70 %}text-warning
                                        {% else %}text-danger{% endif %}">
                                        {{ data.final_grade.percentage }}%
                                    </div>
                                    <small class="text-muted">Overall Grade</small>
                                </div>
                            </div>
                            
                            <!-- Quarter Grades -->
                            {% if data.quarter_grades %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-calendar-week me-1"></i>
                                    Quarter Grades
                                </h6>
                                <div class="row g-2">
                                    {% for quarter_name, quarter_data in data.quarter_grades.items() %}
                                    <div class="col-6">
                                        <div class="border rounded p-2 text-center">
                                            <div class="small text-muted">{{ quarter_name }}</div>
                                            <div class="fw-bold 
                                                {% if quarter_data.average >= 90 %}text-success
                                                {% elif quarter_data.average >= 80 %}text-primary
                                                {% elif quarter_data.average >= 70 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ quarter_data.average }}%
                                            </div>
                                            <div class="small">{{ quarter_data.letter }}</div>
                                            <div class="small text-muted">{{ quarter_data.assignments }} assignments</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Semester Grades -->
                            {% if data.semester_grades %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-calendar-month me-1"></i>
                                    Semester Grades
                                </h6>
                                <div class="row g-2">
                                    {% for semester_name, semester_data in data.semester_grades.items() %}
                                    <div class="col-6">
                                        <div class="border rounded p-2 text-center">
                                            <div class="small text-muted">{{ semester_name }}</div>
                                            <div class="fw-bold 
                                                {% if semester_data.average >= 90 %}text-success
                                                {% elif semester_data.average >= 80 %}text-primary
                                                {% elif semester_data.average >= 70 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ semester_data.average }}%
                                            </div>
                                            <div class="small">{{ semester_data.letter }}</div>
                                            <div class="small text-muted">{{ semester_data.assignments }} assignments</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Recent Assignments -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-clock-history me-1"></i>
                                    Recent Assignments
                                </h6>
                                {% if data.recent_assignments %}
                                    <div class="list-group list-group-flush recent-assignments">
                                        {% for assignment in data.recent_assignments %}
                                        <div class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold text-truncate" title="{{ assignment.title }}">
                                                    {{ assignment.title }}
                                                </div>
                                                <small class="text-muted">{{ assignment.graded_at }}</small>
                                            </div>
                                            <div class="ms-2 text-end">
                                                <div class="badge fs-6 px-2 py-1
                                                    {% if assignment.score >= 90 %}bg-success
                                                    {% elif assignment.score >= 80 %}bg-primary
                                                    {% elif assignment.score >= 70 %}bg-warning text-dark
                                                    {% else %}bg-danger{% endif %}">
                                                    {{ assignment.score }}%
                                                </div>
                                                <div class="small text-muted">{{ assignment.letter }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center text-muted py-3">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        <small>No recent assignments graded</small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Class Progress</small>
                                    <small class="text-muted">{{ data.final_grade.percentage }}%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar 
                                        {% if data.final_grade.percentage >= 90 %}bg-success
                                        {% elif data.final_grade.percentage >= 80 %}bg-primary
                                        {% elif data.final_grade.percentage >= 70 %}bg-warning
                                        {% else %}bg-danger{% endif %}"
                                         style="width: {{ data.final_grade.percentage }}%">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-light">
                            <button class="btn btn-outline-primary btn-sm w-100" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#details-{{ loop.index }}" 
                                    aria-expanded="false">
                                <i class="bi bi-chevron-down me-1"></i>
                                View All Assignments
                            </button>
                        </div>
                    </div>
                    
                    <!-- Collapsible Assignment Details -->
                    <div class="collapse mt-2" id="details-{{ loop.index }}">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-list-ul me-2"></i>
                                    All Assignment Grades
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0 assignment-details-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Assignment</th>
                                                <th class="text-center">Grade</th>
                                                <th class="text-center">Letter</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for assignment_title, assignment_grade in data.grades.Current.grade_details.items() %}
                                            <tr>
                                                <td class="text-truncate" style="max-width: 150px;" title="{{ assignment_title }}">
                                                    {{ assignment_title }}
                                                </td>
                                                <td class="text-center fw-bold">{{ assignment_grade }}</td>
                                                <td class="text-center">
                                                    {% set score = assignment_grade|replace('%', '')|int %}
                                                    <span class="badge 
                                                        {% if score >= 90 %}bg-success
                                                        {% elif score >= 80 %}bg-primary
                                                        {% elif score >= 70 %}bg-warning text-dark
                                                        {% else %}bg-danger{% endif %}">
                                                        {{ get_letter_grade(score) }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="card border-0 shadow-sm empty-grades-state">
                    <div class="card-body py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mt-3">No Grades Available</h4>
                        <p class="text-muted">You don't have any grades recorded yet. Check back after your teachers have graded your assignments.</p>
                    </div>
                </div>
            </div>
        {% endif %}

    {% elif section == 'assignments' %}
        <!-- Assignments List View -->
        <h2 class="mb-4">My Assignments</h2>

        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Due Date</th>
                            <th>Assignment Title</th>
                            <th>Class</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for assignment, submission in assignments_with_status %}
                            <tr>
                                <td>{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div>
                                        <strong>{{ assignment.title }}</strong>
                                        {% if assignment.attachment_filename %}
                                            <br><small class="text-primary">
                                                <i class="bi bi-paperclip me-1"></i>
                                                <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" class="text-decoration-none">
                                                    {{ assignment.attachment_original_filename }}
                                                </a>
                                            </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>{{ assignment.class_info.name }}</td>
                                <td>
                                    {% if submission %}
                                        {% if submission.status == 'Graded' %}
                                            <span class="badge bg-success">Graded ({{ submission.grade }})</span>
                                        {% elif submission.status in ['Received', 'Late Submission'] %}
                                            <span class="badge bg-info">Submitted</span>
                                        {% else %}
                                             <span class="badge bg-secondary">{{ submission.status }}</span>
                                        {% endif %}
                                    {% else %}
                                        {% if assignment.due_date < today %}
                                            <span class="badge bg-danger">Past Due</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Not Submitted</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('student.submit_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-primary">
                                        {% if submission %}View / Resubmit{% else %}Submit{% endif %}
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">You have no assignments.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    {% elif section == 'schedule' %}
        <!-- Schedule View -->
        <h2 class="mb-4">My Schedule</h2>
        
        <div class="alert alert-info">
            <h5><i class="bi bi-calendar-week-fill me-2"></i>Class Schedule</h5>
            <p>Your class schedule will be displayed here. This feature is currently under development.</p>
        </div>

    {% elif section == 'school-calendar' %}
        <!-- School Calendar View -->
        <h2 class="mb-4">School Calendar</h2>
        
        {% if calendar_data %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ calendar_data.month_name }} {{ calendar_data.year }}</h5>
                        <div>
                            <a href="?month={{ prev_month.month }}&year={{ prev_month.year }}" class="btn btn-sm btn-outline-light me-2">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                            <a href="?month={{ next_month.month }}&year={{ next_month.year }}" class="btn btn-sm btn-outline-light">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            {% for day in calendar_data.weekdays %}
                                <div class="calendar-day-header">{{ day }}</div>
                            {% endfor %}
                        </div>
                        <div class="calendar-body">
                            {% for week in calendar_data.weeks %}
                                <div class="calendar-week">
                                    {% for day in week %}
                                        <div class="calendar-day {% if day.is_today %}today{% endif %} {% if not day.is_current_month %}other-month{% endif %}">
                                            {% if day.day_num %}
                                                <div class="day-number">{{ day.day_num }}</div>
                                                {% if day.events %}
                                                    <div class="day-events">
                                                        {% for event in day.events %}
                                                            <div class="event-item holiday">
                                                                <small>{{ event.title }}</small>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Calendar Unavailable</h5>
                <p>The school calendar is currently unavailable. Please check back later.</p>
            </div>
        {% endif %}

    {% elif section == 'communications' %}
        <!-- Discord-like Communications Hub for Students -->
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>Student Chat Center</h2>
                    <div class="chat-actions">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="openNewMessageModal()">
                            <i class="bi bi-plus-circle me-1"></i>New Message
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="openCreateGroupModal()">
                            <i class="bi bi-people-plus me-1"></i>Create Group
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-layout">
                <!-- Left Sidebar - Chat List -->
                <div class="chat-sidebar">
                    <div class="sidebar-header">
                        <h6 class="mb-0"><i class="bi bi-hash me-2"></i>Chats & Groups</h6>
                    </div>
                    
                    <!-- Direct Messages -->
                    <div class="sidebar-section">
                        <div class="section-header" onclick="toggleSection('direct-messages')">
                            <i class="bi bi-person-lines-fill me-2"></i>Direct Messages
                            <i class="bi bi-chevron-down ms-auto" id="dm-chevron"></i>
                        </div>
                        <div class="section-content" id="direct-messages">
                            {% if messages %}
                                {% for message in messages[:10] %}
                                    <div class="chat-item" onclick="openChat('{{ message.sender.username }}', 'direct')">
                                        <div class="chat-avatar">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-name">{{ message.sender.username }}</div>
                                            <div class="chat-preview">{{ message.content[:30] }}{% if message.content|length > 30 %}...{% endif %}</div>
                                        </div>
                                        <div class="chat-meta">
                                            <small class="text-muted">{{ message.created_at.strftime('%H:%M') if message.created_at else 'N/A' }}</small>
                                            {% if not message.is_read %}
                                                <span class="unread-indicator"></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-chats">
                                    <i class="bi bi-chat-dots text-muted"></i>
                                    <small class="text-muted">No messages yet</small>
                                </div>
                            {% endif %}
                            
                            <!-- Quick Start New Chat -->
                            <div class="chat-item new-chat-item" onclick="openNewMessageModal()">
                                <div class="chat-avatar new-chat-avatar">
                                    <i class="bi bi-plus"></i>
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name text-info">Start New Chat</div>
                                    <div class="chat-preview">Click to message someone</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Groups -->
                    <div class="sidebar-section">
                        <div class="section-header" onclick="toggleSection('groups')">
                            <i class="bi bi-people-fill me-2"></i>Groups
                            <i class="bi bi-chevron-down ms-auto" id="groups-chevron"></i>
                        </div>
                        <div class="section-content" id="groups">
                            {% if groups %}
                                {% for group in groups[:5] %}
                                    <div class="chat-item" onclick="openChat('{{ group.name }}', 'group')">
                                        <div class="chat-avatar group-avatar">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-name">{{ group.name }}</div>
                                            <div class="chat-preview">{{ group.members|length }} members</div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-chats">
                                    <i class="bi bi-people text-muted"></i>
                                    <small class="text-muted">No groups yet</small>
                                </div>
                            {% endif %}
                            
                            <!-- Create New Group -->
                            <div class="chat-item new-chat-item" onclick="openCreateGroupModal()">
                                <div class="chat-avatar new-chat-avatar">
                                    <i class="bi bi-plus"></i>
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name text-info">Create Group</div>
                                    <div class="chat-preview">Start a new study group</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Announcements -->
                    <div class="sidebar-section">
                        <div class="section-header" onclick="toggleSection('announcements')">
                            <i class="bi bi-megaphone-fill me-2"></i>Announcements
                            <i class="bi bi-chevron-down ms-auto" id="announcements-chevron"></i>
                        </div>
                        <div class="section-content" id="announcements">
                            {% if announcements %}
                                {% for announcement in announcements[:5] %}
                                    <div class="chat-item announcement-item" onclick="openAnnouncement('{{ announcement.id }}')">
                                        <div class="chat-avatar announcement-avatar">
                                            <i class="bi bi-megaphone"></i>
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-name">{{ announcement.title }}</div>
                                            <div class="chat-preview">{{ announcement.message[:30] }}{% if announcement.message|length > 30 %}...{% endif %}</div>
                                        </div>
                                        {% if announcement.is_important %}
                                            <span class="badge bg-warning badge-sm">!</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-chats">
                                    <i class="bi bi-megaphone text-muted"></i>
                                    <small class="text-muted">No announcements</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="chat-main">
                    <div class="chat-welcome" id="chat-welcome">
                        <div class="welcome-content">
                            <i class="bi bi-chat-dots display-1 text-muted"></i>
                            <h3 class="mt-3">Welcome to Student Chat!</h3>
                            <p class="text-muted">Select a chat from the sidebar to start messaging</p>
                            <div class="welcome-actions">
                                <button class="btn btn-primary me-2" onclick="openNewMessageModal()">
                                    <i class="bi bi-plus-circle me-1"></i>Start New Chat
                                </button>
                                <button class="btn btn-outline-info" onclick="openCreateGroupModal()">
                                    <i class="bi bi-people-plus me-1"></i>Create Study Group
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Active Chat (Hidden by default) -->
                    <div class="active-chat" id="active-chat" style="display: none;">
                        <div class="chat-header-bar">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-link btn-sm me-2" onclick="closeActiveChat()">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                                <div class="chat-avatar me-2">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div>
                                    <div class="chat-name" id="active-chat-name">Chat Name</div>
                                    <div class="chat-status" id="active-chat-status">Online</div>
                                </div>
                            </div>
                        </div>

                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will be loaded here -->
                        </div>

                        <div class="chat-input-area">
                            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                                <small class="text-muted"><i class="bi bi-three-dots"></i> Someone is typing...</small>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="message-input" placeholder="Type your message..." oninput="handleTyping()">
                                <button class="btn btn-primary" onclick="sendMessage()" id="send-button">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Message Modal -->
        <div class="modal fade" id="newMessageModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">New Message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="recipient" class="form-label">To:</label>
                            <select class="form-select" id="recipient">
                                <option value="">Select recipient...</option>
                                <!-- Recipients will be populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="message-content" class="form-label">Message:</label>
                            <textarea class="form-control" id="message-content" rows="4" placeholder="Type your message..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="sendNewMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Group Modal -->
        <div class="modal fade" id="createGroupModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Group</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="group-name" class="form-label">Group Name:</label>
                            <input type="text" class="form-control" id="group-name" placeholder="Enter group name...">
                        </div>
                        <div class="mb-3">
                            <label for="group-description" class="form-label">Description:</label>
                            <textarea class="form-control" id="group-description" rows="3" placeholder="Enter group description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="group-members" class="form-label">Add Members:</label>
                            <select class="form-select" id="group-members" multiple>
                                <!-- Members will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'messages' %}
        <!-- Messages List View -->
        <h2 class="mb-4">All Messages</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Messages</h5>
                    <a href="{{ url_for('student.student_send_message') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Send Message
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if messages %}
                    <div class="list-group list-group-flush">
                        {% for message in messages %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ message.subject or 'No Subject' }}</h6>
                                        <small class="text-muted">From: {{ message.sender.username }}</small>
                                        <p class="mb-1 text-truncate">{{ message.content[:150] }}{% if message.content|length > 150 %}...{% endif %}</p>
                                        <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="ms-2">
                                        {% if not message.is_read %}
                                            <span class="badge bg-danger">New</span>
                                        {% endif %}
                                        <a href="{{ url_for('student.student_view_message', message_id=message.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-envelope text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">No messages to display.</p>
                        <a href="{{ url_for('student.student_send_message') }}" class="btn btn-primary">
                            <i class="bi bi-envelope-plus me-2"></i>Send Your First Message
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

    {% elif section == 'view_message' %}
        <!-- View Specific Message -->
        <h2 class="mb-4">View Message</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Message Details</h5>
            </div>
            <div class="card-body">
                {% if message %}
                    <div class="mb-3">
                        <h5>{{ message.subject or 'No Subject' }}</h5>
                        <div class="text-muted mb-2">
                            <strong>From:</strong> {{ message.sender.username }}<br>
                            <strong>Date:</strong> {{ message.created_at.strftime('%Y-%m-%d %H:%M') }}<br>
                            {% if message.is_read %}
                                <strong>Read:</strong> {{ message.read_at.strftime('%Y-%m-%d %H:%M') if message.read_at else 'Unknown' }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Message Content:</h6>
                        <div class="border rounded p-3 bg-light">
                            {{ message.content|nl2br }}
                        </div>
                    </div>
                    {% if message.attachments %}
                        <div class="mb-3">
                            <h6>Attachments:</h6>
                            <ul class="list-group">
                                {% for attachment in message.attachments %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ attachment.original_filename }}</span>
                                        <small class="text-muted">{{ attachment.file_size }} bytes</small>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    <div class="mt-3">
                                                        <a href="{{ url_for('student.student_messages') }}" class="btn btn-outline-secondary">Back to Messages</a>
                    </div>
                {% else %}
                    <p class="text-muted">Message not found.</p>
                {% endif %}
            </div>
        </div>

    {% elif section == 'groups' %}
        <!-- Groups List View -->
        <h2 class="mb-4">Message Groups</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Your Groups</h5>
                                                <a href="{{ url_for('student.student_create_group') }}" class="btn btn-light btn-sm">
                                <i class="bi bi-plus-circle me-1"></i>Create Group
                            </a>
                </div>
            </div>
            <div class="card-body">
                {% if groups %}
                    <div class="row">
                        {% for group in groups %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ group.name }}</h6>
                                        <p class="card-text text-muted">{{ group.description or 'No description' }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Type: {{ group.group_type }}</small>
                                            <a href="{{ url_for('student.student_view_group', group_id=group.id) }}" class="btn btn-sm btn-outline-info">View</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-people-fill text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">You are not a member of any message groups.</p>
                        <a href="{{ url_for('student.student_create_group') }}" class="btn btn-info">
                            <i class="bi bi-plus-circle me-2"></i>Create Your First Group
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

    {% elif section == 'view_group' %}
        <!-- View Specific Group -->
        <h2 class="mb-4">Group: {{ group.name }}</h2>

        <div class="row">
            <!-- Group Information and Messages -->
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Group Messages</h5>
                    </div>
                    <div class="card-body">
                        {% if group %}
                            <div class="mb-3">
                                <h6>Group Information:</h6>
                                <p><strong>Name:</strong> {{ group.name }}</p>
                                <p><strong>Description:</strong> {{ group.description or 'No description' }}</p>
                                <p><strong>Type:</strong> {{ group.group_type }}</p>
                            </div>
                            
                            {% if messages %}
                                <h6>Messages:</h6>
                                <div class="list-group">
                                    {% for message in messages %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ message.subject or 'No Subject' }}</h6>
                                                    <small class="text-muted">From: {{ message.sender.username }}</small>
                                                    <p class="mb-1">{{ message.content[:200] }}{% if message.content|length > 200 %}...{% endif %}</p>
                                                    <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No messages in this group.</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">Group not found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Send Message to Group -->
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Send Message</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('student.student_send_group_message', group_id=group.id) }}">
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject (Optional)</label>
                                <input type="text" class="form-control" id="subject" name="subject" placeholder="Message subject">
                            </div>
                            
                            <div class="mb-3">
                                <label for="content" class="form-label">Message</label>
                                <textarea class="form-control" id="content" name="content" rows="4" placeholder="Type your message..." required></textarea>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Send to Group</button>
                            </div>
                        </form>
                        
                        <hr>
                        
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('student.student_groups') }}" class="btn btn-outline-secondary">Back to Groups</a>
                            {% if group and group.created_by != current_user.id %}
                                <form method="POST" action="{{ url_for('student.student_leave_group', group_id=group.id) }}" 
                                      onsubmit="return confirm('Are you sure you want to leave this group?')">
                                    <button type="submit" class="btn btn-outline-danger">Leave Group</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'announcements' %}
        <!-- Announcements List View -->
        <h2 class="mb-4">Announcements</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-megaphone-fill me-2"></i>All Announcements</h5>
            </div>
            <div class="card-body">
                {% if announcements %}
                    <div class="list-group list-group-flush">
                        {% for announcement in announcements %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ announcement.title }}</h6>
                                        <small class="text-muted">From: {{ announcement.sender.username }}</small>
                                        <p class="mb-1">{{ announcement.message }}</p>
                                        <small class="text-muted">{{ announcement.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="ms-2">
                                        {% if announcement.is_important %}
                                            <span class="badge bg-warning">Important</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No announcements to display.</p>
                {% endif %}
            </div>
        </div>

    {% elif section == 'send_message' %}
        <!-- Send Message View -->
        <h2 class="mb-4">Send Message</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Compose New Message</h5>
            </div>
            <div class="card-body">
                                        <form method="POST" action="{{ url_for('student.student_send_message') }}">
                    <div class="mb-3">
                        <label for="recipient_id" class="form-label">Recipient</label>
                        <select class="form-select" id="recipient_id" name="recipient_id" required>
                            <option value="">Choose a recipient...</option>
                            
                            <!-- Students Section -->
                            <optgroup label="Students">
                                {% for student in students %}
                                    {% if student.user %}
                                        <option value="{{ student.user.id }}">{{ student.first_name }} {{ student.last_name }} (Student)</option>
                                    {% endif %}
                                {% endfor %}
                            </optgroup>
                            
                            <!-- Teachers Section -->
                            <optgroup label="Teachers & Staff">
                                {% for teacher in teachers %}
                                    {% if teacher.user %}
                                        <option value="{{ teacher.user.id }}">{{ teacher.first_name }} {{ teacher.last_name }} ({{ teacher.role }})</option>
                                    {% endif %}
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject (Optional)</label>
                        <input type="text" class="form-control" id="subject" name="subject" placeholder="Message subject">
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">Message Content</label>
                        <textarea class="form-control" id="content" name="content" rows="6" placeholder="Type your message here..." required></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                                                    <a href="{{ url_for('student.student_messages') }}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Send Message</button>
                    </div>
                </form>
            </div>
        </div>

    {% elif section == 'create_group' %}
        <!-- Create Group View -->
        <h2 class="mb-4">Create New Group</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Create Message Group</h5>
            </div>
            <div class="card-body">
                                        <form method="POST" action="{{ url_for('student.student_create_group') }}">
                    <div class="mb-3">
                        <label for="name" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="Enter group name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe the group's purpose"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="group_type" class="form-label">Group Type</label>
                        <select class="form-select" id="group_type" name="group_type">
                            <option value="student">Student Group</option>
                            <option value="study">Study Group</option>
                            <option value="social">Social Group</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Add Members</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            {% for student in students %}
                                {% if student.user and student.user.id != current_user.id %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="members" value="{{ student.user.id }}" id="member_{{ student.user.id }}">
                                        <label class="form-check-label" for="member_{{ student.user.id }}">
                                            {{ student.first_name }} {{ student.last_name }}
                                        </label>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <small class="text-muted">Select the students you want to add to this group.</small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                                                    <a href="{{ url_for('student.student_groups') }}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-info">Create Group</button>
                    </div>
                </form>
            </div>
        </div>

    {% elif section == 'sent_messages' %}
        <!-- Sent Messages View -->
        <h2 class="mb-4">Sent Messages</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Messages You've Sent</h5>
            </div>
            <div class="card-body">
                {% if sent_messages %}
                    <div class="list-group list-group-flush">
                        {% for message in sent_messages %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ message.subject or 'No Subject' }}</h6>
                                        <small class="text-muted">
                                            To: 
                                            {% if message.recipient %}
                                                {{ message.recipient.username }}
                                            {% elif message.group %}
                                                {{ message.group.name }} (Group)
                                            {% else %}
                                                Unknown
                                            {% endif %}
                                        </small>
                                        <p class="mb-1 text-truncate">{{ message.content[:150] }}{% if message.content|length > 150 %}...{% endif %}</p>
                                        <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="ms-2">
                                        {% if message.message_type == 'group' %}
                                            <span class="badge bg-info">Group</span>
                                        {% else %}
                                            <span class="badge bg-primary">Direct</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">You haven't sent any messages yet.</p>
                {% endif %}
            </div>
        </div>

    {% elif section == 'settings' %}
        <!-- Settings Section -->
        <h2 class="mb-4">Settings <span class="text-muted fs-6">(Student View)</span></h2>

        <div class="row">
            <div class="col-lg-8">
                <!-- Account Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-fill me-2"></i>Account Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Student ID</label>
                                    <input type="text" class="form-control" value="{{ student.state_id or 'N/A' }}" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" value="{{ student.first_name }} {{ student.last_name }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Grade Level</label>
                                    <input type="text" class="form-control" value="{{ student.grade_level or 'N/A' }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Preferences</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notification_preferences" class="form-label">Notification Preferences</label>
                                    <select class="form-select" id="notification_preferences">
                                        <option value="all">All Notifications</option>
                                        <option value="important">Important Only</option>
                                        <option value="none">No Notifications</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="theme_preference" class="form-label">Theme</label>
                                    <select class="form-select" id="theme_preference">
                                        <option value="light">Light Theme</option>
                                        <option value="dark">Dark Theme</option>
                                        <option value="auto">Auto (System)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-info" onclick="savePreferences()">
                            <i class="bi bi-check-circle me-2"></i>Save Preferences
                        </button>
                    </div>
                </div>

                <!-- Bug Report -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-bug-fill me-2"></i>Report a Bug</h5>
                    </div>
                    <div class="card-body">
                        <form id="studentBugReportForm">
                            <div class="mb-3">
                                <label for="student_bug_title" class="form-label">Bug Title:</label>
                                <input type="text" class="form-control" id="student_bug_title" name="title" placeholder="Brief description of the issue..." required>
                            </div>
                            <div class="mb-3">
                                <label for="student_bug_description" class="form-label">Detailed Description:</label>
                                <textarea class="form-control" id="student_bug_description" name="description" rows="5" placeholder="Please describe the bug you encountered in detail..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="student_bug_severity" class="form-label">Severity Level:</label>
                                <select class="form-select" id="student_bug_severity" name="severity">
                                    <option value="low">Low - Minor issue, doesn't affect functionality</option>
                                    <option value="medium" selected>Medium - Some functionality affected</option>
                                    <option value="high">High - Major functionality broken</option>
                                    <option value="critical">Critical - System unusable</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="student_contact_email" class="form-label">Your Email (Optional):</label>
                                <input type="email" class="form-control" id="student_contact_email" name="contact_email" placeholder="Enter your email for follow-up">
                            </div>
                            <input type="hidden" name="page_url" value="{{ request.url }}">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-send me-2"></i>Submit Bug Report
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Quick Actions -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="exportData()">
                                <i class="bi bi-download me-2"></i>Export My Data
                            </button>
                            <button class="btn btn-outline-info" onclick="viewActivityLog()">
                                <i class="bi bi-clock-history me-2"></i>View Activity Log
                            </button>
                            <button class="btn btn-outline-warning" onclick="changePassword()">
                                <i class="bi bi-key me-2"></i>Change Password
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>System Information</h5>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">
                            <p><strong>Last Login:</strong> <span id="lastLogin">Loading...</span></p>
                            <p><strong>Account Created:</strong> <span id="accountCreated">Loading...</span></p>
                            <p><strong>Version:</strong> 1.0.0</p>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Chat functionality for Discord-like interface
        let currentChat = null;
        let currentChatType = null;

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const chevron = document.getElementById(sectionId + '-chevron');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                chevron.className = 'bi bi-chevron-down ms-auto';
            } else {
                section.style.display = 'none';
                chevron.className = 'bi bi-chevron-up ms-auto';
            }
        }

        function openChat(chatName, chatType) {
            currentChat = chatName;
            currentChatType = chatType;
            
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('active-chat').style.display = 'flex';
            document.getElementById('active-chat-name').textContent = chatName;
            document.getElementById('active-chat-status').textContent = chatType === 'group' ? 'Group Chat' : 'Direct Message';
            
            // Load chat messages
            loadChatMessages(chatName, chatType);
        }

        function closeActiveChat() {
            currentChat = null;
            currentChatType = null;
            document.getElementById('active-chat').style.display = 'none';
            document.getElementById('chat-welcome').style.display = 'flex';
            document.getElementById('chat-messages').innerHTML = '';
        }

        function loadChatMessages(chatName, chatType) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (chatType === 'direct') {
                // Load direct message history
                loadDirectMessages(chatName);
            } else if (chatType === 'group') {
                // Load group message history
                loadGroupMessages(chatName);
            }
        }

        function loadDirectMessages(recipientName) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Find the user by username
            const recipient = findUserByUsername(recipientName);
            if (!recipient) {
                messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">User not found</div>';
                return;
            }

            // Load messages between current user and recipient
            fetch(`/student/communications/messages?recipient_id=${recipient.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages, 'direct');
                    } else {
                        messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">No messages found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">Error loading messages</div>';
                });
        }

        function loadGroupMessages(groupName) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Find the group by name
            const group = findGroupByName(groupName);
            if (!group) {
                messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">Group not found</div>';
                return;
            }

            // Load group messages
            fetch(`/student/communications/group/${group.id}/messages`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages, 'group');
                    } else {
                        messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">No messages found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">Error loading messages</div>';
                });
        }

        function displayMessages(messages, chatType) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (!messages || messages.length === 0) {
                messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">No messages yet. Start the conversation!</div>';
                return;
            }

            let html = '';
            messages.forEach(message => {
                const isOwnMessage = message.sender_id === {{ current_user.id }};
                const messageClass = isOwnMessage ? 'message-item own-message mb-3' : 'message-item mb-3';
                const avatarClass = isOwnMessage ? 'chat-avatar own-avatar me-2' : 'chat-avatar me-2';
                
                html += `
                    <div class="${messageClass}">
                        <div class="d-flex align-items-start ${isOwnMessage ? 'justify-content-end' : ''}">
                            ${!isOwnMessage ? `<div class="${avatarClass}">
                                <i class="bi bi-person-circle"></i>
                            </div>` : ''}
                            <div class="message-content ${isOwnMessage ? 'text-end' : ''}">
                                <div class="message-header">
                                    <span class="message-author ${isOwnMessage ? 'text-info' : 'text-primary'}">${message.sender_name}</span>
                                    <small class="text-muted ms-2">${formatMessageTime(message.created_at)}</small>
                                </div>
                                <div class="message-text text-white">${message.content}</div>
                            </div>
                            ${isOwnMessage ? `<div class="${avatarClass}">
                                <i class="bi bi-person-circle"></i>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            messagesContainer.innerHTML = html;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !currentChat) return;
            
            if (currentChatType === 'direct') {
                sendDirectMessage(message);
            } else if (currentChatType === 'group') {
                sendGroupMessage(message);
            }
        }

        function sendDirectMessage(content) {
            const recipient = findUserByUsername(currentChat);
            if (!recipient) return;

            fetch('/student/communications/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recipient_id: recipient.id,
                    content: content,
                    message_type: 'direct'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add message to chat
                    addMessageToChat({
                        sender_id: {{ current_user.id }},
                        sender_name: '{{ current_user.username }}',
                        content: content,
                        created_at: new Date().toISOString()
                    });
                    document.getElementById('message-input').value = '';
                } else {
                    alert('Error sending message: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        }

        function sendGroupMessage(content) {
            const group = findGroupByName(currentChat);
            if (!group) return;

            fetch(`/student/communications/group/${group.id}/send-message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: content,
                    message_type: 'group'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add message to chat
                    addMessageToChat({
                        sender_id: {{ current_user.id }},
                        sender_name: '{{ current_user.username }}',
                        content: content,
                        created_at: new Date().toISOString()
                    });
                    document.getElementById('message-input').value = '';
                } else {
                    alert('Error sending message: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        }

        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item own-message mb-3';
            
            messageElement.innerHTML = `
                <div class="d-flex align-items-start justify-content-end">
                    <div class="message-content text-end">
                        <div class="message-header">
                            <span class="message-author text-info">You</span>
                            <small class="text-muted ms-2">${formatMessageTime(message.created_at)}</small>
                        </div>
                        <div class="message-text text-white">${message.content}</div>
                    </div>
                    <div class="chat-avatar own-avatar me-2">
                        <i class="bi bi-person-circle"></i>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function openNewMessageModal() {
            // Populate recipients dropdown
            populateRecipientsDropdown();
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined') {
                const modal = new bootstrap.Modal(document.getElementById('newMessageModal'));
                modal.show();
            } else {
                // Fallback: show modal manually
                document.getElementById('newMessageModal').style.display = 'block';
                document.getElementById('newMessageModal').classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        function openCreateGroupModal() {
            // Populate members dropdown
            populateMembersDropdown();
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined') {
                const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
                modal.show();
            } else {
                // Fallback: show modal manually
                document.getElementById('createGroupModal').style.display = 'block';
                document.getElementById('createGroupModal').classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        function populateRecipientsDropdown() {
            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = '<option value="">Select recipient...</option>';
            
            // Add sample recipients for now
            const sampleRecipients = [
                { id: 1, username: 'Teacher Smith' },
                { id: 2, username: 'Teacher Johnson' },
                { id: 3, username: 'Student Alice' },
                { id: 4, username: 'Student Bob' }
            ];
            
            sampleRecipients.forEach(recipient => {
                recipientSelect.innerHTML += `<option value="${recipient.id}">${recipient.username}</option>`;
            });
        }

        function populateMembersDropdown() {
            const membersSelect = document.getElementById('group-members');
            membersSelect.innerHTML = '';
            
            // Add sample members for now
            const sampleMembers = [
                { id: 1, username: 'Student Alice' },
                { id: 2, username: 'Student Bob' },
                { id: 3, username: 'Student Charlie' },
                { id: 4, username: 'Student Diana' }
            ];
            
            sampleMembers.forEach(member => {
                membersSelect.innerHTML += `<option value="${member.id}">${member.username}</option>`;
            });
        }

        function sendNewMessage() {
            const recipientId = document.getElementById('recipient').value;
            const content = document.getElementById('message-content').value;
            
            if (!recipientId || !content) {
                alert('Please fill in all fields');
                return;
            }

            // For now, just show success and close modal
            alert('Message sent successfully!');
            closeModal('newMessageModal');
            
            // Clear form
            document.getElementById('recipient').value = '';
            document.getElementById('message-content').value = '';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        function createGroup() {
            const name = document.getElementById('group-name').value;
            const description = document.getElementById('group-description').value;
            const memberIds = Array.from(document.getElementById('group-members').selectedOptions).map(option => option.value);
            
            if (!name || !description) {
                alert('Please fill in group name and description');
                return;
            }

            // For now, just show success and close modal
            alert(`Group "${name}" created successfully!`);
            closeModal('createGroupModal');
            
            // Clear form
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-members').selectedIndex = -1;
        }

        function openAnnouncement(announcementId) {
            // For now, just show a simple alert
            alert(`Opening announcement ${announcementId}`);
            
            // In the future, this would load the actual announcement data
            // and display it in a modal
        }

        function showAnnouncementModal(announcement) {
            // For now, just show an alert
            alert(`Announcement: ${announcement.title}\n\n${announcement.message}`);
        }

        // Helper functions
        function findUserByUsername(username) {
            // This would typically search through available users
            // For now, return a mock user object
            return { id: 1, username: username };
        }

        function findGroupByName(groupName) {
            // This would typically search through available groups
            // For now, return a mock group object
            return { id: 1, name: groupName };
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Typing indicator functionality
        let typingTimeout;
        let isTyping = false;

        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                showTypingIndicator();
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                hideTypingIndicator();
            }, 1000);
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // Enhanced message input handling
        function handleMessageInput() {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            
            if (messageInput && sendButton) {
                messageInput.addEventListener('input', function() {
                    sendButton.disabled = !this.value.trim();
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }

        // Auto-refresh chat data
        function startAutoRefresh() {
            if (currentChat && currentChatType) {
                setInterval(() => {
                    loadChatMessages(currentChat, currentChatType);
                }, 30000); // Refresh every 30 seconds
            }
        }

        // Handle Enter key in message input
        document.addEventListener('DOMContentLoaded', function() {
            handleMessageInput();
            
            // Initialize chat sections
            initializeChatSections();
            
            // Add modal close handlers
            addModalCloseHandlers();
        });

        function addModalCloseHandlers() {
            // Close modal when clicking close button
            const closeButtons = document.querySelectorAll('.btn-close');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // Close modal when clicking outside
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
        }

        function initializeChatSections() {
            // Set default sections to expanded
            const sections = ['direct-messages', 'groups', 'announcements'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle student bug report form submission
            const studentBugReportForm = document.getElementById('studentBugReportForm');
            if (studentBugReportForm) {
                studentBugReportForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(studentBugReportForm);
                    const submitButton = studentBugReportForm.querySelector('button[type="submit"]');
                    const originalText = submitButton.innerHTML;
                    
                    // Disable button and show loading state
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Submitting...';
                    
                    fetch('{{ url_for("auth.submit_bug_report") }}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show';
                            alertDiv.innerHTML = `
                                <i class="bi bi-check-circle-fill me-2"></i>${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            studentBugReportForm.parentNode.insertBefore(alertDiv, studentBugReportForm);
                            
                            // Reset form
                            studentBugReportForm.reset();
                        } else {
                            // Show error message
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                            alertDiv.innerHTML = `
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            studentBugReportForm.parentNode.insertBefore(alertDiv, studentBugReportForm);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>An error occurred while submitting the bug report. Please try again.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        studentBugReportForm.parentNode.insertBefore(alertDiv, studentBugReportForm);
                    })
                    .finally(() => {
                        // Re-enable button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    });
                });
            }
        });

        function savePreferences() {
            alert('Preferences saved successfully!');
        }

        function exportData() {
            alert('Export functionality will be implemented here.');
        }

        function viewActivityLog() {
            alert('Activity log functionality will be implemented here.');
        }

        function changePassword() {
            alert('Password change functionality will be implemented here.');
        }
        </script>

    {% else %}
        <!-- Generic fallback content for other sections -->
        <div class="alert alert-warning">
            <h4>Debug Information:</h4>
            <p><strong>Section:</strong> "{{ section }}"</p>
            <p><strong>Active Tab:</strong> "{{ active_tab }}"</p>
            <p><strong>Student:</strong> {{ student.first_name }} {{ student.last_name if student else 'NONE' }}</p>
            <hr>
            <p>Content for the '{{ section }}' section for students is currently under development. Please check back later!</p>
        </div>
    {% endif %}
</div>
{% endblock %} 