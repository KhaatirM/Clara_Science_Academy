{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <!-- DEBUG: Current section is "{{ section }}" -->
    {% if section == 'home' %}
        <!-- Home Dashboard -->
        <h2 class="mb-4">Teacher Dashboard <span class="text-muted fs-6">(Teacher View)</span></h2>

        <div class="row g-3 g-md-4">
            <!-- Left Column -->
            <div class="col-12 col-lg-5">
                <!-- Teacher Information Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #2E8B57 0%, #228B22 50%, #556B2F 100%);">
                        <h5 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i>{% if is_admin %}Administrator Information{% else %}Teacher Information{% endif %}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% if teacher %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Name:</strong>
                                <span>{{ teacher.first_name }} {{ teacher.last_name }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Email:</strong>
                                <span>{{ teacher.email or 'N/A' }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Phone:</strong>
                                <span>{{ teacher.phone or 'N/A' }}</span>
                            </li>
                            {% else %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Role:</strong>
                                <span>{{ current_user.role }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Username:</strong>
                                <span>{{ current_user.username }}</span>
                            </li>
                            {% endif %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Classes:</strong>
                                <span>{{ classes|length if classes else 0 }}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #228B22 0%, #2E8B57 50%, #556B2F 100%);">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('teacher.my_classes') }}" class="btn" style="border-color: #2E8B57; color: #2E8B57;">
                                <i class="bi bi-house-door-fill me-2"></i>View My Classes
                            </a>
                            <a href="{{ url_for('teacher.my_assignments') }}" class="btn" style="border-color: #228B22; color: #228B22;">
                                <i class="bi bi-journal-check me-2"></i>Manage Assignments
                            </a>
                            <a href="{{ url_for('teacher.my_grades') }}" class="btn" style="border-color: #556B2F; color: #556B2F;">
                                <i class="bi bi-mortarboard-fill me-2"></i>Grade Assignments
                            </a>
                            <a href="{{ url_for('teacher.student_grades') }}" class="btn" style="border-color: #2E8B57; color: #2E8B57;">
                                <i class="bi bi-graph-up me-2"></i>View Student Grades
                            </a>
                            <a href="{{ url_for('teacher.attendance') }}" class="btn" style="border-color: #228B22; color: #228B22;">
                                <i class="bi bi-calendar-check-fill me-2"></i>Take Attendance
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-7">
                <!-- Notifications Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #556B2F 0%, #2E8B57 50%, #228B22 100%);">
                        <h5 class="mb-0"><i class="bi bi-bell-fill me-2"></i>Notifications</h5>
                    </div>
                    <div class="card-body">
                        {% if notifications and notifications|length > 0 %}
                            <div class="list-group mb-3">
                                {% for notification in notifications %}
                                    <div class="list-group-item list-group-item-action {% if not notification.is_read %}list-group-item-warning{% endif %}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ notification.title }}</strong>
                                                <p class="mb-1">{{ notification.message }}</p>
                                                <small class="text-muted">{{ notification.timestamp.strftime('%b %d, %Y %I:%M %p') }}</small>
                                            </div>
                                            <div class="ms-2">
                                                {% if not notification.is_read %}
                                                    <span class="badge bg-warning text-dark">New</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            {% if notification.link %}
                                                <a href="{{ notification.link }}" class="btn btn-sm btn-outline-warning me-2">View Details</a>
                                            {% endif %}
                                            {% if not notification.is_read %}
                                                <form method="POST" action="{{ url_for('teacher.mark_notification_read', notification_id=notification.id) }}" style="display: inline;">
        {{ csrf_token() }}
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary">Mark as Read</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle-fill me-2"></i>No new notifications at this time.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_activity and recent_activity|length > 0 %}
                            <div class="list-group">
                                {% for activity in recent_activity %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ activity.title }}</strong>
                                                <p class="mb-1 text-muted">{{ activity.description }}</p>
                                                <small class="text-muted">{{ activity.timestamp.strftime('%b %d, %Y %I:%M %p') }}</small>
                                            </div>
                                            <div class="ms-2">
                                                {% if activity.type == 'submission' %}
                                                    <span class="badge bg-primary">Submission</span>
                                                {% elif activity.type == 'grade' %}
                                                    <span class="badge bg-success">Grade</span>
                                                {% elif activity.type == 'assignment' %}
                                                    <span class="badge bg-info">Assignment</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ activity.type|title }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if activity.link %}
                                            <a href="{{ activity.link }}" class="btn btn-sm btn-outline-primary mt-2">View Details</a>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle-fill me-2"></i>No recent activity to display. Start by creating assignments or grading student work!
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Statistics Card -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center g-3">
                            <div class="col-4">
                                <h4 class="text-primary">{{ classes|length if classes else 0 }}</h4>
                                <small class="text-muted">Classes</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-success">{{ total_students if total_students else 0 }}</h4>
                                <small class="text-muted">Students</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-warning">{{ active_assignments if active_assignments else 0 }}</h4>
                                <small class="text-muted">Assignments</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'classes' %}
        <!-- My Classes View -->
        <h2 class="mb-4">My Classes <span class="text-muted fs-6">(Teacher View)</span></h2>

        <div class="row g-3 g-md-4">
            {% for class in classes %}
                <div class="col-12 col-sm-6 col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">{{ class.name }}</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="flex-grow-1">
                                <p class="card-text">
                                    <strong>Subject:</strong> {{ class.subject or 'N/A' }}<br>
                                    <strong>Grade Level:</strong> {{ class.grade_level or 'N/A' }}<br>
                                    <strong>School Year:</strong> {{ class.school_year.name if class.school_year else 'N/A' }}
                                </p>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('teacher.view_class', class_id=class.id) }}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Class
                                </a>
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('teacher.add_assignment', class_id=class.id) }}" class="btn btn-outline-success btn-sm flex-fill">
                                        <i class="bi bi-plus-circle me-1"></i>Add Assignment
                                    </a>
                                    <a href="{{ url_for('teacher.take_attendance', class_id=class.id) }}" class="btn btn-outline-warning btn-sm flex-fill">
                                        <i class="bi bi-clipboard-check me-1"></i>Take Attendance
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle me-2"></i>No Classes Assigned</h5>
                        <p>You don't have any classes assigned to you yet. Please contact the school administrator.</p>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% elif section == 'assignments' %}
        <!-- Assignments View -->
        <h2 class="mb-4">My Assignments</h2>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Due Date</th>
                                <th>Assignment Title</th>
                                <th>Class</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ assignment.title }}</td>
                                    <td>{{ assignment.class_info.name }}</td>
                                    <td>
                                        {% if assignment.due_date < today %}
                                            <span class="badge bg-danger">Past Due</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <a href="{{ url_for('teacher.view_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-secondary">
                                                View
                                            </a>
                                            <a href="{{ url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-primary">
                                                Grade
                                            </a>
                                            <a href="{{ url_for('teacher.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-warning">
                                                Edit
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-assignment-btn"
                                                    data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}">
                                                Remove
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">You have no assignments created yet.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'grades' %}
        <!-- Grades View -->
        <h2 class="mb-4">Grade Management</h2>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Assignment</th>
                                <th>Class</th>
                                <th>Due Date</th>
                                <th>Students</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.title }}</td>
                                    <td>{{ assignment.class_info.name }}</td>
                                    <td>{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ assignment.students|length if assignment.students else 0 }}</td>
                                    <td>
                                        <a href="{{ url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-sm btn-primary">
                                            Grade Assignment
                                        </a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No assignments available for grading.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'student-grades' %}
        <!-- Student Grades View -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="bi bi-mortarboard-fill text-primary me-2"></i>
                Student Grades Overview
            </h2>
            <div class="d-flex gap-2">
                <a href="{{ url_for('teacher.my_grades') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Grade Management
                </a>
            </div>
        </div>

        <!-- Class Filter -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('teacher.student_grades') }}" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="class_filter" class="form-label">Filter by Class:</label>
                        <select class="form-select" id="class_filter" name="class_id">
                            <option value="">All Classes</option>
                            {% for class in classes %}
                                <option value="{{ class.id }}" {% if class_filter == class.id %}selected{% endif %}>
                                    {{ class.name }} - {{ class.subject }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel me-1"></i>Apply Filter
                        </button>
                        <a href="{{ url_for('teacher.student_grades') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Student Grades by Class -->
        {% for class in classes %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>
                        {{ class.name }} - {{ class.subject }}
                    </h5>
                </div>
                <div class="card-body">
                    {% set class_students = students_by_class.get(class.id, []) %}
                    {% if class_students %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Email</th>
                                        <th>Overall GPA</th>
                                        <th>Assignments</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in class_students %}
                                        {% set student_grades = grades_by_student.get(student.id, {}) %}
                                        {% set student_gpa = student_gpas_by_class.get(class.id, {}).get(student.id, 0.0) %}
                                        {% set class_assignments = assignments|selectattr('class_id', 'equalto', class.id)|list %}
                                        {% set class_assignment_ids = class_assignments|map(attribute='id')|list %}
                                        {% set completed_assignments = 0 %}
                                        {% for assignment_id in class_assignment_ids %}
                                            {% if assignment_id in student_grades %}
                                                {% set completed_assignments = completed_assignments + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                        {% set total_assignments = class_assignments|length %}
                                        
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm me-3">
                                                        <i class="bi bi-person-circle fs-4 text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                                        <br><small class="text-muted">{{ student.student_id }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if student.email %}
                                                    <a href="mailto:{{ student.email }}" class="text-decoration-none">
                                                        {{ student.email }}
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge {% if student_gpa >= 3.5 %}bg-success
                                                               {% elif student_gpa >= 3.0 %}bg-primary
                                                               {% elif student_gpa >= 2.0 %}bg-warning text-dark
                                                               {% else %}bg-danger{% endif %} fs-6">
                                                    {{ "%.2f"|format(student_gpa) }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {{ completed_assignments }}/{{ total_assignments }}
                                                </span>
                                                <br><small class="text-muted">Completed</small>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                                            data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-gear me-1"></i>Actions
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" href="#" 
                                                               onclick="viewStudentGrades({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                                                <i class="bi bi-eye me-2"></i>View Grades
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" 
                                                               onclick="viewStudentAssignments({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                                                <i class="bi bi-journal-text me-2"></i>View Assignments
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" 
                                                               onclick="viewStudentProgress({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">
                                                                <i class="bi bi-graph-up me-2"></i>View Progress
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-people fs-1 text-muted"></i>
                            <p class="mt-2">No students enrolled in this class.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No classes available for viewing student grades.
            </div>
        {% endfor %}

        <!-- Student Details Modal -->
        <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="studentDetailsContent">
                        <!-- Content will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
        function viewStudentGrades(studentId, studentName) {
            // Implementation for viewing individual student grades
            document.getElementById('studentDetailsModalLabel').textContent = `Grades - ${studentName}`;
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="text-center">
                    <h6>Grades for ${studentName}</h6>
                    <p class="text-muted">Detailed grade breakdown will be implemented here.</p>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
        }

        function viewStudentAssignments(studentId, studentName) {
            // Implementation for viewing student assignments
            document.getElementById('studentDetailsModalLabel').textContent = `Assignments - ${studentName}`;
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="text-center">
                    <h6>Assignments for ${studentName}</h6>
                    <p class="text-muted">Assignment list will be implemented here.</p>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
        }

        function viewStudentProgress(studentId, studentName) {
            // Implementation for viewing student progress
            document.getElementById('studentDetailsModalLabel').textContent = `Progress - ${studentName}`;
            document.getElementById('studentDetailsContent').innerHTML = `
                <div class="text-center">
                    <h6>Progress Report for ${studentName}</h6>
                    <p class="text-muted">Progress charts will be implemented here.</p>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            modal.show();
        }
        </script>

    {% elif section == 'attendance' %}
        <!-- Attendance View -->
        <h2 class="mb-4">Attendance Management</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-calendar-check-fill me-2"></i>Attendance Tracking</h5>
            <p>Manage attendance for all classes. Your assigned classes are highlighted.</p>
        </div>

        <div class="row">
            {% for class in all_classes %}
                {% set is_assigned = class in classes %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-sm {% if is_assigned %}border-primary{% else %}border-secondary opacity-75{% endif %}">
                        <div class="card-header {% if is_assigned %}bg-warning text-dark{% else %}bg-secondary text-white{% endif %}">
                            <h5 class="card-title mb-0">
                                {{ class.name }}
                                {% if is_assigned %}
                                    <span class="badge bg-success ms-2">Your Class</span>
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>Subject:</strong> {{ class.subject or 'N/A' }}<br>
                                <strong>Students:</strong> {{ class.enrolled_student_count }} enrolled
                            </p>
                            {% if is_assigned %}
                                <a href="{{ url_for('teacher.take_attendance', class_id=class.id) }}" class="btn btn-warning btn-sm">
                                    <i class="bi bi-clipboard-check me-1"></i>Take Attendance
                                </a>
                            {% else %}
                                <button class="btn btn-secondary btn-sm" disabled>
                                    <i class="bi bi-lock me-1"></i>Not Assigned
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle me-2"></i>No Classes Available</h5>
                        <p>There are no classes in the system for attendance tracking.</p>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% elif section == 'students' %}
        <!-- Students Directory View -->
        <h2 class="mb-4">Students Directory</h2>

        <!-- Advanced Student Search -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-search me-2"></i>Advanced Student Search</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('teacher.students_directory') }}" id="studentSearchForm" class="row g-3">
                    <!-- Search Query -->
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search Query</label>
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               value="{{ search_query or '' }}" 
                               placeholder="Enter search terms..."
                               autocomplete="off">
                    </div>
                    
                    <!-- Search Type -->
                    <div class="col-md-3">
                        <label for="search_type" class="form-label">Search Type</label>
                        <select class="form-select" id="search_type" name="search_type">
                            <option value="all" {% if search_type == 'all' %}selected{% endif %}>All Fields</option>
                            <option value="name" {% if search_type == 'name' %}selected{% endif %}>Student Name</option>
                            <option value="contact" {% if search_type == 'contact' %}selected{% endif %}>Contact Info</option>
                            <option value="academic" {% if search_type == 'academic' %}selected{% endif %}>Academic Info</option>
                            <option value="address" {% if search_type == 'address' %}selected{% endif %}>Address</option>
                            <option value="emergency" {% if search_type == 'emergency' %}selected{% endif %}>Emergency Contact</option>
                            <option value="student_id" {% if search_type == 'student_id' %}selected{% endif %}>Student ID</option>
                        </select>
                    </div>
                    
                    <!-- Grade Filter -->
                    <div class="col-md-3">
                        <label for="grade_filter" class="form-label">Grade Level</label>
                        <select class="form-select" id="grade_filter" name="grade_filter">
                            <option value="">All Grades</option>
                            <option value="Kindergarten" {% if grade_filter == 'Kindergarten' %}selected{% endif %}>Kindergarten</option>
                            <option value="1st" {% if grade_filter == '1st' %}selected{% endif %}>1st Grade</option>
                            <option value="2nd" {% if grade_filter == '2nd' %}selected{% endif %}>2nd Grade</option>
                            <option value="3rd" {% if grade_filter == '3rd' %}selected{% endif %}>3rd Grade</option>
                            <option value="4th" {% if grade_filter == '4th' %}selected{% endif %}>4th Grade</option>
                            <option value="5th" {% if grade_filter == '5th' %}selected{% endif %}>5th Grade</option>
                            <option value="6th" {% if grade_filter == '6th' %}selected{% endif %}>6th Grade</option>
                            <option value="7th" {% if grade_filter == '7th' %}selected{% endif %}>7th Grade</option>
                            <option value="8th" {% if grade_filter == '8th' %}selected{% endif %}>8th Grade</option>
                            <option value="9th" {% if grade_filter == '9th' %}selected{% endif %}>9th Grade</option>
                            <option value="10th" {% if grade_filter == '10th' %}selected{% endif %}>10th Grade</option>
                            <option value="11th" {% if grade_filter == '11th' %}selected{% endif %}>11th Grade</option>
                            <option value="12th" {% if grade_filter == '12th' %}selected{% endif %}>12th Grade</option>
                        </select>
                    </div>
                    
                    <!-- Status Filter -->
                    <div class="col-md-3">
                        <label for="status_filter" class="form-label">Account Status</label>
                        <select class="form-select" id="status_filter" name="status_filter">
                            <option value="">All Statuses</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                            <option value="no_account" {% if status_filter == 'no_account' %}selected{% endif %}>No Account</option>
                        </select>
                    </div>
                    
                    <!-- Sort Options -->
                    <div class="col-md-3">
                        <label for="sort_by" class="form-label">Sort By</label>
                        <select class="form-select" id="sort_by" name="sort_by">
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                            <option value="grade" {% if sort_by == 'grade' %}selected{% endif %}>Grade Level</option>
                            <option value="gpa" {% if sort_by == 'gpa' %}selected{% endif %}>GPA</option>
                            <option value="student_id" {% if sort_by == 'student_id' %}selected{% endif %}>Student ID</option>
                        </select>
                    </div>
                    
                    <!-- Sort Order -->
                    <div class="col-md-3">
                        <label for="sort_order" class="form-label">Order</label>
                        <select class="form-select" id="sort_order" name="sort_order">
                            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Search
                            </button>
                            <a href="{{ url_for('teacher.students_directory') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reset
                            </a>
                            <button type="button" class="btn btn-outline-info" data-bs-toggle="collapse" data-bs-target="#searchTips">
                                <i class="bi bi-lightbulb me-2"></i>Search Tips
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Search Tips -->
                <div class="collapse mt-3" id="searchTips">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle me-2"></i>Search Tips:</h6>
                        <ul class="mb-0">
                            <li><strong>All Fields:</strong> Searches across all student information including name, contact, academic details, and emergency contacts</li>
                            <li><strong>Student Name:</strong> Search by first name, last name, or middle initial</li>
                            <li><strong>Contact Info:</strong> Search by email address or phone number</li>
                            <li><strong>Academic Info:</strong> Search by grade level, GPA, or student ID</li>
                            <li><strong>Address:</strong> Search by street, city, state, or zip code</li>
                            <li><strong>Emergency Contact:</strong> Search by emergency contact name, phone, or relationship</li>
                            <li><strong>Student ID:</strong> Search by student identification number</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results Info -->
        {% if search_query or grade_filter or status_filter %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Search Results:</strong> Found {{ students|length }} student(s)
                {% if search_query %}<span class="badge bg-primary me-1">Search: "{{ search_query }}"</span>{% endif %}
                {% if grade_filter %}<span class="badge bg-secondary me-1">Grade: "{{ grade_filter }}"</span>{% endif %}
                {% if status_filter %}<span class="badge bg-warning me-1">Status: "{{ status_filter }}"</span>{% endif %}
            </div>
        {% endif %}

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Grade Level</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>GPA</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-3">
                                                <i class="bi bi-person-circle fs-4 text-primary"></i>
                                            </div>
                                            <div>
                                                <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                                <br><small class="text-muted">{{ student.student_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ student.grade_level or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        {% if student.email %}
                                            <a href="mailto:{{ student.email }}" class="text-decoration-none">
                                                {{ student.email }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ student.phone or 'N/A' }}</td>
                                    <td>
                                        {% set student_gpa = student_gpas.get(student.id, 0.0) %}
                                        <span class="badge {% if student_gpa >= 3.5 %}bg-success
                                                       {% elif student_gpa >= 3.0 %}bg-primary
                                                       {% elif student_gpa >= 2.0 %}bg-warning text-dark
                                                       {% else %}bg-danger{% endif %} fs-6">
                                            {{ "%.2f"|format(student_gpa) }}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showInfoUnavailableModal()">View Details</button>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No students found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'teachers-staff' %}
        <!-- Teachers & Staff Directory View -->
        <h2 class="mb-4">Teachers & Staff Directory</h2>

        <!-- Search Bar -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form method="GET" action="{{ url_for('teacher.teachers_staff_directory') }}" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search Teachers & Staff</label>
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               value="{{ search_query or '' }}" 
                               placeholder="Search by name, email, or role..."
                               autocomplete="off">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search me-2"></i>Search
                        </button>
                    </div>
                    <div class="col-md-3">
                        {% if search_query %}
                            <a href="{{ url_for('teacher.teachers_staff_directory') }}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-x-circle me-2"></i>Clear Search
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results Info -->
        {% if search_query %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Search Results:</strong> Found {{ teachers_staff|length }} staff member(s) matching "{{ search_query }}"
            </div>
        {% endif %}

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for staff in teachers_staff %}
                                <tr>
                                    <td>{{ staff.first_name }} {{ staff.last_name }}</td>
                                    <td>{{ staff.assigned_role or 'N/A' }}</td>
                                    <td>{{ staff.email or 'N/A' }}</td>
                                    <td>{{ staff.phone or 'N/A' }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showInfoUnavailableModal()">View Details</button>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No staff members found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif section == 'calendar' %}
        <!-- Calendar View -->
        <h2 class="mb-4">School Calendar</h2>
        
        {% if calendar_data %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ calendar_data.month_name }} {{ calendar_data.year }}</h5>
                        <div>
                            <a href="{{ url_for('teacher.calendar', month=prev_month.month, year=prev_month.year) }}" class="btn btn-sm btn-outline-light me-2">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                            <a href="{{ url_for('teacher.calendar', month=next_month.month, year=next_month.year) }}" class="btn btn-sm btn-outline-light">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="row text-center">
                                <div class="col">Mon</div>
                                <div class="col">Tue</div>
                                <div class="col">Wed</div>
                                <div class="col">Thu</div>
                                <div class="col">Fri</div>
                                <div class="col">Sat</div>
                                <div class="col">Sun</div>
                            </div>
                        </div>
                        <div class="calendar-body">
                            {% for week in calendar_data.weeks %}
                                <div class="row calendar-week">
                                    {% for day in week %}
                                        <div class="col calendar-day {% if not day.is_current_month %}empty{% endif %} {% if day.is_today %}today{% endif %}">
                                            {% if day.is_current_month %}
                                                <div class="day-number">{{ day.day_num }}</div>
                                                {% if day.events %}
                                                    <div class="day-events">
                                                        {% for event in day.events %}
                                                            <div class="calendar-event event-{{ event.category|lower|replace(' ', '_') if event.category else 'default' }}" title="{{ event.title }}">
                                                                <small class="event-title">{{ event.title }}</small>
                                                                {% if event.category %}
                                                                    <small class="event-category">{{ event.category }}</small>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Calendar Information -->
            <div class="row g-3 g-md-4 mt-4">
                <div class="col-12 col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Upcoming Events</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <p>No upcoming events scheduled.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary btn-sm me-2 mb-2">
                                <i class="bi bi-plus-circle me-1"></i>Add Event
                            </button>
                            <button class="btn btn-outline-success btn-sm me-2 mb-2">
                                <i class="bi bi-download me-1"></i>Export Calendar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Calendar Unavailable</h5>
                <p>The school calendar is currently unavailable. Please check back later.</p>
            </div>
        {% endif %}

    {% elif section == 'communications' %}
        <!-- Communications View -->
        <h2 class="mb-4">Communications</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-chat-dots-fill me-2"></i>Communications Center</h5>
            <p>The communications center is currently under development. This will allow you to send messages to students, parents, and other staff members.</p>
        </div>

    {% elif section == 'settings' %}
        <!-- Settings View -->
        <h2 class="mb-4">Settings</h2>

        <div class="alert alert-info">
            <h5><i class="bi bi-gear-fill me-2"></i>Account Settings</h5>
            <p>Account settings and preferences are currently under development.</p>
        </div>

    {% else %}
        <!-- Generic fallback content for other sections -->
        <div class="alert alert-warning">
            <h4>Debug Information:</h4>
            <p><strong>Section:</strong> "{{ section }}"</p>
            <p><strong>Active Tab:</strong> "{{ active_tab }}"</p>
            <p><strong>Teacher:</strong> {{ teacher.first_name }} {{ teacher.last_name if teacher else 'NONE' }}</p>
            <hr>
            <p>Content for the '{{ section }}' section for teachers is currently under development. Please check back later!</p>
        </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the assignment "<span id="assignmentTitle"></span>"?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
        {{ csrf_token() }}
                    <button type="submit" class="btn btn-danger">Delete Assignment</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} 

{% block scripts %}
{{ super() }}
<script>
function showInfoUnavailableModal() {
    let modalEl = document.getElementById('infoUnavailableModal');
    if (!modalEl) {
        const modalHtml = `
        <div class="modal fade" id="infoUnavailableModal" tabindex="-1" aria-labelledby="infoUnavailableModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="infoUnavailableModalLabel">Information Unavailable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Information is currently unavailable. Please contact either the School Administrator or Director for more information.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('infoUnavailableModal'));
    modal.show();
}

// Enhanced Search Functionality for Students
{% if section == 'students' %}
document.addEventListener('DOMContentLoaded', function() {
    const studentSearchForm = document.getElementById('studentSearchForm');
    const searchInput = document.getElementById('search');
    const searchTypeSelect = document.getElementById('search_type');
    const gradeFilterSelect = document.getElementById('grade_filter');
    const statusFilterSelect = document.getElementById('status_filter');
    const sortBySelect = document.getElementById('sort_by');
    const sortOrderSelect = document.getElementById('sort_order');

    // Auto-submit form when filter dropdowns change
    [searchTypeSelect, gradeFilterSelect, statusFilterSelect, sortBySelect, sortOrderSelect].forEach(element => {
        if (element) {
            element.addEventListener('change', function() {
                studentSearchForm.submit();
            });
        }
    });

    // Visual feedback for search input
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            if (this.value.length >= 2) {
                this.style.borderColor = '#0d6efd';
            } else {
                this.style.borderColor = '';
            }
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            if (searchInput) {
                searchInput.focus();
            }
        }
        if (e.key === 'Escape' && searchInput) {
            searchInput.value = '';
            searchInput.style.borderColor = '';
        }
    });
});
{% endif %}



// Handle remove assignment button clicks
document.addEventListener('DOMContentLoaded', function() {
    const removeButtons = document.querySelectorAll('.remove-assignment-btn');
    const deleteModal = document.getElementById('deleteModal');
    const assignmentTitleSpan = document.getElementById('assignmentTitle');
    const deleteForm = document.getElementById('deleteForm');
    
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.getAttribute('data-assignment-id');
            const assignmentTitle = this.getAttribute('data-assignment-title');
            
            // Update modal content
            assignmentTitleSpan.textContent = assignmentTitle;
            
            // Update form action
            deleteForm.action = "{{ url_for('teacher.remove_assignment', assignment_id=0) }}".replace('0', assignmentId);
            
            // Show modal
            const modal = new bootstrap.Modal(deleteModal);
            modal.show();
        });
    });
});
</script>
{% endblock %} 