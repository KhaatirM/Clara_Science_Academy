{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
  <div class="container-fluid py-3">
    <div class="row align-items-center mb-4">
      <div class="col-12 col-md-8">
        <h3 class="mb-0">Teachers & Staff Directory 
          <span class="text-muted fs-6 fw-normal">
            {% if current_user.role == 'Director' %}(Director View){% elif current_user.role == 'School Administrator' %}(Admin View){% endif %}
          </span>
        </h3>
      </div>
      <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
        <div class="d-flex flex-wrap justify-content-md-end align-items-center">
          {% if current_user.role in ['Director', 'School Administrator'] %}
            <a href="{{ url_for('management.add_teacher_staff') }}" class="btn btn-sm btn-primary me-2 mb-2 mb-md-0">Add Teacher/Staff</a>
            <form class="d-flex" method="GET" action="{{ url_for('management.teachers') }}">
          {% endif %}
            <input class="form-control form-control-sm me-1" type="search" name="search_query" placeholder="Search Name..." aria-label="Search" value="{{ search_query }}">
            <button class="btn btn-sm btn-outline-secondary" type="submit">Search</button>
          </form>
        </div>
      </div>
    </div>

    <div class="row row-cols-1 g-3"> 
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <!-- Table head and body go here -->
          <thead class="table-dark">
            <tr>
              <th>Name</th>
              <th>Role</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            {% for teacher in teachers_staff %}
              <tr>
                <td>{{ teacher.name }}</td>
                <td>{{ teacher.role or 'N/A' }}</td>
                <td>{{ teacher.email }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="col">
        {% if search_query %}
        <div class="alert alert-warning" role="alert">No teachers or staff found matching your search: "{{ search_query }}".</div>
        {% else %}
        <div class="alert alert-info" role="alert">No teachers or staff are currently listed.</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

  {# Pagination #}
  {% if total_pages and total_pages > 1 %}
  <nav aria-label="Teacher Staff navigation" class="mt-4">
    <ul class="pagination pagination-sm justify-content-center">
      {% set pagination_params = {'section': 'teachers_staff'} %}
      {% if search_query %}{% set _ = pagination_params.update({'search_query': search_query}) %}{% endif %}
      
      {% if current_user.role in ['Director', 'School Administrator'] %}
        <li class="page-item {% if page <= 1 %}disabled{% endif %}"><a class="page-link" href="{{ url_for('management.teachers', page=page-1, **pagination_params) }}">Previous</a></li>
        {% for p in range(1, total_pages + 1) %}<li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('management.teachers', page=p, **pagination_params) }}">{{ p }}</a></li>{% endfor %}
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}"><a class="page-link" href="{{ url_for('management.teachers', page=page+1, **pagination_params) }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  
  {% if total_teachers_staff and (total_teachers_staff > 0 or search_query) %}
    <p class="text-center text-muted small mt-2">
        Showing {{ teachers_staff|length }} 
        {% if search_query and teachers_staff|length != total_teachers_staff %}
          of {{ total_teachers_staff }} matching teachers/staff.
        {% elif teachers_staff|length == total_teachers_staff and total_teachers_staff > 0 %}
          of {{ total_teachers_staff }} total teachers/staff.
        {% else %}
             matching teachers/staff.
        {% endif %}
    </p>
  {% endif %}

  {# Bootstrap Modal for Staff Credentials #}
  <div class="modal fade" id="staffCredentialsModal" tabindex="-1" aria-labelledby="staffCredentialsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staffCredentialsModalLabel">Staff Credentials</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Name:</strong> <span id="modal_staff_name"></span></p>
          <p><strong>Staff ID:</strong> <span id="modal_staff_id"></span></p> 
          <p><strong>Assigned Role:</strong> <span id="modal_staff_assigned_role"></span></p> 
          <p><strong>SSN:</strong> <span id="modal_staff_ssn"></span> <small class="text-muted">(Masked)</small></p>
          <p><strong>Email:</strong> <span id="modal_staff_email"></span></p>
          <hr>
          <h6 class="text-danger small">System Access (Confidential - For Admin Use)</h6>
          <p class="mb-1"><small><strong>Username:</strong> <span id="modal_staff_username"></span></small></p>
          <p class="mb-0"><small><strong>Generated Password:</strong> <span id="modal_staff_password"></span></small></p>
          <p class="mt-2 text-danger small"><strong>Security Warning:</strong> This generated password is shown for initial setup only. The staff member should be instructed to change it upon their first login if a self-service password change system were implemented. Storing or displaying plaintext passwords is a security risk.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const removeButtons = document.querySelectorAll('.remove-staff-btn');
      removeButtons.forEach(button => {
        button.addEventListener('click', function() {
          const staffId = this.dataset.staffId;
          const staffName = this.dataset.staffName;
          
          if (confirm(`Are you sure you want to remove ${staffName}? This action cannot be undone.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            
            {% if current_user.role in ['Director', 'School Administrator'] %}
              form.action = `{{ url_for('management.remove_teacher_staff', staff_id=0) }}`.replace('0', staffId);
            {% endif %}
            
            document.body.appendChild(form);
            form.submit();
          }
        });
      });
    });

    function maskSSN(ssn) {
        if (!ssn || typeof ssn !== 'string' || ssn.length < 4) { return "N/A"; }
        const lastFour = ssn.slice(-4);
        return `***-**-${lastFour}`;
    }

    function showStaffCredentials(staff) {
        console.log("Showing credentials for:", staff);
        if (!staff || typeof staff !== 'object') {
            console.error("Invalid staff data for credentials modal.");
            return;
        }

        document.getElementById('modal_staff_name').innerText = staff.name || 'N/A';
        document.getElementById('modal_staff_id').innerText = staff.staff_id || 'N/A'; 
        document.getElementById('modal_staff_assigned_role').innerText = staff.assigned_role || 'N/A';
        document.getElementById('modal_staff_ssn').innerText = maskSSN(staff.ssn);
        document.getElementById('modal_staff_email').innerText = staff.email || 'N/A';
        document.getElementById('modal_staff_username').innerText = staff.username || 'N/A'; 
        document.getElementById('modal_staff_password').innerText = staff.password || 'N/A'; 
    }
  </script>
{% endblock %} 