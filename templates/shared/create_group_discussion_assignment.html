{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-3 px-md-4 px-lg-5">
    <!-- Enhanced Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div>
                            <h2 class="mb-2 mb-md-0 fw-bold">
                                <i class="bi bi-chat-dots me-3"></i>Create Group Discussion Assignment
                            </h2>
                            <p class="mb-0 opacity-75">Facilitate meaningful discussions with structured prompts and collaborative learning</p>
                        </div>
                        <div class="d-flex gap-2 mt-3 mt-md-0">
                            <a href="{{ url_for('teacher.group_assignment_type_selector', class_id=class_obj.id) }}" class="btn btn-light btn-sm">
                                <i class="bi bi-arrow-left me-1"></i>Back to Assignment Types
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-8">
            <form method="POST" enctype="multipart/form-data" id="discussionForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <!-- Discussion Information -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-info-circle me-2"></i>Discussion Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="title" class="form-label fw-semibold">
                                    <i class="bi bi-journal-text me-1 text-primary"></i>Discussion Title
                                </label>
                                <input type="text" class="form-control form-control-lg" id="title" name="title" required 
                                       placeholder="Enter a descriptive title for your discussion">
                                <div class="form-text">Choose a clear, engaging title that describes the discussion topic</div>
                            </div>
                            
                            <div class="col-12">
                                <label for="description" class="form-label fw-semibold">
                                    <i class="bi bi-file-text me-1 text-primary"></i>Description & Instructions
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="4" 
                                          placeholder="Provide background information, discussion guidelines, and learning objectives..."></textarea>
                                <div class="form-text">Include context, guidelines, and what students should achieve</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discussion Configuration -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-gear me-2"></i>Discussion Configuration</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Participation Requirements -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="fw-semibold text-muted mb-3">Participation Requirements</h6>
                            </div>
                            <div class="col-md-4">
                                <label for="min_posts" class="form-label fw-semibold">
                                    <i class="bi bi-chat-dots me-1 text-success"></i>Minimum Posts
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="min_posts" name="min_posts" min="1" max="20" value="2">
                                    <span class="input-group-text">posts</span>
                                </div>
                                <div class="form-text">Minimum posts each group must make</div>
                            </div>
                            <div class="col-md-4">
                                <label for="min_words" class="form-label fw-semibold">
                                    <i class="bi bi-file-text me-1 text-success"></i>Minimum Words
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="min_words" name="min_words" min="10" max="1000" value="100">
                                    <span class="input-group-text">words</span>
                                </div>
                                <div class="form-text">Minimum word count per post</div>
                            </div>
                            <div class="col-md-4">
                                <label for="max_posts" class="form-label fw-semibold">
                                    <i class="bi bi-chat-square me-1 text-success"></i>Maximum Posts
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_posts" name="max_posts" min="1" max="50" value="10">
                                    <span class="input-group-text">posts</span>
                                </div>
                                <div class="form-text">Maximum posts per group (0 = unlimited)</div>
                            </div>
                        </div>
                        
                        <!-- Discussion Features -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="fw-semibold text-muted mb-3">Discussion Features</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allow_replies" name="allow_replies" checked>
                                    <label class="form-check-label fw-semibold" for="allow_replies">
                                        <i class="bi bi-reply me-2 text-info"></i>Allow Group Replies
                                    </label>
                                    <div class="form-text">Groups can reply to each other's posts</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="require_citations" name="require_citations">
                                    <label class="form-check-label fw-semibold" for="require_citations">
                                        <i class="bi bi-book me-2 text-info"></i>Require Citations
                                    </label>
                                    <div class="form-text">Groups must cite sources in their posts</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Moderation Settings -->
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="fw-semibold text-muted mb-3">Moderation & Privacy</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="anonymous_posts" name="anonymous_posts">
                                    <label class="form-check-label fw-semibold" for="anonymous_posts">
                                        <i class="bi bi-person-x me-2 text-warning"></i>Allow Anonymous Posts
                                    </label>
                                    <div class="form-text">Groups can post anonymously</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="moderate_posts" name="moderate_posts">
                                    <label class="form-check-label fw-semibold" for="moderate_posts">
                                        <i class="bi bi-shield-check me-2 text-warning"></i>Moderate Posts
                                    </label>
                                    <div class="form-text">Review posts before they appear</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Settings -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-people me-2"></i>Group Settings</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="group_size_min" class="form-label fw-semibold">
                                    <i class="bi bi-people me-1 text-warning"></i>Minimum Group Size
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="group_size_min" name="group_size_min" 
                                           min="1" max="10" value="2">
                                    <span class="input-group-text">students</span>
                                </div>
                                <div class="form-text">Minimum number of students per group</div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="group_size_max" class="form-label fw-semibold">
                                    <i class="bi bi-people-fill me-1 text-warning"></i>Maximum Group Size
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="group_size_max" name="group_size_max" 
                                           min="2" max="20" value="4">
                                    <span class="input-group-text">students</span>
                                </div>
                                <div class="form-text">Maximum number of students per group</div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="collaboration_type" class="form-label fw-semibold">
                                    <i class="bi bi-gear me-1 text-warning"></i>Collaboration Type
                                </label>
                                <select class="form-select" id="collaboration_type" name="collaboration_type">
                                    <option value="group">Group Work Only</option>
                                    <option value="individual">Individual Work Only</option>
                                    <option value="both">Allow Both Group and Individual</option>
                                </select>
                                <div class="form-text">Choose the collaboration approach</div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allow_individual" name="allow_individual">
                                    <label class="form-check-label fw-semibold" for="allow_individual">
                                        <i class="bi bi-person me-2 text-warning"></i>Allow Individual Submissions
                                    </label>
                                    <div class="form-text">Students can participate individually even if working in groups</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discussion Prompts -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-question-circle me-2"></i>Discussion Prompts</h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="promptsContainer">
                            <div class="text-center py-4" id="noPromptsMessage">
                                <i class="bi bi-question-circle text-muted mb-3" style="font-size: 3rem;"></i>
                                <h6 class="text-muted">No discussion prompts added yet</h6>
                                <p class="text-muted mb-4">Start building your discussion by adding prompts</p>
                                <button type="button" class="btn btn-primary btn-lg" onclick="addPrompt()">
                                    <i class="bi bi-plus-circle me-2"></i>Add Your First Prompt
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4" id="addPromptBtn" style="display: none;">
                            <button type="button" class="btn btn-outline-primary" onclick="addPrompt()">
                                <i class="bi bi-plus-circle me-2"></i>Add Another Prompt
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Due Date & Academic Period -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-calendar me-2"></i>Due Date & Academic Period</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="due_date" class="form-label fw-semibold">
                                    <i class="bi bi-clock me-1 text-secondary"></i>Due Date & Time
                                </label>
                                <input type="datetime-local" class="form-control" id="due_date" name="due_date" required>
                                <div class="form-text">When should this discussion be completed?</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="quarter" class="form-label fw-semibold">
                                    <i class="bi bi-calendar3 me-1 text-secondary"></i>Quarter
                                </label>
                                <select class="form-select" id="quarter" name="quarter" required>
                                    <option value="">Select Quarter</option>
                                    <option value="Q1">Quarter 1</option>
                                    <option value="Q2">Quarter 2</option>
                                    <option value="Q3">Quarter 3</option>
                                    <option value="Q4">Quarter 4</option>
                                </select>
                                <div class="form-text">Which quarter does this discussion belong to?</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="semester" class="form-label fw-semibold">
                                    <i class="bi bi-calendar-range me-1 text-secondary"></i>Semester
                                </label>
                                <select class="form-select" id="semester" name="semester">
                                    <option value="">Select Semester (Optional)</option>
                                    <option value="S1">Semester 1</option>
                                    <option value="S2">Semester 2</option>
                                </select>
                                <div class="form-text">Optional semester classification</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="academic_period_id" class="form-label fw-semibold">
                                    <i class="bi bi-calendar-check me-1 text-secondary"></i>Academic Period
                                </label>
                                <select class="form-select" id="academic_period_id" name="academic_period_id">
                                    <option value="">Select Academic Period (Optional)</option>
                                    {% for period in academic_periods %}
                                        <option value="{{ period.id }}">{{ period.name }} ({{ period.period_type }})</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Optional specific academic period</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('teacher.group_assignment_type_selector', class_id=class_obj.id) }}" 
                               class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-info btn-lg fw-bold" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i>Create Discussion Assignment
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-12 col-lg-4">
            <!-- Live Preview -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-eye me-2"></i>Discussion Preview</h6>
                </div>
                <div class="card-body">
                    <div id="discussionPreview">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-chat-dots mb-2" style="font-size: 2rem;"></i>
                            <p class="mb-0">Discussion preview will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussion Stats -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-graph-up me-2"></i>Discussion Stats</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="mb-1 text-info" id="promptCount">0</h4>
                                <small class="text-muted">Prompts</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="mb-1 text-success" id="minPosts">2</h4>
                            <small class="text-muted">Min Posts</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussion Best Practices -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-lightbulb me-2"></i>Discussion Best Practices</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Use open-ended questions</small>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Encourage respectful debate</small>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Provide clear participation guidelines</small>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Set realistic word count requirements</small>
                        </li>
                        <li>
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Allow time for thoughtful responses</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let promptCount = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Set default due date to next week
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    const dateTimeString = nextWeek.toISOString().slice(0, 16);
    document.getElementById('due_date').value = dateTimeString;
    
    // Set default quarter to current quarter
    const currentQuarter = getCurrentQuarter();
    document.getElementById('quarter').value = currentQuarter;
    
    // Form validation
    const form = document.getElementById('discussionForm');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('input', validateForm);
    form.addEventListener('change', validateForm);
    
    function validateForm() {
        const title = document.getElementById('title').value.trim();
        const hasPrompts = promptCount > 0;
        
        if (title && hasPrompts) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-info');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.remove('btn-info');
            submitBtn.classList.add('btn-secondary');
        }
    }
});

function addPrompt() {
    promptCount++;
    const container = document.getElementById('promptsContainer');
    const noPromptsMessage = document.getElementById('noPromptsMessage');
    const addPromptBtn = document.getElementById('addPromptBtn');
    
    // Hide no prompts message and show add prompt button
    noPromptsMessage.style.display = 'none';
    addPromptBtn.style.display = 'block';
    
    // Create prompt HTML
    const promptHTML = `
        <div class="prompt-item mb-4 p-4 border rounded shadow-sm" data-prompt-id="${promptCount}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="mb-0 fw-bold">
                    <span class="badge bg-info me-2 prompt-number-badge">${promptCount}</span>
                    Discussion Prompt ${promptCount}
                </h6>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="movePrompt(${promptCount}, -1)" title="Move Up">
                        <i class="bi bi-arrow-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="movePrompt(${promptCount}, 1)" title="Move Down">
                        <i class="bi bi-arrow-down"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="removePrompt(${promptCount})" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label fw-semibold">Prompt Text</label>
                    <textarea class="form-control" name="prompt_text_${promptCount}" rows="4" 
                              placeholder="Enter your discussion prompt here..." required></textarea>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Prompt Type</label>
                    <select class="form-select" name="prompt_type_${promptCount}" required>
                        <option value="">Select Type</option>
                        <option value="question">Question</option>
                        <option value="scenario">Scenario</option>
                        <option value="debate">Debate</option>
                        <option value="reflection">Reflection</option>
                        <option value="analysis">Analysis</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Required Response Length</label>
                    <select class="form-select" name="response_length_${promptCount}" required>
                        <option value="">Select Length</option>
                        <option value="brief">Brief (50-100 words)</option>
                        <option value="short">Short (100-200 words)</option>
                        <option value="medium">Medium (200-400 words)</option>
                        <option value="long">Long (400+ words)</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', promptHTML);
    updateDiscussionPreview();
    updateDiscussionStats();
}

function removePrompt(promptId) {
    document.querySelector(`[data-prompt-id="${promptId}"]`).remove();
    promptCount--;
    updatePromptNumbers();
    updateDiscussionPreview();
    updateDiscussionStats();
    
    // Show no prompts message if no prompts left
    if (promptCount === 0) {
        document.getElementById('noPromptsMessage').style.display = 'block';
        document.getElementById('addPromptBtn').style.display = 'none';
    }
}

function movePrompt(promptId, direction) {
    const promptElement = document.querySelector(`[data-prompt-id="${promptId}"]`);
    const prompts = Array.from(document.querySelectorAll('.prompt-item'));
    const currentIndex = prompts.indexOf(promptElement);
    const newIndex = currentIndex + direction;
    
    if (newIndex >= 0 && newIndex < prompts.length) {
        if (direction > 0) {
            promptElement.parentNode.insertBefore(promptElement, prompts[newIndex].nextSibling);
        } else {
            promptElement.parentNode.insertBefore(promptElement, prompts[newIndex]);
        }
        updatePromptNumbers();
    }
}

function updatePromptNumbers() {
    const prompts = document.querySelectorAll('.prompt-item');
    prompts.forEach((prompt, index) => {
        const promptNumber = index + 1;
        prompt.querySelector('.prompt-number-badge').textContent = promptNumber;
        prompt.querySelector('h6').innerHTML = `
            <span class="badge bg-info me-2 prompt-number-badge">${promptNumber}</span>
            Discussion Prompt ${promptNumber}
        `;
    });
}

function updateDiscussionPreview() {
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const minPosts = document.getElementById('min_posts').value;
    const minWords = document.getElementById('min_words').value;
    
    let previewHTML = '<div class="discussion-preview">';
    
    if (title) {
        previewHTML += `<h6 class="fw-bold text-info mb-2">${title}</h6>`;
    }
    
    if (description) {
        previewHTML += `<p class="text-muted small mb-2">${description.substring(0, 100)}${description.length > 100 ? '...' : ''}</p>`;
    }
    
    if (minPosts) {
        previewHTML += `<small class="text-info"><i class="bi bi-chat-dots me-1"></i>Minimum Posts: ${minPosts}</small><br>`;
    }
    
    if (minWords) {
        previewHTML += `<small class="text-success"><i class="bi bi-file-text me-1"></i>Minimum Words: ${minWords}</small><br>`;
    }
    
    if (promptCount > 0) {
        previewHTML += `<small class="text-secondary"><i class="bi bi-question-circle me-1"></i>${promptCount} prompt${promptCount !== 1 ? 's' : ''}</small>`;
    }
    
    previewHTML += '</div>';
    
    document.getElementById('discussionPreview').innerHTML = previewHTML;
}

function updateDiscussionStats() {
    document.getElementById('promptCount').textContent = promptCount;
    
    const minPosts = document.getElementById('min_posts').value || '2';
    document.getElementById('minPosts').textContent = minPosts;
}

function getCurrentQuarter() {
    const now = new Date();
    const month = now.getMonth() + 1; // 0-indexed
    if (month >= 1 && month <= 3) return 'Q1';
    if (month >= 4 && month <= 6) return 'Q2';
    if (month >= 7 && month <= 9) return 'Q3';
    return 'Q4';
}

// Add event listeners for dynamic updates
document.addEventListener('input', function(e) {
    if (e.target.id === 'min_posts' || e.target.id === 'min_words') {
        updateDiscussionStats();
    }
    updateDiscussionPreview();
});
</script>

{% endblock %}
