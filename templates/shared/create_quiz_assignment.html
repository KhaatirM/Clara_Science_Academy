{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-3 px-md-4 px-lg-5">
    <!-- Enhanced Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div>
                            <h2 class="mb-2 mb-md-0 fw-bold">
                                <i class="bi bi-quiz me-3"></i>Create Quiz Assignment
                            </h2>
                            <p class="mb-0 opacity-75">Design engaging quizzes with multiple question types and smart features</p>
                        </div>
                        <div class="d-flex gap-2 mt-3 mt-md-0">
                            {% if current_user.role in ['Director', 'School Administrator'] %}
                                <a href="{{ url_for('management.assignment_type_selector') }}" class="btn btn-light btn-sm">
                                    <i class="bi bi-arrow-left me-1"></i>Back to Assignment Types
                                </a>
                            {% else %}
                                <a href="{{ url_for('teacher.assignment_type_selector') }}" class="btn btn-light btn-sm">
                                    <i class="bi bi-arrow-left me-1"></i>Back to Assignment Types
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="quizAssignmentForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="assignment_type" value="quiz">
        
        <div class="row">
            <!-- Main Form Column -->
            <div class="col-12 col-lg-8">
                <!-- Basic Assignment Info -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-info-circle me-2"></i>Quiz Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="title" class="form-label fw-semibold">
                                    <i class="bi bi-pencil-square me-1 text-primary"></i>Quiz Title <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control form-control-lg" id="title" name="title" 
                                       placeholder="Enter an engaging quiz title..." required>
                                <div class="form-text">Make it descriptive and engaging for students</div>
                            </div>
                            <div class="col-md-6">
                                <label for="class_id" class="form-label fw-semibold">
                                    <i class="bi bi-book me-1 text-primary"></i>Class <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="class_id" name="class_id" required>
                                    <option value="">Choose a class...</option>
                                    {% for class in classes %}
                                        <option value="{{ class.id }}">{{ class.name }} - {{ class.subject }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="description" class="form-label fw-semibold">
                                <i class="bi bi-card-text me-1 text-primary"></i>Quiz Description
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="Describe what this quiz covers, learning objectives, and any special instructions for students..."></textarea>
                            <div class="form-text">Help students understand what they'll be tested on</div>
                        </div>
                        
                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="due_date" class="form-label fw-semibold">
                                    <i class="bi bi-calendar-event me-1 text-primary"></i>Due Date <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local" class="form-control form-control-lg" id="due_date" name="due_date" min="2020-01-01T00:00" required>
                            </div>
                            <div class="col-md-6">
                                <label for="quarter" class="form-label fw-semibold">
                                    <i class="bi bi-calendar3 me-1 text-primary"></i>Quarter <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="quarter" name="quarter" required>
                                    <option value="1" {% if current_quarter == "1" %}selected{% endif %}>Quarter 1</option>
                                    <option value="2" {% if current_quarter == "2" %}selected{% endif %}>Quarter 2</option>
                                    <option value="3" {% if current_quarter == "3" %}selected{% endif %}>Quarter 3</option>
                                    <option value="4" {% if current_quarter == "4" %}selected{% endif %}>Quarter 4</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment Availability Section -->
                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <h6 class="fw-semibold text-muted mb-3">
                                    <i class="bi bi-clock-history me-2"></i>Assignment Availability
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <label for="open_date" class="form-label fw-semibold">
                                    <i class="bi bi-unlock me-1 text-success"></i>Open Date & Time
                                </label>
                                <input type="datetime-local" class="form-control form-control-lg" id="open_date" name="open_date" min="2020-01-01T00:00">
                                <div class="form-text">When students can start this quiz (leave empty for immediate availability)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="close_date" class="form-label fw-semibold">
                                    <i class="bi bi-lock me-1 text-danger"></i>Close Date & Time
                                </label>
                                <input type="datetime-local" class="form-control form-control-lg" id="close_date" name="close_date" min="2020-01-01T00:00">
                                <div class="form-text">When this quiz closes (leave empty to close at due date)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Settings -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-gear me-2"></i>Quiz Configuration</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Time and Attempt Settings -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="time_limit" class="form-label fw-semibold">
                                    <i class="bi bi-clock me-1 text-success"></i>Time Limit
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="time_limit" name="time_limit" 
                                           min="1" max="300" placeholder="No limit">
                                    <span class="input-group-text">minutes</span>
                                </div>
                                <div class="form-text">Leave empty for unlimited time</div>
                            </div>
                            <div class="col-md-4">
                                <label for="attempts" class="form-label fw-semibold">
                                    <i class="bi bi-arrow-repeat me-1 text-success"></i>Max Attempts
                                </label>
                                <input type="number" class="form-control" id="attempts" name="attempts" 
                                       min="1" max="10" value="1">
                                <div class="form-text">How many times students can take this quiz</div>
                            </div>
                            <div class="col-md-4">
                                <label for="passing_score" class="form-label fw-semibold">
                                    <i class="bi bi-trophy me-1 text-success"></i>Passing Score
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="passing_score" name="passing_score" 
                                           min="0" max="100" value="70">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Minimum score to pass</div>
                            </div>
                        </div>
                        
                        <!-- Advanced Options -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="fw-semibold text-muted mb-3">Advanced Options</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="shuffle_questions" name="shuffle_questions">
                                    <label class="form-check-label fw-semibold" for="shuffle_questions">
                                        <i class="bi bi-shuffle me-2 text-info"></i>Shuffle Questions
                                    </label>
                                    <div class="form-text">Randomize question order for each student</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_correct_answers" name="show_correct_answers" checked>
                                    <label class="form-check-label fw-semibold" for="show_correct_answers">
                                        <i class="bi bi-eye me-2 text-info"></i>Show Correct Answers
                                    </label>
                                    <div class="form-text">Display answers after submission</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Google Forms Integration -->
                        <div class="border-top pt-4 mb-4">
                            <div class="mb-3">
                                <h6 class="fw-semibold text-muted mb-3">
                                    <i class="bi bi-google me-2"></i>Google Forms Integration (Optional)
                                </h6>
                                <div class="alert alert-info mb-3" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); border-color: #3b82f6; border-left: 4px solid #3b82f6;">
                                    <i class="bi bi-info-circle me-2 text-primary"></i>
                                    <strong>Link an existing Google Form:</strong> If you've created a quiz in Google Forms, paste the form URL below to link it to this assignment. Students will be directed to complete the form in Google. You can also export native quizzes to Google Forms later.
                                </div>
                                <div class="mb-3">
                                    <label for="google_form_url" class="form-label fw-semibold">
                                        <i class="bi bi-link-45deg me-1"></i>Google Form URL
                                    </label>
                                    <input type="url" class="form-control" id="google_form_url" name="google_form_url" 
                                           placeholder="https://docs.google.com/forms/d/e/1FAIpQLS...">
                                    <div class="form-text">Paste the full Google Form URL here</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="link_google_form" name="link_google_form" 
                                           onchange="toggleGoogleFormLink(this)">
                                    <label class="form-check-label" for="link_google_form">
                                        Link this quiz to the Google Form above
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save and Continue Settings -->
                        <div class="border-top pt-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="allow_save_and_continue" name="allow_save_and_continue" checked>
                                <label class="form-check-label fw-bold" for="allow_save_and_continue">
                                    <i class="bi bi-save me-2 text-warning"></i>Allow Save and Continue
                                </label>
                                <div class="form-text">Students can save progress and return later (only for native quizzes)</div>
                            </div>
                            
                            <div id="saveContinueSettings" class="row g-3">
                                <div class="col-md-6">
                                    <label for="max_save_attempts" class="form-label fw-semibold">
                                        <i class="bi bi-save2 me-1 text-warning"></i>Max Save Attempts
                                    </label>
                                    <input type="number" class="form-control" id="max_save_attempts" name="max_save_attempts" 
                                           min="1" max="50" value="10">
                                    <div class="form-text">How many times students can save</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="save_timeout_minutes" class="form-label fw-semibold">
                                        <i class="bi bi-hourglass me-1 text-warning"></i>Save Timeout
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="save_timeout_minutes" name="save_timeout_minutes" 
                                               min="5" max="120" value="30">
                                        <span class="input-group-text">minutes</span>
                                    </div>
                                    <div class="form-text">How long saved progress stays valid</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions Section -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white d-flex justify-content-between align-items-center flex-wrap gap-2" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-question-square me-2"></i>Quiz Questions</h5>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-info btn-sm fw-bold shadow-sm" id="importFromBankBtn" title="Import questions from question banks" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; transition: transform 0.2s;">
                                <i class="bi bi-database me-2"></i>Import from Bank
                            </button>
                            <button type="button" class="btn btn-light btn-sm fw-bold shadow-sm" id="addQuestionBtn" style="transition: transform 0.2s;">
                                <i class="bi bi-plus-circle me-2"></i>Add Question
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div id="questionsContainer">
                            <div class="text-center text-muted py-5">
                                <div class="mb-3">
                                    <i class="bi bi-question-circle text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
                                </div>
                                <h5 class="text-muted mb-2">No questions added yet</h5>
                                <p class="text-muted mb-4">Click "Add Question" to start building your quiz</p>
                                <button type="button" class="btn btn-outline-primary btn-lg" id="addFirstQuestionBtn">
                                    <i class="bi bi-plus-circle me-2"></i>Add Your First Question
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Sidebar -->
            <div class="col-12 col-lg-4">
                <!-- Quiz Preview -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-eye me-2"></i>Live Preview</h6>
                    </div>
                    <div class="card-body p-3">
                        <div id="quizPreview">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-eye-slash mb-2 d-block" style="font-size: 2rem; opacity: 0.5;"></i>
                                <p class="small mb-0">Quiz preview will appear here as you build it</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Question Types Guide -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-lightbulb me-2"></i>Question Types Guide</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-list-ul text-primary fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <strong class="small">Multiple Choice</strong>
                                        <p class="small text-muted mb-0">One correct answer from multiple options</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-check2-square text-success fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <strong class="small">True/False</strong>
                                        <p class="small text-muted mb-0">Simple true or false questions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-chat-text text-warning fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <strong class="small">Short Answer</strong>
                                        <p class="small text-muted mb-0">Brief text responses</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-file-text text-danger fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <strong class="small">Essay</strong>
                                        <p class="small text-muted mb-0">Longer, detailed responses</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%);">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-graph-up me-2"></i>Quiz Stats</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="mb-0 text-primary" id="questionCount">0</h4>
                                    <small class="text-muted">Questions</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="mb-0 text-success" id="totalPoints">0</h4>
                                <small class="text-muted">Total Points</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-lg fw-bold shadow-sm" id="createQuizBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                                <i class="bi bi-check-circle me-2"></i>Create Quiz Assignment
                            </button>
                            {% if current_user.role in ['Director', 'School Administrator'] %}
                                <a href="{{ url_for('management.assignment_type_selector') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i>Cancel
                                </a>
                            {% else %}
                                <a href="{{ url_for('teacher.assignment_type_selector') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i>Cancel
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Enhanced Question Template (Hidden) -->
<template id="questionTemplate">
    <div class="question-item card mb-4 border-0 shadow-sm" data-question-id="" style="border-left: 4px solid #667eea !important; transition: box-shadow 0.2s;">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);">
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2 question-number-badge">1</span>
                <h6 class="mb-0 fw-bold">Question <span class="question-number"></span></h6>
            </div>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary move-question-up" title="Move Up" style="transition: all 0.2s;" onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#667eea';">
                    <i class="bi bi-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-outline-primary move-question-down" title="Move Down" style="transition: all 0.2s;" onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#667eea';">
                    <i class="bi bi-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-outline-danger delete-question" title="Delete Question" style="transition: all 0.2s;" onmouseover="this.style.background='#dc2626'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#dc2626';">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-list-ul me-1 text-primary"></i>Question Type
                    </label>
                    <select class="form-select question-type" name="question_type[]">
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="true_false">True/False</option>
                        <option value="short_answer">Short Answer</option>
                        <option value="essay">Essay</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-star me-1 text-warning"></i>Points <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control question-points" name="question_points[]" min="1" max="100" value="1" required>
                        <span class="input-group-text">pts</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <label class="form-label fw-semibold">
                    <i class="bi bi-question-circle me-1 text-primary"></i>Question Text <span class="text-danger">*</span>
                </label>
                <textarea class="form-control question-text" name="question_text[]" rows="3" 
                          placeholder="Enter your question here..." required></textarea>
                <div class="form-text">Be clear and specific in your question wording</div>
            </div>
            
            <!-- Multiple Choice Options -->
            <div class="multiple-choice-options" style="display: none;">
                <label class="form-label">Answer Options <span class="text-danger">*</span></label>
                <div class="options-container">
                    <div class="option-item mb-2">
                        <div class="input-group">
                            <div class="input-group-text">
                                <input class="form-check-input" type="radio" name="correct_answer_0" value="0" required>
                            </div>
                            <input type="text" class="form-control" name="option_text_0[]" placeholder="Option A" required>
                            <button type="button" class="btn btn-outline-danger remove-option" title="Remove Option" style="transition: all 0.2s;" onmouseover="this.style.background='#dc2626'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#dc2626';">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="option-item mb-2">
                        <div class="input-group">
                            <div class="input-group-text">
                                <input class="form-check-input" type="radio" name="correct_answer_0" value="1" required>
                            </div>
                            <input type="text" class="form-control" name="option_text_0[]" placeholder="Option B" required>
                            <button type="button" class="btn btn-outline-danger remove-option" title="Remove Option" style="transition: all 0.2s;" onmouseover="this.style.background='#dc2626'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#dc2626';">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary add-option" style="transition: all 0.2s;" onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#667eea';">
                        <i class="bi bi-plus-circle me-1"></i>Add Option
                    </button>
                    <small class="text-muted">Select the radio button next to the correct answer</small>
                </div>
            </div>
            
            <!-- True/False Options -->
            <div class="true-false-options" style="display: none;">
                <label class="form-label">Correct Answer <span class="text-danger">*</span></label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="correct_answer_0" value="true" required>
                    <label class="form-check-label">
                        <i class="bi bi-check-circle text-success me-2"></i>True
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="correct_answer_0" value="false" required>
                    <label class="form-check-label">
                        <i class="bi bi-x-circle text-danger me-2"></i>False
                    </label>
                </div>
                <small class="text-muted">Select the correct answer for this True/False question</small>
            </div>
            
            <!-- Short Answer / Essay -->
            <div class="text-answer-options" style="display: none;">
                <label class="form-label">Sample Answer (Optional)</label>
                <div class="short-answer-input" style="display: none;">
                    <input type="text" class="form-control" name="sample_answer[]" placeholder="Provide a sample answer or key points to look for...">
                </div>
                <div class="essay-input" style="display: none;">
                    <textarea class="form-control" name="sample_answer[]" rows="4" placeholder="Provide a sample answer or key points to look for..."></textarea>
                </div>
                <small class="text-muted">This will help with grading and provide guidance for students</small>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let questionCounter = 0;
    const questionsContainer = document.getElementById('questionsContainer');
    const questionTemplate = document.getElementById('questionTemplate');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const quizPreview = document.getElementById('quizPreview');
    const form = document.getElementById('quizAssignmentForm');
    
    // Add question functionality with animation
    addQuestionBtn.addEventListener('click', function() {
        addQuestion();
        // Animate button press
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 150);
    });
    
    // Import from bank button animation
    const importFromBankBtn = document.getElementById('importFromBankBtn');
    if (importFromBankBtn) {
        importFromBankBtn.addEventListener('click', function() {
            // TODO: Implement import from bank functionality
            alert('Question Bank import feature coming soon!');
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    }
    
    // Add first question button
    const addFirstQuestionBtn = document.getElementById('addFirstQuestionBtn');
    if (addFirstQuestionBtn) {
        addFirstQuestionBtn.addEventListener('click', function() {
            addQuestion();
        });
    }
    
    function addQuestion() {
        questionCounter++;
        const questionElement = questionTemplate.content.cloneNode(true);
        const questionItem = questionElement.querySelector('.question-item');
        const questionNumber = questionElement.querySelector('.question-number');
        
        questionItem.dataset.questionId = questionCounter;
        questionNumber.textContent = questionCounter;
        
        // Update all form field names to be unique for this question
        updateQuestionFieldNames(questionElement, questionCounter);
        
        // Remove the "no questions" message if it exists
        const noQuestionsMsg = questionsContainer.querySelector('.text-center');
        if (noQuestionsMsg) {
            noQuestionsMsg.remove();
        }
        
        // Append the question to the DOM first
        questionsContainer.appendChild(questionElement);
        
        // Now get the actual DOM element (not the fragment)
        const actualQuestionElement = questionsContainer.lastElementChild;
        
        // Set up event listeners for the new question using the actual DOM element
        setupQuestionEventListeners(actualQuestionElement);
        
        // Show the appropriate options for the default question type
        const questionType = actualQuestionElement.querySelector('.question-type');
        // Initialize with the default question type (multiple_choice)
        toggleQuestionOptions(actualQuestionElement, questionType.value);
        
        updateQuizPreview();
    }
    
    function updateQuestionFieldNames(questionElement, questionId) {
        // Update question type and text names
        const questionType = questionElement.querySelector('.question-type');
        const questionText = questionElement.querySelector('.question-text');
        const questionPoints = questionElement.querySelector('.question-points');
        
        if (questionType) questionType.name = `question_type_${questionId}`;
        if (questionText) questionText.name = `question_text_${questionId}`;
        if (questionPoints) questionPoints.name = `question_points_${questionId}`;
        
        // Update correct answer radio buttons
        const correctAnswerRadios = questionElement.querySelectorAll('input[name^="correct_answer"]');
        correctAnswerRadios.forEach(radio => {
            radio.name = `correct_answer_${questionId}`;
        });
        
        // Update option text inputs
        const optionTextInputs = questionElement.querySelectorAll('input[name^="option_text"]');
        optionTextInputs.forEach(input => {
            input.name = `option_text_${questionId}[]`;
        });
        
        // Update sample answer inputs
        const sampleAnswerInputs = questionElement.querySelectorAll('input[name^="sample_answer"], textarea[name^="sample_answer"]');
        sampleAnswerInputs.forEach(input => {
            input.name = `sample_answer_${questionId}`;
        });
    }
    
    function setupQuestionEventListeners(questionElement) {
        const questionType = questionElement.querySelector('.question-type');
        const deleteBtn = questionElement.querySelector('.delete-question');
        const moveUpBtn = questionElement.querySelector('.move-question-up');
        const moveDownBtn = questionElement.querySelector('.move-question-down');
        const addOptionBtn = questionElement.querySelector('.add-option');
        
        // Question type change
        questionType.addEventListener('change', function() {
            toggleQuestionOptions(questionElement, this.value);
            updateQuizPreview();
        });
        
        // Delete question
        deleteBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this question?')) {
                questionElement.querySelector('.question-item').remove();
                updateQuestionNumbers();
                updateQuizPreview();
            }
        });
        
        // Move question up
        moveUpBtn.addEventListener('click', function() {
            const questionItem = questionElement.querySelector('.question-item');
            const prevSibling = questionItem.previousElementSibling;
            if (prevSibling) {
                questionItem.parentNode.insertBefore(questionItem, prevSibling);
                updateQuestionNumbers();
                updateQuizPreview();
            }
        });
        
        // Move question down
        moveDownBtn.addEventListener('click', function() {
            const questionItem = questionElement.querySelector('.question-item');
            const nextSibling = questionItem.nextElementSibling;
            if (nextSibling) {
                questionItem.parentNode.insertBefore(nextSibling, questionItem);
                updateQuestionNumbers();
                updateQuizPreview();
            }
        });
        
        // Add option for multiple choice
        addOptionBtn.addEventListener('click', function() {
            addOption(questionElement);
        });
        
        // Set up remove option buttons for existing options
        const removeButtons = questionElement.querySelectorAll('.remove-option');
        removeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const optionsContainer = questionElement.querySelector('.options-container');
                if (optionsContainer.children.length > 2) {
                    button.closest('.option-item').remove();
                    updateOptionValues(questionElement);
                } else {
                    alert('At least 2 options are required for multiple choice questions.');
                }
            });
        });
        
        // Update preview on text changes
        const questionText = questionElement.querySelector('.question-text');
        const questionPoints = questionElement.querySelector('.question-points');
        
        questionText.addEventListener('input', updateQuizPreview);
        questionPoints.addEventListener('input', updateQuizPreview);
    }
    
    function toggleQuestionOptions(questionElement, questionType) {
        const multipleChoice = questionElement.querySelector('.multiple-choice-options');
        const trueFalse = questionElement.querySelector('.true-false-options');
        const textAnswer = questionElement.querySelector('.text-answer-options');
        const shortAnswerInput = questionElement.querySelector('.short-answer-input');
        const essayInput = questionElement.querySelector('.essay-input');
        
        // Hide all options first and remove required attributes from hidden fields
        if (multipleChoice) {
            multipleChoice.style.display = 'none';
            // Remove required from option text inputs when hidden
            const optionInputs = multipleChoice.querySelectorAll('input[name*="option_text"]');
            optionInputs.forEach(input => input.removeAttribute('required'));
            // Remove required from radio buttons when hidden
            const radioButtons = multipleChoice.querySelectorAll('input[type="radio"][name*="correct_answer"]');
            radioButtons.forEach(radio => radio.removeAttribute('required'));
        }
        if (trueFalse) {
            trueFalse.style.display = 'none';
            // Remove required from radio buttons when hidden
            const radioButtons = trueFalse.querySelectorAll('input[type="radio"][name*="correct_answer"]');
            radioButtons.forEach(radio => radio.removeAttribute('required'));
        }
        if (textAnswer) {
            textAnswer.style.display = 'none';
        }
        if (shortAnswerInput) {
            shortAnswerInput.style.display = 'none';
        }
        if (essayInput) {
            essayInput.style.display = 'none';
        }
        
        // Show relevant options based on question type
        switch(questionType) {
            case 'multiple_choice':
                if (multipleChoice) {
                    multipleChoice.style.display = 'block';
                    // Add required back to option text inputs when visible
                    const optionInputs = multipleChoice.querySelectorAll('input[name*="option_text"]');
                    optionInputs.forEach(input => input.setAttribute('required', 'required'));
                    // Add required back to radio buttons when visible (at least one must be selected)
                    const radioButtons = multipleChoice.querySelectorAll('input[type="radio"][name*="correct_answer"]');
                    radioButtons.forEach(radio => radio.setAttribute('required', 'required'));
                }
                break;
            case 'true_false':
                if (trueFalse) {
                    trueFalse.style.display = 'block';
                    // Add required back to radio buttons when visible
                    const radioButtons = trueFalse.querySelectorAll('input[type="radio"][name*="correct_answer"]');
                    radioButtons.forEach(radio => radio.setAttribute('required', 'required'));
                }
                break;
            case 'short_answer':
                if (textAnswer) {
                    textAnswer.style.display = 'block';
                }
                if (shortAnswerInput) {
                    shortAnswerInput.style.display = 'block';
                }
                break;
            case 'essay':
                if (textAnswer) {
                    textAnswer.style.display = 'block';
                }
                if (essayInput) {
                    essayInput.style.display = 'block';
                }
                break;
        }
    }
    
    function addOption(questionElement) {
        const optionsContainer = questionElement.querySelector('.options-container');
        const optionCount = optionsContainer.children.length;
        const optionLetter = String.fromCharCode(65 + optionCount); // A, B, C, D, etc.
        
        // Get the question ID from the question element
        // questionElement is the .question-item element itself
        const questionId = questionElement.dataset.questionId;
        
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-item mb-2';
        optionDiv.innerHTML = `
            <div class="input-group">
                <div class="input-group-text">
                    <input class="form-check-input" type="radio" name="correct_answer_${questionId}" value="${optionCount}" required>
                </div>
                <input type="text" class="form-control" name="option_text_${questionId}[]" placeholder="Option ${optionLetter}" required>
                <button type="button" class="btn btn-outline-danger remove-option" title="Remove Option">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        // Only add required attribute if this is a multiple choice question
        const questionType = questionElement.querySelector('.question-type').value;
        if (questionType !== 'multiple_choice') {
            const optionInput = optionDiv.querySelector('input[name*="option_text"]');
            if (optionInput) {
                optionInput.removeAttribute('required');
            }
        }
        
        // Add remove option functionality
        optionDiv.querySelector('.remove-option').addEventListener('click', function() {
            if (optionsContainer.children.length > 2) { // Keep at least 2 options
                optionDiv.remove();
                updateOptionValues(questionElement);
            } else {
                alert('At least 2 options are required for multiple choice questions.');
            }
        });
        
        optionsContainer.appendChild(optionDiv);
        updateOptionValues(questionElement);
    }
    
    function updateOptionValues(questionElement) {
        const options = questionElement.querySelectorAll('.options-container .option-item');
        options.forEach((option, index) => {
            const radio = option.querySelector('input[type="radio"]');
            radio.value = index;
        });
    }
    
    function updateQuestionNumbers() {
        const questions = questionsContainer.querySelectorAll('.question-item');
        questions.forEach((question, index) => {
            const questionNumber = question.querySelector('.question-number');
            const questionNumberBadge = question.querySelector('.question-number-badge');
            const number = index + 1;
            if (questionNumber) questionNumber.textContent = number;
            if (questionNumberBadge) questionNumberBadge.textContent = number;
        });
    }
    
    function updateQuizPreview() {
        const questions = questionsContainer.querySelectorAll('.question-item');
        let previewHTML = '';
        let totalPoints = 0;
        
        if (questions.length === 0) {
            previewHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-eye-slash mb-2 d-block" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p class="small mb-0">Quiz preview will appear here as you build it</p>
                </div>
            `;
        } else {
            previewHTML = '<h6 class="fw-bold mb-3">Quiz Preview:</h6>';
            questions.forEach((question, index) => {
                const questionText = question.querySelector('.question-text').value || 'Untitled Question';
                const questionType = question.querySelector('.question-type').value;
                const questionPoints = parseFloat(question.querySelector('.question-points').value) || 1;
                totalPoints += questionPoints;
                
                const typeIcon = getQuestionTypeIcon(questionType);
                const typeColor = getQuestionTypeColor(questionType);
                
                previewHTML += `
                    <div class="preview-question border-bottom pb-2 mb-2">
                        <div class="d-flex align-items-start">
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <div class="flex-grow-1">
                                <strong class="small">${questionText}</strong>
                                <div class="d-flex align-items-center mt-1">
                                    <i class="bi ${typeIcon} me-1 text-${typeColor}"></i>
                                    <small class="text-muted me-2">${questionType.replace('_', ' ').toUpperCase()}</small>
                                    <span class="badge bg-secondary">${questionPoints} pt${questionPoints != 1 ? 's' : ''}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        quizPreview.innerHTML = previewHTML;
        
        // Update stats
        updateQuizStats(questions.length, totalPoints);
    }
    
    function getQuestionTypeIcon(type) {
        const icons = {
            'multiple_choice': 'bi-list-ul',
            'true_false': 'bi-check2-square',
            'short_answer': 'bi-chat-text',
            'essay': 'bi-file-text'
        };
        return icons[type] || 'bi-question-circle';
    }
    
    function getQuestionTypeColor(type) {
        const colors = {
            'multiple_choice': 'primary',
            'true_false': 'success',
            'short_answer': 'warning',
            'essay': 'danger'
        };
        return colors[type] || 'secondary';
    }
    
    function updateQuizStats(questionCount, totalPoints) {
        const questionCountEl = document.getElementById('questionCount');
        const totalPointsEl = document.getElementById('totalPoints');
        
        if (questionCountEl) questionCountEl.textContent = questionCount;
        if (totalPointsEl) totalPointsEl.textContent = totalPoints;
    }
    
    // Save and continue settings toggle
    const allowSaveContinue = document.getElementById('allow_save_and_continue');
    const saveContinueSettings = document.getElementById('saveContinueSettings');
    
    function toggleSaveContinueSettings() {
        if (allowSaveContinue.checked) {
            saveContinueSettings.style.display = 'block';
        } else {
            saveContinueSettings.style.display = 'none';
        }
    }
    
    allowSaveContinue.addEventListener('change', toggleSaveContinueSettings);
    toggleSaveContinueSettings(); // Initialize on page load
    
    // Google Form linking
    function toggleGoogleFormLink(checkbox) {
        const formUrlInput = document.getElementById('google_form_url');
        const questionsSection = document.querySelector('#questionsContainer').closest('.card');
        if (checkbox.checked) {
            // If linking Google Form, make URL required and hide questions section
            if (formUrlInput) {
                formUrlInput.setAttribute('required', 'required');
            }
            if (questionsSection) {
                questionsSection.style.display = 'none';
            }
        } else {
            // If not linking, remove required and show questions section
            if (formUrlInput) {
                formUrlInput.removeAttribute('required');
            }
            if (questionsSection) {
                questionsSection.style.display = 'block';
            }
        }
    }
    
    // Validate Google Form URL format
    const googleFormUrlInput = document.getElementById('google_form_url');
    if (googleFormUrlInput) {
        googleFormUrlInput.addEventListener('blur', function() {
            const url = this.value.trim();
            if (url && !url.match(/^https:\/\/docs\.google\.com\/forms\/d\/e\/[A-Za-z0-9_-]+\/viewform/)) {
                alert('Please enter a valid Google Forms URL (should start with https://docs.google.com/forms/d/e/...)');
                this.focus();
            }
        });
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        console.log('Form submission started');
        const questions = questionsContainer.querySelectorAll('.question-item');
        console.log(`Found ${questions.length} questions`);
        
        // Remove required attribute from all hidden radio buttons to prevent browser validation errors
        questions.forEach(question => {
            const hiddenContainers = question.querySelectorAll('.multiple-choice-options[style*="display: none"], .true-false-options[style*="display: none"]');
            hiddenContainers.forEach(container => {
                const hiddenRadios = container.querySelectorAll('input[type="radio"][name*="correct_answer"]');
                hiddenRadios.forEach(radio => radio.removeAttribute('required'));
            });
        });
        
        // Check if linking Google Form
        const linkGoogleForm = document.getElementById('link_google_form')?.checked;
        const googleFormUrl = document.getElementById('google_form_url')?.value?.trim();
        
        // If linking Google Form, skip question validation
        if (!linkGoogleForm && questions.length === 0) {
            e.preventDefault();
            alert('Please add at least one question to the quiz, or link a Google Form.');
            return;
        }
        
        // If linking Google Form, validate URL
        if (linkGoogleForm && !googleFormUrl) {
            e.preventDefault();
            alert('Please enter a Google Form URL to link.');
            return;
        }
        
        // Validate questions
        let isValid = true;
        let validationError = '';
        
        for (let index = 0; index < questions.length; index++) {
            const question = questions[index];
            const questionText = question.querySelector('.question-text')?.value.trim();
            
            if (!questionText) {
                isValid = false;
                validationError = `Question ${index + 1} needs text.`;
                break;
            }
            
            const questionType = question.querySelector('.question-type')?.value;
            
            if (questionType === 'multiple_choice') {
                const options = question.querySelectorAll('.options-container input[name*="option_text"]');
                const hasValidOptions = Array.from(options).some(option => option.value.trim());
                const hasCorrectAnswer = question.querySelector('input[name*="correct_answer"]:checked');
                
                if (!hasValidOptions) {
                    isValid = false;
                    validationError = `Question ${index + 1}: Please provide at least one option text.`;
                    break;
                }
                
                if (!hasCorrectAnswer) {
                    isValid = false;
                    validationError = `Question ${index + 1}: Please select the correct answer.`;
                    break;
                }
            } else if (questionType === 'true_false') {
                const hasCorrectAnswer = question.querySelector('input[name*="correct_answer"]:checked');
                if (!hasCorrectAnswer) {
                    isValid = false;
                    validationError = `Question ${index + 1}: Please select True or False as the correct answer.`;
                    break;
                }
            }
            // short_answer and essay questions don't need correct answers, so we skip validation for those
        }
        
        if (!isValid) {
            e.preventDefault();
            console.log('Form validation failed:', validationError);
            if (validationError) {
                alert(validationError);
            }
            return;
        }
        
        console.log('Form validation passed, submitting...');
        // Show loading state
        const submitBtn = document.getElementById('createQuizBtn');
        if (submitBtn) {
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating Quiz...';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.7';
            submitBtn.style.cursor = 'not-allowed';
        }
        
        // Allow form to submit naturally
        // Form will submit to the backend route
    });
});
</script>
{% endblock %}


