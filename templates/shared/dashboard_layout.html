{% set TEACHER_ROLES = [
    'History Teacher',
    'Science Teacher',
    'Physics Teacher',
    'English Language Arts Teacher',
    'Math Teacher',
    'Substitute Teacher',
    'School Counselor',
    'School Administrator',
    'Director'
] %}
<!DOCTYPE html>
<html lang="en" class="{% block html_class %}{% endblock %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <!-- Content Security Policy is handled by Flask app headers -->
    <title>{{ dashboard_title or 'Dashboard' }} - Clara Science Academy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body class="theme-{{ effective_theme | default('default') }} {% block body_class %}{% endblock %}">
    <div class="dashboard-flex-wrapper d-flex flex-row">
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
        
        <div class="sidebar" id="sidebar">
            <h3 class="sidebar-heading text-center">{{ dashboard_title or current_user.role }}</h3>
            <!-- Sidebar toggle - visible on all screen sizes -->
            <div class="sidebar-toggle" onclick="window.innerWidth <= 768 ? toggleMobileSidebar() : toggleSidebar()">
                <div class="hamburger" id="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="collapse-text" id="collapse-text">Collapse</div>
            </div>
            <ul class="nav flex-column sidebar-nav">
                
                {# --- DIRECTOR TABS --- #}
                {% if current_user.role == 'Director' %}
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.management_dashboard' %}active{% endif %}" href="{{ url_for('management.management_dashboard') }}"><i class="bi bi-grid-1x2-fill"></i><span> Home</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.students' %}active{% endif %}" href="{{ url_for('management.students') }}"><i class="bi bi-people-fill"></i><span> Students</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.teachers' %}active{% endif %}" href="{{ url_for('management.teachers') }}"><i class="bi bi-person-badge-fill"></i><span> Teachers & Staff</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.classes' %}active{% endif %}" href="{{ url_for('management.classes') }}"><i class="bi bi-house-door-fill"></i><span> Classes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.assignments_and_grades' %}active{% endif %}" href="{{ url_for('management.assignments_and_grades') }}"><i class="bi bi-journal-check"></i><span> Assignments & Grades</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.unified_attendance' %}active{% endif %}" href="{{ url_for('management.unified_attendance') }}"><i class="bi bi-calendar-check-fill"></i><span> Attendance</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.report_cards' %}active{% endif %}" href="{{ url_for('management.report_cards') }}"><i class="bi bi-mortarboard-fill"></i><span> Report Cards</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.billing' %}active{% endif %}" href="{{ url_for('management.billing') }}"><i class="bi bi-currency-dollar"></i><span> Billing & Financials</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.calendar' %}active{% endif %}" href="{{ url_for('management.calendar') }}"><i class="bi bi-calendar-event-fill"></i><span> School Calendar</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.student_jobs' %}active{% endif %}" href="{{ url_for('management.student_jobs') }}"><i class="bi bi-briefcase-fill"></i><span> Student Jobs</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'auth.bug_reports' %}active{% endif %}" href="{{ url_for('auth.bug_reports') }}"><i class="bi bi-bug-fill"></i><span> Bug Reports</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.settings' %}active{% endif %}" href="{{ url_for('management.settings') }}"><i class="bi bi-gear-fill"></i><span> Settings</span></a></li>

                {# --- SCHOOL ADMINISTRATOR TABS --- #}
                {% elif current_user.role == 'School Administrator' %}
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.management_dashboard' %}active{% endif %}" href="{{ url_for('management.management_dashboard') }}"><i class="bi bi-grid-1x2-fill"></i><span> Home</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.students' %}active{% endif %}" href="{{ url_for('management.students') }}"><i class="bi bi-people-fill"></i><span> Students</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.teachers' %}active{% endif %}" href="{{ url_for('management.teachers') }}"><i class="bi bi-person-badge-fill"></i><span> Teachers & Staff</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.classes' %}active{% endif %}" href="{{ url_for('management.classes') }}"><i class="bi bi-house-door-fill"></i><span> Classes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.assignments_and_grades' %}active{% endif %}" href="{{ url_for('management.assignments_and_grades') }}"><i class="bi bi-journal-check"></i><span> Assignments & Grades</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.unified_attendance' %}active{% endif %}" href="{{ url_for('management.unified_attendance') }}"><i class="bi bi-calendar-check-fill"></i><span> Attendance</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.report_cards' %}active{% endif %}" href="{{ url_for('management.report_cards') }}"><i class="bi bi-mortarboard-fill"></i><span> Report Cards</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.calendar' %}active{% endif %}" href="{{ url_for('management.calendar') }}"><i class="bi bi-calendar-event-fill"></i><span> School Calendar</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.student_jobs' %}active{% endif %}" href="{{ url_for('management.student_jobs') }}"><i class="bi bi-briefcase-fill"></i><span> Student Jobs</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'auth.bug_reports' %}active{% endif %}" href="{{ url_for('auth.bug_reports') }}"><i class="bi bi-bug-fill"></i><span> Bug Reports</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.settings' %}active{% endif %}" href="{{ url_for('management.settings') }}"><i class="bi bi-gear-fill"></i><span> Settings</span></a></li>

                {# --- TEACHER TABS --- #}
                {% elif (current_user.role in TEACHER_ROLES or 'Teacher' in current_user.role) and current_user.role not in ['Director', 'School Administrator'] %}
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.dashboard.teacher_dashboard' %}active{% endif %}" href="{{ url_for('teacher.dashboard.teacher_dashboard') }}"><i class="bi bi-grid-1x2-fill"></i><span> Home</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.dashboard.my_classes' %}active{% endif %}" href="{{ url_for('teacher.dashboard.my_classes') }}"><i class="bi bi-house-door-fill"></i><span> My Classes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint in ['teacher.dashboard.assignments_and_grades', 'teacher.dashboard.my_assignments', 'teacher.my_grades', 'teacher.student_grades'] %}active{% endif %}" href="{{ url_for('teacher.dashboard.assignments_and_grades') }}"><i class="bi bi-journal-check"></i><span> Assignments & Grades</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.attendance.attendance_hub' %}active{% endif %}" href="{{ url_for('teacher.attendance.attendance_hub') }}"><i class="bi bi-calendar-check-fill"></i><span> Attendance</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.dashboard.my_students' %}active{% endif %}" href="{{ url_for('teacher.dashboard.my_students') }}"><i class="bi bi-people-fill"></i><span> Students Directory</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.dashboard.teachers_staff' %}active{% endif %}" href="{{ url_for('teacher.dashboard.teachers_staff') }}"><i class="bi bi-person-badge-fill"></i><span> Teachers & Staff Dir</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.dashboard.teacher_schedule' %}active{% endif %}" href="{{ url_for('teacher.dashboard.teacher_schedule') }}"><i class="bi bi-calendar-week-fill"></i><span> Schedule</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.dashboard.calendar' %}active{% endif %}" href="{{ url_for('teacher.dashboard.calendar') }}"><i class="bi bi-calendar-event-fill"></i><span> School Calendar</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.student_jobs' %}active{% endif %}" href="{{ url_for('management.student_jobs') }}"><i class="bi bi-briefcase-fill"></i><span> Student Jobs</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'auth.bug_reports' %}active{% endif %}" href="{{ url_for('auth.bug_reports') }}"><i class="bi bi-bug-fill"></i><span> Bug Reports</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'teacher.settings' %}active{% endif %}" href="{{ url_for('teacher.settings') }}"><i class="bi bi-gear-fill"></i><span> Settings</span></a></li>
                    
                {# --- STUDENT TABS --- #}
                {% elif current_user.role == 'Student' %}
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_dashboard' %}active{% endif %}" href="{{ url_for('student.student_dashboard') }}"><i class="bi bi-house-door-fill"></i><span> Home</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_assignments' %}active{% endif %}" href="{{ url_for('student.student_assignments') }}"><i class="bi bi-file-earmark-text-fill"></i><span> Assignments</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_classes' %}active{% endif %}" href="{{ url_for('student.student_classes') }}"><i class="bi bi-journal-bookmark-fill"></i><span> Classes</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_grades' %}active{% endif %}" href="{{ url_for('student.student_grades') }}"><i class="bi bi-card-checklist"></i><span> Grades</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_submissions' %}active{% endif %}" href="{{ url_for('student.student_submissions') }}"><i class="bi bi-pencil-square"></i><span> Submissions</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_schedule' %}active{% endif %}" href="{{ url_for('student.student_schedule') }}"><i class="bi bi-calendar-week-fill"></i><span> Schedule</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_school_calendar' %}active{% endif %}" href="{{ url_for('student.student_school_calendar') }}"><i class="bi bi-calendar-event-fill"></i><span> School Calendar</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.student_jobs' %}active{% endif %}" href="{{ url_for('management.student_jobs') }}"><i class="bi bi-briefcase-fill"></i><span> Student Jobs</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'auth.bug_reports' %}active{% endif %}" href="{{ url_for('auth.bug_reports') }}"><i class="bi bi-bug-fill"></i><span> Bug Reports</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'student.student_settings' %}active{% endif %}" href="{{ url_for('student.student_settings') }}"><i class="bi bi-gear-fill"></i><span> Settings</span></a></li>

                {# --- IT TABS --- #}
                {% elif current_user.role in ['Tech', 'IT Support'] %}
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'tech.tech_dashboard' %}active{% endif %}" href="{{ url_for('tech.tech_dashboard') }}"><i class="bi bi-grid-1x2-fill"></i><span> Home</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'tech.activity_log' %}active{% endif %}" href="{{ url_for('tech.activity_log') }}"><i class="bi bi-list-check"></i><span> Activity Log</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'tech.error_reports' %}active{% endif %}" href="{{ url_for('tech.error_reports') }}"><i class="bi bi-bug-fill"></i><span> Error/Bug Log</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint in ['tech.system', 'tech.system_status', 'tech.system_config', 'tech.maintenance_control'] %}active{% endif %}" href="{{ url_for('tech.system') }}"><i class="bi bi-gear-fill"></i><span> System</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'auth.bug_reports' %}active{% endif %}" href="{{ url_for('auth.bug_reports') }}"><i class="bi bi-bug-fill"></i><span> Bug Reports</span></a></li>
                    <li class="nav-item"><a class="nav-link {% if request.endpoint == 'tech.user_management' %}active{% endif %}" href="{{ url_for('tech.user_management') }}"><i class="bi bi-people-fill"></i><span> User Management</span></a></li>
                {% endif %}
            </ul>
            <div class="logout-btn-container">
                <a href="{{ url_for('auth.logout') }}" class="btn btn-danger w-100">
                    <i class="bi bi-box-arrow-right"></i><span> Logout</span>
                </a>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <!-- Impersonation Banner -->
            {% if session.get('original_user_id') %}
            <div class="alert alert-warning alert-dismissible fade show m-2 m-md-3" role="alert">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                    <div>
                        <i class="bi bi-person-check-fill"></i>
                        <strong>Impersonating:</strong> {{ session.get('impersonating_username') }} 
                        <span class="badge bg-secondary">{{ current_user.role }}</span>
                    </div>
                    <a href="{{ url_for('tech.stop_impersonating') }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-person-x"></i> Stop Impersonating
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show m-2 m-md-3" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% block dashboard_content %}{% endblock %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const hamburgerIcon = document.getElementById('hamburger-icon');
            const collapseText = document.getElementById('collapse-text');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
            
            // Toggle between hamburger icon and collapse text
            const isCollapsed = sidebar.classList.contains('collapsed');
            if (isCollapsed) {
                hamburgerIcon.style.display = 'flex';
                collapseText.style.display = 'none';
            } else {
                hamburgerIcon.style.display = 'none';
                collapseText.style.display = 'flex';
            }
            
            // Save state to localStorage
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }
        
        // Close mobile sidebar when clicking on a nav link; set hover tooltips from tab names
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleMobileSidebar();
                    }
                });
                const span = link.querySelector('span');
                if (span) link.setAttribute('title', span.textContent.trim());
            });
            const logoutBtn = document.querySelector('.sidebar .logout-btn-container a');
            if (logoutBtn) {
                const span = logoutBtn.querySelector('span');
                if (span) logoutBtn.setAttribute('title', span.textContent.trim());
            }
        });
        
        // Sync sidebar with viewport: collapse on mobile/tablet, restore preference on desktop
        function forceSidebarCollapsedOnMobile() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburgerIcon = document.getElementById('hamburger-icon');
            const collapseText = document.getElementById('collapse-text');
            const width = window.innerWidth;

            if (width <= 768) {
                // Mobile: sidebar off-screen by default, floating hamburger to open it
                sidebar.classList.remove('show');
                if (overlay) overlay.classList.remove('show');
                sidebar.classList.add('collapsed');
                mainContent.classList.add('collapsed');
                sidebarToggle.style.display = 'flex'; // show floating hamburger
                hamburgerIcon.style.display = 'flex';
                collapseText.style.display = 'none';
            } else if (width <= 1200) {
                // Tablet/small desktop: CSS shows icons-only; force collapsed state so layout and toggle match
                sidebar.classList.remove('show');
                if (overlay) overlay.classList.remove('show');
                sidebar.classList.add('collapsed');
                mainContent.classList.add('collapsed');
                sidebarToggle.style.display = 'flex';
                hamburgerIcon.style.display = 'flex';
                collapseText.style.display = 'none';
            } else {
                // Desktop (>1200px): show toggle and restore user preference
                sidebarToggle.style.display = 'flex';
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

                if (isCollapsed) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('collapsed');
                    hamburgerIcon.style.display = 'flex';
                    collapseText.style.display = 'none';
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('collapsed');
                    hamburgerIcon.style.display = 'none';
                    collapseText.style.display = 'flex';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', forceSidebarCollapsedOnMobile);
        window.addEventListener('resize', forceSidebarCollapsedOnMobile);
    </script>
    
    <!-- Password Change Popup Modal -->
    {% if current_user.is_authenticated and current_user.is_temporary_password %}
        {% include 'shared/password_change_popup.html' %}
    {% elif current_user.is_authenticated and current_user.login_count == 1 and not current_user.password_changed_at %}
        {% include 'shared/password_change_popup.html' %}
    {% endif %}
    
    {% block scripts %}{% endblock %}
</body>
</html>
