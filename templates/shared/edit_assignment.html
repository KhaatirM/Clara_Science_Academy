{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
        <h3 class="mb-2 mb-md-0">
            <i class="bi bi-pencil me-2"></i>Edit Assignment
        </h3>
        <div class="d-flex gap-2">
            {% if current_user.role in ['Director', 'School Administrator'] %}
                <a href="{{ url_for('management.assignments_and_grades') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Assignments
                </a>
                <a href="{{ url_for('management.view_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye me-1"></i>View Assignment
                </a>
                <a href="{{ url_for('management.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-mortarboard me-1"></i>Grade Assignment
                </a>
            {% elif current_user.role in ['Teacher'] %}
                <a href="{{ url_for('teacher.view_class', class_id=assignment.class_id) }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Class
                </a>
                <a href="{{ url_for('teacher.view_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye me-1"></i>View Assignment
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-edit me-2"></i>Edit Assignment Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row g-3">
                            <!-- Assignment Title -->
                            <div class="col-12">
                                <label for="title" class="form-label">Assignment Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       value="{{ assignment.title }}" required>
                            </div>

                            <!-- Assignment Description -->
                            <div class="col-12">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="4">{{ assignment.description or '' }}</textarea>
                            </div>

                            <!-- Class Selection -->
                            <div class="col-12 col-md-6">
                                <label for="class_id" class="form-label">Class <span class="text-danger">*</span></label>
                                <select class="form-select" id="class_id" name="class_id" required>
                                    <option value="">Select a class</option>
                                    {% for class in classes %}
                                        <option value="{{ class.id }}" 
                                                {% if assignment.class_id == class.id %}selected{% endif %}>
                                            {{ class.name }} - {{ class.subject }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Quarter Selection -->
                            <div class="col-12 col-md-6">
                                <label for="quarter" class="form-label">Quarter <span class="text-danger">*</span></label>
                                <select class="form-select" id="quarter" name="quarter" required>
                                    <option value="">Select quarter</option>
                                    <option value="1" {% if assignment.quarter == "1" or assignment.quarter == 1 %}selected{% endif %}>Q1</option>
                                    <option value="2" {% if assignment.quarter == "2" or assignment.quarter == 2 %}selected{% endif %}>Q2</option>
                                    <option value="3" {% if assignment.quarter == "3" or assignment.quarter == 3 %}selected{% endif %}>Q3</option>
                                    <option value="4" {% if assignment.quarter == "4" or assignment.quarter == 4 %}selected{% endif %}>Q4</option>
                                </select>
                            </div>

                            <!-- Due Date -->
                            <div class="col-12 col-md-6">
                                <label for="due_date" class="form-label">Due Date & Time <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="due_date" name="due_date" 
                                       value="{% if assignment.due_date %}{{ assignment.due_date.strftime('%Y-%m-%dT%H:%M') }}{% endif %}" required>
                            </div>

                            <!-- School Year -->
                            <div class="col-12 col-md-6">
                                <label for="school_year_id" class="form-label">School Year</label>
                                <select class="form-select" id="school_year_id" name="school_year_id">
                                    <option value="">Select school year</option>
                                    {% for school_year in school_years %}
                                        <option value="{{ school_year.id }}" 
                                                {% if assignment.school_year_id == school_year.id %}selected{% endif %}>
                                            {{ school_year.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Assignment Status -->
                            <div class="col-12 col-md-6">
                                <label for="status" class="form-label">Assignment Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="Active" {% if assignment.status == 'Active' %}selected{% endif %}>Active</option>
                                    <option value="Inactive" {% if assignment.status == 'Inactive' %}selected{% endif %}>Inactive</option>
                                    <option value="Voided" {% if assignment.status == 'Voided' %}selected{% endif %}>Voided</option>
                                </select>
                                <div class="form-text">
                                    <strong>Active:</strong> Students can still submit work<br>
                                    <strong>Inactive:</strong> Students cannot submit work<br>
                                    <strong>Voided:</strong> Assignment doesn't affect grades (0/0 for all students)
                                </div>
                            </div>

                            <!-- File Upload -->
                            <div class="col-12">
                                <label for="assignment_file" class="form-label">Assignment File</label>
                                <input type="file" class="form-control" id="assignment_file" name="assignment_file" 
                                       accept=".pdf,.doc,.docx,.txt,.rtf">
                                <div class="form-text">
                                    Accepted formats: PDF, DOC, DOCX, TXT, RTF. Leave empty to keep current file.
                                </div>
                                
                                <!-- Current File Display -->
                                {% if assignment.attachment_filename %}
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small class="text-muted">
                                        <i class="bi bi-paperclip me-1"></i>
                                        Current file: {{ assignment.attachment_original_filename or assignment.attachment_filename }}
                                    </small>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Submit Buttons -->
                            <div class="col-12">
                                <hr class="my-3">
                                <div class="d-flex gap-2 justify-content-end">
                                    {% if current_user.role in ['Director', 'School Administrator'] %}
                                        <a href="{{ url_for('management.view_assignment', assignment_id=assignment.id) }}" 
                                           class="btn btn-secondary">Cancel</a>
                                    {% elif current_user.role in ['Teacher'] %}
                                        <a href="{{ url_for('teacher.view_assignment', assignment_id=assignment.id) }}" 
                                           class="btn btn-secondary">Cancel</a>
                                    {% endif %}
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-check-circle me-1"></i>Update Assignment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today for due date
    const dueDateInput = document.getElementById('due_date');
    const today = new Date().toISOString().slice(0, 16);
    dueDateInput.min = today;
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const dueDate = document.getElementById('due_date').value;
        const quarter = document.getElementById('quarter').value;
        const classId = document.getElementById('class_id').value;
        
        if (!title || !dueDate || !quarter || !classId) {
            e.preventDefault();
            alert('Please fill in all required fields marked with *.');
            return false;
        }
        
        // Check if due date is in the future
        const selectedDate = new Date(dueDate);
        const now = new Date();
        if (selectedDate <= now) {
            e.preventDefault();
            alert('Due date must be in the future.');
            return false;
        }
    });
});
</script>
{% endblock %}
