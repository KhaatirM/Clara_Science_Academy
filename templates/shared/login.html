{% extends "shared/base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared_login.css') }}">
{% endblock %}

{% block content %}
<!-- Cache busting for security updates -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- Optimized Background -->
<div class="slideshow-container">
    <div class="slideshow-image active" style="background-image: url('/static/img/backimg/image1.png');"></div>
    <div class="slideshow-overlay"></div>
</div>


<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <h1 class="login-title">Welcome Back</h1>
      <p class="login-subtitle">Sign in to your account</p>
    </div>
    
    <div class="login-body">
      <div class="security-badge">
        <i class="bi bi-shield-check"></i>
        Enhanced Security Enabled
      </div>
      
      <form method="POST" action="/login" id="loginForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="form-group">
          <label for="username" class="form-label">Username</label>
          <input type="text" name="username" id="username" class="form-control" 
                 placeholder="Enter your username" autocomplete="username" required>
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">Password</label>
          <div class="input-group">
            <input type="password" name="password" id="password" class="form-control" 
                   placeholder="Enter your password" autocomplete="current-password" required>
            <button class="password-toggle" type="button" id="togglePassword" 
                    data-bs-toggle="tooltip" data-bs-placement="top" title="Show Password">
              <i class="bi bi-eye" id="passwordIcon"></i>
            </button>
          </div>
        </div>
        
        
        <button type="submit" class="btn-login" id="loginBtn">
          <span class="btn-text">Sign In</span>
        </button>
      </form>
      
      <!-- Divider -->
      <div class="login-divider">
        <span>OR</span>
      </div>
      
      <!-- Google Sign-In Button -->
      <a href="{{ url_for('auth.google_login') }}" class="btn-google">
        <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        <span>Sign in with Google</span>
      </a>
      
      <div class="security-features">
        <h6><i class="bi bi-lock"></i> Security Features</h6>
        <ul>
          <li>Secure authentication system</li>
          <li>Automatic role detection</li>
          <li>Secure password requirements</li>
          <li>Session management and monitoring</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="mobileWarningModal" tabindex="-1" aria-labelledby="mobileWarningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mobileWarningModalLabel">Compatibility Notice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>For the best experience, we recommend using a desktop or laptop computer. This site is not fully optimized for mobile devices (Version 1.03).</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Password visibility toggle functionality
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    const passwordIcon = document.getElementById('passwordIcon');
    const tooltip = bootstrap.Tooltip.getInstance(togglePassword);

    togglePassword.addEventListener('click', function() {
      // Toggle password visibility
      const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
      password.setAttribute('type', type);
      
      // Toggle icon
      if (type === 'text') {
        passwordIcon.classList.remove('bi-eye');
        passwordIcon.classList.add('bi-eye-slash');
        tooltip.setContent({ '.tooltip-inner': 'Hide Password' });
      } else {
        passwordIcon.classList.remove('bi-eye-slash');
        passwordIcon.classList.add('bi-eye');
        tooltip.setContent({ '.tooltip-inner': 'Show Password' });
      }
    });

    // Form submission with loading state
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.querySelector('.btn-text');

    // Simple form submission without interference
    loginForm.addEventListener('submit', function(e) {
      // Debug: Check form data
      const formData = new FormData(loginForm);
      console.log('Form data being submitted:');
      for (let [key, value] of formData.entries()) {
        console.log(key + ': ' + value);
      }
      
      // Add loading state but don't prevent submission
      loginBtn.classList.add('loading');
      btnText.textContent = 'Signing In...';
    });

    // Add focus effects to form inputs
    const formInputs = document.querySelectorAll('.form-control');
    formInputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.parentElement.classList.add('focused');
      });
      
      input.addEventListener('blur', function() {
        this.parentElement.classList.remove('focused');
      });
    });

    // Add floating label effect
    formInputs.forEach(input => {
      input.addEventListener('input', function() {
        if (this.value) {
          this.classList.add('has-value');
        } else {
          this.classList.remove('has-value');
        }
      });
    });

    // Mobile warning popup logic
    if (window.innerWidth < 768) {
        var myModal = new bootstrap.Modal(document.getElementById('mobileWarningModal'), {
            keyboard: false
        });
        myModal.show();
    }

    // Add subtle animations to form elements
    const formGroups = document.querySelectorAll('.form-group');
    formGroups.forEach((group, index) => {
      group.style.opacity = '0';
      group.style.transform = 'translateY(20px)';
      
      setTimeout(() => {
        group.style.transition = 'all 0.4s ease';
        group.style.opacity = '1';
        group.style.transform = 'translateY(0)';
      }, 100 + (index * 100));
    });

    // Enter key support is handled naturally by the form

    // Remove any CSRF token text that might appear
    function removeCSRFTokenText() {
      // Check the entire document, not just login body
      const walker = document.createTreeWalker(
        document.body,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      
      let node;
      while (node = walker.nextNode()) {
        if (node.textContent && node.textContent.trim()) {
          const text = node.textContent.trim();
          // Match CSRF token pattern (base64-like with dots)
          if (text.match(/^[A-Za-z0-9+/=]+\.[A-Za-z0-9+/=]+\.[A-Za-z0-9+/=]+$/) && text.length > 20) {
            console.log('Removing CSRF token text:', text);
            node.remove();
          }
        }
      }
    }
    
    // Run immediately and after delays to catch any dynamically added content
    removeCSRFTokenText();
    setTimeout(removeCSRFTokenText, 100);
    setTimeout(removeCSRFTokenText, 500);
    setTimeout(removeCSRFTokenText, 1000);
    
    // Also run on DOM mutations
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          removeCSRFTokenText();
        }
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Slideshow functionality removed for performance optimization
    // Using static background image instead of animated slideshow
  });
</script>
{% endblock %}
