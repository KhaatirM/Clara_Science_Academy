<!-- Password Change Modal -->
<div class="modal fade" id="passwordChangeModal" tabindex="-1" aria-labelledby="passwordChangeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="passwordChangeModalLabel">
                    <i class="bi bi-shield-exclamation me-2"></i>Password Change Required
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Security Notice:</strong> You are using a temporary password. Please change it to a secure password for your account safety.
                </div>
                
                <form id="passwordChangeForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        <div class="form-text">Enter your current temporary password</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="8">
                        <div class="form-text">Password must be at least 8 characters long</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                        <div class="form-text">Re-enter your new password</div>
                    </div>
                    
                    <!-- Password strength indicator -->
                    <div class="mb-3">
                        <label class="form-label">Password Strength</label>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" id="passwordStrengthBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="passwordStrengthText" class="form-text text-muted">Enter a password to see strength</small>
                    </div>
                    
                    <!-- Password requirements -->
                    <div class="mb-3">
                        <small class="form-text text-muted">
                            <strong>Password Requirements:</strong>
                            <ul class="mb-0 mt-1">
                                <li id="req-length">At least 8 characters</li>
                                <li id="req-uppercase">One uppercase letter</li>
                                <li id="req-lowercase">One lowercase letter</li>
                                <li id="req-number">One number</li>
                            </ul>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelPasswordChange" disabled>
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="submitPasswordChange">
                    <i class="bi bi-check-circle me-1"></i>Change Password
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('passwordChangeModal'));
    const form = document.getElementById('passwordChangeForm');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    const submitBtn = document.getElementById('submitPasswordChange');
    const cancelBtn = document.getElementById('cancelPasswordChange');
    
    // Show modal immediately when page loads
    modal.show();
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password)
        };
        
        // Update requirement indicators
        document.getElementById('req-length').style.color = requirements.length ? '#28a745' : '#dc3545';
        document.getElementById('req-uppercase').style.color = requirements.uppercase ? '#28a745' : '#dc3545';
        document.getElementById('req-lowercase').style.color = requirements.lowercase ? '#28a745' : '#dc3545';
        document.getElementById('req-number').style.color = requirements.number ? '#28a745' : '#dc3545';
        
        // Calculate strength
        Object.values(requirements).forEach(met => {
            if (met) strength += 25;
        });
        
        // Update strength bar
        strengthBar.style.width = strength + '%';
        
        if (strength < 25) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Very Weak';
        } else if (strength < 50) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Weak';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
        }
        
        return strength >= 50; // Minimum 50% strength required
    }
    
    // Real-time password strength checking
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });
    
    // Form validation
    function validateForm() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            return false;
        }
        
        if (newPassword !== confirmPassword) {
            return false;
        }
        
        if (!checkPasswordStrength(newPassword)) {
            return false;
        }
        
        return true;
    }
    
    // Update submit button state
    function updateSubmitButton() {
        const isValid = validateForm();
        submitBtn.disabled = !isValid;
        
        if (isValid) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        } else {
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-secondary');
        }
    }
    
    // Add event listeners for form validation
    form.addEventListener('input', updateSubmitButton);
    
    // Password confirmation matching
    confirmPasswordInput.addEventListener('input', function() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = this.value;
        
        if (confirmPassword && newPassword !== confirmPassword) {
            this.setCustomValidity('Passwords do not match');
            this.classList.add('is-invalid');
        } else {
            this.setCustomValidity('');
            this.classList.remove('is-invalid');
        }
        updateSubmitButton();
    });
    
    // Form submission
    submitBtn.addEventListener('click', function() {
        if (!validateForm()) {
            alert('Please fill in all fields correctly and ensure passwords match.');
            return;
        }
        
        const formData = new FormData(form);
        
        // Disable submit button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Changing...';
        
        fetch('/change-password', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert('Password changed successfully! You will be redirected to the dashboard.');
                
                // Hide modal and redirect
                modal.hide();
                window.location.href = data.redirect_url || '/';
            } else {
                // Show error message
                alert('Error: ' + (data.message || 'Failed to change password. Please try again.'));
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
        });
    });
    
    // Prevent modal from being closed
    document.getElementById('passwordChangeModal').addEventListener('hide.bs.modal', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Initial validation
    updateSubmitButton();
});
</script>

<style>
#passwordChangeModal .modal-header {
    border-bottom: 2px solid #ffc107;
}

#passwordChangeModal .modal-content {
    border: 2px solid #ffc107;
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
}

.password-requirement {
    transition: color 0.3s ease;
}

.progress {
    background-color: #e9ecef;
}

.progress-bar {
    transition: width 0.3s ease, background-color 0.3s ease;
}

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
