{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <!-- Enhanced Header with Gradient Background -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white shadow-lg border-0">
                <div class="card-body p-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div>
                            <h2 class="mb-2 text-white">
                                <i class="bi bi-journal-text me-3"></i>{{ assignment.title }}
                            </h2>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                {% if assignment.assignment_type == 'quiz' %}
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="bi bi-question-circle me-1"></i>Quiz Assignment
                                    </span>
                                {% elif assignment.assignment_type == 'discussion' %}
                                    <span class="badge bg-info fs-6">
                                        <i class="bi bi-chat-dots me-1"></i>Discussion Assignment
                                    </span>
                                {% else %}
                                    <span class="badge bg-light text-dark fs-6">
                                        <i class="bi bi-file-earmark-pdf me-1"></i>PDF/Paper Assignment
                                    </span>
                                {% endif %}
                                {% if assignment.status == 'Active' %}
                                    <span class="badge bg-success fs-6">
                                        <i class="bi bi-check-circle me-1"></i>Active
                                    </span>
                                {% elif assignment.status == 'Inactive' %}
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="bi bi-pause-circle me-1"></i>Inactive
                                    </span>
                                {% elif assignment.status == 'Voided' %}
                                    <span class="badge bg-danger fs-6">
                                        <i class="bi bi-x-circle me-1"></i>Voided
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            {% if current_user.role in ['Director', 'School Administrator'] %}
                                <a href="{{ url_for('management.assignments_and_grades') }}" class="btn btn-outline-light btn-lg">
                                    <i class="bi bi-arrow-left me-2"></i>Back to Assignments
                                </a>
                                <a href="{{ url_for('management.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-warning btn-lg">
                                    <i class="bi bi-pencil me-2"></i>Edit Assignment
                                </a>
                            {% elif current_user.role in ['Teacher'] %}
                                <a href="{{ url_for('teacher.assignments_and_grades') }}" class="btn btn-outline-light btn-lg">
                                    <i class="bi bi-arrow-left me-2"></i>Back to Assignments
                                </a>
                                <a href="{{ url_for('teacher.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-warning btn-lg">
                                    <i class="bi bi-pencil me-2"></i>Edit Assignment
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Assignment Details Card -->
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-info-circle me-2 text-primary"></i>Assignment Details
                    </h5>
                </div>
                <div class="card-body p-4">
                    {% if assignment.description %}
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Description</h6>
                            <div class="p-3 bg-light rounded-3">
                                <p class="mb-0">{{ assignment.description }}</p>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Key Information Grid -->
                    <div class="row g-4 mb-4">
                        <div class="col-12 col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-calendar-event text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Due Date</h6>
                                    <p class="mb-0 fw-bold">
                                        {% if assignment.due_date %}
                                            {{ assignment.due_date.strftime('%B %d, %Y at %I:%M %p') }}
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% if assignment.due_date %}
                                {% set due_date = assignment.due_date.date() if assignment.due_date.date else assignment.due_date %}
                                {% set days_remaining = (due_date - today).days %}
                                {% if days_remaining > 0 %}
                                    <span class="badge bg-success fs-6">
                                        <i class="bi bi-clock me-1"></i>{{ days_remaining }} days remaining
                                    </span>
                                {% elif days_remaining == 0 %}
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Due today
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger fs-6">
                                        <i class="bi bi-x-circle me-1"></i>{{ (days_remaining * -1) }} days overdue
                                    </span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-calendar-week text-info"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Quarter</h6>
                                    <p class="mb-0 fw-bold">Q{{ assignment.quarter }}</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if assignment.points %}
                        <div class="col-12 col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-star text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Points</h6>
                                    <p class="mb-0 fw-bold">{{ assignment.points }} points</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if assignment.attachment_filename %}
                        <div class="col-12 col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-paperclip text-success"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Attachment</h6>
                                    <p class="mb-0 fw-bold text-truncate">
                                        {{ assignment.attachment_original_filename or assignment.attachment_filename }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Assignment Type Information -->
                    <div class="mb-4">
                        {% if assignment.assignment_type == 'quiz' %}
                            <div class="alert alert-warning border-0 shadow-sm">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning bg-opacity-20 rounded-circle p-2 me-3">
                                        <i class="bi bi-question-circle text-warning"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Quiz Assignment</h6>
                                        <p class="mb-0 text-muted">Students will be able to take the quiz online when they access this assignment.</p>
                                    </div>
                                </div>
                            </div>
                            {% if assignment.attachment_filename %}
                                <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" 
                                   class="btn btn-warning btn-lg shadow-sm">
                                    <i class="bi bi-download me-2"></i>Download Quiz Materials
                                </a>
                            {% endif %}
                        {% elif assignment.assignment_type == 'discussion' %}
                            <div class="alert alert-info border-0 shadow-sm">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-opacity-20 rounded-circle p-2 me-3">
                                        <i class="bi bi-chat-dots text-info"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Discussion Assignment</h6>
                                        <p class="mb-0 text-muted">Students can participate in online discussions and share their thoughts on the topic.</p>
                                    </div>
                                </div>
                            </div>
                            {% if assignment.attachment_filename %}
                                <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" 
                                   class="btn btn-info btn-lg shadow-sm">
                                    <i class="bi bi-download me-2"></i>Download Discussion Materials
                                </a>
                            {% endif %}
                        {% else %}
                            {% if assignment.attachment_filename %}
                                <div class="alert alert-primary border-0 shadow-sm">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary bg-opacity-20 rounded-circle p-2 me-3">
                                                <i class="bi bi-file-earmark-pdf text-primary"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Assignment Materials</h6>
                                                <p class="mb-0 text-muted">{{ assignment.attachment_original_filename or assignment.attachment_filename }}</p>
                                            </div>
                                        </div>
                                        <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" 
                                           class="btn btn-primary shadow-sm">
                                            <i class="bi bi-download me-2"></i>Download
                                        </a>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-light border-0 shadow-sm">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light bg-opacity-50 rounded-circle p-2 me-3">
                                            <i class="bi bi-info-circle text-muted"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 text-muted">No Attachment</h6>
                                            <p class="mb-0 text-muted">No additional materials provided for this assignment.</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Sidebar -->
        <div class="col-12 col-lg-4">
            <!-- Class Information Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-people me-2 text-info"></i>Class Information
                    </h5>
                </div>
                <div class="card-body p-4">
                    {% if class_info %}
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-book text-info"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Class</h6>
                                    <p class="mb-0 fw-bold">{{ class_info.name }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-mortarboard text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Subject</h6>
                                    <p class="mb-0 fw-bold">{{ class_info.subject }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-award text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Grade Level</h6>
                                    <p class="mb-0 fw-bold">{{ class_info.grade_level or 'N/A' }}</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if teacher %}
                        <div class="mb-0">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-person text-success"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-muted">Teacher</h6>
                                    <p class="mb-0 fw-bold">{{ teacher.first_name }} {{ teacher.last_name }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-info-circle fs-1 mb-3"></i>
                            <p class="mb-0">No class information available</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Assignment Statistics Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-graph-up me-2 text-success"></i>Assignment Statistics
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="bg-success bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                    <i class="bi bi-file-earmark-check text-success fs-4"></i>
                                </div>
                                <h4 class="text-success mb-1">{{ submissions_count }}</h4>
                                <p class="text-muted mb-0 small">Submissions</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                    <i class="bi bi-star text-warning fs-4"></i>
                                </div>
                                <h4 class="text-warning mb-1">{{ assignment.points or 0 }}</h4>
                                <p class="text-muted mb-0 small">Points</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if current_user.role in ['Director', 'School Administrator', 'Teacher'] %}
                        <div class="d-grid gap-2 mt-3">
                            <a href="#" class="btn btn-success shadow-sm">
                                <i class="bi bi-eye me-2"></i>View All Submissions
                            </a>
                            <a href="{{ url_for('management.grade_assignment', assignment_id=assignment.id) if current_user.role in ['Director', 'School Administrator'] else url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" 
                               class="btn btn-outline-success shadow-sm">
                                <i class="bi bi-pencil me-2"></i>Grade Assignment
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-lightning me-2 text-warning"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-grid gap-2">
                        {% if current_user.role in ['Director', 'School Administrator'] %}
                            <a href="{{ url_for('management.edit_assignment', assignment_id=assignment.id) }}" 
                               class="btn btn-warning shadow-sm">
                                <i class="bi bi-pencil me-2"></i>Edit Assignment
                            </a>
                            <button type="button" class="btn btn-outline-danger shadow-sm" 
                                    onclick="confirmDelete('{{ assignment.title }}', {{ assignment.id }})">
                                <i class="bi bi-trash me-2"></i>Remove Assignment
                            </button>
                        {% elif current_user.role in ['Teacher'] %}
                            <a href="{{ url_for('teacher.edit_assignment', assignment_id=assignment.id) }}" 
                               class="btn btn-warning shadow-sm">
                                <i class="bi bi-pencil me-2"></i>Edit Assignment
                            </a>
                            <button type="button" class="btn btn-outline-danger shadow-sm" 
                                    onclick="confirmDelete('{{ assignment.title }}', {{ assignment.id }})">
                                <i class="bi bi-trash me-2"></i>Remove Assignment
                            </button>
                        {% endif %}
                        
                        {% if assignment.status == 'Active' %}
                            <button type="button" class="btn btn-outline-warning shadow-sm" 
                                    onclick="changeStatus('{{ assignment.id }}', 'Inactive')">
                                <i class="bi bi-pause me-2"></i>Deactivate
                            </button>
                        {% elif assignment.status == 'Inactive' %}
                            <button type="button" class="btn btn-outline-success shadow-sm" 
                                    onclick="changeStatus('{{ assignment.id }}', 'Active')">
                                <i class="bi bi-play me-2"></i>Activate
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove "<span id="assignmentTitle"></span>"?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Assignment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced styling for the view assignment page */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.alert {
    border-radius: 0.75rem;
}

.badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .btn-lg {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }
    
    .card-body {
        padding: 1.5rem !important;
    }
}
</style>

<script>
function confirmDelete(title, assignmentId) {
    document.getElementById('assignmentTitle').textContent = title;
    {% if current_user.role in ['Director', 'School Administrator'] %}
        document.getElementById('deleteForm').action = `/management/remove-assignment/${assignmentId}`;
    {% elif current_user.role in ['Teacher'] %}
        document.getElementById('deleteForm').action = `/teacher/assignment/remove/${assignmentId}`;
    {% endif %}
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

function changeStatus(assignmentId, newStatus) {
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                     document.querySelector('input[name=csrf_token]')?.value || '';
    
    // Create form data
    const formData = new FormData();
    formData.append('status', newStatus);
    formData.append('csrf_token', csrfToken);
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Updating...';
    button.disabled = true;
    
    {% if current_user.role in ['Director', 'School Administrator'] %}
        const url = `/management/assignment/change-status/${assignmentId}`;
    {% elif current_user.role in ['Teacher'] %}
        const url = `/teacher/assignment/${assignmentId}/change-status`;
    {% endif %}
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload
            showNotification('Assignment status updated successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification('Error: ' + data.message, 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the assignment status.', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Add smooth scroll behavior
document.addEventListener('DOMContentLoaded', function() {
    // Add animation to cards on load
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
