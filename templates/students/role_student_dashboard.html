{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/students_role_student_dashboard.css') }}">
<style>
/* Custom Modal Backdrop - Lighter and more readable */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.25) !important;
    backdrop-filter: blur(1px);
}

.modal-backdrop.show {
    opacity: 0.25 !important;
}

/* Ensure modal content has good contrast */
.modal-content {
    background-color: #ffffff !important;
    border: none;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.modal-body {
    background-color: #ffffff !important;
    color: #212529 !important;
}

/* Ensure all text in modals is readable */
.modal-body {
    color: #212529 !important;
}

.modal-body p,
.modal-body span:not(.badge):not(.text-primary):not(.text-info):not(.text-success):not(.text-warning):not(.text-danger):not(.text-muted),
.modal-body div:not(.alert):not(.badge),
.modal-body label,
.modal-body small,
.modal-body .form-text,
.modal-body h1,
.modal-body h2,
.modal-body h3,
.modal-body h4,
.modal-body h5,
.modal-body h6 {
    color: #212529 !important;
}

.modal-body .text-muted {
    color: #6c757d !important;
}

.modal-body .text-primary {
    color: #0d6efd !important;
}

.modal-body .text-info {
    color: #0dcaf0 !important;
}

.modal-body .text-success {
    color: #198754 !important;
}

.modal-body .text-warning {
    color: #ffc107 !important;
}

.modal-body .text-danger {
    color: #dc3545 !important;
}

/* Ensure form controls are readable */
.modal-body .form-control,
.modal-body .form-select {
    background-color: #ffffff !important;
    color: #212529 !important;
    border-color: #dee2e6;
}

.modal-body .form-control:focus,
.modal-body .form-select:focus {
    background-color: #ffffff !important;
    color: #212529 !important;
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.modal-body .form-control::placeholder {
    color: #6c757d !important;
}

/* Alert boxes in modals */
.modal-body .alert-light {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border-color: #dee2e6;
}

.modal-body .alert-info {
    background-color: #d1ecf1 !important;
    color: #0c5460 !important;
    border-color: #bee5eb;
}

/* File upload area */
.modal-body .file-upload-area {
    background-color: #f8f9fa !important;
    color: #212529 !important;
}

.modal-body .file-upload-area:hover {
    background-color: #f0f4ff !important;
}

.modal-body .file-upload-area p,
.modal-body .file-upload-area .text-muted {
    color: #212529 !important;
}

.modal-body .file-upload-area:hover p,
.modal-body .file-upload-area:hover .text-muted {
    color: #212529 !important;
}

/* Ensure header text is readable (white text on gradient is fine) */
.modal-header.text-white h4,
.modal-header.text-white h5,
.modal-header.text-white p {
    color: #ffffff !important;
}

/* Footer background */
.modal-footer.bg-light {
    background-color: #f8f9fa !important;
}

/* Ensure buttons are visible */
.modal-footer .btn-primary,
.modal-footer .btn-success,
.modal-footer .btn-info,
.modal-footer .btn-danger {
    color: #ffffff !important;
}

.modal-footer .btn-outline-secondary {
    color: #6c757d !important;
    border-color: #6c757d;
    background-color: transparent;
}

.modal-footer .btn-outline-secondary:hover {
    color: #ffffff !important;
    background-color: #6c757d;
    border-color: #6c757d;
}
</style>
{% endblock %}

{% block dashboard_content %}
<script>
// Global assignment view modal function - MUST be loaded first
window.openAssignmentViewModal = function(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade, assignmentType) {
    console.log('openAssignmentViewModal called with:', {assignmentId, assignmentTitle, assignmentAttachment, assignmentType});
    const modalElement = document.getElementById('assignmentViewModal');
    
    if (!modalElement) {
        console.error('Assignment view modal not found!');
        alert('Assignment view modal not found. Please refresh the page.');
        return;
    }
    
    // Set assignment data
    document.getElementById('viewAssignmentTitle').textContent = assignmentTitle;
    document.getElementById('viewAssignmentQuarter').textContent = `Q${assignmentQuarter}`;
    
    // Set assignment type badge with enhanced styling
    const typeElement = document.getElementById('viewAssignmentType');
    if (assignmentType === 'quiz') {
        typeElement.className = 'badge fs-6 px-3 py-2';
        typeElement.style.background = 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)';
        typeElement.style.color = 'white';
        typeElement.innerHTML = '<i class="bi bi-question-circle me-1"></i>Interactive Quiz';
    } else if (assignmentType === 'discussion') {
        typeElement.className = 'badge fs-6 px-3 py-2';
        typeElement.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
        typeElement.style.color = 'white';
        typeElement.innerHTML = '<i class="bi bi-chat-dots me-1"></i>Group Discussion';
    } else {
        typeElement.className = 'badge fs-6 px-3 py-2';
        typeElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        typeElement.style.color = 'white';
        typeElement.innerHTML = '<i class="bi bi-file-earmark-pdf me-1"></i>Document Assignment';
    }
    
    // Set dynamic header based on assignment type
    const modalHeader = document.getElementById('viewModalHeader');
    const assignmentIcon = document.getElementById('viewAssignmentIcon');
    if (assignmentType === 'quiz') {
        modalHeader.style.background = 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)';
        assignmentIcon.innerHTML = '<i class="bi bi-question-circle-fill"></i>';
    } else if (assignmentType === 'discussion') {
        modalHeader.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
        assignmentIcon.innerHTML = '<i class="bi bi-chat-dots-fill"></i>';
    } else {
        modalHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        assignmentIcon.innerHTML = '<i class="bi bi-file-earmark-text-fill"></i>';
    }
    
    // Set description with type-specific messaging and instructions
    const descriptionElement = document.getElementById('viewAssignmentDescription');
    const instructionsElement = document.getElementById('viewAssignmentInstructions');
    
    if (assignmentDescription && assignmentDescription.trim()) {
        descriptionElement.innerHTML = `<p class="mb-0">${assignmentDescription}</p>`;
    } else {
        descriptionElement.innerHTML = '<p class="mb-0 text-muted"><em>No specific instructions provided.</em></p>';
    }
    
    // Add type-specific instructions
    if (assignmentType === 'quiz') {
        instructionsElement.innerHTML = `
            <div class="alert alert-warning border-0" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                <h6 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>Quiz Instructions</h6>
                <ul class="mb-0">
                    <li>Read each question carefully before answering</li>
                    <li>You can review your answers before submitting</li>
                    <li>Once submitted, you cannot change your answers</li>
                    <li>Take your time - there's no rush!</li>
                </ul>
            </div>
        `;
    } else if (assignmentType === 'discussion') {
        instructionsElement.innerHTML = `
            <div class="alert alert-info border-0" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);">
                <h6 class="alert-heading"><i class="bi bi-people me-2"></i>Discussion Guidelines</h6>
                <ul class="mb-0">
                    <li>Share your thoughts and ideas respectfully</li>
                    <li>Respond to your classmates' posts</li>
                    <li>Ask questions to deepen the conversation</li>
                    <li>Support your points with examples</li>
                </ul>
            </div>
        `;
    } else {
        instructionsElement.innerHTML = `
            <div class="alert alert-primary border-0" style="background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);">
                <h6 class="alert-heading"><i class="bi bi-file-earmark-check me-2"></i>Submission Guidelines</h6>
                <ul class="mb-0">
                    <li>Review all requirements before starting</li>
                    <li>Download and read the assignment file</li>
                    <li>Follow the formatting guidelines provided</li>
                    <li>Submit your work before the due date</li>
                </ul>
            </div>
        `;
    }
    
    // Set due date with enhanced formatting
    const dueDateElement = document.getElementById('viewAssignmentDueDate');
    dueDateElement.innerHTML = `
        <span class="fs-5">${assignmentDueDate}</span>
        <br><small class="opacity-75">Submit before this date and time</small>
    `;
    
    // Calculate and display time remaining
    calculateTimeRemaining(assignmentDueDate);
    
    // Set attachment info based on assignment type with enhanced styling
    const attachmentElement = document.getElementById('viewAssignmentAttachment');
    const typeCardHeader = document.getElementById('viewTypeCardHeader');
    const typeCardTitle = document.getElementById('viewTypeCardTitle');
    const typeInstructions = document.getElementById('viewTypeInstructions');
    
    if (assignmentType === 'quiz') {
        typeCardHeader.style.background = 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)';
        typeCardTitle.innerHTML = '<i class="bi bi-question-circle me-2"></i>Quiz Resources';
        attachmentElement.innerHTML = `
            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                <i class="bi bi-question-circle-fill fs-1 text-warning mb-2"></i>
                <h6 class="text-dark mb-2">Interactive Quiz</h6>
                <p class="text-dark mb-0 small">Questions will appear when you start the quiz</p>
            </div>
        `;
        typeInstructions.innerHTML = `
            <div class="mt-3">
                <h6 class="text-warning"><i class="bi bi-clock me-2"></i>Time Management</h6>
                <p class="small text-muted">Most quizzes have no time limit, so take your time to think through each question carefully.</p>
            </div>
        `;
    } else if (assignmentType === 'discussion') {
        typeCardHeader.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
        typeCardTitle.innerHTML = '<i class="bi bi-chat-dots me-2"></i>Discussion Forum';
        attachmentElement.innerHTML = `
            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);">
                <i class="bi bi-chat-dots-fill fs-1 text-info mb-2"></i>
                <h6 class="text-dark mb-2">Discussion Board</h6>
                <p class="text-dark mb-0 small">Join the conversation with your classmates</p>
            </div>
        `;
        typeInstructions.innerHTML = `
            <div class="mt-3">
                <h6 class="text-info"><i class="bi bi-heart me-2"></i>Participation Tips</h6>
                <p class="small text-muted">Engage actively by posting thoughtful responses and asking follow-up questions.</p>
            </div>
        `;
    } else {
        typeCardHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        typeCardTitle.innerHTML = '<i class="bi bi-file-earmark me-2"></i>Assignment Files';
        if (assignmentAttachment && assignmentAttachment.trim()) {
            console.log('Setting up PDF/Paper assignment attachment with ID:', assignmentId);
            attachmentElement.innerHTML = `
                <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #cce7ff 0%, #b3d9ff 100%);">
                    <i class="bi bi-file-earmark-text-fill fs-1 text-primary mb-2"></i>
                    <h6 class="text-dark mb-2">Assignment Materials</h6>
                    <p class="text-dark mb-3 small">Download the assignment file to get started</p>
                    <a href="/student/download-assignment-file/${assignmentId}" class="btn btn-primary btn-sm">
                        <i class="bi bi-download me-1"></i>Download File
                    </a>
                </div>
            `;
        } else {
            attachmentElement.innerHTML = `
                <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <i class="bi bi-info-circle-fill fs-1 text-muted mb-2"></i>
                    <h6 class="text-dark mb-2">No Files Attached</h6>
                    <p class="text-dark mb-0 small">This assignment doesn't require additional files</p>
                </div>
            `;
        }
        typeInstructions.innerHTML = `
            <div class="mt-3">
                <h6 class="text-primary"><i class="bi bi-check-circle me-2"></i>Submission Checklist</h6>
                <p class="small text-muted">Make sure to review all requirements and submit your work before the deadline.</p>
            </div>
        `;
    }
    
    // Set enhanced submission status with progress tracking
    const statusElement = document.getElementById('viewAssignmentStatus');
    const submissionStatusElement = document.getElementById('viewSubmissionStatus');
    const progressBar = document.getElementById('viewProgressBar');
    const progressText = document.getElementById('viewProgressText');
    const progressContainer = document.getElementById('viewProgressContainer');
    const banner = document.getElementById('viewAssignmentBanner');
    const statusIcon = document.getElementById('viewAssignmentStatusIcon');
    const statusTitle = document.getElementById('viewAssignmentStatusTitle');
    const statusMessage = document.getElementById('viewAssignmentStatusMessage');
    const submissionCardHeader = document.getElementById('viewSubmissionCardHeader');
    
    // Show/hide progress bar based on assignment type
    if (assignmentType === 'quiz' || assignmentType === 'discussion') {
        progressContainer.style.display = 'block';
    } else {
        progressContainer.style.display = 'none';
    }
    
    if (hasGrade) {
        // Graded - Complete
        statusElement.className = 'badge fs-6 px-3 py-2';
        statusElement.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
        statusElement.style.color = 'white';
        statusElement.innerHTML = '<i class="bi bi-check-circle me-1"></i>Completed';
        
        banner.className = 'alert border-0 shadow-sm';
        banner.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
        statusTitle.textContent = 'Assignment Complete!';
        statusMessage.textContent = 'Congratulations! Your work has been graded and reviewed.';
        
        submissionCardHeader.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
        
        submissionStatusElement.innerHTML = `
            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                <i class="bi bi-trophy-fill fs-1 text-success mb-2"></i>
                <h6 class="text-success mb-2">Great Job!</h6>
                <p class="text-success mb-0 small">Your assignment has been successfully graded</p>
            </div>
        `;
        
        if (assignmentType === 'quiz' || assignmentType === 'discussion') {
            if (assignmentType === 'quiz' && hasQuizProgress) {
                // Show actual quiz progress
                const progressPercentage = Math.round((quizProgressData.questions_answered / quizProgressData.total_questions) * 100);
                progressBar.style.width = progressPercentage + '%';
                progressBar.className = 'progress-bar bg-info';
                progressText.textContent = `Progress: ${progressPercentage}% - ${quizProgressData.questions_answered}/${quizProgressData.total_questions} questions answered`;
            } else {
                // Default complete state
                progressBar.style.width = '100%';
                progressBar.className = 'progress-bar bg-success';
                progressText.textContent = 'Progress: 100% - Complete!';
            }
        }
        
    } else if (hasSubmission) {
        // Submitted but not graded - In Progress
        statusElement.className = 'badge fs-6 px-3 py-2';
        statusElement.style.background = 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)';
        statusElement.style.color = 'dark';
        statusElement.innerHTML = '<i class="bi bi-clock-history me-1"></i>Under Review';
        
        banner.className = 'alert border-0 shadow-sm';
        banner.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
        statusIcon.innerHTML = '<i class="bi bi-hourglass-split text-warning"></i>';
        statusTitle.textContent = 'Work Submitted!';
        statusMessage.textContent = 'Your submission is being reviewed by your teacher.';
        
        submissionCardHeader.style.background = 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)';
        
        submissionStatusElement.innerHTML = `
            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                <i class="bi bi-hourglass-split fs-1 text-warning mb-2"></i>
                <h6 class="text-warning mb-2">Under Review</h6>
                <p class="text-warning mb-0 small">Your teacher is reviewing your work</p>
            </div>
        `;
        
        if (assignmentType === 'quiz' || assignmentType === 'discussion') {
            if (assignmentType === 'quiz' && hasQuizProgress) {
                // Show actual quiz progress
                const progressPercentage = Math.round((quizProgressData.questions_answered / quizProgressData.total_questions) * 100);
                progressBar.style.width = progressPercentage + '%';
                progressBar.className = 'progress-bar bg-warning';
                progressText.textContent = `Progress: ${progressPercentage}% - ${quizProgressData.questions_answered}/${quizProgressData.total_questions} questions answered`;
            } else {
                // Default submitted state
                progressBar.style.width = '75%';
                progressBar.className = 'progress-bar bg-warning';
                progressText.textContent = 'Progress: 75% - Awaiting Grade';
            }
        }
        
    } else {
        // Not submitted - Pending
        statusElement.className = 'badge fs-6 px-3 py-2';
        statusElement.style.background = 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)';
        statusElement.style.color = 'white';
        statusElement.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Pending';
        
        banner.className = 'alert border-0 shadow-sm';
        banner.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
        statusIcon.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
        statusTitle.textContent = 'Ready to Start!';
        statusMessage.textContent = 'This assignment is waiting for you to begin.';
        
        submissionCardHeader.style.background = 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)';
        
        submissionStatusElement.innerHTML = `
            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);">
                <i class="bi bi-play-circle-fill fs-1 text-danger mb-2"></i>
                <h6 class="text-danger mb-2">Ready to Begin</h6>
                <p class="text-danger mb-0 small">Click the action button below to get started</p>
            </div>
        `;
        
        if (assignmentType === 'quiz' || assignmentType === 'discussion') {
            if (assignmentType === 'quiz' && hasQuizProgress) {
                // Show actual quiz progress
                const progressPercentage = Math.round((quizProgressData.questions_answered / quizProgressData.total_questions) * 100);
                progressBar.style.width = progressPercentage + '%';
                progressBar.className = 'progress-bar bg-info';
                progressText.textContent = `Progress: ${progressPercentage}% - ${quizProgressData.questions_answered}/${quizProgressData.total_questions} questions answered`;
            } else {
                // Default not started state
                progressBar.style.width = '25%';
                progressBar.className = 'progress-bar bg-danger';
                progressText.textContent = 'Progress: 25% - Not Started';
            }
        }
    }
    
    // Set enhanced action buttons based on assignment type
    const actionButtonsElement = document.getElementById('viewActionButtons');
    if (actionButtonsElement) {
        actionButtonsElement.innerHTML = '';
        
        if (assignmentType === 'quiz') {
            // Quiz-specific buttons with enhanced styling
            if (!hasSubmission) {
                actionButtonsElement.innerHTML += `
                    <button type="button" class="btn btn-lg text-white shadow" 
                            style="background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);"
                            onclick="takeQuiz(${assignmentId}, '${assignmentTitle}')">
                        <i class="bi bi-play-circle-fill me-2"></i>Start Quiz
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showQuizHelp()">
                        <i class="bi bi-question-circle me-1"></i>Quiz Help
                    </button>
                `;
            } else if (!hasGrade) {
                actionButtonsElement.innerHTML += `
                    <div class="alert alert-warning border-0 mb-2" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                        <i class="bi bi-hourglass-split me-2"></i><strong>Quiz Submitted!</strong><br>
                        <small>Your quiz is being reviewed by your teacher.</small>
                    </div>
                `;
            } else {
                actionButtonsElement.innerHTML += `
                    <div class="alert alert-success border-0 mb-2" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                        <i class="bi bi-trophy-fill me-2"></i><strong>Quiz Complete!</strong><br>
                        <small>Congratulations! Your quiz has been graded.</small>
                    </div>
                `;
            }
        } else if (assignmentType === 'discussion') {
            // Discussion-specific buttons with enhanced styling
            actionButtonsElement.innerHTML += `
                <button type="button" class="btn btn-lg text-white shadow" 
                        style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"
                        onclick="joinDiscussion(${assignmentId}, '${assignmentTitle}')">
                    <i class="bi bi-chat-dots-fill me-2"></i>Join Discussion
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="showDiscussionHelp()">
                    <i class="bi bi-people me-1"></i>Discussion Tips
                </button>
            `;
        } else {
            // PDF/Paper assignment buttons with enhanced styling
            if (!hasSubmission) {
                actionButtonsElement.innerHTML += `
                    <button type="button" class="btn btn-lg text-white shadow" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                            onclick="switchToSubmissionModal(${assignmentId}, '${assignmentTitle}', false)">
                        <i class="bi bi-upload me-2"></i>Submit Assignment
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showSubmissionHelp()">
                        <i class="bi bi-info-circle me-1"></i>Submission Help
                    </button>
                `;
            } else if (!hasGrade) {
                actionButtonsElement.innerHTML += `
                    <button type="button" class="btn btn-lg text-white shadow" 
                            style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);"
                            onclick="switchToSubmissionModal(${assignmentId}, '${assignmentTitle}', true)">
                        <i class="bi bi-pencil-square me-2"></i>Resubmit Assignment
                    </button>
                    <div class="alert alert-info border-0 mt-2" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);">
                        <i class="bi bi-clock-history me-2"></i><small>Your submission is being reviewed.</small>
                    </div>
                `;
            }
        }
    }
    
    // Show modal using Bootstrap 5 with proper backdrop handling
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Remove any existing backdrops first
        const existingBackdrops = document.querySelectorAll('.modal-backdrop');
        existingBackdrops.forEach(backdrop => backdrop.remove());
        
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
        modal.show();
    } else {
        // Simple fallback
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');
    }
};

// Helper function to calculate time remaining
function calculateTimeRemaining(dueDateString) {
    const timeElement = document.getElementById('viewTimeRemaining');
    if (!timeElement || !dueDateString) return;
    
    try {
        const dueDate = new Date(dueDateString);
        const now = new Date();
        const diffMs = dueDate - now;
        
        if (diffMs < 0) {
            timeElement.innerHTML = `
                <span class="text-danger fw-bold">Overdue</span>
                <br><small class="text-danger">Past due date</small>
            `;
        } else {
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                timeElement.innerHTML = `
                    <span class="text-success fw-bold">${days} day${days !== 1 ? 's' : ''}</span>
                    <br><small class="text-success">${hours}h ${minutes}m remaining</small>
                `;
            } else if (hours > 0) {
                timeElement.innerHTML = `
                    <span class="text-warning fw-bold">${hours}h ${minutes}m</span>
                    <br><small class="text-warning">Less than a day left!</small>
                `;
            } else {
                timeElement.innerHTML = `
                    <span class="text-danger fw-bold">${minutes} minutes</span>
                    <br><small class="text-danger">Due very soon!</small>
                `;
            }
        }
    } catch (error) {
        timeElement.textContent = 'Unable to calculate';
    }
}

// Help functions for different assignment types
function showAssignmentHelp() {
    alert('Assignment Help:\n\n• Read all instructions carefully\n• Check the due date and time\n• Download any attached files\n• Ask your teacher if you have questions\n• Submit your work before the deadline');
}

function showQuizHelp() {
    alert('Quiz Help:\n\n• Read each question carefully\n• Take your time - most quizzes have no time limit\n• You can review your answers before submitting\n• Once submitted, you cannot change your answers\n• If you\'re unsure, make your best guess');
}

function showDiscussionHelp() {
    alert('Discussion Help:\n\n• Share your thoughts and ideas respectfully\n• Respond to your classmates\' posts\n• Ask questions to deepen the conversation\n• Support your points with examples\n• Be constructive and encouraging');
}

function showSubmissionHelp() {
    alert('Submission Help:\n\n• Review all assignment requirements\n• Download and read the assignment file\n• Follow the formatting guidelines\n• Save your work frequently\n• Submit before the deadline\n• Keep a backup copy of your work');
}

// Global view assignment function - called by View button
window.viewAssignment = function(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade, assignmentType) {
    console.log('viewAssignment function called with:', arguments);
    try {
        // For quiz assignments, redirect to take quiz page instead of showing modal
        if (assignmentType === 'quiz') {
            window.location.href = `/student/take-quiz/${assignmentId}`;
            return;
        }
        // For other assignment types, show the view modal
        openAssignmentViewModal(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade, assignmentType);
    } catch (error) {
        console.error('Error in viewAssignment function:', error);
        alert('Error opening assignment view. Please try again.');
    }
};

// Function to switch from view modal to submission modal
window.switchToSubmissionModal = function(assignmentId, assignmentTitle, isResubmit) {
    console.log('Switching to submission modal:', assignmentId, assignmentTitle, isResubmit);
    
    try {
        // First, close the assignment view modal
        const viewModal = document.getElementById('assignmentViewModal');
        if (viewModal) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modalInstance = bootstrap.Modal.getInstance(viewModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            } else {
                // Fallback for non-Bootstrap
                viewModal.style.display = 'none';
                viewModal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }
        
        // Remove any existing backdrops
        const existingBackdrops = document.querySelectorAll('.modal-backdrop');
        existingBackdrops.forEach(backdrop => backdrop.remove());
        
        // Wait a moment for the view modal to close, then open submission modal
        setTimeout(() => {
            if (typeof openSubmissionModal === 'function') {
                openSubmissionModal(assignmentId, assignmentTitle, isResubmit);
            } else {
                console.error('openSubmissionModal function not found');
                alert('Submission modal function not available. Please refresh the page.');
            }
        }, 300); // 300ms delay to ensure smooth transition
        
    } catch (error) {
        console.error('Error switching to submission modal:', error);
        alert('Error opening submission form. Please try again.');
    }
};

// Global submission modal function
window.openSubmissionModal = function(assignmentId, assignmentTitle, isResubmit) {
    console.log('Opening submission modal:', assignmentId, assignmentTitle, isResubmit);
    
    try {
        const modalElement = document.getElementById('submissionModal');
        
        if (!modalElement) {
            console.error('Submission modal not found!');
            alert('Submission modal not found. Please refresh the page.');
            return;
        }
        
        // Set assignment data in the submission modal
        document.getElementById('submissionAssignmentId').value = assignmentId;
        document.getElementById('submissionAssignmentTitle').textContent = assignmentTitle;
        document.getElementById('submissionModalLabel').textContent = isResubmit ? 'Resubmit Assignment' : 'Submit Assignment';
        const submitBtn = document.getElementById('submissionSubmitBtn');
        const submitBtnText = document.getElementById('submissionSubmitBtnText');
        if (submitBtnText) {
            submitBtnText.textContent = isResubmit ? 'Resubmit Assignment' : 'Submit Assignment';
        } else {
            submitBtn.textContent = isResubmit ? 'Resubmit' : 'Submit';
        }
        
        // Clear any previous file input
        const fileInput = document.getElementById('submission_file');
        if (fileInput) {
            fileInput.value = '';
        }
        
        // Clear any previous comments
        const commentsInput = document.getElementById('submission_notes');
        if (commentsInput) {
            commentsInput.value = '';
        }
        
        // Show modal using Bootstrap 5
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // Remove any existing backdrops first
            const existingBackdrops = document.querySelectorAll('.modal-backdrop');
            existingBackdrops.forEach(backdrop => backdrop.remove());
            
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            modal.show();
        } else {
            // Simple fallback
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            document.body.classList.add('modal-open');
        }
        
    } catch (error) {
        console.error('Error opening submission modal:', error);
        alert('Error opening submission form. Please try again.');
    }
};

// Function to handle assignment submission
window.handleAssignmentSubmission = function() {
    console.log('Handling assignment submission...');
    
    try {
        // First, let's test if we can access the form elements
        const form = document.getElementById('assignmentSubmissionForm');
        const assignmentId = document.getElementById('submissionAssignmentId');
        const fileInput = document.getElementById('submission_file');
        const commentsInput = document.getElementById('submission_notes');
        
        console.log('Form elements found:', {
            form: !!form,
            assignmentId: !!assignmentId,
            fileInput: !!fileInput,
            commentsInput: !!commentsInput
        });
        
        if (!form || !assignmentId) {
            console.error('Form or assignment ID not found');
            alert('Submission form error. Please refresh the page.');
            return;
        }
        
        // Validate file input
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert('Please select a file to submit.');
            return;
        }
        
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('assignment_id', assignmentId.value);
        formData.append('submission_file', fileInput.files[0]);
        
        if (commentsInput && commentsInput.value.trim()) {
            formData.append('submission_notes', commentsInput.value.trim());
        }
        
        // Show loading state
        const submitBtn = document.getElementById('submissionSubmitBtn');
        const submitBtnText = document.getElementById('submissionSubmitBtnText');
        const originalText = submitBtnText ? submitBtnText.textContent : submitBtn.textContent;
        if (submitBtnText) {
            submitBtnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        } else {
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        }
        submitBtn.disabled = true;
        
        // Submit the assignment
        fetch(`/student/submit/${assignmentId.value}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Assignment submitted successfully!');
                
                // Close the submission modal
                const modalElement = document.getElementById('submissionModal');
                if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
                
                // Refresh the page to show updated status
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } else {
                alert('Submission failed: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Submission error:', error);
            alert('Error submitting assignment. Please try again.');
        })
        .finally(() => {
            // Reset button state
            const submitBtnText = document.getElementById('submissionSubmitBtnText');
            if (submitBtnText) {
                submitBtnText.textContent = originalText;
            } else {
                submitBtn.textContent = originalText;
            }
            submitBtn.disabled = false;
        });
        
        
    } catch (error) {
        console.error('Error in handleAssignmentSubmission:', error);
        alert('Error submitting assignment. Please try again.');
    }
};


// Function to submit assignment directly from the table
window.submitAssignmentFromTable = function(assignmentId, assignmentTitle, hasSubmission) {
    console.log('Submit assignment from table:', assignmentId, assignmentTitle, hasSubmission);
    
    try {
        // Check if assignment is already submitted
        if (hasSubmission) {
            const confirmResubmit = confirm(`Assignment "${assignmentTitle}" has already been submitted. Do you want to resubmit it?`);
            if (!confirmResubmit) {
                return;
            }
        }
        
        // Open the submission modal directly
        if (typeof openSubmissionModal === 'function') {
            openSubmissionModal(assignmentId, assignmentTitle, hasSubmission);
        } else {
            console.error('openSubmissionModal function not found');
            alert('Submission modal function not available. Please refresh the page.');
        }
        
    } catch (error) {
        console.error('Error in submitAssignmentFromTable:', error);
        alert('Error opening submission form. Please try again.');
    }
};

// Function to show extension request message
window.showExtensionRequestMessage = function(assignmentTitle) {
    console.log('Extension request clicked for:', assignmentTitle);
    
    // Show the "Currently in Development" message
    alert(`Extension Request for "${assignmentTitle}"\n\nCurrently in Development\n\nPlease speak to your assigned teacher in person to request an extension.`);
};
</script>


<div class="container-fluid px-2 px-md-4">
    <!-- DEBUG: Current section is "{{ section }}" -->
    {% if section == 'home' %}
        <!-- Home Dashboard -->
        <!-- Modern Student Home Header -->
        <div class="student-home-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="student-home-title mb-1">
                        <i class="bi bi-house-heart-fill me-2"></i>Welcome Back, {{ student.first_name }}!
                    </h2>
                    <p class="student-home-subtitle mb-0">
                        <i class="bi bi-calendar3 me-2"></i>Your Learning Dashboard
                    </p>
                </div>
                <div class="student-home-role-badge">
                    <span class="badge badge-student-home"><i class="bi bi-mortarboard-fill me-1"></i>Student</span>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="student-stat-card">
                    <div class="student-stat-icon student-stat-gpa">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="student-stat-content">
                        <h3 class="student-stat-number">{{ "%.2f"|format(gpa) }}</h3>
                        <p class="student-stat-label">Current GPA</p>
                        <span class="badge bg-success">On Track</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="student-stat-card">
                    <div class="student-stat-icon student-stat-classes">
                        <i class="bi bi-house-door-fill"></i>
                    </div>
                    <div class="student-stat-content">
                        <h3 class="student-stat-number">{{ my_classes|length }}</h3>
                        <p class="student-stat-label">Enrolled Classes</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="student-stat-card">
                    <div class="student-stat-icon student-stat-assignments">
                        <i class="bi bi-journal-check"></i>
                    </div>
                    <div class="student-stat-content">
                        <h3 class="student-stat-number">{{ upcoming_assignments|length if upcoming_assignments else 0 }}</h3>
                        <p class="student-stat-label">Upcoming Assignments</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="student-stat-card">
                    <div class="student-stat-icon student-stat-grade">
                        <i class="bi bi-trophy-fill"></i>
                    </div>
                    <div class="student-stat-content">
                        <h3 class="student-stat-number">{{ student.grade_level or 'N/A' }}</h3>
                        <p class="student-stat-label">Grade Level</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 g-md-4">
            <!-- Left Column -->
            <div class="col-12 col-lg-4">
                <!-- Student Profile Card -->
                <div class="student-profile-card mb-4">
                    <div class="student-profile-header">
                        <div class="student-profile-avatar">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div class="student-profile-info">
                            <h4 class="student-profile-name">{{ student.first_name }} {{ student.last_name }}</h4>
                            <p class="student-profile-id">ID: {{ student.state_id or student.student_id or 'N/A' }}</p>
                        </div>
                    </div>
                    <div class="student-profile-details">
                        <div class="student-profile-item">
                            <i class="bi bi-mortarboard me-2"></i>
                            <span>Grade {{ student.grade_level | display_grade }}</span>
                        </div>
                        <div class="student-profile-item">
                            <i class="bi bi-calendar3 me-2"></i>
                            <span>{{ student.dob or 'N/A' }}</span>
                        </div>
                        <div class="student-profile-item">
                            <i class="bi bi-envelope me-2"></i>
                            <span>{{ student.email or 'N/A' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Academic Goals Card -->
                <div class="student-goals-card mb-4">
                    <div class="student-goals-header">
                        <h5 class="mb-0"><i class="bi bi-target me-2"></i>Academic Goals</h5>
                    </div>
                    <div class="student-goals-body">
                        {% if student.enrollments %}
                            {% set active_enrollments = student.enrollments|selectattr('is_active')|list %}
                            {% for enrollment in active_enrollments[:5] %}
                                {% set class = enrollment.class_info %}
                                {% set goal = goals.get(class.id) %}
                                {% set current_grade = grades.get(class.name, 0) %}
                                <div class="mb-3">
                                    <h6>{{ class.name }}</h6>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Current: {{ "%.1f"|format(current_grade) }}%</span>
                                        {% if goal %}
                                            <span>Goal: {{ "%.1f"|format(goal.target_grade) }}%</span>
                                        {% endif %}
                                    </div>
                                    {% if goal %}
                                        <div class="progress mb-2">
                                            {% set progress = (current_grade / goal.target_grade * 100) if goal.target_grade > 0 else 0 %}
                                            <div class="progress-bar {% if progress >= 100 %}bg-success{% elif progress >= 80 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ [progress, 100]|min }}%">
                                                {{ "%.1f"|format(progress) }}%
                                            </div>
                                        </div>
                                                        <form method="POST" action="{{ url_for('student.delete_goal', goal_id=goal.id) }}"
                      style="display: inline;" onsubmit="return confirm('Delete this goal?')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Remove Goal</button>
                                        </form>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('student.set_goal') }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <input type="hidden" name="class_id" value="{{ class.id }}">
                                            <div class="input-group input-group-sm">
                                                <input type="number" name="target_grade" class="form-control" 
                                                       placeholder="Target %" min="0" max="100" step="0.1" required>
                                                <button type="submit" class="btn btn-outline-primary">Set Goal</button>
                                            </div>
                                        </form>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">You are not yet enrolled in any classes.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Links Card -->
                <div class="student-links-card">
                    <div class="student-links-header">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="student-links-body">
                        {% if student.enrollments %}
                            {% set active_enrollments = student.enrollments|selectattr('is_active')|list %}
                            {% for enrollment in active_enrollments[:5] %}
                                {% set class = enrollment.class_info %}
                                <a href="{{ url_for('student.view_class', class_id=class.id) }}" class="student-link-btn">
                                    <i class="bi bi-book me-2"></i>
                                    <span>{{ class.name }}</span>
                                    <i class="bi bi-chevron-right ms-auto"></i>
                                </a>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">You are not yet enrolled in any classes.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-12 col-lg-8">
                <!-- Redo Opportunities Card -->
                {% if redo_opportunities %}
                <div class="student-redo-card mb-4">
                    <div class="student-redo-header">
                        <h5 class="mb-0">
                            <i class="bi bi-arrow-repeat me-2"></i>Redo Opportunities
                            <span class="badge bg-warning text-dark ms-2">{{ redo_opportunities|length }}</span>
                        </h5>
                    </div>
                    <div class="student-redo-body">
                        {% for redo in redo_opportunities %}
                        <div class="student-redo-item">
                            <div class="student-redo-icon">
                                <i class="bi bi-arrow-clockwise"></i>
                            </div>
                            <div class="student-redo-info">
                                <h6 class="student-redo-title">{{ redo.assignment.title }}</h6>
                                <p class="student-redo-class mb-1">{{ redo.assignment.class_info.name if redo.assignment.class_info else 'N/A' }}</p>
                                {% if redo.reason %}
                                <p class="student-redo-reason"><i class="bi bi-info-circle me-1"></i>{{ redo.reason }}</p>
                                {% endif %}
                                {% if redo.original_grade %}
                                <p class="student-redo-original-grade">
                                    <i class="bi bi-graph-down me-1"></i>Original Grade: <strong>{{ redo.original_grade }}%</strong>
                                </p>
                                {% endif %}
                            </div>
                            <div class="student-redo-action">
                                <div class="student-redo-deadline mb-2">
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-calendar-event me-1"></i>Due: {{ redo.redo_deadline.strftime('%m/%d/%Y') }}
                                    </span>
                                </div>
                                <a href="{{ url_for('student.submit_assignment', assignment_id=redo.assignment_id, is_redo=1) }}" 
                                   class="btn btn-sm btn-warning w-100">
                                    <i class="bi bi-upload me-1"></i>Submit Redo
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Upcoming Assignments Card -->
                <div class="student-upcoming-card mb-4">
                    <div class="student-upcoming-header">
                        <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Upcoming Assignments</h5>
                    </div>
                    <div class="student-upcoming-body">
                        {% if upcoming_assignments %}
                            {% for assignment in upcoming_assignments[:5] %}
                            <div class="student-assignment-item">
                                <div class="student-assignment-icon">
                                    <i class="bi bi-journal-text"></i>
                                </div>
                                <div class="student-assignment-info">
                                    <h6 class="student-assignment-title">{{ assignment.title }}</h6>
                                    <p class="student-assignment-class">{{ assignment.class_info.name if assignment.class_info else 'N/A' }}</p>
                                </div>
                                <div class="student-assignment-due">
                                    <span class="badge bg-warning">Due: {{ assignment.due_date.strftime('%m/%d') if assignment.due_date else 'N/A' }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center py-3">No upcoming assignments</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="student-activity-card">
                    <div class="student-activity-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
                    </div>
                    <div class="student-activity-body">
                        <div class="student-activity-timeline">
                            {% if notifications and notifications|length > 0 %}
                                {% for notification in notifications[:5] %}
                                <div class="student-activity-item">
                                    <div class="student-activity-dot"></div>
                                    <div class="student-activity-content">
                                        <h6 class="student-activity-title">{{ notification.title }}</h6>
                                        <p class="student-activity-text">{{ notification.message }}</p>
                                        <small class="student-activity-time">{{ notification.timestamp.strftime('%b %d, %I:%M %p') if notification.timestamp else 'Recently' }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% elif past_due_assignments %}
                                {% for assignment in past_due_assignments[:5] %}
                                <div class="student-activity-item">
                                    <div class="student-activity-dot" style="background: #dc3545;"></div>
                                    <div class="student-activity-content">
                                        <h6 class="student-activity-title">Past Due: {{ assignment.title }}</h6>
                                        <p class="student-activity-text">{{ assignment.class_info.name if assignment.class_info else 'N/A' }}</p>
                                        <small class="student-activity-time">Due: {{ assignment.due_date.strftime('%b %d, %Y') if assignment.due_date else 'N/A' }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center py-3">No recent activity</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'classes' %}
        <!-- Modern Classes View -->
        <div class="student-classes-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="student-classes-title mb-1">
                        <i class="bi bi-house-door-fill me-2"></i>My Classes
                    </h2>
                    <p class="student-classes-subtitle mb-0">
                        <i class="bi bi-calendar3 me-2"></i>View your enrolled classes and access course materials
                    </p>
                </div>
                <div class="badge badge-student-classes">
                    {{ my_classes|length }} {% if my_classes|length == 1 %}Class{% else %}Classes{% endif %}
                </div>
            </div>
        </div>

        <!-- Classes Grid -->
        <div class="row g-3">
            {% for class in my_classes %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="student-class-card">
                        <!-- Card Header -->
                        <div class="student-class-card-header">
                            <div class="student-class-icon">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <span class="student-class-grade-badge">Grade {{ class.grade_level or 'N/A' }}</span>
                        </div>

                        <!-- Card Body -->
                        <div class="student-class-card-body">
                            <h5 class="student-class-card-title">{{ class.name }}</h5>
                            <p class="student-class-card-subject">
                                <i class="bi bi-journals me-1"></i>{{ class.subject or 'General' }}
                            </p>
                            <div class="student-class-card-teacher">
                                <i class="bi bi-person-circle me-1"></i>
                                <span>{{ class.teacher.first_name }} {{ class.teacher.last_name if class.teacher else 'N/A' }}</span>
                            </div>
                            {% if class.room_number %}
                            <div class="student-class-card-room">
                                <i class="bi bi-geo-alt me-1"></i>
                                <span>Room {{ class.room_number }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Card Footer -->
                        <div class="student-class-card-footer">
                            <a href="{{ url_for('student.view_class', class_id=class.id) }}" class="btn btn-sm btn-student-class-primary">
                                <i class="bi bi-box-arrow-up-right me-1"></i>Open
                            </a>
                            <button type="button" class="btn btn-sm btn-student-class-secondary" onclick="openClassAssignmentsModal({{ class.id }}, '{{ class.name }}')">
                                <i class="bi bi-journal-text me-1"></i>Assignments
                            </button>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="student-classes-empty">
                        <i class="bi bi-inbox"></i>
                        <h4>No Classes Enrolled</h4>
                        <p>You are not currently enrolled in any classes. Contact your school administrator for assistance.</p>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Class Assignments View (when show_assignments is True) -->
        {% if show_assignments and class_obj %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="bi bi-journal-text text-info me-2"></i>
                        Assignments for {{ class_obj.name }}
                    </h3>
                    <a href="{{ url_for('student.student_classes') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Classes
                    </a>
                </div>
                
                {% if assignments %}
                    <div class="row g-3">
                        {% for assignment in assignments %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ assignment.title }}</h6>
                                        <p class="card-text small text-muted">
                                            {{ assignment.description or 'No description provided.' }}
                                        </p>
                                        
                                        <div class="mb-2">
                                            <strong>Due:</strong> 
                                            {% if assignment.due_date %}
                                                {{ assignment.due_date.strftime('%B %d, %Y at %I:%M %p') }}
                                                {% set due_date = assignment.due_date.date() if assignment.due_date.date else assignment.due_date %}
                                                {% set days_remaining = (due_date - today).days %}
                                                
                                                <!-- Check if this assignment is completed by looking at the status -->
                                                {% set assignment_status = 'Un-Submitted' %}
                                                {% for assignment_item, submission, status in assignments_with_status %}
                                                    {% if assignment_item.id == assignment.id %}
                                                        {% set assignment_status = status %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                {% if assignment_status == 'completed' %}
                                                    <span class="badge bg-success ms-2">Completed</span>
                                                {% elif days_remaining > 0 %}
                                                    <span class="badge bg-success ms-2">{{ days_remaining }} days remaining</span>
                                                {% elif days_remaining == 0 %}
                                                    <span class="badge bg-warning ms-2">Due today</span>
                                                {% else %}
                                                    <span class="badge bg-danger ms-2">{{ (days_remaining * -1) }} days overdue</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">No due date</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-2">
                                            <strong>Quarter:</strong> Q{{ assignment.quarter }}
                                        </div>
                                        
                                        {% if assignment.attachment_filename %}
                                        <div class="mb-2">
                                            <a href="{{ url_for('student.download_assignment_file', assignment_id=assignment.id) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-download me-1"></i>Download Assignment
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Assignment Status -->
                                        {% set submission = submissions.get(assignment.id) %}
                                        {% set grade = grades.get(assignment.id) %}
                                        {% set is_past_due = assignment.due_date and assignment.due_date.date() < today.date() %}
                                        <div class="mt-2">
                                            {% if grade %}
                                                <!-- Graded by teacher -->
                                                <span class="badge bg-success">Graded: {{ grade.score }}%</span>
                                            {% elif submission and is_past_due %}
                                                <!-- Submitted but past due and not graded -->
                                                <span class="badge bg-warning">Submitted</span>
                                                <span class="badge bg-danger ms-1">Past Due</span>
                                            {% elif submission %}
                                                <!-- Submitted but not graded yet -->
                                                <span class="badge bg-info">Submitted</span>
                                            {% elif is_past_due %}
                                                <!-- Not submitted and past due -->
                                                <span class="badge bg-danger">Past Due</span>
                                            {% else %}
                                                <!-- Not submitted and not past due -->
                                                <span class="badge bg-secondary">Not Submitted</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No assignments have been posted for this class yet.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Teacher Info View (when show_teacher is True) -->
        {% if show_teacher and class_obj %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="bi bi-person text-secondary me-2"></i>
                        Teacher Information for {{ class_obj.name }}
                    </h3>
                    <a href="{{ url_for('student.student_classes') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Classes
                    </a>
                </div>
                
                {% if teacher %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-person-circle me-2"></i>
                                        {{ teacher.first_name }} {{ teacher.last_name }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <strong>Position:</strong> {{ teacher.position or 'Teacher' }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Email:</strong> 
                                            {% if teacher.email %}
                                                <a href="mailto:{{ teacher.email }}" class="text-decoration-none">
                                                    {{ teacher.email }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">Not available</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-12">
                                            <strong>Phone:</strong> 
                                            {% if teacher.phone %}
                                                <a href="tel:{{ teacher.phone }}" class="text-decoration-none">
                                                    {{ teacher.phone }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">Not available</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-12">
                                            <strong>Subject:</strong> {{ class_obj.subject }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Class:</strong> {{ class_obj.name }} - Grade {{ class_obj.grade_level }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Class Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <strong>Class Name:</strong> {{ class_obj.name }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Subject:</strong> {{ class_obj.subject }}
                                        </div>
                                        <div class="col-12">
                                            <strong>Grade Level:</strong> {{ class_obj.grade_level }}
                                        </div>
                                        <div class="col-12">
                                            <strong>School Year:</strong> 
                                            {% if class_obj.school_year %}
                                                {{ class_obj.school_year.name }}
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No teacher has been assigned to this class yet.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Comprehensive Class Details View (when show_class_details is True) -->
        {% if show_class_details and class_obj %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">
                        <i class="bi bi-house-door text-primary me-2"></i>
                        {{ class_obj.name }} - Class Details
                    </h2>
                    <a href="{{ url_for('student.student_classes') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Classes
                    </a>
                </div>

                <!-- Class Overview Cards -->
                <div class="row g-3 mb-4">
                    <!-- Class Info Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-info-circle fs-1 mb-2"></i>
                                <h6 class="card-title">Class Information</h6>
                                <p class="card-text mb-1">{{ class_obj.subject }}</p>
                                <p class="card-text small">Grade {{ class_obj.grade_level }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Teacher Info Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-person-badge fs-1 mb-2"></i>
                                <h6 class="card-title">Teacher</h6>
                                {% if teacher %}
                                    <p class="card-text mb-1">{{ teacher.first_name }} {{ teacher.last_name }}</p>
                                    <p class="card-text small">{{ teacher.position or 'Teacher' }}</p>
                                {% else %}
                                    <p class="card-text mb-1">Not Assigned</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Students Count Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-people fs-1 mb-2"></i>
                                <h6 class="card-title">Students</h6>
                                <p class="card-text mb-1">{{ enrolled_students|length }}</p>
                                <p class="card-text small">Enrolled</p>
                            </div>
                        </div>
                    </div>

                    <!-- Class GPA Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card {% if class_gpa >= 3.5 %}bg-success{% elif class_gpa >= 3.0 %}bg-primary{% elif class_gpa >= 2.0 %}bg-warning{% else %}bg-danger{% endif %} text-white h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-graph-up fs-1 mb-2"></i>
                                <h6 class="card-title">Your GPA</h6>
                                <p class="card-text mb-1">{{ "%.2f"|format(class_gpa) }}</p>
                                <p class="card-text small">In This Class</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Row -->
                <div class="row g-4">
                    <!-- Left Column: Teacher & Class Info -->
                    <div class="col-lg-4">
                        <!-- Teacher Information -->
                        {% if teacher %}
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-person-circle me-2"></i>
                                    Teacher Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <i class="bi bi-person-circle fs-1 text-success"></i>
                                    <h6 class="mt-2">{{ teacher.first_name }} {{ teacher.last_name }}</h6>
                                    <p class="text-muted mb-0">{{ teacher.position or 'Teacher' }}</p>
                                </div>
                                <hr>
                                <div class="row g-2">
                                    <div class="col-12">
                                        <strong>Email:</strong> 
                                        {% if teacher.email %}
                                            <a href="mailto:{{ teacher.email }}" class="text-decoration-none">
                                                {{ teacher.email }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Not available</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        <strong>Phone:</strong> 
                                        {% if teacher.phone %}
                                            <a href="tel:{{ teacher.phone }}" class="text-decoration-none">
                                                {{ teacher.phone }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Not available</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Class Information -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Class Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <strong>Class Name:</strong> {{ class_obj.name }}
                                    </div>
                                    <div class="col-12">
                                        <strong>Subject:</strong> {{ class_obj.subject }}
                                    </div>
                                    <div class="col-12">
                                        <strong>Grade Level:</strong> {{ class_obj.grade_level }}
                                    </div>
                                    <div class="col-12">
                                        <strong>School Year:</strong> 
                                        {% if class_obj.school_year %}
                                            {{ class_obj.school_year.name }}
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enrolled Students -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-people me-2"></i>
                                    Class Roster
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <div class="list-group list-group-flush">
                                        {% for student in enrolled_students %}
                                        <div class="list-group-item d-flex align-items-center">
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <div class="flex-grow-1">
                                                <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                                {% if student.id == current_user.student_id %}
                                                    <span class="badge bg-success ms-2">You</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Assignments & Announcements -->
                    <div class="col-lg-8">
                        <!-- Recent Assignments -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="bi bi-journal-text me-2"></i>
                                    Recent Assignments
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if assignments %}
                                    <div class="row g-3">
                                        {% for assignment in assignments[:6] %}
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light h-100">
                                                <div class="card-body">
                                                    <h6 class="card-title">{{ assignment.title }}</h6>
                                                    <p class="card-text small text-muted">
                                                        {{ assignment.description or 'No description provided.' }}
                                                    </p>
                                                    
                                                    <div class="mb-2">
                                                        <strong>Due:</strong> 
                                                        {% if assignment.due_date %}
                                                            {{ assignment.due_date.strftime('%B %d, %Y') }}
                                                            {% set due_date = assignment.due_date.date() if assignment.due_date.date else assignment.due_date %}
                                                            {% set days_remaining = (due_date - today).days %}
                                                            
                                                            <!-- Check if this assignment is completed by looking at the status -->
                                                            {% set assignment_status = 'Un-Submitted' %}
                                                            {% for assignment_item, submission, status in assignments_with_status %}
                                                                {% if assignment_item.id == assignment.id %}
                                                                    {% set assignment_status = status %}
                                                                {% endif %}
                                                            {% endfor %}
                                                            
                                                            {% if assignment_status == 'completed' %}
                                                                <span class="badge bg-success ms-2">Completed</span>
                                                            {% elif days_remaining > 0 %}
                                                                <span class="badge bg-success ms-2">{{ days_remaining }} days</span>
                                                            {% elif days_remaining == 0 %}
                                                                <span class="badge bg-warning ms-2">Due today</span>
                                                            {% else %}
                                                                <span class="badge bg-danger ms-2">{{ (days_remaining * -1) }} overdue</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">No due date</span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="mb-2">
                                                        <strong>Quarter:</strong> Q{{ assignment.quarter }}
                                                    </div>
                                                    
                                                    <!-- Submission Status -->
                                                    {% set submission = submissions.get(assignment.id) %}
                                                    {% set grade = grades.get(assignment.id) %}
                                                    <div class="mt-2">
                                                        {% if submission %}
                                                            <span class="badge bg-success">Submitted</span>
                                                            {% if grade %}
                                                                <span class="badge bg-info ms-1">{{ grade.score }}%</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="badge bg-warning">Not Submitted</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% if assignments|length > 6 %}
                                    <div class="text-center mt-3">
                                        <a href="{{ url_for('student.view_class_assignments', class_id=class_obj.id) }}" class="btn btn-outline-warning btn-sm">
                                            View All Assignments
                                        </a>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No assignments have been posted for this class yet.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Recent Announcements -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-megaphone me-2"></i>
                                    Recent Announcements
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if announcements %}
                                    <div class="list-group list-group-flush">
                                        {% for announcement in announcements %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ announcement.title }}</h6>
                                                    <p class="mb-1 text-muted">{{ announcement.message }}</p>
                                                    <small class="text-muted">
                                                        {{ announcement.timestamp.strftime('%B %d, %Y at %I:%M %p') }}
                                                    </small>
                                                </div>
                                                <span class="badge bg-secondary">New</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No announcements for this class yet.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    {% elif section == 'grades' %}
        <!-- Grades View -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="bi bi-graph-up-arrow text-primary me-2"></i>
                    My Academic Performance
                </h2>
                
                <!-- Overall GPA Summary Card -->
                <div class="card bg-gradient-primary text-white shadow-lg mb-4 gpa-display">
                    <div class="card-body text-center py-4">
                        <h3 class="card-title mb-2">
                            <i class="bi bi-star-fill me-2"></i>
                            Overall Academic Standing
                        </h3>
                        <div class="display-4 fw-bold mb-2">{{ "%.2f"|format(gpa) }}</div>
                        <p class="card-text fs-5 mb-0">Collective GPA</p>
                        <div class="mt-3">
                            {% if gpa >= 3.5 %}
                                <span class="badge bg-success fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-award me-1"></i>Honor Roll
                                </span>
                            {% elif gpa >= 3.0 %}
                                <span class="badge bg-primary fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-check-circle me-1"></i>Good Standing
                                </span>
                            {% elif gpa >= 2.0 %}
                                <span class="badge bg-warning text-dark fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-exclamation-triangle me-1"></i>Needs Improvement
                                </span>
                            {% else %}
                                <span class="badge bg-danger fs-6 px-3 py-2 academic-status-badge">
                                    <i class="bi bi-x-circle me-1"></i>Academic Warning
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if grades_by_class %}
            <!-- Academic Period Summary -->
            <div class="row g-4 mb-4">
                <!-- Quarters Summary -->
                {% if quarters %}
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-week me-2"></i>
                                Quarter Performance Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for quarter in quarters %}
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <h6 class="text-muted mb-2">{{ quarter.name }}</h6>
                                        {% set quarter_grades = [] %}
                                        {% set quarter_status = 'completed' %}
                                        {% for class_name, data in grades_by_class.items() %}
                                            {% if data.quarter_grades and data.quarter_grades.get(quarter.name) %}
                                                {% set quarter_data = data.quarter_grades[quarter.name] %}
                                                {% if quarter_data.status == 'in_progress' %}
                                                    {% set quarter_status = 'in_progress' %}
                                                {% endif %}
                                                {% if quarter_data.average %}
                                                    {% set _ = quarter_grades.append(quarter_data.average) %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if quarter_status == 'in_progress' %}
                                            <div class="h4 fw-bold text-info">
                                                <i class="bi bi-clock"></i> In Progress
                                            </div>
                                            <div class="small text-muted">Quarter ends {{ quarter.end_date.strftime('%m/%d/%Y') }}</div>
                                        {% elif quarter_grades %}
                                            {% set quarter_avg = (quarter_grades | sum) / (quarter_grades | length) %}
                                            {% set quarter_gpa = calculate_gpa(quarter_grades) %}
                                            <div class="h4 fw-bold 
                                                {% if quarter_avg >= 90 %}text-success
                                                {% elif quarter_avg >= 80 %}text-primary
                                                {% elif quarter_avg >= 70 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ "%.1f"|format(quarter_avg) }}%
                                            </div>
                                            <div class="small text-muted">GPA: {{ "%.2f"|format(quarter_gpa) }}</div>
                                            <div class="small text-muted">{{ quarter_grades | length }} classes</div>
                                        {% else %}
                                            <div class="h4 text-muted">N/A</div>
                                            <div class="small text-muted">No grades</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Semesters Summary -->
                {% if semesters %}
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-month me-2"></i>
                                Semester Performance Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for semester in semesters %}
                                <div class="col-6">
                                    <div class="text-center p-3 border rounded">
                                        <h6 class="text-muted mb-2">{{ semester.name }}</h6>
                                        {% set semester_grades = [] %}
                                        {% set semester_status = 'completed' %}
                                        {% for class_name, data in grades_by_class.items() %}
                                            {% if data.semester_grades and data.semester_grades.get(semester.name) %}
                                                {% set semester_data = data.semester_grades[semester.name] %}
                                                {% if semester_data.status == 'in_progress' %}
                                                    {% set semester_status = 'in_progress' %}
                                                {% endif %}
                                                {% if semester_data.average %}
                                                    {% set _ = semester_grades.append(semester_data.average) %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if semester_status == 'in_progress' %}
                                            <div class="h4 fw-bold text-info">
                                                <i class="bi bi-clock"></i> In Progress
                                            </div>
                                            <div class="small text-muted">Semester ends {{ semester.end_date.strftime('%m/%d/%Y') }}</div>
                                        {% elif semester_grades %}
                                            {% set semester_avg = (semester_grades | sum) / (semester_grades | length) %}
                                            {% set semester_gpa = calculate_gpa(semester_grades) %}
                                            <div class="h4 fw-bold 
                                                {% if semester_avg >= 90 %}text-success
                                                {% elif semester_avg >= 80 %}text-primary
                                                {% elif semester_avg >= 70 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ "%.1f"|format(semester_avg) }}%
                                            </div>
                                            <div class="small text-muted">GPA: {{ "%.2f"|format(semester_gpa) }}</div>
                                            <div class="small text-muted">{{ semester_grades | length }} classes</div>
                                        {% else %}
                                            <div class="h4 text-muted">N/A</div>
                                            <div class="small text-muted">No grades</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="row g-4">
                {% for class_name, data in grades_by_class.items() %}
                <div class="col-12 col-lg-6 col-xl-4">
                    <div class="card h-100 shadow-sm border-0 grade-card performance-indicator">
                        <div class="card-header bg-gradient-{{ 'success' if data.final_grade.percentage >= 90 else 'primary' if data.final_grade.percentage >= 80 else 'warning' if data.final_grade.percentage >= 70 else 'danger' }} text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold" style="color: white !important; text-shadow: 0 1px 4px rgba(0,0,0,0.6) !important; font-weight: 700 !important;">
                                    <i class="bi bi-book me-2"></i>{{ class_name }}
                                </h5>
                                <span class="badge bg-white text-dark fs-6 px-2 py-1">
                                    {{ data.final_grade.letter }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <!-- Class GPA and Overall Grade -->
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="border-end">
                                        <div class="h4 text-primary fw-bold mb-1 gpa-display">{{ "%.2f"|format(data.class_gpa) }}</div>
                                        <small class="text-muted">Class GPA</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="h4 fw-bold mb-1 
                                        {% if data.final_grade.percentage >= 90 %}text-success
                                        {% elif data.final_grade.percentage >= 80 %}text-primary
                                        {% elif data.final_grade.percentage >= 70 %}text-warning
                                        {% else %}text-danger{% endif %}">
                                        {{ data.final_grade.percentage }}%
                                    </div>
                                    <small class="text-muted">Overall Grade</small>
                                </div>
                            </div>
                            
                            <!-- Quarter Grades -->
                            {% if data.quarter_grades %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-calendar-week me-1"></i>
                                    Quarter Grades
                                </h6>
                                <div class="row g-2">
                                    {% for quarter_name, quarter_data in data.quarter_grades.items() %}
                                    <div class="col-6">
                                        <div class="border rounded p-2 text-center">
                                            <div class="small text-muted">{{ quarter_name }}</div>
                                            {% if quarter_data.status == 'in_progress' %}
                                                <div class="fw-bold text-info">
                                                    <i class="bi bi-clock"></i> In Progress
                                                </div>
                                                <div class="small text-muted">Ends {{ quarter_data.end_date.strftime('%m/%d/%Y') }}</div>
                                            {% elif quarter_data.average %}
                                                <div class="fw-bold 
                                                    {% if quarter_data.average >= 90 %}text-success
                                                    {% elif quarter_data.average >= 80 %}text-primary
                                                    {% elif quarter_data.average >= 70 %}text-warning
                                                    {% else %}text-danger{% endif %}">
                                                    {{ quarter_data.average }}%
                                                </div>
                                                <div class="small">{{ quarter_data.letter }}</div>
                                                <div class="small text-muted">{{ quarter_data.assignments }} assignments</div>
                                            {% else %}
                                                <div class="fw-bold text-muted">No Grades</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Semester Grades -->
                            {% if data.semester_grades %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-calendar-month me-1"></i>
                                    Semester Grades
                                </h6>
                                <div class="row g-2">
                                    {% for semester_name, semester_data in data.semester_grades.items() %}
                                    <div class="col-6">
                                        <div class="border rounded p-2 text-center">
                                            <div class="small text-muted">{{ semester_name }}</div>
                                            {% if semester_data.status == 'in_progress' %}
                                                <div class="fw-bold text-info">
                                                    <i class="bi bi-clock"></i> In Progress
                                                </div>
                                                <div class="small text-muted">Ends {{ semester_data.end_date.strftime('%m/%d/%Y') }}</div>
                                            {% elif semester_data.average %}
                                                <div class="fw-bold 
                                                    {% if semester_data.average >= 90 %}text-success
                                                    {% elif semester_data.average >= 80 %}text-primary
                                                    {% elif semester_data.average >= 70 %}text-warning
                                                    {% else %}text-danger{% endif %}">
                                                    {{ semester_data.average }}%
                                                </div>
                                                <div class="small">{{ semester_data.letter }}</div>
                                                <div class="small text-muted">{{ semester_data.assignments }} assignments</div>
                                            {% else %}
                                                <div class="fw-bold text-muted">No Grades</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Recent Assignments -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-clock-history me-1"></i>
                                    Recent Assignments
                                </h6>
                                {% if data.recent_assignments %}
                                    <div class="list-group list-group-flush recent-assignments">
                                        {% for assignment in data.recent_assignments %}
                                        <div class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1 me-3" style="min-width: 0;">
                                                <div class="fw-semibold assignment-name-truncated" title="{{ assignment.title }}">
                                                    {{ assignment.title }}
                                                </div>
                                                <small class="text-muted">{{ assignment.graded_at }}</small>
                                            </div>
                                            <div class="text-end flex-shrink-0">
                                                <div class="badge assignment-grade-badge fs-6
                                                    {% if assignment.score and assignment.score >= 90 %}bg-success
                                                    {% elif assignment.score and assignment.score >= 80 %}bg-primary
                                                    {% elif assignment.score and assignment.score >= 70 %}bg-warning text-dark
                                                    {% else %}bg-danger{% endif %}">
                                                    {{ assignment.score }}%
                                                </div>
                                                <div class="small text-muted">{{ assignment.letter }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center text-muted py-3">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        <small>No recent assignments graded</small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Class Progress</small>
                                    <small class="text-muted">{{ data.final_grade.percentage }}%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar 
                                        {% if data.final_grade.percentage >= 90 %}bg-success
                                        {% elif data.final_grade.percentage >= 80 %}bg-primary
                                        {% elif data.final_grade.percentage >= 70 %}bg-warning
                                        {% else %}bg-danger{% endif %}"
                                         style="width: {{ data.final_grade.percentage }}%">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-light p-0">
                            <button class="btn btn-outline-primary btn-sm w-100 m-0 border-0 rounded-0 btn-view-all-assignments" style="border-bottom-left-radius: 0.375rem !important; border-bottom-right-radius: 0.375rem !important;" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#details-{{ loop.index }}" 
                                    aria-expanded="false">
                                <i class="bi bi-chevron-down me-1" style="transition: transform 0.3s ease;"></i>
                                View All Assignments
                            </button>
                            
                            <!-- Collapsible Assignment Details - INSIDE the card -->
                            <div class="collapse border-top" id="details-{{ loop.index }}">
                                <div class="p-3">
                                    <h6 class="mb-3">
                                        <i class="bi bi-list-ul me-2"></i>
                                        All Assignment Grades
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0 assignment-details-table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Assignment</th>
                                                    <th class="text-center">Grade</th>
                                                    <th class="text-center">Letter</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for assignment_title, assignment_grade in data.grades.Current.grade_details.items() %}
                                                <tr>
                                                    <td class="text-truncate" style="max-width: 200px;" title="{{ assignment_title }}">
                                                        {{ assignment_title }}
                                                    </td>
                                                    <td class="text-center fw-bold">{{ assignment_grade }}</td>
                                                    <td class="text-center">
                                                        {% set score = assignment_grade|replace('%', '')|int %}
                                                        <span class="badge 
                                                            {% if score >= 90 %}bg-success
                                                            {% elif score >= 80 %}bg-primary
                                                            {% elif score >= 70 %}bg-warning text-dark
                                                            {% else %}bg-danger{% endif %}">
                                                            {{ get_letter_grade(score) }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="card border-0 shadow-sm empty-grades-state">
                    <div class="card-body py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mt-3">No Grades Available</h4>
                        <p class="text-muted">You don't have any grades recorded yet. Check back after your teachers have graded your assignments.</p>
                    </div>
                </div>
            </div>
        {% endif %}

    {% elif section == 'assignments' %}
        <!-- Modern Assignments View -->
        <div class="student-assignments-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
                <div>
                    <h2 class="student-assignments-title mb-1">
                        <i class="bi bi-journal-text me-2"></i>My Assignments
                    </h2>
                    <p class="student-assignments-subtitle mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>Track and complete your coursework
                    </p>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    <form method="GET" action="{{ url_for('student.student_assignments') }}" id="assignmentFilterForm" class="row g-3 align-items-end">
                        <div class="col-12 col-md-3">
                            <label for="filterClass" class="form-label small fw-bold">
                                <i class="bi bi-book me-1"></i>Filter by Class
                            </label>
                            <select name="class_id" id="filterClass" class="form-select form-select-sm">
                                <option value="">All Classes</option>
                                {% for class_obj in classes %}
                                <option value="{{ class_obj.id }}" {% if filter_class_id == class_obj.id %}selected{% endif %}>
                                    {{ class_obj.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="filterStatus" class="form-label small fw-bold">
                                <i class="bi bi-funnel me-1"></i>Status
                            </label>
                            <select name="status" id="filterStatus" class="form-select form-select-sm">
                                <option value="">All Statuses</option>
                                <option value="Active" {% if filter_status == 'Active' %}selected{% endif %}>Active</option>
                                <option value="Inactive" {% if filter_status == 'Inactive' %}selected{% endif %}>Inactive</option>
                                <option value="Voided" {% if filter_status == 'Voided' %}selected{% endif %}>Voided</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="filterStartDate" class="form-label small fw-bold">
                                <i class="bi bi-calendar3 me-1"></i>Start Date
                            </label>
                            <input type="date" name="start_date" id="filterStartDate" class="form-control form-control-sm" value="{{ filter_start_date }}">
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="filterEndDate" class="form-label small fw-bold">
                                <i class="bi bi-calendar3 me-1"></i>End Date
                            </label>
                            <input type="date" name="end_date" id="filterEndDate" class="form-control form-control-sm" value="{{ filter_end_date }}">
                        </div>
                        <div class="col-12 col-md-3">
                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="bi bi-search me-1"></i>Apply Filters
                            </button>
                            <a href="{{ url_for('student.student_assignments') }}" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                                <i class="bi bi-x-circle me-1"></i>Clear Filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Active Assignments Section -->
        {% if active_assignments %}
        <div class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <div class="flex-grow-1">
                    <h3 class="mb-0">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>Active Assignments
                    </h3>
                    <small class="text-muted">{{ active_assignments|length }} assignment(s)</small>
                </div>
            </div>
            <div class="border-top border-success border-3 pt-3"></div>
            
            <div class="row g-3 mt-3" id="activeAssignmentsTable">
                {% for assignment, submission, student_status in active_assignments %}
                <div class="col-12 col-md-6 col-lg-4 assignment-card-wrapper" 
                     data-status="{{ student_status }}" 
                     data-type="{{ assignment.assignment_type or 'pdf' }}" 
                     data-due="{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else '9999-12-31' }}"
                     data-title="{{ assignment.title }}"
                     data-class="{{ assignment.class_info.name if assignment.class_info else 'Unknown' }}">
                    <div class="student-assignment-card">
                        <!-- Card Header -->
                        <div class="student-assignment-card-header">
                            <div class="student-assignment-type-icon
                                {% if assignment.assignment_type == 'quiz' %}type-quiz
                                {% elif assignment.assignment_type == 'discussion' %}type-discussion
                                {% else %}type-pdf{% endif %}">
                                {% if assignment.assignment_type == 'quiz' %}
                                    <i class="bi bi-question-circle-fill"></i>
                                {% elif assignment.assignment_type == 'discussion' %}
                                    <i class="bi bi-chat-dots-fill"></i>
                                {% else %}
                                    <i class="bi bi-file-earmark-text-fill"></i>
                                {% endif %}
                            </div>
                            <div class="student-assignment-status-badge">
                                {% set grade_obj = grades.get(assignment.id) %}
                                {% set score = none %}
                                {% if grade_obj and grade_obj.grade_data %}
                                    {% set grade_data_dict = grade_obj.grade_data|from_json %}
                                    {% set score = grade_data_dict.get('score') if grade_data_dict else none %}
                                {% endif %}
                                
                                {# Check if student has an active extension #}
                                {% set has_extension = student_status == 'Extended' %}
                                
                                {% if student_status == 'Voided' %}
                                    <span class="badge bg-secondary">Voided</span>
                                {% elif has_extension and not score %}
                                    {# Show Extension badge if extension granted and not yet graded #}
                                    <span class="badge badge-extension">
                                        <i class="bi bi-clock-history me-1"></i>Extension
                                    </span>
                                {% elif score is not none and score > 0 %}
                                    {# Show letter grade if graded with score > 0 #}
                                    {% if score >= 97 %}
                                        <span class="badge grade-badge grade-a-plus">A+</span>
                                    {% elif score >= 93 %}
                                        <span class="badge grade-badge grade-a">A</span>
                                    {% elif score >= 90 %}
                                        <span class="badge grade-badge grade-a-minus">A-</span>
                                    {% elif score >= 87 %}
                                        <span class="badge grade-badge grade-b-plus">B+</span>
                                    {% elif score >= 83 %}
                                        <span class="badge grade-badge grade-b">B</span>
                                    {% elif score >= 80 %}
                                        <span class="badge grade-badge grade-b-minus">B-</span>
                                    {% elif score >= 77 %}
                                        <span class="badge grade-badge grade-c-plus">C+</span>
                                    {% elif score >= 73 %}
                                        <span class="badge grade-badge grade-c">C</span>
                                    {% elif score >= 70 %}
                                        <span class="badge grade-badge grade-c-minus">C-</span>
                                    {% elif score >= 67 %}
                                        <span class="badge grade-badge grade-d-plus">D+</span>
                                    {% elif score >= 63 %}
                                        <span class="badge grade-badge grade-d">D</span>
                                    {% elif score >= 60 %}
                                        <span class="badge grade-badge grade-d-minus">D-</span>
                                    {% else %}
                                        <span class="badge grade-badge grade-f">F</span>
                                    {% endif %}
                                {% elif score is not none and score == 0 %}
                                    {# Show Overdue if graded with 0 #}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif student_status == 'completed' %}
                                    {# Fallback: No grade data but marked completed #}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif student_status == 'Submitted or Awaiting Grade' %}
                                    <span class="badge bg-info">Awaiting Grade</span>
                                {% elif student_status == 'Past Due' %}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif student_status == 'Extended' %}
                                    <span class="badge bg-warning">Extended</span>
                                {% else %}
                                    <span class="badge bg-primary">Pending</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="student-assignment-card-body">
                            <h5 class="student-assignment-card-title">{{ assignment.title }}</h5>
                            <p class="student-assignment-card-class">
                                <i class="bi bi-book me-1"></i>{{ assignment.class_info.name if assignment.class_info else 'Unknown Class' }}
                            </p>
                            <div class="student-assignment-card-meta">
                                <span class="meta-item">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    Due: {{ assignment.due_date.strftime('%b %d, %Y') if assignment.due_date else 'No due date' }}
                                </span>
                                {% if assignment.quarter %}
                                <span class="meta-item">
                                    <i class="bi bi-calendar-range me-1"></i>Q{{ assignment.quarter }}
                                </span>
                                {% endif %}
                            </div>
                            {% if assignment.attachment_filename %}
                            <div class="student-assignment-attachment">
                                <i class="bi bi-paperclip me-1"></i>
                                <a href="{{ url_for('student.download_assignment_file', assignment_id=assignment.id) }}" class="text-decoration-none">
                                    {{ assignment.attachment_original_filename or assignment.attachment_filename }}
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Card Footer -->
                        <div class="student-assignment-card-footer">
                            <button type="button" class="btn btn-sm btn-student-view" onclick="viewAssignment({{ assignment.id }}, '{{ assignment.title }}', '{{ assignment.description or '' }}', '{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else 'No due date' }}', '{{ assignment.quarter or 'N/A' }}', '{{ assignment.attachment_filename or '' }}', {{ 'true' if submission else 'false' }}, {{ 'true' if grades.get(assignment.id) else 'false' }}, '{{ assignment.assignment_type }}')">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                            {% if assignment.assignment_type == 'quiz' %}
                                <button type="button" class="btn btn-sm btn-student-action" onclick="takeQuiz({{ assignment.id }}, '{{ assignment.title }}')">
                                    <i class="bi bi-play-fill me-1"></i>Take Quiz
                                </button>
                            {% elif assignment.assignment_type == 'discussion' %}
                                <button type="button" class="btn btn-sm btn-student-action" onclick="joinDiscussion({{ assignment.id }}, '{{ assignment.title }}')">
                                    <i class="bi bi-chat-fill me-1"></i>Discuss
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-student-action" onclick="submitAssignmentFromTable({{ assignment.id }}, '{{ assignment.title }}', {{ 'true' if submission else 'false' }})">
                                    <i class="bi bi-upload me-1"></i>Submit
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Inactive Assignments Section -->
        {% if inactive_assignments %}
        <div class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <div class="flex-grow-1">
                    <h3 class="mb-0">
                        <i class="bi bi-pause-circle-fill text-secondary me-2"></i>Inactive Assignments
                    </h3>
                    <small class="text-muted">{{ inactive_assignments|length }} assignment(s)</small>
                </div>
            </div>
            <div class="border-top border-secondary border-3 pt-3"></div>
            
            <div class="row g-3 mt-3" id="inactiveAssignmentsTable">
                {% for assignment, submission, student_status in inactive_assignments %}
                <div class="col-12 col-md-6 col-lg-4 assignment-card-wrapper" 
                     data-status="{{ student_status }}" 
                     data-type="{{ assignment.assignment_type or 'pdf' }}" 
                     data-due="{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else '9999-12-31' }}"
                     data-title="{{ assignment.title }}"
                     data-class="{{ assignment.class_info.name if assignment.class_info else 'Unknown' }}"
                     style="opacity: 0.7;">
                    <div class="student-assignment-card">
                        <!-- Card Header -->
                        <div class="student-assignment-card-header">
                            <div class="student-assignment-type-icon
                                {% if assignment.assignment_type == 'quiz' %}type-quiz
                                {% elif assignment.assignment_type == 'discussion' %}type-discussion
                                {% else %}type-pdf{% endif %}">
                                {% if assignment.assignment_type == 'quiz' %}
                                    <i class="bi bi-question-circle-fill"></i>
                                {% elif assignment.assignment_type == 'discussion' %}
                                    <i class="bi bi-chat-dots-fill"></i>
                                {% else %}
                                    <i class="bi bi-file-earmark-text-fill"></i>
                                {% endif %}
                            </div>
                            <div class="student-assignment-status-badge">
                                {% set grade_obj = grades.get(assignment.id) %}
                                {% set score = none %}
                                {% if grade_obj and grade_obj.grade_data %}
                                    {% set grade_data_dict = grade_obj.grade_data|from_json %}
                                    {% set score = grade_data_dict.get('score') if grade_data_dict else none %}
                                {% endif %}
                                
                                {# Check if student has an active extension #}
                                {% set has_extension = student_status == 'Extended' %}
                                
                                {% if student_status == 'Voided' %}
                                    <span class="badge bg-secondary">Voided</span>
                                {% elif has_extension and not score %}
                                    {# Show Extension badge if extension granted and not yet graded #}
                                    <span class="badge badge-extension">
                                        <i class="bi bi-clock-history me-1"></i>Extension
                                    </span>
                                {% elif score is not none and score > 0 %}
                                    {# Show letter grade if graded with score > 0 #}
                                    {% if score >= 97 %}
                                        <span class="badge grade-badge grade-a-plus">A+</span>
                                    {% elif score >= 93 %}
                                        <span class="badge grade-badge grade-a">A</span>
                                    {% elif score >= 90 %}
                                        <span class="badge grade-badge grade-a-minus">A-</span>
                                    {% elif score >= 87 %}
                                        <span class="badge grade-badge grade-b-plus">B+</span>
                                    {% elif score >= 83 %}
                                        <span class="badge grade-badge grade-b">B</span>
                                    {% elif score >= 80 %}
                                        <span class="badge grade-badge grade-b-minus">B-</span>
                                    {% elif score >= 77 %}
                                        <span class="badge grade-badge grade-c-plus">C+</span>
                                    {% elif score >= 73 %}
                                        <span class="badge grade-badge grade-c">C</span>
                                    {% elif score >= 70 %}
                                        <span class="badge grade-badge grade-c-minus">C-</span>
                                    {% elif score >= 67 %}
                                        <span class="badge grade-badge grade-d-plus">D+</span>
                                    {% elif score >= 63 %}
                                        <span class="badge grade-badge grade-d">D</span>
                                    {% elif score >= 60 %}
                                        <span class="badge grade-badge grade-d-minus">D-</span>
                                    {% else %}
                                        <span class="badge grade-badge grade-f">F</span>
                                    {% endif %}
                                {% elif score is not none and score == 0 %}
                                    {# Show Overdue if graded with 0 #}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif student_status == 'completed' %}
                                    {# Fallback: No grade data but marked completed #}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif student_status == 'Submitted or Awaiting Grade' %}
                                    <span class="badge bg-info">Awaiting Grade</span>
                                {% elif student_status == 'Past Due' %}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif student_status == 'Extended' %}
                                    <span class="badge bg-warning">Extended</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="student-assignment-card-body">
                            <h5 class="student-assignment-card-title">{{ assignment.title }}</h5>
                            <p class="student-assignment-card-class">
                                <i class="bi bi-book me-1"></i>{{ assignment.class_info.name if assignment.class_info else 'Unknown Class' }}
                            </p>
                            <div class="student-assignment-card-meta">
                                <span class="meta-item">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    Due: {{ assignment.due_date.strftime('%b %d, %Y') if assignment.due_date else 'No due date' }}
                                </span>
                                {% if assignment.quarter %}
                                <span class="meta-item">
                                    <i class="bi bi-calendar-range me-1"></i>Q{{ assignment.quarter }}
                                </span>
                                {% endif %}
                            </div>
                            {% if assignment.attachment_filename %}
                            <div class="student-assignment-attachment">
                                <i class="bi bi-paperclip me-1"></i>
                                <a href="{{ url_for('student.download_assignment_file', assignment_id=assignment.id) }}" class="text-decoration-none">
                                    {{ assignment.attachment_original_filename or assignment.attachment_filename }}
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Card Footer -->
                        <div class="student-assignment-card-footer">
                            <button type="button" class="btn btn-sm btn-student-view" onclick="viewAssignment({{ assignment.id }}, '{{ assignment.title }}', '{{ assignment.description or '' }}', '{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else 'No due date' }}', '{{ assignment.quarter or 'N/A' }}', '{{ assignment.attachment_filename or '' }}', {{ 'true' if submission else 'false' }}, {{ 'true' if grades.get(assignment.id) else 'false' }}, '{{ assignment.assignment_type }}')">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                            {% if assignment.assignment_type == 'quiz' %}
                                <button type="button" class="btn btn-sm btn-student-action" disabled style="opacity: 0.5; cursor: not-allowed;" title="Assignment is inactive">
                                    <i class="bi bi-play-fill me-1"></i>Take Quiz
                                </button>
                            {% elif assignment.assignment_type == 'discussion' %}
                                <button type="button" class="btn btn-sm btn-student-action" disabled style="opacity: 0.5; cursor: not-allowed;" title="Assignment is inactive">
                                    <i class="bi bi-chat-fill me-1"></i>Discuss
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-student-action" disabled style="opacity: 0.5; cursor: not-allowed;" title="Assignment is inactive - submission closed">
                                    <i class="bi bi-upload me-1"></i>Submit
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Voided Assignments Section -->
        {% if voided_assignments %}
        <div class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <div class="flex-grow-1">
                    <h3 class="mb-0">
                        <i class="bi bi-x-circle-fill text-dark me-2"></i>Voided Assignments
                    </h3>
                    <small class="text-muted">{{ voided_assignments|length }} assignment(s)</small>
                </div>
            </div>
            <div class="border-top border-dark border-3 pt-3"></div>
            
            <div class="row g-3 mt-3" id="voidedAssignmentsTable">
                {% for assignment, submission, student_status in voided_assignments %}
                <div class="col-12 col-md-6 col-lg-4 assignment-card-wrapper" 
                     data-status="{{ student_status }}" 
                     data-type="{{ assignment.assignment_type or 'pdf' }}" 
                     data-due="{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else '9999-12-31' }}"
                     data-title="{{ assignment.title }}"
                     data-class="{{ assignment.class_info.name if assignment.class_info else 'Unknown' }}"
                     style="opacity: 0.6;">
                    <div class="student-assignment-card">
                        <!-- Card Header -->
                        <div class="student-assignment-card-header">
                            <div class="student-assignment-type-icon
                                {% if assignment.assignment_type == 'quiz' %}type-quiz
                                {% elif assignment.assignment_type == 'discussion' %}type-discussion
                                {% else %}type-pdf{% endif %}">
                                {% if assignment.assignment_type == 'quiz' %}
                                    <i class="bi bi-question-circle-fill"></i>
                                {% elif assignment.assignment_type == 'discussion' %}
                                    <i class="bi bi-chat-dots-fill"></i>
                                {% else %}
                                    <i class="bi bi-file-earmark-text-fill"></i>
                                {% endif %}
                            </div>
                            <div class="student-assignment-status-badge">
                                <span class="badge bg-dark">Voided</span>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="student-assignment-card-body">
                            <h5 class="student-assignment-card-title">{{ assignment.title }}</h5>
                            <p class="student-assignment-card-class">
                                <i class="bi bi-book me-1"></i>{{ assignment.class_info.name if assignment.class_info else 'Unknown Class' }}
                            </p>
                            <div class="student-assignment-card-meta">
                                <span class="meta-item">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    Due: {{ assignment.due_date.strftime('%b %d, %Y') if assignment.due_date else 'No due date' }}
                                </span>
                                {% if assignment.quarter %}
                                <span class="meta-item">
                                    <i class="bi bi-calendar-range me-1"></i>Q{{ assignment.quarter }}
                                </span>
                                {% endif %}
                            </div>
                            {% if assignment.attachment_filename %}
                            <div class="student-assignment-attachment">
                                <i class="bi bi-paperclip me-1"></i>
                                <a href="{{ url_for('student.download_assignment_file', assignment_id=assignment.id) }}" class="text-decoration-none">
                                    {{ assignment.attachment_original_filename or assignment.attachment_filename }}
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Card Footer -->
                        <div class="student-assignment-card-footer">
                            <button type="button" class="btn btn-sm btn-student-view" onclick="viewAssignment({{ assignment.id }}, '{{ assignment.title }}', '{{ assignment.description or '' }}', '{{ assignment.due_date.strftime('%Y-%m-%d') if assignment.due_date else 'No due date' }}', '{{ assignment.quarter or 'N/A' }}', '{{ assignment.attachment_filename or '' }}', {{ 'true' if submission else 'false' }}, {{ 'true' if grades.get(assignment.id) else 'false' }}, '{{ assignment.assignment_type }}')">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                            {% if assignment.assignment_type == 'quiz' %}
                                <button type="button" class="btn btn-sm btn-student-action" disabled style="opacity: 0.5; cursor: not-allowed;" title="Assignment is voided">
                                    <i class="bi bi-play-fill me-1"></i>Take Quiz
                                </button>
                            {% elif assignment.assignment_type == 'discussion' %}
                                <button type="button" class="btn btn-sm btn-student-action" disabled style="opacity: 0.5; cursor: not-allowed;" title="Assignment is voided">
                                    <i class="bi bi-chat-fill me-1"></i>Discuss
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-student-action" disabled style="opacity: 0.5; cursor: not-allowed;" title="Assignment is voided - submission closed">
                                    <i class="bi bi-upload me-1"></i>Submit
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Empty State -->
        {% if not active_assignments and not inactive_assignments and not voided_assignments %}
        <div class="row g-3">
            <div class="col-12">
                <div class="student-assignments-empty">
                    <i class="bi bi-inbox"></i>
                    <h4>No Assignments Found</h4>
                    <p>No assignments match your current filters. Try adjusting your search criteria.</p>
                    <a href="{{ url_for('student.student_assignments') }}" class="btn btn-primary mt-2">
                        <i class="bi bi-arrow-clockwise me-1"></i>Clear Filters
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Assignment Modal Functions (moved outside conditional for global access) -->
        <script>
        // Assignment Submission Modal Functions
        function openSubmissionModal(assignmentId, assignmentTitle, isResubmit) {
            const modalElement = document.getElementById('submissionModal');
            
            // Set assignment data
            document.getElementById('submissionAssignmentId').value = assignmentId;
            document.getElementById('submissionAssignmentTitle').textContent = assignmentTitle;
            document.getElementById('submissionModalLabel').textContent = isResubmit ? 'Resubmit Assignment' : 'Submit Assignment';
            document.getElementById('submissionSubmitBtn').textContent = isResubmit ? 'Resubmit' : 'Submit';
            
            // Show modal using Bootstrap 5
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                // Simple fallback
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');
            }
        }





        </script>

    {% elif section == 'schedule' %}
        <!-- Schedule View -->
        <h2 class="mb-4">My Schedule</h2>
        
        <div class="alert alert-info">
            <h5><i class="bi bi-calendar-week-fill me-2"></i>Class Schedule</h5>
            <p>Your class schedule will be displayed here. This feature is currently under development.</p>
        </div>

    {% elif section == 'school-calendar' %}
        <!-- School Calendar View -->
        <h2 class="mb-4">School Calendar</h2>
        
        {% if calendar_data %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ calendar_data.month_name }} {{ calendar_data.year }}</h5>
                        <div>
                            <a href="?month={{ prev_month.month }}&year={{ prev_month.year }}" class="btn btn-sm btn-outline-light me-2">
                                <i class="bi bi-chevron-left"></i> Previous
                            </a>
                            <a href="?month={{ next_month.month }}&year={{ next_month.year }}" class="btn btn-sm btn-outline-light">
                                Next <i class="bi bi-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            {% for day in calendar_data.weekdays %}
                                <div class="calendar-day-header">{{ day }}</div>
                            {% endfor %}
                        </div>
                        <div class="calendar-body">
                            {% for week in calendar_data.weeks %}
                                <div class="calendar-week">
                                    {% for day in week %}
                                        <div class="calendar-day {% if day.is_today %}today{% endif %} {% if not day.is_current_month %}other-month{% endif %}">
                                            {% if day.day_num %}
                                                <div class="day-number">{{ day.day_num }}</div>
                                                {% if day.events %}
                                                    <div class="day-events">
                                                        {% for event in day.events %}
                                                            <div class="event-item holiday">
                                                                <small>{{ event.title }}</small>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Calendar Unavailable</h5>
                <p>The school calendar is currently unavailable. Please check back later.</p>
            </div>
        {% endif %}

    {% elif section == 'communications' %}
        <!-- Discord-like Communications Hub for Students -->
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>Student Chat Center</h2>
                    <div class="chat-actions">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="openNewMessageModal()">
                            <i class="bi bi-plus-circle me-1"></i>New Message
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="openCreateGroupModal()">
                            <i class="bi bi-people-plus me-1"></i>Create Group
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-layout">
                <!-- Left Sidebar - Chat List -->
                <div class="chat-sidebar">
                    <div class="sidebar-header">
                        <h6 class="mb-0"><i class="bi bi-hash me-2"></i>Chats & Groups</h6>
                    </div>
                    
                    <!-- Direct Messages -->
                    <div class="sidebar-section">
                        <div class="section-header" onclick="toggleSection('direct-messages')">
                            <i class="bi bi-person-lines-fill me-2"></i>Direct Messages
                            <i class="bi bi-chevron-down ms-auto" id="dm-chevron"></i>
                        </div>
                        <div class="section-content" id="direct-messages">
                            {% if messages %}
                                {% for message in messages[:10] %}
                                    <div class="chat-item" onclick="openChat('{{ message.sender.username }}', 'direct')">
                                        <div class="chat-avatar">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-name">{{ message.sender.username }}</div>
                                            <div class="chat-preview">{{ message.content[:30] }}{% if message.content|length > 30 %}...{% endif %}</div>
                                        </div>
                                        <div class="chat-meta">
                                            <small class="text-muted">{{ message.created_at.strftime('%H:%M') if message.created_at else 'N/A' }}</small>
                                            {% if not message.is_read %}
                                                <span class="unread-indicator"></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-chats">
                                    <i class="bi bi-chat-dots text-muted"></i>
                                    <small class="text-muted">No messages yet</small>
                                </div>
                            {% endif %}
                            
                            <!-- Quick Start New Chat -->
                            <div class="chat-item new-chat-item" onclick="openNewMessageModal()">
                                <div class="chat-avatar new-chat-avatar">
                                    <i class="bi bi-plus"></i>
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name text-info">Start New Chat</div>
                                    <div class="chat-preview">Click to message someone</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Groups -->
                    <div class="sidebar-section">
                        <div class="section-header" onclick="toggleSection('groups')">
                            <i class="bi bi-people-fill me-2"></i>Groups
                            <i class="bi bi-chevron-down ms-auto" id="groups-chevron"></i>
                        </div>
                        <div class="section-content" id="groups">
                            {% if groups %}
                                {% for group in groups[:5] %}
                                    <div class="chat-item" onclick="openChat('{{ group.name }}', 'group')">
                                        <div class="chat-avatar group-avatar">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-name">{{ group.name }}</div>
                                            <div class="chat-preview">{{ group.members|length }} members</div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-chats">
                                    <i class="bi bi-people text-muted"></i>
                                    <small class="text-muted">No groups yet</small>
                                </div>
                            {% endif %}
                            
                            <!-- Create New Group -->
                            <div class="chat-item new-chat-item" onclick="openCreateGroupModal()">
                                <div class="chat-avatar new-chat-avatar">
                                    <i class="bi bi-plus"></i>
                                </div>
                                <div class="chat-info">
                                    <div class="chat-name text-info">Create Group</div>
                                    <div class="chat-preview">Start a new study group</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Announcements -->
                    <div class="sidebar-section">
                        <div class="section-header" onclick="toggleSection('announcements')">
                            <i class="bi bi-megaphone-fill me-2"></i>Announcements
                            <i class="bi bi-chevron-down ms-auto" id="announcements-chevron"></i>
                        </div>
                        <div class="section-content" id="announcements">
                            {% if announcements %}
                                {% for announcement in announcements[:5] %}
                                    <div class="chat-item announcement-item" onclick="openAnnouncement('{{ announcement.id }}')">
                                        <div class="chat-avatar announcement-avatar">
                                            <i class="bi bi-megaphone"></i>
                                        </div>
                                        <div class="chat-info">
                                            <div class="chat-name">{{ announcement.title }}</div>
                                            <div class="chat-preview">{{ announcement.message[:30] }}{% if announcement.message|length > 30 %}...{% endif %}</div>
                                        </div>
                                        {% if announcement.is_important %}
                                            <span class="badge bg-warning badge-sm">!</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-chats">
                                    <i class="bi bi-megaphone text-muted"></i>
                                    <small class="text-muted">No announcements</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="chat-main">
                    <div class="chat-welcome" id="chat-welcome">
                        <div class="welcome-content">
                            <i class="bi bi-chat-dots display-1 text-muted"></i>
                            <h3 class="mt-3">Welcome to Student Chat!</h3>
                            <p class="text-muted">Select a chat from the sidebar to start messaging</p>
                            <div class="welcome-actions">
                                <button class="btn btn-primary me-2" onclick="openNewMessageModal()">
                                    <i class="bi bi-plus-circle me-1"></i>Start New Chat
                                </button>
                                <button class="btn btn-outline-info" onclick="openCreateGroupModal()">
                                    <i class="bi bi-people-plus me-1"></i>Create Study Group
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Active Chat (Hidden by default) -->
                    <div class="active-chat" id="active-chat" style="display: none;">
                        <div class="chat-header-bar">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-link btn-sm me-2" onclick="closeActiveChat()">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                                <div class="chat-avatar me-2">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div>
                                    <div class="chat-name" id="active-chat-name">Chat Name</div>
                                    <div class="chat-status" id="active-chat-status">Online</div>
                                </div>
                            </div>
                        </div>

                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will be loaded here -->
                        </div>

                        <div class="chat-input-area">
                            <div class="typing-indicator" id="typing-indicator" style="display: none;">
                                <small class="text-muted"><i class="bi bi-three-dots"></i> Someone is typing...</small>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="message-input" placeholder="Type your message..." oninput="handleTyping()">
                                <button class="btn btn-primary" onclick="sendMessage()" id="send-button">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Message Modal -->
        <div class="modal fade" id="newMessageModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">New Message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="recipient" class="form-label">To:</label>
                            <select class="form-select" id="recipient">
                                <option value="">Select recipient...</option>
                                <!-- Recipients will be populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="message-content" class="form-label">Message:</label>
                            <textarea class="form-control" id="message-content" rows="4" placeholder="Type your message..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="sendNewMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Group Modal -->
        <div class="modal fade" id="createGroupModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Group</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="group-name" class="form-label">Group Name:</label>
                            <input type="text" class="form-control" id="group-name" placeholder="Enter group name...">
                        </div>
                        <div class="mb-3">
                            <label for="group-description" class="form-label">Description:</label>
                            <textarea class="form-control" id="group-description" rows="3" placeholder="Enter group description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="group-members" class="form-label">Add Members:</label>
                            <select class="form-select" id="group-members" multiple>
                                <!-- Members will be populated -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'messages' %}
        <!-- Messages List View -->
        <h2 class="mb-4">All Messages</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Messages</h5>
                    <a href="{{ url_for('student.student_send_message') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Send Message
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if messages %}
                    <div class="list-group list-group-flush">
                        {% for message in messages %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ message.subject or 'No Subject' }}</h6>
                                        <small class="text-muted">From: {{ message.sender.username }}</small>
                                        <p class="mb-1 text-truncate">{{ message.content[:150] }}{% if message.content|length > 150 %}...{% endif %}</p>
                                        <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="ms-2">
                                        {% if not message.is_read %}
                                            <span class="badge bg-danger">New</span>
                                        {% endif %}
                                        <a href="{{ url_for('student.student_view_message', message_id=message.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-envelope text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">No messages to display.</p>
                        <a href="{{ url_for('student.student_send_message') }}" class="btn btn-primary">
                            <i class="bi bi-envelope-plus me-2"></i>Send Your First Message
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

    {% elif section == 'view_message' %}
        <!-- View Specific Message -->
        <h2 class="mb-4">View Message</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Message Details</h5>
            </div>
            <div class="card-body">
                {% if message %}
                    <div class="mb-3">
                        <h5>{{ message.subject or 'No Subject' }}</h5>
                        <div class="text-muted mb-2">
                            <strong>From:</strong> {{ message.sender.username }}<br>
                            <strong>Date:</strong> {{ message.created_at.strftime('%Y-%m-%d %H:%M') }}<br>
                            {% if message.is_read %}
                                <strong>Read:</strong> {{ message.read_at.strftime('%Y-%m-%d %H:%M') if message.read_at else 'Unknown' }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Message Content:</h6>
                        <div class="border rounded p-3 bg-light">
                            {{ message.content|nl2br }}
                        </div>
                    </div>
                    {% if message.attachments %}
                        <div class="mb-3">
                            <h6>Attachments:</h6>
                            <ul class="list-group">
                                {% for attachment in message.attachments %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ attachment.original_filename }}</span>
                                        <small class="text-muted">{{ attachment.file_size }} bytes</small>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    <div class="mt-3">
                                                        <a href="{{ url_for('student.student_messages') }}" class="btn btn-outline-secondary">Back to Messages</a>
                    </div>
                {% else %}
                    <p class="text-muted">Message not found.</p>
                {% endif %}
            </div>
        </div>

    {% elif section == 'groups' %}
        <!-- Groups List View -->
        <h2 class="mb-4">Message Groups</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Your Groups</h5>
                                                <a href="{{ url_for('student.student_create_group') }}" class="btn btn-light btn-sm">
                                <i class="bi bi-plus-circle me-1"></i>Create Group
                            </a>
                </div>
            </div>
            <div class="card-body">
                {% if groups %}
                    <div class="row">
                        {% for group in groups %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ group.name }}</h6>
                                        <p class="card-text text-muted">{{ group.description or 'No description' }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Type: {{ group.group_type }}</small>
                                            <a href="{{ url_for('student.student_view_group', group_id=group.id) }}" class="btn btn-sm btn-outline-info">View</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-people-fill text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">You are not a member of any message groups.</p>
                        <a href="{{ url_for('student.student_create_group') }}" class="btn btn-info">
                            <i class="bi bi-plus-circle me-2"></i>Create Your First Group
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

    {% elif section == 'view_group' %}
        <!-- View Specific Group -->
        <h2 class="mb-4">Group: {{ group.name }}</h2>

        <div class="row">
            <!-- Group Information and Messages -->
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Group Messages</h5>
                    </div>
                    <div class="card-body">
                        {% if group %}
                            <div class="mb-3">
                                <h6>Group Information:</h6>
                                <p><strong>Name:</strong> {{ group.name }}</p>
                                <p><strong>Description:</strong> {{ group.description or 'No description' }}</p>
                                <p><strong>Type:</strong> {{ group.group_type }}</p>
                            </div>
                            
                            {% if messages %}
                                <h6>Messages:</h6>
                                <div class="list-group">
                                    {% for message in messages %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ message.subject or 'No Subject' }}</h6>
                                                    <small class="text-muted">From: {{ message.sender.username }}</small>
                                                    <p class="mb-1">{{ message.content[:200] }}{% if message.content|length > 200 %}...{% endif %}</p>
                                                    <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No messages in this group.</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">Group not found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Send Message to Group -->
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Send Message</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('student.student_send_group_message', group_id=group.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject (Optional)</label>
                                <input type="text" class="form-control" id="subject" name="subject" placeholder="Message subject">
                            </div>
                            
                            <div class="mb-3">
                                <label for="content" class="form-label">Message</label>
                                <textarea class="form-control" id="content" name="content" rows="4" placeholder="Type your message..." required></textarea>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Send to Group</button>
                            </div>
                        </form>
                        
                        <hr>
                        
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('student.student_groups') }}" class="btn btn-outline-secondary">Back to Groups</a>
                            {% if group and group.created_by != current_user.id %}
                                <form method="POST" action="{{ url_for('student.student_leave_group', group_id=group.id) }}" 
                                      onsubmit="return confirm('Are you sure you want to leave this group?')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-outline-danger">Leave Group</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif section == 'announcements' %}
        <!-- Announcements List View -->
        <h2 class="mb-4">Announcements</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-megaphone-fill me-2"></i>All Announcements</h5>
            </div>
            <div class="card-body">
                {% if announcements %}
                    <div class="list-group list-group-flush">
                        {% for announcement in announcements %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ announcement.title }}</h6>
                                        <small class="text-muted">From: {{ announcement.sender.username }}</small>
                                        <p class="mb-1">{{ announcement.message }}</p>
                                        <small class="text-muted">{{ announcement.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="ms-2">
                                        {% if announcement.is_important %}
                                            <span class="badge bg-warning">Important</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No announcements to display.</p>
                {% endif %}
            </div>
        </div>

    {% elif section == 'send_message' %}
        <!-- Send Message View -->
        <h2 class="mb-4">Send Message</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Compose New Message</h5>
            </div>
            <div class="card-body">
                                        <form method="POST" action="{{ url_for('student.student_send_message') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="recipient_id" class="form-label">Recipient</label>
                        <select class="form-select" id="recipient_id" name="recipient_id" required>
                            <option value="">Choose a recipient...</option>
                            
                            <!-- Students Section -->
                            <optgroup label="Students">
                                {% for student in students %}
                                    {% if student.user %}
                                        <option value="{{ student.user.id }}">{{ student.first_name }} {{ student.last_name }} (Student)</option>
                                    {% endif %}
                                {% endfor %}
                            </optgroup>
                            
                            <!-- Teachers Section -->
                            <optgroup label="Teachers & Staff">
                                {% for teacher in teachers %}
                                    {% if teacher.user %}
                                        <option value="{{ teacher.user.id }}">{{ teacher.first_name }} {{ teacher.last_name }} ({{ teacher.user.role if teacher.user else 'No Role' }})</option>
                                    {% endif %}
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject (Optional)</label>
                        <input type="text" class="form-control" id="subject" name="subject" placeholder="Message subject">
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">Message Content</label>
                        <textarea class="form-control" id="content" name="content" rows="6" placeholder="Type your message here..." required></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                                                    <a href="{{ url_for('student.student_messages') }}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Send Message</button>
                    </div>
                </form>
            </div>
        </div>

    {% elif section == 'create_group' %}
        <!-- Create Group View -->
        <h2 class="mb-4">Create New Group</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Create Message Group</h5>
            </div>
            <div class="card-body">
                                        <form method="POST" action="{{ url_for('student.student_create_group') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="name" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="Enter group name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe the group's purpose"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="group_type" class="form-label">Group Type</label>
                        <select class="form-select" id="group_type" name="group_type">
                            <option value="student">Student Group</option>
                            <option value="study">Study Group</option>
                            <option value="social">Social Group</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Add Members</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            {% for student in students %}
                                {% if student.user and student.user.id != current_user.id %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="members" value="{{ student.user.id }}" id="member_{{ student.user.id }}">
                                        <label class="form-check-label" for="member_{{ student.user.id }}">
                                            {{ student.first_name }} {{ student.last_name }}
                                        </label>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <small class="text-muted">Select the students you want to add to this group.</small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                                                    <a href="{{ url_for('student.student_groups') }}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-info">Create Group</button>
                    </div>
                </form>
            </div>
        </div>

    {% elif section == 'sent_messages' %}
        <!-- Sent Messages View -->
        <h2 class="mb-4">Sent Messages</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-fill me-2"></i>Messages You've Sent</h5>
            </div>
            <div class="card-body">
                {% if sent_messages %}
                    <div class="list-group list-group-flush">
                        {% for message in sent_messages %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ message.subject or 'No Subject' }}</h6>
                                        <small class="text-muted">
                                            To: 
                                            {% if message.recipient %}
                                                {{ message.recipient.username }}
                                            {% elif message.group %}
                                                {{ message.group.name }} (Group)
                                            {% else %}
                                                Unknown
                                            {% endif %}
                                        </small>
                                        <p class="mb-1 text-truncate">{{ message.content[:150] }}{% if message.content|length > 150 %}...{% endif %}</p>
                                        <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="ms-2">
                                        {% if message.message_type == 'group' %}
                                            <span class="badge bg-info">Group</span>
                                        {% else %}
                                            <span class="badge bg-primary">Direct</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">You haven't sent any messages yet.</p>
                {% endif %}
            </div>
        </div>

    {% elif section == 'settings' %}
        <!-- Enhanced Settings Section -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/students_settings.css') }}">
        
        <div class="container-fluid py-4 student-settings-container">
            <!-- Animated Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="header-card-settings animated-fade-in">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="header-icon-wrapper-settings me-3">
                                    <i class="bi bi-gear-fill"></i>
                                </div>
                                <div>
                                    <h2 class="mb-1 fw-bold text-white">Settings</h2>
                                    <p class="text-white mb-0 opacity-90">
                                        <i class="bi bi-person me-2"></i>{{ student.first_name }} {{ student.last_name }} - Grade {{ student.grade_level or 'N/A' }}
                                    </p>
                                </div>
                            </div>
                            <button class="btn-back-settings" onclick="window.history.back()">
                                <i class="bi bi-arrow-left me-2"></i>Back
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Account Information -->
                <div class="col-lg-6">
                    <div class="settings-card animated-fade-in" style="animation-delay: 0.1s;">
                        <div class="settings-card-header">
                            <div class="card-icon-settings bg-primary">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div>
                                <h5 class="card-title-settings">Account Information</h5>
                                <p class="card-subtitle-settings">Your student account details</p>
                            </div>
                        </div>
                        <div class="settings-card-body">
                            <div class="form-group-modern">
                                <label for="username" class="label-modern">
                                    <i class="bi bi-person me-2"></i>Username
                                </label>
                                <input type="text" class="input-modern" id="username" value="{{ current_user.username }}" readonly>
                                <small class="text-muted">Username cannot be changed</small>
                            </div>
                            
                            <div class="form-group-modern">
                                <label for="student_id" class="label-modern">
                                    <i class="bi bi-id-card me-2"></i>Student ID
                                </label>
                                <input type="text" class="input-modern" id="student_id" value="{{ student.state_id or 'N/A' }}" readonly>
                            </div>
                            
                            <div class="form-group-modern">
                                <label for="full_name" class="label-modern">
                                    <i class="bi bi-person-badge me-2"></i>Full Name
                                </label>
                                <input type="text" class="input-modern" id="full_name" value="{{ student.first_name }} {{ student.last_name }}" readonly>
                            </div>
                            
                            <div class="form-group-modern">
                                <label for="grade_level" class="label-modern">
                                    <i class="bi bi-mortarboard me-2"></i>Grade Level
                                </label>
                                <input type="text" class="input-modern" id="grade_level" value="{{ student.grade_level or 'N/A' }}" readonly>
                            </div>
                            
                            <div class="form-group-modern">
                                <label class="label-modern">
                                    <i class="bi bi-shield-lock me-2"></i>Password Security
                                </label>
                                <a href="{{ url_for('auth.change_password') }}" class="btn-action-settings btn-warning-gradient">
                                    <i class="bi bi-lock-fill me-2"></i>Change Password
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="col-lg-6">
                    <div class="settings-card animated-fade-in" style="animation-delay: 0.2s;">
                        <div class="settings-card-header">
                            <div class="card-icon-settings bg-success">
                                <i class="bi bi-sliders"></i>
                            </div>
                            <div>
                                <h5 class="card-title-settings">Preferences</h5>
                                <p class="card-subtitle-settings">Customize your experience</p>
                            </div>
                        </div>
                        <div class="settings-card-body">
                            <div class="preference-section">
                                <label class="label-modern">
                                    <i class="bi bi-bell me-2"></i>Notification Preferences
                                </label>
                                <div class="toggle-list">
                                    <div class="toggle-item">
                                        <div class="toggle-info">
                                            <span class="toggle-title">Assignment Reminders</span>
                                            <small class="toggle-desc">Get notified about upcoming assignments</small>
                                        </div>
                                        <label class="switch-modern">
                                            <input type="checkbox" id="notifAssignments" checked>
                                            <span class="slider-modern"></span>
                                        </label>
                                    </div>
                                    <div class="toggle-item">
                                        <div class="toggle-info">
                                            <span class="toggle-title">Grade Updates</span>
                                            <small class="toggle-desc">Notifications when grades are posted</small>
                                        </div>
                                        <label class="switch-modern">
                                            <input type="checkbox" id="notifGrades" checked>
                                            <span class="slider-modern"></span>
                                        </label>
                                    </div>
                                    <div class="toggle-item">
                                        <div class="toggle-info">
                                            <span class="toggle-title">Class Announcements</span>
                                            <small class="toggle-desc">Important announcements from teachers</small>
                                        </div>
                                        <label class="switch-modern">
                                            <input type="checkbox" id="notifAnnouncements" checked>
                                            <span class="slider-modern"></span>
                                        </label>
                                    </div>
                                    <div class="toggle-item">
                                        <div class="toggle-info">
                                            <span class="toggle-title">Due Date Reminders</span>
                                            <small class="toggle-desc">Daily reminders for upcoming due dates</small>
                                        </div>
                                        <label class="switch-modern">
                                            <input type="checkbox" id="notifDueDates">
                                            <span class="slider-modern"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="preference-section">
                                <label for="theme_preference" class="label-modern">
                                    <i class="bi bi-palette me-2"></i>Theme
                                </label>
                                <select class="select-modern" id="theme_preference">
                                    <option value="light">Light Theme</option>
                                    <option value="dark">Dark Theme</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                            
                            <div class="preference-section">
                                <label for="language" class="label-modern">
                                    <i class="bi bi-translate me-2"></i>Language
                                </label>
                                <select class="select-modern" id="language">
                                    <option value="en">English</option>
                                    <option value="es">Español</option>
                                    <option value="fr">Français</option>
                                </select>
                            </div>
                            
                            <button type="button" class="btn-save-settings" onclick="saveStudentPreferences()">
                                <i class="bi bi-check-circle me-2"></i>Save Preferences
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data & Privacy -->
                <div class="col-lg-6">
                    <div class="settings-card animated-fade-in" style="animation-delay: 0.3s;">
                        <div class="settings-card-header">
                            <div class="card-icon-settings bg-info">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div>
                                <h5 class="card-title-settings">Data & Privacy</h5>
                                <p class="card-subtitle-settings">Manage your data and privacy</p>
                            </div>
                        </div>
                        <div class="settings-card-body">
                            <div class="data-actions">
                                <button class="data-action-card" onclick="exportStudentData()">
                                    <div class="action-icon bg-primary">
                                        <i class="bi bi-download"></i>
                                    </div>
                                    <div class="action-content">
                                        <div class="action-title">Export My Data</div>
                                        <div class="action-desc">Download all your assignments, grades, and submissions</div>
                                    </div>
                                    <i class="bi bi-chevron-right action-arrow"></i>
                                </button>
                                
                                <button class="data-action-card" onclick="viewActivityLog()">
                                    <div class="action-icon bg-warning">
                                        <i class="bi bi-clock-history"></i>
                                    </div>
                                    <div class="action-content">
                                        <div class="action-title">Activity Log</div>
                                        <div class="action-desc">View your account activity history</div>
                                    </div>
                                    <i class="bi bi-chevron-right action-arrow"></i>
                                </button>
                                
                                <button class="data-action-card" onclick="viewPrivacySettings()">
                                    <div class="action-icon bg-danger">
                                        <i class="bi bi-eye-slash"></i>
                                    </div>
                                    <div class="action-content">
                                        <div class="action-title">Privacy Settings</div>
                                        <div class="action-desc">Control who sees your information</div>
                                    </div>
                                    <i class="bi bi-chevron-right action-arrow"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Academic Information -->
                <div class="col-lg-6">
                    <div class="settings-card animated-fade-in" style="animation-delay: 0.4s;">
                        <div class="settings-card-header">
                            <div class="card-icon-settings bg-purple">
                                <i class="bi bi-book"></i>
                            </div>
                            <div>
                                <h5 class="card-title-settings">Academic Information</h5>
                                <p class="card-subtitle-settings">Your academic profile</p>
                            </div>
                        </div>
                        <div class="settings-card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-calendar3 me-2"></i>Current School Year
                                    </div>
                                    <div class="info-value">
                                        {% if school_year %}
                                            {{ school_year.name }}
                                        {% else %}
                                            Not Available
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-people me-2"></i>Enrolled Classes
                                    </div>
                                    <div class="info-value">
                                        {% if enrollments %}
                                            {{ enrollments|length }} Class{{ 'es' if enrollments|length != 1 else '' }}
                                        {% else %}
                                            No Classes
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-graph-up me-2"></i>Overall GPA
                                    </div>
                                    <div class="info-value">
                                        {% if gpa %}
                                            {{ "%.2f"|format(gpa) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-label">
                                        <i class="bi bi-check-circle me-2"></i>Account Status
                                    </div>
                                    <div class="info-value">
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="col-12">
                    <div class="settings-card animated-fade-in" style="animation-delay: 0.5s;">
                        <div class="settings-card-header">
                            <div class="card-icon-settings bg-secondary">
                                <i class="bi bi-info-circle"></i>
                            </div>
                            <div>
                                <h5 class="card-title-settings">System Information</h5>
                                <p class="card-subtitle-settings">Account and system details</p>
                            </div>
                        </div>
                        <div class="settings-card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="system-info-item">
                                        <div class="system-info-label">
                                            <i class="bi bi-clock-history me-2"></i>Last Login
                                        </div>
                                        <div class="system-info-value" id="lastLogin">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="system-info-item">
                                        <div class="system-info-label">
                                            <i class="bi bi-calendar-plus me-2"></i>Account Created
                                        </div>
                                        <div class="system-info-value" id="accountCreated">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="system-info-item">
                                        <div class="system-info-label">
                                            <i class="bi bi-code-slash me-2"></i>Version
                                        </div>
                                        <div class="system-info-value">1.0.0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Student Settings Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load last login and account created dates
            // This would typically come from the backend
            const now = new Date();
            document.getElementById('lastLogin').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('accountCreated').textContent = '{{ current_user.created_at.strftime("%B %d, %Y") if current_user.created_at else "N/A" }}';
            
            // Theme preference handler
            const themeSelect = document.getElementById('theme_preference');
            if (themeSelect) {
                const savedTheme = localStorage.getItem('studentTheme') || 'light';
                themeSelect.value = savedTheme;
                
                themeSelect.addEventListener('change', function() {
                    localStorage.setItem('studentTheme', this.value);
                    applyTheme(this.value);
                });
            }
            
            // Apply saved theme
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }
            
            applyTheme(localStorage.getItem('studentTheme') || 'light');
        });
        
        function saveStudentPreferences() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
            btn.disabled = true;
            
            // Collect preferences
            const preferences = {
                notifications: {
                    assignments: document.getElementById('notifAssignments').checked,
                    grades: document.getElementById('notifGrades').checked,
                    announcements: document.getElementById('notifAnnouncements').checked,
                    dueDates: document.getElementById('notifDueDates').checked
                },
                theme: document.getElementById('theme_preference').value,
                language: document.getElementById('language').value
            };
            
            // Save to localStorage (in production, this would be sent to the server)
            localStorage.setItem('studentPreferences', JSON.stringify(preferences));
            
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Preferences Saved!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1500);
            }, 1000);
        }
        
        function exportStudentData() {
            alert('Export feature will be available soon! This will download all your assignments, grades, and submissions.');
        }
        
        function viewActivityLog() {
            alert('Activity log feature will be available soon!');
        }
        
        function viewPrivacySettings() {
            alert('Privacy settings feature will be available soon!');
        }
        </script>

        <script>
        // Chat functionality for Discord-like interface
        let currentChat = null;
        let currentChatType = null;

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const chevron = document.getElementById(sectionId + '-chevron');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                chevron.className = 'bi bi-chevron-down ms-auto';
            } else {
                section.style.display = 'none';
                chevron.className = 'bi bi-chevron-up ms-auto';
            }
        }

        function openChat(chatName, chatType) {
            currentChat = chatName;
            currentChatType = chatType;
            
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('active-chat').style.display = 'flex';
            document.getElementById('active-chat-name').textContent = chatName;
            document.getElementById('active-chat-status').textContent = chatType === 'group' ? 'Group Chat' : 'Direct Message';
            
            // Load chat messages
            loadChatMessages(chatName, chatType);
        }

        function closeActiveChat() {
            currentChat = null;
            currentChatType = null;
            document.getElementById('active-chat').style.display = 'none';
            document.getElementById('chat-welcome').style.display = 'flex';
            document.getElementById('chat-messages').innerHTML = '';
        }

        function loadChatMessages(chatName, chatType) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (chatType === 'direct') {
                // Load direct message history
                loadDirectMessages(chatName);
            } else if (chatType === 'group') {
                // Load group message history
                loadGroupMessages(chatName);
            }
        }

        function loadDirectMessages(recipientName) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Find the user by username
            const recipient = findUserByUsername(recipientName);
            if (!recipient) {
                messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">User not found</div>';
                return;
            }

            // Load messages between current user and recipient
            fetch(`/student/communications/messages?recipient_id=${recipient.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages, 'direct');
                    } else {
                        messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">No messages found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">Error loading messages</div>';
                });
        }

        function loadGroupMessages(groupName) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Find the group by name
            const group = findGroupByName(groupName);
            if (!group) {
                messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">Group not found</div>';
                return;
            }

            // Load group messages
            fetch(`/student/communications/group/${group.id}/messages`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages, 'group');
                    } else {
                        messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">No messages found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">Error loading messages</div>';
                });
        }

        function displayMessages(messages, chatType) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (!messages || messages.length === 0) {
                messagesContainer.innerHTML = '<div class="text-center text-muted mt-4">No messages yet. Start the conversation!</div>';
                return;
            }

            let html = '';
            messages.forEach(message => {
                const isOwnMessage = message.sender_id === {{ current_user.id }};
                const messageClass = isOwnMessage ? 'message-item own-message mb-3' : 'message-item mb-3';
                const avatarClass = isOwnMessage ? 'chat-avatar own-avatar me-2' : 'chat-avatar me-2';
                
                html += `
                    <div class="${messageClass}">
                        <div class="d-flex align-items-start ${isOwnMessage ? 'justify-content-end' : ''}">
                            ${!isOwnMessage ? `<div class="${avatarClass}">
                                <i class="bi bi-person-circle"></i>
                            </div>` : ''}
                            <div class="message-content ${isOwnMessage ? 'text-end' : ''}">
                                <div class="message-header">
                                    <span class="message-author ${isOwnMessage ? 'text-info' : 'text-primary'}">${message.sender_name}</span>
                                    <small class="text-muted ms-2">${formatMessageTime(message.created_at)}</small>
                                </div>
                                <div class="message-text text-white">${message.content}</div>
                            </div>
                            ${isOwnMessage ? `<div class="${avatarClass}">
                                <i class="bi bi-person-circle"></i>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            messagesContainer.innerHTML = html;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !currentChat) return;
            
            if (currentChatType === 'direct') {
                sendDirectMessage(message);
            } else if (currentChatType === 'group') {
                sendGroupMessage(message);
            }
        }

        function sendDirectMessage(content) {
            const recipient = findUserByUsername(currentChat);
            if (!recipient) return;

            fetch('/student/communications/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recipient_id: recipient.id,
                    content: content,
                    message_type: 'direct'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add message to chat
                    addMessageToChat({
                        sender_id: {{ current_user.id }},
                        sender_name: '{{ current_user.username }}',
                        content: content,
                        created_at: new Date().toISOString()
                    });
                    document.getElementById('message-input').value = '';
                } else {
                    alert('Error sending message: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        }

        function sendGroupMessage(content) {
            const group = findGroupByName(currentChat);
            if (!group) return;

            fetch(`/student/communications/group/${group.id}/send-message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: content,
                    message_type: 'group'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add message to chat
                    addMessageToChat({
                        sender_id: {{ current_user.id }},
                        sender_name: '{{ current_user.username }}',
                        content: content,
                        created_at: new Date().toISOString()
                    });
                    document.getElementById('message-input').value = '';
                } else {
                    alert('Error sending message: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        }

        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item own-message mb-3';
            
            messageElement.innerHTML = `
                <div class="d-flex align-items-start justify-content-end">
                    <div class="message-content text-end">
                        <div class="message-header">
                            <span class="message-author text-info">You</span>
                            <small class="text-muted ms-2">${formatMessageTime(message.created_at)}</small>
                        </div>
                        <div class="message-text text-white">${message.content}</div>
                    </div>
                    <div class="chat-avatar own-avatar me-2">
                        <i class="bi bi-person-circle"></i>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function openNewMessageModal() {
            // Populate recipients dropdown
            populateRecipientsDropdown();
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined') {
                const modal = new bootstrap.Modal(document.getElementById('newMessageModal'));
                modal.show();
            } else {
                // Fallback: show modal manually
                document.getElementById('newMessageModal').style.display = 'block';
                document.getElementById('newMessageModal').classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        function openCreateGroupModal() {
            // Populate members dropdown
            populateMembersDropdown();
            
            // Check if Bootstrap is available
            if (typeof bootstrap !== 'undefined') {
                const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
                modal.show();
            } else {
                // Fallback: show modal manually
                document.getElementById('createGroupModal').style.display = 'block';
                document.getElementById('createGroupModal').classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        function populateRecipientsDropdown() {
            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = '<option value="">Select recipient...</option>';
            
            // Add sample recipients for now
            const sampleRecipients = [
                { id: 1, username: 'Teacher Smith' },
                { id: 2, username: 'Teacher Johnson' },
                { id: 3, username: 'Student Alice' },
                { id: 4, username: 'Student Bob' }
            ];
            
            sampleRecipients.forEach(recipient => {
                recipientSelect.innerHTML += `<option value="${recipient.id}">${recipient.username}</option>`;
            });
        }

        function populateMembersDropdown() {
            const membersSelect = document.getElementById('group-members');
            membersSelect.innerHTML = '';
            
            // Add sample members for now
            const sampleMembers = [
                { id: 1, username: 'Student Alice' },
                { id: 2, username: 'Student Bob' },
                { id: 3, username: 'Student Charlie' },
                { id: 4, username: 'Student Diana' }
            ];
            
            sampleMembers.forEach(member => {
                membersSelect.innerHTML += `<option value="${member.id}">${member.username}</option>`;
            });
        }

        function sendNewMessage() {
            const recipientId = document.getElementById('recipient').value;
            const content = document.getElementById('message-content').value;
            
            if (!recipientId || !content) {
                alert('Please fill in all fields');
                return;
            }

            // For now, just show success and close modal
            alert('Message sent successfully!');
            closeModal('newMessageModal');
            
            // Clear form
            document.getElementById('recipient').value = '';
            document.getElementById('message-content').value = '';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        function createGroup() {
            const name = document.getElementById('group-name').value;
            const description = document.getElementById('group-description').value;
            const memberIds = Array.from(document.getElementById('group-members').selectedOptions).map(option => option.value);
            
            if (!name || !description) {
                alert('Please fill in group name and description');
                return;
            }

            // For now, just show success and close modal
            alert(`Group "${name}" created successfully!`);
            closeModal('createGroupModal');
            
            // Clear form
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-members').selectedIndex = -1;
        }

        function openAnnouncement(announcementId) {
            // For now, just show a simple alert
            alert(`Opening announcement ${announcementId}`);
            
            // In the future, this would load the actual announcement data
            // and display it in a modal
        }

        function showAnnouncementModal(announcement) {
            // For now, just show an alert
            alert(`Announcement: ${announcement.title}\n\n${announcement.message}`);
        }

        // Helper functions
        function findUserByUsername(username) {
            // This would typically search through available users
            // For now, return a mock user object
            return { id: 1, username: username };
        }

        function findGroupByName(groupName) {
            // This would typically search through available groups
            // For now, return a mock group object
            return { id: 1, name: groupName };
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Typing indicator functionality
        let typingTimeout;
        let isTyping = false;

        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                showTypingIndicator();
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                hideTypingIndicator();
            }, 1000);
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // Enhanced message input handling
        function handleMessageInput() {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            
            if (messageInput && sendButton) {
                messageInput.addEventListener('input', function() {
                    sendButton.disabled = !this.value.trim();
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }

        // Auto-refresh chat data
        function startAutoRefresh() {
            if (currentChat && currentChatType) {
                setInterval(() => {
                    loadChatMessages(currentChat, currentChatType);
                }, 30000); // Refresh every 30 seconds
            }
        }

        // Handle Enter key in message input
        document.addEventListener('DOMContentLoaded', function() {
            handleMessageInput();
            
            // Initialize chat sections
            initializeChatSections();
            
            // Add modal close handlers
            addModalCloseHandlers();
        });

        function addModalCloseHandlers() {
            // Close modal when clicking close button
            const closeButtons = document.querySelectorAll('.btn-close');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // Close modal when clicking outside
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
        }

        function initializeChatSections() {
            // Set default sections to expanded
            const sections = ['direct-messages', 'groups', 'announcements'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }
            });
        }



        function savePreferences() {
            alert('Preferences saved successfully!');
        }

        function exportData() {
            alert('Export functionality will be implemented here.');
        }

        function viewActivityLog() {
            alert('Activity log functionality will be implemented here.');
        }





        function handleAssignmentSubmission() {
            const form = document.getElementById('assignmentSubmissionForm');
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submissionSubmitBtn');
            const originalText = submitBtn.innerHTML;
            
            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Submitting...';
            
            fetch('{{ url_for("student.submit_assignment", assignment_id=0) }}'.replace('/0', '/' + document.getElementById('submissionAssignmentId').value), {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle-fill me-2"></i>Assignment submitted successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    // Insert alert at the top of the page
                    const container = document.querySelector('.container-fluid');
                    container.insertBefore(alertDiv, container.firstChild);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('submissionModal'));
                    modal.hide();
                    
                    // Reload page to show updated status
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('Submission failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>An error occurred while submitting the assignment. Please try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert alert at the top of the page
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);
            })
            .finally(() => {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        }
        </script>

    {% else %}
        <!-- Generic fallback content for other sections -->
        <div class="alert alert-warning">
            <h4>Section Under Development</h4>
            <p>Content for the '{{ section }}' section for students is currently under development. Please check back later!</p>
        </div>
    {% endif %}

    <!-- Assignment Submission Modal -->
    <div class="modal fade" id="submissionModal" tabindex="-1" aria-labelledby="submissionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <!-- Enhanced Header -->
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="d-flex align-items-center w-100">
                        <div class="me-3">
                            <div class="bg-white bg-opacity-20 rounded-circle p-3">
                                <i class="bi bi-cloud-upload-fill fs-2"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h4 class="modal-title mb-1" id="submissionModalLabel">Submit Assignment</h4>
                            <p class="mb-0 opacity-75 small" id="submissionAssignmentTitle">Assignment Title</p>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                
                <div class="modal-body p-4" style="background-color: #ffffff; color: #212529;">
                    <form id="assignmentSubmissionForm" enctype="multipart/form-data">
                        <input type="hidden" id="submissionAssignmentId" name="assignment_id">
                        
                        <!-- File Upload Section -->
                        <div class="mb-4">
                            <label for="submission_file" class="form-label fw-bold mb-3">
                                <i class="bi bi-file-earmark-arrow-up me-2 text-primary"></i>Upload Your Assignment File
                            </label>
                            <div class="file-upload-area border-2 border-dashed rounded p-4 text-center" 
                                 style="border-color: #dee2e6; background-color: #f8f9fa; transition: all 0.3s; color: #212529;"
                                 onmouseover="this.style.borderColor='#667eea'; this.style.backgroundColor='#f0f4ff';"
                                 onmouseout="this.style.borderColor='#dee2e6'; this.style.backgroundColor='#f8f9fa';">
                                <i class="bi bi-cloud-upload display-4 mb-3" style="color: #6c757d;"></i>
                                <p class="mb-2 fw-semibold" style="color: #212529;">Click to browse or drag and drop</p>
                                <p class="small mb-3" style="color: #6c757d;">Select your assignment file to upload</p>
                                <input type="file" 
                                       class="form-control d-none" 
                                       id="submission_file" 
                                       name="submission_file" 
                                       required
                                       onchange="updateFileDisplay(this)">
                                <button type="button" 
                                        class="btn btn-outline-primary" 
                                        onclick="document.getElementById('submission_file').click()">
                                    <i class="bi bi-folder2-open me-2"></i>Choose File
                                </button>
                                <div id="fileDisplay" class="mt-3" style="display: none;">
                                    <div class="alert alert-info d-flex align-items-center" style="background-color: #d1ecf1; border-color: #bee5eb;">
                                        <i class="bi bi-file-earmark-check-fill me-2 fs-5" style="color: #0c5460;"></i>
                                        <div class="flex-grow-1">
                                            <strong id="fileName" style="color: #0c5460;"></strong>
                                            <br>
                                            <small id="fileSize" style="color: #0c5460; opacity: 0.85;"></small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFileSelection()">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Supported formats:</strong> PDF, DOC, DOCX, TXT, PNG, JPG, JPEG, GIF, MD
                            </div>
                        </div>
                        
                        <!-- Additional Notes Section -->
                        <div class="mb-3">
                            <label for="submission_notes" class="form-label fw-bold">
                                <i class="bi bi-chat-left-text me-2 text-primary"></i>Additional Notes <span class="text-muted fw-normal">(Optional)</span>
                            </label>
                            <textarea class="form-control" 
                                      id="submission_notes" 
                                      name="submission_notes" 
                                      rows="4" 
                                      placeholder="Add any additional notes, comments, or special instructions about your submission..."
                                      style="resize: vertical;"></textarea>
                            <div class="form-text">
                                <i class="bi bi-lightbulb me-1"></i>
                                You can use this field to provide context, explain your approach, or note any special circumstances.
                            </div>
                        </div>
                        
                        <!-- Submission Guidelines -->
                        <div class="alert alert-light border-start border-4 border-info mt-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-exclamation-circle-fill text-info me-2 fs-5"></i>
                                <div>
                                    <h6 class="alert-heading mb-2">Before Submitting</h6>
                                    <ul class="mb-0 small">
                                        <li>Make sure your file is complete and ready for submission</li>
                                        <li>Double-check that you've selected the correct file</li>
                                        <li>You can resubmit if needed, but previous submissions will be replaced</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary btn-lg px-4" id="submissionSubmitBtn" onclick="handleAssignmentSubmission()">
                        <i class="bi bi-cloud-upload me-2"></i><span id="submissionSubmitBtnText">Submit Assignment</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // File display functions
    function updateFileDisplay(input) {
        const fileDisplay = document.getElementById('fileDisplay');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            fileName.textContent = file.name;
            
            // Format file size
            const sizeInBytes = file.size;
            let sizeFormatted;
            if (sizeInBytes < 1024) {
                sizeFormatted = sizeInBytes + ' bytes';
            } else if (sizeInBytes < 1048576) {
                sizeFormatted = (sizeInBytes / 1024).toFixed(2) + ' KB';
            } else {
                sizeFormatted = (sizeInBytes / 1048576).toFixed(2) + ' MB';
            }
            fileSize.textContent = sizeFormatted;
            
            fileDisplay.style.display = 'block';
        }
    }
    
    function clearFileSelection() {
        const fileInput = document.getElementById('submission_file');
        const fileDisplay = document.getElementById('fileDisplay');
        
        fileInput.value = '';
        fileDisplay.style.display = 'none';
    }
    
    // Class Assignments Modal Functions
    function closeClassAssignmentsModal() {
        const modalElement = document.getElementById('classAssignmentsModal');
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        } else {
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
        }
    }
    
    function openClassAssignmentsModal(classId, className) {
        const modalElement = document.getElementById('classAssignmentsModal');
        const modalTitle = document.getElementById('classAssignmentsModalTitle');
        const assignmentsContainer = document.getElementById('classAssignmentsList');
        
        // Set class name
        modalTitle.textContent = `Assignments - ${className}`;
        
        // Show loading state
        assignmentsContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading assignments...</p>
            </div>
        `;
        
        // Show modal
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
        }
        
        // Fetch assignments
        fetch(`/student/api/class/${classId}/assignments`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    assignmentsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>${data.error}
                        </div>
                    `;
                    return;
                }
                
                if (!data.assignments || data.assignments.length === 0) {
                    assignmentsContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>No assignments have been posted for this class yet.
                        </div>
                    `;
                    return;
                }
                
                // Group assignments by status
                const activeAssignments = data.assignments.filter(a => a.is_active);
                const inactiveAssignments = data.assignments.filter(a => !a.is_active);
                
                let html = '';
                
                // Active Assignments
                if (activeAssignments.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h5 class="text-success mb-3">
                                <i class="bi bi-check-circle me-2"></i>Active Assignments
                            </h5>
                            <div class="row g-3">
                    `;
                    
                    activeAssignments.forEach(assignment => {
                        html += createAssignmentCard(assignment);
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Inactive Assignments
                if (inactiveAssignments.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h5 class="text-muted mb-3">
                                <i class="bi bi-x-circle me-2"></i>Inactive Assignments
                            </h5>
                            <div class="row g-3">
                    `;
                    
                    inactiveAssignments.forEach(assignment => {
                        html += createAssignmentCard(assignment, true);
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                assignmentsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Error fetching assignments:', error);
                assignmentsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>Error loading assignments. Please try again.
                    </div>
                `;
            });
    }
    
    function createAssignmentCard(assignment, isInactive = false) {
        const inactiveClass = isInactive ? 'opacity-75' : '';
        const statusBadgeClass = `badge bg-${assignment.status_class}`;
        
        let daysInfo = '';
        if (assignment.days_remaining !== null && assignment.days_remaining !== undefined) {
            daysInfo = `<span class="badge bg-success ms-2">${assignment.days_remaining} days remaining</span>`;
        } else if (assignment.days_overdue !== null && assignment.days_overdue !== undefined) {
            daysInfo = `<span class="badge bg-danger ms-2">${assignment.days_overdue} days overdue</span>`;
        }
        
        let gradeInfo = '';
        if (assignment.has_grade) {
            gradeInfo = `<div class="mt-2"><span class="badge bg-success">Graded: ${assignment.grade_percentage || assignment.grade_score}%</span></div>`;
        }
        
        return `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm ${inactiveClass}">
                    <div class="card-body">
                        <h6 class="card-title">${assignment.title}</h6>
                        <p class="card-text small text-muted">${assignment.description || 'No description provided.'}</p>
                        
                        <div class="mb-2">
                            <strong>Due:</strong> ${assignment.due_date_formatted} ${daysInfo}
                        </div>
                        
                        <div class="mb-2">
                            <strong>Quarter:</strong> Q${assignment.quarter || 'N/A'}
                        </div>
                        
                        ${assignment.has_attachment ? `
                            <div class="mb-2">
                                <a href="/student/download-assignment-file/${assignment.id}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-download me-1"></i>Download
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="mt-2">
                            <span class="${statusBadgeClass}">${assignment.submission_status}</span>
                        </div>
                        
                        ${gradeInfo}
                        
                        <div class="mt-3">
                            <button type="button" 
                                    class="btn btn-sm btn-primary ${isInactive ? 'disabled' : ''}" 
                                    ${isInactive ? 'disabled' : `onclick="closeClassAssignmentsModal(); window.openAssignmentViewModal(${assignment.id}, '${assignment.title.replace(/'/g, "\\'")}', '${(assignment.description || '').replace(/'/g, "\\'")}', '${assignment.due_date || ''}', '${assignment.quarter || 'N/A'}', '${assignment.attachment_filename || ''}', ${assignment.has_submission}, ${assignment.has_grade}, '${assignment.assignment_type}')"`}>
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    </script>

    <!-- Assignment View Modal -->
    <div class="modal fade" id="assignmentViewModal" tabindex="-1" aria-labelledby="assignmentViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down" style="max-width: 90vw; width: 90vw;">
            <div class="modal-content border-0 shadow-lg">
                <!-- Dynamic Header based on assignment type -->
                <div class="modal-header text-white" id="viewModalHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="d-flex align-items-center w-100">
                        <div class="me-3">
                            <div id="viewAssignmentIcon" class="fs-1"></div>
                        </div>
                        <div class="flex-grow-1">
                            <h4 class="modal-title mb-1" id="assignmentViewModalLabel">
                                <span id="viewAssignmentTitle"></span>
                            </h4>
                            <p class="mb-0 opacity-75" id="viewAssignmentSubtitle">Assignment Details & Instructions</p>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                
                <div class="modal-body p-5" style="background-color: #ffffff; color: #212529;">
                    <!-- Assignment Status Banner -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert border-0 shadow-sm" id="viewAssignmentBanner" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div id="viewAssignmentStatusIcon" class="fs-4"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1" id="viewAssignmentStatusTitle">Assignment Status</h6>
                                        <p class="mb-0" id="viewAssignmentStatusMessage">Current status and next steps</p>
                                    </div>
                                    <div class="d-flex flex-wrap gap-1">
                                        <span class="badge fs-6 px-3 py-2" id="viewAssignmentQuarter"></span>
                                        <span class="badge fs-6 px-3 py-2" id="viewAssignmentType"></span>
                                        <span class="badge fs-6 px-3 py-2" id="viewAssignmentStatus"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="row g-4">
                        <!-- Left Column: Assignment Details -->
                        <div class="col-12 col-lg-8 col-xl-7">
                            <!-- Assignment Description Card -->
                            <div class="card border-0 shadow-sm mb-4" id="viewDescriptionCard">
                                <div class="card-header border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h5 class="mb-0 text-white">
                                        <i class="bi bi-journal-text me-2"></i>Assignment Instructions
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="viewAssignmentDescription" class="fs-6"></div>
                                    <div id="viewAssignmentInstructions" class="mt-3"></div>
                                </div>
                            </div>

                            <!-- Progress & Timeline Card -->
                            <div class="card border-0 shadow-sm" id="viewProgressCard">
                                <div class="card-header border-0" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h5 class="mb-0 text-white">
                                        <i class="bi bi-clock-history me-2"></i>Timeline & Progress
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center p-3 rounded" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                                <div class="me-3">
                                                    <i class="bi bi-calendar-check fs-2 text-white"></i>
                                                </div>
                                                <div>
                                                    <h6 class="text-white mb-1">Due Date</h6>
                                                    <p class="text-white mb-0 fw-bold" id="viewAssignmentDueDate"></p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center p-3 rounded" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                                <div class="me-3">
                                                    <i class="bi bi-speedometer2 fs-2 text-dark"></i>
                                                </div>
                                                <div>
                                                    <h6 class="text-dark mb-1">Time Remaining</h6>
                                                    <p class="text-dark mb-0 fw-bold" id="viewTimeRemaining">Calculating...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Actions & Resources -->
                        <div class="col-12 col-lg-4 col-xl-5">
                            <!-- Assignment Type Specific Card -->
                            <div class="card border-0 shadow-sm mb-4" id="viewTypeCard">
                                <div class="card-header border-0" id="viewTypeCardHeader">
                                    <h5 class="mb-0 text-white" id="viewTypeCardTitle">
                                        <i class="bi bi-info-circle me-2"></i>Assignment Type
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="viewAssignmentAttachment"></div>
                                    <div id="viewTypeInstructions" class="mt-3"></div>
                                </div>
                            </div>

                            <!-- Submission Status Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header border-0" id="viewSubmissionCardHeader">
                                    <h5 class="mb-0 text-white">
                                        <i class="bi bi-person-check me-2"></i>Your Progress
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="viewSubmissionStatus"></div>
                                    <div class="mt-3" id="viewProgressContainer">
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" id="viewProgressBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted mt-2 d-block" id="viewProgressText">Progress: 0%</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons Card -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-header border-0" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                    <h5 class="mb-0 text-dark">
                                        <i class="bi bi-lightning-charge me-2"></i>Quick Actions
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="viewActionButtons" class="d-grid gap-2">
                                        <!-- Buttons will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" id="viewHelpButton" onclick="showAssignmentHelp()">
                        <i class="bi bi-question-circle me-1"></i>Need Help?
                    </button>
                </div>
            </div>
        </div>
    </div>

         <!-- Fallback Functions for Assignment Buttons -->
     <script>
     // Test if JavaScript is working at all
     console.log('Student dashboard JavaScript loaded');
     
     // Test if basic functions exist
     if (typeof openAssignmentViewModal === 'undefined') {
         console.error('openAssignmentViewModal function is not defined!');
     }
     if (typeof openSubmissionModal === 'undefined') {
         console.error('openSubmissionModal function is not defined!');
     }
     
     // Test functions for debugging
     window.testJavaScript = function() {
         console.log('JavaScript test function called');
         alert('JavaScript is working! Check the console for more details.');
     };
     
     window.testBootstrap = function() {
         if (typeof bootstrap === 'undefined') {
             alert('Bootstrap is NOT loaded! This will prevent modals from working.');
         } else {
             alert('Bootstrap is loaded successfully!');
         }
     };
     
     window.testModals = function() {
         const assignmentViewModal = document.getElementById('assignmentViewModal');
         const submissionModal = document.getElementById('submissionModal');
         
         let message = 'Modal elements found:\n';
         message += assignmentViewModal ? '✓ assignmentViewModal\n' : '✗ assignmentViewModal\n';
         message += submissionModal ? '✓ submissionModal\n' : '✗ submissionModal\n';
         
         alert(message);
     };
     
     window.showDebugInfo = function() {
         const debugInfo = document.getElementById('debugInfo');
         if (debugInfo.style.display === 'none') {
             debugInfo.style.display = 'block';
         } else {
             debugInfo.style.display = 'none';
         }
     };
     

     
     // Fallback functions that work even if the event listeners fail
     function fallbackViewAssignment(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade, assignmentType) {
         console.log('Fallback view function called with:', arguments);
         try {
             openAssignmentViewModal(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade, assignmentType);
         } catch (error) {
             console.error('Error in fallback view function:', error);
             alert('Error opening assignment view. Please try again.');
         }
     }
     
     function fallbackSubmitAssignment(assignmentId, assignmentTitle, isResubmit) {
         console.log('Fallback submit function called with:', arguments);
         try {
             openSubmissionModal(assignmentId, assignmentTitle, isResubmit);
         } catch (error) {
             console.error('Error in fallback submit function:', error);
             alert('Error opening submission form. Please try again.');
         }
     }
     
     <!-- Event Listeners for Assignment Buttons -->
     document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');
        
        // Debug: Check if Bootstrap is available
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap is not loaded! This will prevent modals from working.');
            // Fallback: Add click handlers that show alerts instead of modals
            document.querySelectorAll('.view-assignment-btn, .submit-assignment-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    alert('Bootstrap is not loaded. Please refresh the page or contact support.');
                });
            });
            return;
        }
        
        console.log('Bootstrap is available');
        
        // View Assignment Button Event Listeners
        const viewButtons = document.querySelectorAll('.view-assignment-btn');
        console.log('Found', viewButtons.length, 'view assignment buttons');
        
        viewButtons.forEach(function(button, index) {
            console.log('Setting up view button', index, 'with data:', button.dataset);
            button.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('View button clicked:', this.dataset);
                
                try {
                    const assignmentId = this.dataset.assignmentId;
                    const assignmentTitle = this.dataset.assignmentTitle;
                    const assignmentDescription = this.dataset.assignmentDescription;
                    const assignmentDueDate = this.dataset.assignmentDueDate;
                    const assignmentQuarter = this.dataset.assignmentQuarter;
                    const assignmentAttachment = this.dataset.assignmentAttachment;
                    const hasSubmission = this.dataset.hasSubmission === 'true';
                    const hasGrade = this.dataset.hasGrade === 'true';
                    
                    console.log('Opening view modal with:', {
                        assignmentId, assignmentTitle, assignmentDescription, 
                        assignmentDueDate, assignmentQuarter, assignmentAttachment,
                        hasSubmission, hasGrade
                    });
                    
                    openAssignmentViewModal(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade);
                } catch (error) {
                    console.error('Error in view button click handler:', error);
                    alert('Error opening assignment view. Please try again.');
                }
            });
        });

        // Submit Assignment Button Event Listeners
        const submitButtons = document.querySelectorAll('.submit-assignment-btn');
        
        submitButtons.forEach(function(button, index) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const assignmentId = this.dataset.assignmentId;
                const assignmentTitle = this.dataset.assignmentTitle;
                const isResubmit = this.dataset.isResubmit === 'true';
                
                openSubmissionModal(assignmentId, assignmentTitle, isResubmit);
            });
        });
        
        // Safe wrapper functions that read from data attributes
        function viewAssignmentSafe(assignmentId) {
            const button = document.querySelector(`[data-assignment-id="${assignmentId}"]`);
            if (!button) {
                console.error('Button not found for assignment:', assignmentId);
                return;
            }
            
            const assignmentTitle = button.dataset.assignmentTitle;
            const assignmentDescription = button.dataset.assignmentDescription;
            const assignmentDueDate = button.dataset.assignmentDueDate;
            const assignmentQuarter = button.dataset.assignmentQuarter;
            const assignmentAttachment = button.dataset.assignmentAttachment;
            const hasSubmission = button.dataset.hasSubmission === 'true';
            const hasGrade = button.dataset.hasGrade === 'true';
            const assignmentType = button.dataset.assignmentType || 'pdf';
            
            openAssignmentViewModal(assignmentId, assignmentTitle, assignmentDescription, assignmentDueDate, assignmentQuarter, assignmentAttachment, hasSubmission, hasGrade, assignmentType);
        }
        
        function submitAssignmentSafe(assignmentId, isResubmit) {
            const button = document.querySelector(`[data-assignment-id="${assignmentId}"][data-is-resubmit="${isResubmit}"]`);
            if (!button) {
                console.error('Button not found for assignment:', assignmentId);
                return;
            }
            
            const assignmentTitle = button.dataset.assignmentTitle;
            openSubmissionModal(assignmentId, assignmentTitle, isResubmit);
        }
    });
    
    // Assignment filtering and sorting functionality
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');
        const sortBy = document.getElementById('sortBy');
        const table = document.getElementById('assignmentsTable');
        
        if (!table) return;
        
        function filterAndSortAssignments() {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const statusValue = statusFilter.value;
            const typeValue = typeFilter.value;
            const sortValue = sortBy.value;
            
            // Filter rows
            rows.forEach(row => {
                let showRow = true;
                
                // Status filter
                if (statusValue) {
                    const statusBadge = row.querySelector('.badge');
                    const statusText = statusBadge ? statusBadge.textContent.trim() : '';
                    if (statusText !== statusValue) {
                        showRow = false;
                    }
                }
                
                // Type filter
                if (typeValue) {
                    const typeText = row.querySelector('small.text-muted');
                    if (typeText) {
                        const typeContent = typeText.textContent.toLowerCase();
                        if (typeValue === 'pdf' && !typeContent.includes('pdf/paper')) {
                            showRow = false;
                        } else if (typeValue === 'quiz' && !typeContent.includes('quiz')) {
                            showRow = false;
                        } else if (typeValue === 'discussion' && !typeContent.includes('discussion')) {
                            showRow = false;
                        }
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
            
            // Sort visible rows
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            visibleRows.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortValue) {
                    case 'due_date':
                        aValue = a.cells[0].textContent.trim();
                        bValue = b.cells[0].textContent.trim();
                        return aValue.localeCompare(bValue);
                    case 'title':
                        aValue = a.cells[1].querySelector('strong').textContent.trim();
                        bValue = b.cells[1].querySelector('strong').textContent.trim();
                        return aValue.localeCompare(bValue);
                    case 'class':
                        aValue = a.cells[2].textContent.trim();
                        bValue = b.cells[2].textContent.trim();
                        return aValue.localeCompare(bValue);
                    case 'status':
                        aValue = a.cells[3].querySelector('.badge').textContent.trim();
                        bValue = b.cells[3].querySelector('.badge').textContent.trim();
                        return aValue.localeCompare(bValue);
                    default:
                        return 0;
                }
            });
            
            // Reorder rows in table
            const tbody = table.querySelector('tbody');
            visibleRows.forEach(row => tbody.appendChild(row));
        }
        
        // Add event listeners
        if (statusFilter) statusFilter.addEventListener('change', filterAndSortAssignments);
        if (typeFilter) typeFilter.addEventListener('change', filterAndSortAssignments);
        if (sortBy) sortBy.addEventListener('change', filterAndSortAssignments);
    });
    
    // New assignment type specific functions
    function takeQuiz(assignmentId, assignmentTitle) {
        // Redirect to quiz taking interface
        window.location.href = `/student/take-quiz/${assignmentId}`;
    }
    
    function joinDiscussion(assignmentId, assignmentTitle) {
        // Redirect to discussion interface
        window.location.href = `/student/discussion/${assignmentId}`;
    }

    </script>
    
    <!-- Class Assignments Modal -->
    <div class="modal fade" id="classAssignmentsModal" tabindex="-1" aria-labelledby="classAssignmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down" style="max-width: 90vw; width: 90vw;">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="d-flex align-items-center w-100">
                        <div class="me-3">
                            <div class="bg-white bg-opacity-20 rounded-circle p-3">
                                <i class="bi bi-journal-text fs-2"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h4 class="modal-title mb-1" id="classAssignmentsModalLabel">
                                <span id="classAssignmentsModalTitle">Class Assignments</span>
                            </h4>
                            <p class="mb-0 opacity-75 small">View all assignments for this class</p>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                
                <div class="modal-body p-4" style="background-color: #ffffff; color: #212529; max-height: 70vh; overflow-y: auto;">
                    <div id="classAssignmentsList">
                        <!-- Assignments will be loaded here -->
                    </div>
                </div>
                
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 