{% extends "shared/dashboard_layout.html" %}

{% block title %}My Submissions{% endblock %}

{% block dashboard_content %}
<!-- CSS now in /static/css/components.css -->

<div class="container-fluid px-2 px-md-4">
    <!-- Header -->
    <div class="mb-4">
        <h2 class="mb-1"><i class="bi bi-pencil-square me-2 gradient-text"></i>My Submissions</h2>
        <p class="text-muted">Share feedback, reflect on your learning, and report concerns</p>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm submission-stat-card-1">
                <div class="card-body text-white text-center py-4">
                    <i class="bi bi-arrow-repeat display-4 mb-2 opacity-75"></i>
                    <h2 class="mb-0 fw-bold">{{ feedback_submissions|length }}</h2>
                    <p class="mb-0 small text-white-50">360° Feedback Submitted</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm submission-stat-card-2">
                <div class="card-body text-white text-center py-4">
                    <i class="bi bi-journal-text display-4 mb-2 opacity-75"></i>
                    <h2 class="mb-0 fw-bold">{{ journal_submissions|length }}</h2>
                    <p class="mb-0 small text-white-50">Reflection Journals</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm submission-stat-card-3">
                <div class="card-body text-white text-center py-4">
                    <i class="bi bi-exclamation-triangle-fill display-4 mb-2 opacity-75"></i>
                    <h2 class="mb-0 fw-bold">{{ conflict_reports|length }}</h2>
                    <p class="mb-0 small text-white-50">Conflict Reports</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Options -->
    <div class="row g-4 mb-4">
        <!-- 360° Feedback -->
        <div class="col-12 col-md-4">
            <div class="card submission-card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="icon-circle submission-icon-1">
                        <i class="bi bi-arrow-repeat text-white"></i>
                    </div>
                    <h4 class="mb-3">360° Feedback</h4>
                    <p class="text-muted mb-4">Provide comprehensive feedback on your peers' collaboration and contributions</p>
                    <button class="btn btn-primary w-100 submission-btn-1" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                        <i class="bi bi-plus-circle me-2"></i>Submit Feedback
                    </button>
                </div>
            </div>
        </div>

        <!-- Reflection Journal -->
        <div class="col-12 col-md-4">
            <div class="card submission-card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="icon-circle submission-icon-2">
                        <i class="bi bi-journal-text text-white"></i>
                    </div>
                    <h4 class="mb-3">Reflection Journal</h4>
                    <p class="text-muted mb-4">Reflect on your learning experiences and group collaboration</p>
                    <button class="btn btn-primary w-100 submission-btn-2" data-bs-toggle="modal" data-bs-target="#journalModal">
                        <i class="bi bi-plus-circle me-2"></i>Write Journal Entry
                    </button>
                </div>
            </div>
        </div>

        <!-- Conflict Resolution -->
        <div class="col-12 col-md-4">
            <div class="card submission-card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="icon-circle submission-icon-3">
                        <i class="bi bi-exclamation-triangle-fill text-white"></i>
                    </div>
                    <h4 class="mb-3">Report Conflict</h4>
                    <p class="text-muted mb-4">Report group conflicts to help maintain a positive learning environment</p>
                    <button class="btn btn-primary w-100 submission-btn-3" data-bs-toggle="modal" data-bs-target="#conflictModal">
                        <i class="bi bi-plus-circle me-2"></i>Report Conflict
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Submissions History -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Submissions</h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#feedback-tab">360° Feedback ({{ feedback_submissions|length }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#journal-tab">Journals ({{ journal_submissions|length }})</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#conflict-tab">Conflicts ({{ conflict_reports|length }})</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Feedback Tab -->
                <div id="feedback-tab" class="tab-pane fade show active">
                    {% if feedback_submissions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Target Student</th>
                                        <th>Session</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for feedback in feedback_submissions[:10] %}
                                    <tr>
                                        <td><small>{{ feedback.submitted_at.strftime('%m/%d/%Y %I:%M %p') if feedback.submitted_at else 'N/A' }}</small></td>
                                        <td>{{ feedback.target_student.first_name if feedback.target_student else 'N/A' }} {{ feedback.target_student.last_name if feedback.target_student else '' }}</td>
                                        <td>{{ feedback.session.title if feedback.session else 'N/A' }}</td>
                                        <td><span class="badge bg-success">Submitted</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No 360° feedback submitted yet</p>
                    {% endif %}
                </div>

                <!-- Journal Tab -->
                <div id="journal-tab" class="tab-pane fade">
                    {% if journal_submissions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Group</th>
                                        <th>Assignment</th>
                                        <th>Collaboration Rating</th>
                                        <th>Learning Rating</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for journal in journal_submissions[:10] %}
                                    <tr>
                                        <td><small>{{ journal.submitted_at.strftime('%m/%d/%Y %I:%M %p') if journal.submitted_at else 'N/A' }}</small></td>
                                        <td>{{ journal.group.name if journal.group else 'N/A' }}</td>
                                        <td>{{ journal.group_assignment.title if journal.group_assignment else 'N/A' }}</td>
                                        <td><span class="badge bg-success">{{ journal.collaboration_rating if journal.collaboration_rating else 0 }}/5</span></td>
                                        <td><span class="badge bg-info">{{ journal.learning_rating if journal.learning_rating else 0 }}/5</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No reflection journals submitted yet</p>
                    {% endif %}
                </div>

                <!-- Conflict Tab -->
                <div id="conflict-tab" class="tab-pane fade">
                    {% if conflict_reports %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Group</th>
                                        <th>Type</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for conflict in conflict_reports[:10] %}
                                    <tr>
                                        <td><small>{{ conflict.reported_at.strftime('%m/%d/%Y %I:%M %p') if conflict.reported_at else 'N/A' }}</small></td>
                                        <td>{{ conflict.group.name if conflict.group else 'N/A' }}</td>
                                        <td>{{ conflict.conflict_type.replace('_', ' ').title() if conflict.conflict_type else 'N/A' }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if conflict.severity_level == 'critical' %}bg-danger
                                                {% elif conflict.severity_level == 'high' %}bg-warning
                                                {% else %}bg-info
                                                {% endif %}">
                                                {{ conflict.severity_level.title() if conflict.severity_level else 'N/A' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if conflict.status == 'resolved' %}bg-success
                                                {% elif conflict.status == 'investigating' %}bg-info
                                                {% else %}bg-warning
                                                {% endif %}">
                                                {{ conflict.status.title() if conflict.status else 'N/A' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No conflicts reported</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 360° Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('student.submit_360_feedback') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <h5 class="modal-title text-white"><i class="bi bi-arrow-repeat me-2"></i>Submit 360° Feedback</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Feedback Session</label>
                        <select name="feedback360_id" class="form-select" required id="feedbackSessionSelect">
                            <option value="">Choose a session...</option>
                            {% if available_feedback_sessions %}
                                {% for session in available_feedback_sessions %}
                                    <option value="{{ session.id }}">{{ session.title }} ({{ session.target_student.first_name }} {{ session.target_student.last_name }})</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>No active feedback sessions available</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Your Feedback (JSON format)</label>
                        <textarea name="feedback_data" class="form-control" rows="6" required 
                                  placeholder='{"communication": 5, "teamwork": 4, "leadership": 5, "comments": "Great collaborator!"}'></textarea>
                        <small class="text-muted">Provide your feedback in JSON format with ratings and comments</small>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_anonymous" value="true" class="form-check-input" id="anonymousCheck">
                        <label class="form-check-label" for="anonymousCheck">Submit anonymously</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                        <i class="bi bi-send me-1"></i>Submit Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reflection Journal Modal -->
<div class="modal fade" id="journalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('student.submit_reflection_journal') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h5 class="modal-title text-white"><i class="bi bi-journal-text me-2"></i>Write Reflection Journal</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Group Assignment</label>
                        <select name="group_assignment_id" class="form-select" required id="groupAssignmentSelect" onchange="loadGroupForAssignment()">
                            <option value="">Choose an assignment...</option>
                            {% if student_group_assignments %}
                                {% for assignment in student_group_assignments %}
                                    <option value="{{ assignment.id }}" data-group-id="{{ assignment.group_id }}">{{ assignment.title }} - {{ assignment.class_name }}</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>No group assignments available</option>
                            {% endif %}
                        </select>
                    </div>
                    <input type="hidden" name="group_id" id="groupIdInput">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Reflection</label>
                        <textarea name="reflection_text" class="form-control" rows="5" required 
                                  placeholder="Share your thoughts on the group work experience..."></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Collaboration Rating</label>
                            <select name="collaboration_rating" class="form-select" required>
                                <option value="">Select rating...</option>
                                <option value="5">⭐⭐⭐⭐⭐ Excellent (5)</option>
                                <option value="4">⭐⭐⭐⭐ Good (4)</option>
                                <option value="3">⭐⭐⭐ Average (3)</option>
                                <option value="2">⭐⭐ Fair (2)</option>
                                <option value="1">⭐ Poor (1)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Learning Rating</label>
                            <select name="learning_rating" class="form-select" required>
                                <option value="">Select rating...</option>
                                <option value="5">⭐⭐⭐⭐⭐ Excellent (5)</option>
                                <option value="4">⭐⭐⭐⭐ Good (4)</option>
                                <option value="3">⭐⭐⭐ Average (3)</option>
                                <option value="2">⭐⭐ Fair (2)</option>
                                <option value="1">⭐ Poor (1)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Challenges Faced (Optional)</label>
                        <textarea name="challenges_faced" class="form-control" rows="3" 
                                  placeholder="What challenges did your group encounter?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Lessons Learned (Optional)</label>
                        <textarea name="lessons_learned" class="form-control" rows="3" 
                                  placeholder="What did you learn from this experience?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="bi bi-send me-1"></i>Submit Journal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Conflict Report Modal -->
<div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('student.submit_conflict_report') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h5 class="modal-title text-white"><i class="bi bi-exclamation-triangle-fill me-2"></i>Report Conflict</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Confidential Reporting:</strong> This report will be reviewed by your teacher to help resolve the issue.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Group Assignment</label>
                        <select name="group_assignment_id" class="form-select" required id="conflictAssignmentSelect" onchange="loadGroupForConflict()">
                            <option value="">Choose an assignment...</option>
                            {% if student_group_assignments %}
                                {% for assignment in student_group_assignments %}
                                    <option value="{{ assignment.id }}" data-group-id="{{ assignment.group_id }}">{{ assignment.title }} - {{ assignment.class_name }}</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>No group assignments available</option>
                            {% endif %}
                        </select>
                    </div>
                    <input type="hidden" name="group_id" id="conflictGroupIdInput">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Conflict Type</label>
                        <select name="conflict_type" class="form-select" required>
                            <option value="">Select type...</option>
                            <option value="communication">Communication Issues</option>
                            <option value="workload">Unequal Workload Distribution</option>
                            <option value="personality">Personality Conflicts</option>
                            <option value="participation">Lack of Participation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Severity Level</label>
                        <select name="severity_level" class="form-select" required>
                            <option value="">Select severity...</option>
                            <option value="low">Low - Minor issue</option>
                            <option value="medium">Medium - Affecting work</option>
                            <option value="high">High - Significant impact</option>
                            <option value="critical">Critical - Urgent intervention needed</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Describe the Conflict</label>
                        <textarea name="conflict_description" class="form-control" rows="5" required 
                                  placeholder="Please provide details about the conflict..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="bi bi-send me-1"></i>Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function loadGroupForAssignment() {
    const select = document.getElementById('groupAssignmentSelect');
    const groupId = select.options[select.selectedIndex].getAttribute('data-group-id');
    document.getElementById('groupIdInput').value = groupId;
}

function loadGroupForConflict() {
    const select = document.getElementById('conflictAssignmentSelect');
    const groupId = select.options[select.selectedIndex].getAttribute('data-group-id');
    document.getElementById('conflictGroupIdInput').value = groupId;
}
</script>
{% endblock %}

