{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2 gap-md-0">
        <h3 class="mb-2 mb-md-0">My Assignments</h3>
        <div>
            <button class="btn btn-sm text-white" style="background: linear-gradient(135deg, #2E8B57 0%, #228B22 50%, #556B2F 100%);" onclick="window.history.back()">
                <i class="bi bi-arrow-left me-1 me-md-2"></i>Back to Dashboard
            </button>
        </div>
    </div>

    {% if assignments %}
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle assignments-table">
                <thead class="table-dark">
                    <tr>
                        <th>Due Date</th>
                        <th>Assignment Title</th>
                        <th>Class</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in assignments %}
                        <tr>
                            <td data-label="Due Date">{{ assignment.due_date.strftime('%m/%d/%Y %I:%M %p') }}</td>
                            <td data-label="Assignment Title">
                                <strong>{{ assignment.title }}</strong>
                                {% if assignment.description %}
                                    <br><small class="text-muted">{{ assignment.description[:100] }}{% if assignment.description|length > 100 %}...{% endif %}</small>
                                {% endif %}
                                {% if assignment.attachment_filename %}
                                    <br><small class="text-primary">
                                        <i class="bi bi-paperclip me-1"></i>
                                        <a href="{{ url_for('download_assignment_file', assignment_id=assignment.id) }}" class="text-decoration-none">
                                            {{ assignment.attachment_original_filename }}
                                        </a>
                                    </small>
                                {% endif %}
                            </td>
                            <td data-label="Class">{{ assignment.class_info.name }}</td>
                            <td data-label="Status">
                                {% if assignment.due_date > now %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Past Due</span>
                                {% endif %}
                            </td>
                            <td data-label="Actions">
                                <div class="d-flex flex-column flex-sm-row gap-1">
                                    <a href="{{ url_for('teacher.view_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-eye me-1"></i>View
                                    </a>
                                    <a href="{{ url_for('teacher.grade_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-pencil me-1"></i>Grade
                                    </a>
                                    <a href="{{ url_for('teacher.edit_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-warning btn-sm">
                                        <i class="bi bi-pencil-square me-1"></i>Edit
                                    </a>
                                    <button type="button" class="btn btn-outline-info btn-sm change-status-btn"
                                            data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}" 
                                            data-current-status="{{ assignment.status }}">
                                        <i class="bi bi-gear me-1"></i>Status
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-assignment-btn"
                                            data-assignment-id="{{ assignment.id }}" data-assignment-title="{{ assignment.title }}">
                                        <i class="bi bi-trash me-1"></i>Remove
                                    </button>
                                    <a href="{{ url_for('teacher.view_class', class_id=assignment.class_id) }}" class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-eye me-1"></i>View Class
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            <h5>No Assignments Created</h5>
            <p>You haven't created any assignments yet. Create assignments for your classes to get started.</p>
            {% if classes %}
                <div class="mt-3">
                    <h6>Create an assignment for one of your classes:</h6>
                    <div class="row g-2">
                        {% for class in classes %}
                            <div class="col-12 col-sm-6 col-md-4">
                                <a href="{{ url_for('teacher.add_assignment', class_id=class.id) }}" class="btn btn-outline-primary btn-sm w-100">
                                    <i class="bi bi-plus-circle me-1"></i>{{ class.name }}
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Change Assignment Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Assignment: <strong id="statusAssignmentTitle"></strong></p>
                <p>Current Status: <span id="currentStatusBadge"></span></p>
                <form id="statusChangeForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            <option value="Active">Active - Students can submit work</option>
                            <option value="Inactive">Inactive - Students cannot submit work</option>
                            <option value="Voided">Voided - Does not affect grades (0/0 for all students)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Change Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the assignment "<span id="assignmentTitle"></span>"?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Assignment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle remove assignment button clicks
    const removeButtons = document.querySelectorAll('.remove-assignment-btn');
    const deleteModal = document.getElementById('deleteModal');
    const assignmentTitleSpan = document.getElementById('assignmentTitle');
    const deleteForm = document.getElementById('deleteForm');
    
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.getAttribute('data-assignment-id');
            const assignmentTitle = this.getAttribute('data-assignment-title');
            
            // Update modal content
            assignmentTitleSpan.textContent = assignmentTitle;
            
            // Update form action
            deleteForm.action = "{{ url_for('teacher.remove_assignment', assignment_id=0) }}".replace('0', assignmentId);
            
            // Show modal
            const modal = new bootstrap.Modal(deleteModal);
            modal.show();
        });
    });

    // Status change functionality
    const statusButtons = document.querySelectorAll('.change-status-btn');
    const statusModal = document.getElementById('statusChangeModal');
    const statusAssignmentTitle = document.getElementById('statusAssignmentTitle');
    const currentStatusBadge = document.getElementById('currentStatusBadge');
    const statusChangeForm = document.getElementById('statusChangeForm');
    const newStatusSelect = document.getElementById('newStatus');
    const confirmStatusChange = document.getElementById('confirmStatusChange');
    
    statusButtons.forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.dataset.assignmentId;
            const assignmentTitle = this.dataset.assignmentTitle;
            const currentStatus = this.dataset.currentStatus;
            
            // Update modal content
            statusAssignmentTitle.textContent = assignmentTitle;
            
            // Update current status badge
            let badgeClass = 'badge bg-secondary';
            if (currentStatus === 'Active') badgeClass = 'badge bg-success';
            else if (currentStatus === 'Inactive') badgeClass = 'badge bg-warning text-dark';
            else if (currentStatus === 'Voided') badgeClass = 'badge bg-danger';
            
            currentStatusBadge.innerHTML = `<span class="${badgeClass}">${currentStatus}</span>`;
            
            // Set current status as selected in dropdown
            newStatusSelect.value = currentStatus;
            
            // Update form action
            statusChangeForm.action = `{{ url_for('teacher.change_assignment_status', assignment_id=0) }}`.replace('0', assignmentId);
            
            // Show modal
            const modal = new bootstrap.Modal(statusModal);
            modal.show();
        });
    });
    
    confirmStatusChange.addEventListener('click', function() {
        const newStatus = newStatusSelect.value;
        const currentStatus = newStatusSelect.options[newStatusSelect.selectedIndex].text.split(' - ')[0];
        
        if (confirm(`Are you sure you want to change the status to "${currentStatus}"?`)) {
            statusChangeForm.submit();
        }
    });
});
</script>
{% endblock %}

<style>
/* Responsive Table for Assignments */
@media (max-width: 768px) {
  .assignments-table {
    border: 0;
  }
  .assignments-table thead {
    border: none;
    clip: rect(0 0 0 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }
  .assignments-table tr {
    border-bottom: 3px solid #ddd;
    display: block;
    margin-bottom: .625em;
    background-color: #f8f9fa;
    border-radius: .25rem;
    padding: .5rem;
  }
  .assignments-table td {
    border-bottom: 1px solid #ddd;
    display: block;
    font-size: .8em;
    text-align: right;
  }
  .assignments-table td::before {
    content: attr(data-label);
    float: left;
    font-weight: bold;
    text-transform: uppercase;
  }
  .assignments-table td:last-child {
    border-bottom: 0;
  }
}
</style> 