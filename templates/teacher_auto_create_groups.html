{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h3 class="mb-2 mb-md-0"><i class="bi bi-shuffle me-2"></i>Auto Create Groups - {{ class_obj.name }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('management.admin_class_groups', class_id=class_obj.id) if role_prefix else url_for('teacher.class_groups', class_id=class_obj.id) }}" class="btn btn-sm" style="border-color: #2E8B57; color: #2E8B57;">
        <i class="bi bi-arrow-left me-1"></i>Back to Groups
      </a>
    </div>
  </div>

  <!-- Student Overview -->
  <div class="row g-3 g-md-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 style="color: #2E8B57;">{{ students|length }}</h4>
          <p class="mb-0">Available Students</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-info" id="estimated-groups">0</h4>
          <p class="mb-0">Estimated Groups</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-warning" id="remaining-students">0</h4>
          <p class="mb-0">Remaining Students</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Auto Create Form -->
  <div class="card shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #228B22 0%, #2E8B57 50%, #556B2F 100%);">
      <h5 class="mb-0"><i class="bi bi-magic me-2"></i>Auto Group Creation Settings</h5>
    </div>
    <div class="card-body">
      <form method="POST" id="auto-create-form">
        { csrf_token() }
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="group_size" class="form-label">Group Size</label>
            <select class="form-select" id="group_size" name="group_size" required onchange="calculateGroups()">
              <option value="2">2 students per group</option>
              <option value="3" selected>3 students per group</option>
              <option value="4">4 students per group</option>
              <option value="5">5 students per group</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label for="grouping_criteria" class="form-label">Grouping Criteria</label>
            <select class="form-select" id="grouping_criteria" name="grouping_criteria" required>
              <option value="random" selected>Random Assignment</option>
              <option value="mixed_ability">Mixed Ability</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label for="group_prefix" class="form-label">Group Name Prefix</label>
            <input type="text" class="form-control" id="group_prefix" name="group_prefix" value="Group" required>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Preview</label>
            <div class="form-control-plaintext">
              <small class="text-muted">Groups will be named: <span id="preview-names">Group 1, Group 2, Group 3...</span></small>
            </div>
          </div>
        </div>

        <!-- Grouping Criteria Info -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="alert alert-info">
              <h6><i class="bi bi-info-circle me-2"></i>Grouping Criteria Explained:</h6>
              <ul class="mb-0">
                <li><strong>Random Assignment:</strong> Students are randomly distributed into groups</li>
                <li><strong>Mixed Ability:</strong> Groups are created to balance different skill levels (basic implementation)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Student List Preview -->
        <div class="row mt-3">
          <div class="col-12">
            <h6>Students to be grouped:</h6>
            <div class="row g-2" id="student-preview">
              {% for student in students %}
                <div class="col-6 col-md-4 col-lg-3">
                  <div class="card border-primary">
                    <div class="card-body p-2 text-center">
                      <small class="text-muted">{{ student.first_name }} {{ student.last_name }}</small>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-12">
            <button type="submit" class="btn btn-success btn-lg">
              <i class="bi bi-magic me-2"></i>Create Groups Automatically
            </button>
            <a href="{{ url_for('teacher.class_groups', class_id=class_obj.id) }}" class="btn btn-outline-secondary btn-lg ms-2">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function calculateGroups() {
  const groupSize = parseInt(document.getElementById('group_size').value);
  const totalStudents = {{ students|length }};
  const estimatedGroups = Math.floor(totalStudents / groupSize);
  const remainingStudents = totalStudents % groupSize;
  
  document.getElementById('estimated-groups').textContent = estimatedGroups;
  document.getElementById('remaining-students').textContent = remainingStudents;
  
  // Update preview names
  const prefix = document.getElementById('group_prefix').value || 'Group';
  let previewText = '';
  for (let i = 1; i <= estimatedGroups; i++) {
    previewText += `${prefix} ${i}`;
    if (i < estimatedGroups) previewText += ', ';
  }
  if (remainingStudents > 0) {
    previewText += ` (${remainingStudents} students will be distributed)`;
  }
  document.getElementById('preview-names').textContent = previewText;
}

// Update preview when prefix changes
document.getElementById('group_prefix').addEventListener('input', calculateGroups);

// Calculate initial values
calculateGroups();
</script>
{% endblock %}
