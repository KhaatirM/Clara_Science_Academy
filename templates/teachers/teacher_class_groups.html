{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teachers_teacher_class_groups.css') }}">
{% endblock %}

{% block title %}Manage Groups - {{ class_obj.name }}{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <!-- Animated Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% if role_prefix %}{{ url_for('management.view_class', class_id=class_obj.id) }}{% else %}{{ url_for('teacher.dashboard.view_class', class_id=class_obj.id) }}{% endif %}" class="text-decoration-none"><i class="bi bi-arrow-left me-1"></i>Back to Class</a></li>
                    <li class="breadcrumb-item active">Manage Groups</li>
                </ol>
            </nav>
            <div class="header-card animated-fade-in">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="header-icon-wrapper me-3">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div>
                            <h2 class="mb-1 fw-bold">Manage Groups</h2>
                            <p class="text-muted mb-0"><i class="bi bi-book me-2"></i>{{ class_obj.name }} - {{ class_obj.subject if class_obj.subject else 'N/A' }}</p>
                        </div>
                    </div>
                    <button class="btn btn-create-group" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="bi bi-plus-circle me-2"></i>Create Group
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stat-card stat-card-primary animated-fade-in" style="animation-delay: 0.1s;">
                <div class="stat-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div>
                    <div class="stat-value">{{ groups|length }}</div>
                    <div class="stat-label">Total Groups</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card stat-card-success animated-fade-in" style="animation-delay: 0.2s;">
                <div class="stat-icon">
                    <i class="bi bi-person-check"></i>
                </div>
                <div>
                    <div class="stat-value">{{ students|length }}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card stat-card-info animated-fade-in" style="animation-delay: 0.3s;">
                <div class="stat-icon">
                    <i class="bi bi-activity"></i>
                </div>
                <div>
                    <div class="stat-value">{{ (groups|map(attribute='member_count')|sum / groups|length)|round(1) if groups else 0 }}</div>
                    <div class="stat-label">Avg Group Size</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Groups List -->
    <div class="row g-4">
        {% for group in groups %}
        <div class="col-md-6 col-lg-4 animated-fade-in" style="animation-delay: {{ loop.index * 0.05 }}s;">
            <div class="group-card">
                <div class="group-card-header">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="group-icon-badge">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <span class="member-count-badge">
                            <i class="bi bi-person-fill me-1"></i>{{ group.member_count }}
                        </span>
                    </div>
                    <h5 class="group-title mb-2">{{ group.name }}</h5>
                    {% if group.description %}
                    <p class="group-description">{{ group.description }}</p>
                    {% else %}
                    <p class="group-description text-muted">No description provided</p>
                    {% endif %}
                </div>
                <div class="group-card-body">
                    <!-- Members List -->
                    <div class="members-section mb-3">
                        <div class="members-header mb-2">
                            <i class="bi bi-people me-2"></i>
                            <span class="fw-semibold">Members</span>
                        </div>
                        {% if group.members_list %}
                        <div class="members-list">
                            {% for member_data in group.members_list %}
                            {% set member = member_data.student if member_data.student else member_data %}
                            {% set is_leader = member_data.is_leader if member_data.is_leader is defined else False %}
                            <div class="member-item">
                                <div class="member-avatar">
                                    {{ member.first_name[0] }}{{ member.last_name[0] }}
                                </div>
                                <div class="d-flex align-items-center flex-grow-1">
                                    <span class="member-name">{{ member.first_name }} {{ member.last_name }}</span>
                                    {% if is_leader %}
                                    <span class="badge bg-warning text-dark ms-2" title="Group Leader">
                                        <i class="bi bi-star-fill me-1"></i>Leader
                                    </span>
                                    {% else %}
                                    <form method="POST" action="{% if role_prefix %}{{ url_for('management.admin_manage_group', group_id=group.id) }}{% else %}{{ url_for('teacher.groups.set_leader', group_id=group.id) }}{% endif %}" 
                                          style="display: inline;" 
                                          class="ms-2">
                                        {% if role_prefix %}
                                        <input type="hidden" name="action" value="set_leader">
                                        {% endif %}
                                        <input type="hidden" name="student_id" value="{{ member.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-warning" 
                                                title="Set as Group Leader"
                                                onclick="return confirm('Set {{ member.first_name }} as group leader?');">
                                            <i class="bi bi-star"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                <form method="POST" action="{% if role_prefix %}{{ url_for('management.admin_manage_group', group_id=group.id) }}{% else %}{{ url_for('teacher.groups.remove_member', group_id=group.id, student_id=member.id) }}{% endif %}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Remove {{ member.first_name }} from the group?');">
                                    {% if role_prefix %}
                                    <input type="hidden" name="action" value="remove_student">
                                    <input type="hidden" name="student_id" value="{{ member.id }}">
                                    {% endif %}
                                    <button type="submit" class="btn-remove-member">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No members yet</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="group-actions">
                        <button class="btn-action btn-action-add" 
                                data-bs-toggle="modal" 
                                data-bs-target="#addMemberModal{{ group.id }}">
                            <i class="bi bi-person-plus me-2"></i>Add Members
                        </button>
                        <button class="btn-action btn-action-edit" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editGroupModal{{ group.id }}">
                            <i class="bi bi-pencil me-2"></i>Edit
                        </button>
                        <form method="POST" action="{% if role_prefix %}{{ url_for('management.admin_delete_group', group_id=group.id) }}{% else %}{{ url_for('teacher.groups.delete_group', group_id=group.id) }}{% endif %}" 
                              onsubmit="return confirm('Are you sure you want to delete {{ group.name }}?');"
                              style="flex: 1;">
                            <button type="submit" class="btn-action btn-action-delete w-100">
                                <i class="bi bi-trash me-2"></i>Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Member Modal for this group -->
        <div class="modal fade" id="addMemberModal{{ group.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Members to {{ group.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{% if role_prefix %}{{ url_for('management.admin_manage_group', group_id=group.id) }}{% else %}{{ url_for('teacher.groups.add_member', group_id=group.id) }}{% endif %}">
                        {% if role_prefix %}
                        <input type="hidden" name="action" value="add_student">
                        {% endif %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select Students (You can select multiple)</label>
                                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    {% set existing_member_ids = [] %}
                                    {% for member_data in group.members_list %}
                                        {% if member_data.student %}
                                            {% set _ = existing_member_ids.append(member_data.student.id) %}
                                        {% elif member_data.id %}
                                            {% set _ = existing_member_ids.append(member_data.id) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set available_students = [] %}
                                    {% for student in students %}
                                        {% if student.id not in existing_member_ids %}
                                            {% set _ = available_students.append(student) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if available_students %}
                                        {% for student in available_students %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="student_ids" 
                                                   value="{{ student.id }}" 
                                                   id="student_{{ group.id }}_{{ student.id }}">
                                            <label class="form-check-label" for="student_{{ group.id }}_{{ student.id }}">
                                                {{ student.first_name }} {{ student.last_name }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted mb-0">All students are already in this group.</p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="leader_id{{ group.id }}" class="form-label">Select Group Leader (Optional)</label>
                                <select class="form-select" id="leader_id{{ group.id }}" name="leader_id">
                                    <option value="">No leader (or select after adding members)</option>
                                    {% for student in available_students %}
                                    <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">You can also set a leader after adding members.</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Selected Members</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Group Modal -->
        <div class="modal fade" id="editGroupModal{{ group.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Group: {{ group.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{% if role_prefix %}{{ url_for('management.admin_manage_group', group_id=group.id) }}{% else %}{{ url_for('teacher.groups.edit_group', group_id=group.id) }}{% endif %}">
                        {% if role_prefix %}
                        <input type="hidden" name="action" value="edit_group">
                        {% endif %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="edit_name{{ group.id }}" class="form-label">Group Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="edit_name{{ group.id }}" name="name" 
                                       value="{{ group.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit_description{{ group.id }}" class="form-label">Description</label>
                                <textarea class="form-control" id="edit_description{{ group.id }}" name="description" rows="3">{{ group.description or '' }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit_max_students{{ group.id }}" class="form-label">Maximum Students (Optional)</label>
                                <input type="number" class="form-control" id="edit_max_students{{ group.id }}" 
                                       name="max_students" min="1" value="{{ group.max_students or '' }}">
                                <small class="text-muted">Leave empty for unlimited</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not groups %}
    <div class="col-12">
        <div class="empty-state-large">
            <div class="empty-state-icon">
                <i class="bi bi-people"></i>
            </div>
            <h4>No Groups Yet</h4>
            <p class="text-muted">Get started by creating your first group for collaborative work!</p>
            <button class="btn btn-create-group" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                <i class="bi bi-plus-circle me-2"></i>Create Your First Group
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% if current_user.role in ['Director', 'School Administrator'] %}{{ url_for('management.admin_create_student_group', class_id=class_obj.id) }}{% else %}{{ url_for('teacher.groups.create_group', class_id=class_obj.id) }}{% endif %}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Group Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="max_students" class="form-label">Maximum Students (Optional)</label>
                        <input type="number" class="form-control" id="max_students" name="max_students" min="1">
                        <small class="text-muted">Leave empty for unlimited</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}
