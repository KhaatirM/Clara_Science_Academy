{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h3 class="mb-2 mb-md-0"><i class="bi bi-file-text me-2"></i>Create Group Contract - {{ group.name }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('teacher.manage_group', group_id=group.id) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Group
      </a>
    </div>
  </div>

  <!-- Group Info -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
      <h6 class="mb-0"><i class="bi bi-people me-2"></i>Group Information</h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <strong>Group Name:</strong> {{ group.name }}
        </div>
        <div class="col-12 col-md-6">
          <strong>Members:</strong> {{ group.members|length }} students
        </div>
        {% if group.description %}
          <div class="col-12">
            <strong>Description:</strong> {{ group.description }}
          </div>
        {% endif %}
        <div class="col-12">
          <strong>Group Members:</strong>
          <div class="mt-2">
            {% for member in group.members %}
              <span class="badge bg-primary me-1">
                {{ member.student.first_name }} {{ member.student.last_name }}
                {% if member.is_leader %}(Leader){% endif %}
              </span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contract Creation Form -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Group Contract Terms</h5>
    </div>
    <div class="card-body">
      <form method="POST" id="contract-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6">
            <label for="assignment_id" class="form-label">Associated Assignment (Optional)</label>
            <select class="form-select" id="assignment_id" name="assignment_id">
              <option value="">No specific assignment</option>
              {% for assignment in assignments %}
                <option value="{{ assignment.id }}">{{ assignment.title }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Link this contract to a specific assignment.</div>
          </div>
        </div>

        <!-- Contract Terms -->
        <div class="row mb-4">
          <div class="col-12">
            <h6><i class="bi bi-list-ul me-2"></i>Contract Terms</h6>
            <p class="text-muted">Define the rules, expectations, and responsibilities for this group.</p>
          </div>
        </div>

        <!-- Pre-defined Contract Sections -->
        <div class="row g-3 mb-4">
          <div class="col-12">
            <div class="card border-light">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Group Responsibilities</h6>
              </div>
              <div class="card-body">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="responsibility_attendance" checked>
                  <label class="form-check-label" for="responsibility_attendance">
                    All members will attend group meetings and contribute actively
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="responsibility_deadlines" checked>
                  <label class="form-check-label" for="responsibility_deadlines">
                    All members will meet agreed-upon deadlines
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="responsibility_communication" checked>
                  <label class="form-check-label" for="responsibility_communication">
                    All members will communicate respectfully and constructively
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="responsibility_quality" checked>
                  <label class="form-check-label" for="responsibility_quality">
                    All members will maintain high quality standards in their work
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12">
            <div class="card border-light">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Meeting & Communication</h6>
              </div>
              <div class="card-body">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="meeting_schedule" checked>
                  <label class="form-check-label" for="meeting_schedule">
                    Group will establish regular meeting times
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="meeting_attendance" checked>
                  <label class="form-check-label" for="meeting_attendance">
                    Members will give 24-hour notice if unable to attend meetings
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="meeting_communication" checked>
                  <label class="form-check-label" for="meeting_communication">
                    Group will use agreed-upon communication channels
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12">
            <div class="card border-light">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Conflict Resolution</h6>
              </div>
              <div class="card-body">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="conflict_discussion" checked>
                  <label class="form-check-label" for="conflict_discussion">
                    Group will discuss conflicts openly and respectfully
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="conflict_teacher" checked>
                  <label class="form-check-label" for="conflict_teacher">
                    Group will seek teacher assistance if conflicts cannot be resolved
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="conflict_focus" checked>
                  <label class="form-check-label" for="conflict_focus">
                    Group will focus on solutions rather than blame
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Custom Terms -->
        <div class="row mb-4">
          <div class="col-12">
            <label for="contract_terms" class="form-label">Additional Terms & Conditions</label>
            <textarea class="form-control" id="contract_terms" name="contract_terms" rows="6" 
                      placeholder="Add any additional terms, expectations, or special agreements for this group..."></textarea>
            <div class="form-text">Include any specific requirements, consequences, or special arrangements.</div>
          </div>
        </div>

        <!-- Contract Preview -->
        <div class="row mb-4">
          <div class="col-12">
            <h6>Contract Preview:</h6>
            <div class="card border-info">
              <div class="card-header bg-light">
                <strong>Group Contract - {{ group.name }}</strong>
              </div>
              <div class="card-body">
                <div id="contract-preview">
                  <p class="text-muted">Contract terms will appear here...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-file-text me-2"></i>Create Group Contract
            </button>
            <a href="{{ url_for('teacher.manage_group', group_id=group.id) }}" class="btn btn-outline-secondary btn-lg ms-2">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Contract Tips -->
  <div class="row g-3 g-md-4 mt-4">
    <div class="col-12 col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Contract Benefits</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Establishes clear expectations</li>
            <li>Prevents misunderstandings</li>
            <li>Provides conflict resolution framework</li>
            <li>Encourages accountability</li>
            <li>Improves group dynamics</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-white">
          <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Best Practices</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Keep terms clear and specific</li>
            <li>Include measurable expectations</li>
            <li>Address potential conflicts upfront</li>
            <li>Set realistic deadlines and goals</li>
            <li>Review and update as needed</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Update contract preview
function updateContractPreview() {
  const previewContainer = document.getElementById('contract-preview');
  let previewHTML = '<h6>Group Responsibilities:</h6><ul>';
  
  // Check selected responsibilities
  const responsibilities = [
    { id: 'responsibility_attendance', text: 'All members will attend group meetings and contribute actively' },
    { id: 'responsibility_deadlines', text: 'All members will meet agreed-upon deadlines' },
    { id: 'responsibility_communication', text: 'All members will communicate respectfully and constructively' },
    { id: 'responsibility_quality', text: 'All members will maintain high quality standards in their work' }
  ];
  
  responsibilities.forEach(resp => {
    if (document.getElementById(resp.id).checked) {
      previewHTML += `<li>${resp.text}</li>`;
    }
  });
  previewHTML += '</ul>';
  
  // Check selected meeting terms
  previewHTML += '<h6>Meeting & Communication:</h6><ul>';
  const meetings = [
    { id: 'meeting_schedule', text: 'Group will establish regular meeting times' },
    { id: 'meeting_attendance', text: 'Members will give 24-hour notice if unable to attend meetings' },
    { id: 'meeting_communication', text: 'Group will use agreed-upon communication channels' }
  ];
  
  meetings.forEach(meeting => {
    if (document.getElementById(meeting.id).checked) {
      previewHTML += `<li>${meeting.text}</li>`;
    }
  });
  previewHTML += '</ul>';
  
  // Check selected conflict resolution terms
  previewHTML += '<h6>Conflict Resolution:</h6><ul>';
  const conflicts = [
    { id: 'conflict_discussion', text: 'Group will discuss conflicts openly and respectfully' },
    { id: 'conflict_teacher', text: 'Group will seek teacher assistance if conflicts cannot be resolved' },
    { id: 'conflict_focus', text: 'Group will focus on solutions rather than blame' }
  ];
  
  conflicts.forEach(conflict => {
    if (document.getElementById(conflict.id).checked) {
      previewHTML += `<li>${conflict.text}</li>`;
    }
  });
  previewHTML += '</ul>';
  
  // Add custom terms
  const customTerms = document.getElementById('contract_terms').value.trim();
  if (customTerms) {
    previewHTML += '<h6>Additional Terms:</h6>';
    previewHTML += `<p>${customTerms.replace(/\n/g, '<br>')}</p>`;
  }
  
  previewContainer.innerHTML = previewHTML;
}

// Add event listeners to all checkboxes and textarea
document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
  checkbox.addEventListener('change', updateContractPreview);
});

document.getElementById('contract_terms').addEventListener('input', updateContractPreview);

// Initial preview update
updateContractPreview();
</script>
{% endblock %}
