{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h3 class="mb-2 mb-md-0"><i class="bi bi-plus-circle me-2"></i>Create Peer Review</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('teacher.view_peer_reviews', assignment_id=group_assignment.id) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Reviews
      </a>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Peer Review Form</h5>
        </div>
        <div class="card-body">
          <!-- Assignment Info -->
          <div class="alert alert-info mb-4">
            <h6><i class="bi bi-info-circle me-2"></i>Assignment: {{ group_assignment.title }}</h6>
            <p class="mb-0">{{ group_assignment.description }}</p>
          </div>

          <form method="POST" id="reviewForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Student Selection -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <h6 class="text-primary border-bottom pb-2 mb-3">
                  <i class="bi bi-people me-2"></i>Student Selection
                </h6>
              </div>
              <div class="col-12 col-md-6">
                <label for="group_id" class="form-label">Group <span class="text-danger">*</span></label>
                <select class="form-select" id="group_id" name="group_id" required onchange="updateStudents()">
                  <option value="">Select Group</option>
                  {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label for="reviewer_id" class="form-label">Reviewer (Student doing the review) <span class="text-danger">*</span></label>
                <select class="form-select" id="reviewer_id" name="reviewer_id" required>
                  <option value="">Select Reviewer</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label for="reviewee_id" class="form-label">Reviewee (Student being reviewed) <span class="text-danger">*</span></label>
                <select class="form-select" id="reviewee_id" name="reviewee_id" required>
                  <option value="">Select Reviewee</option>
                </select>
              </div>
            </div>

            <!-- Scoring -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <h6 class="text-primary border-bottom pb-2 mb-3">
                  <i class="bi bi-star me-2"></i>Scoring (1-5 Scale)
                </h6>
              </div>
              <div class="col-12 col-md-6">
                <label for="work_quality_score" class="form-label">Work Quality <span class="text-danger">*</span></label>
                <select class="form-select" id="work_quality_score" name="work_quality_score" required>
                  <option value="">Select Score</option>
                  <option value="1">1 - Poor</option>
                  <option value="2">2 - Below Average</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Excellent</option>
                </select>
                <div class="form-text">How well was the work completed?</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="creativity_score" class="form-label">Creativity <span class="text-danger">*</span></label>
                <select class="form-select" id="creativity_score" name="creativity_score" required>
                  <option value="">Select Score</option>
                  <option value="1">1 - Poor</option>
                  <option value="2">2 - Below Average</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Excellent</option>
                </select>
                <div class="form-text">How creative and original was the work?</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="presentation_score" class="form-label">Presentation <span class="text-danger">*</span></label>
                <select class="form-select" id="presentation_score" name="presentation_score" required>
                  <option value="">Select Score</option>
                  <option value="1">1 - Poor</option>
                  <option value="2">2 - Below Average</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Excellent</option>
                </select>
                <div class="form-text">How well was the work presented?</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="overall_score" class="form-label">Overall Score <span class="text-danger">*</span></label>
                <select class="form-select" id="overall_score" name="overall_score" required>
                  <option value="">Select Score</option>
                  <option value="1">1 - Poor</option>
                  <option value="2">2 - Below Average</option>
                  <option value="3">3 - Average</option>
                  <option value="4">4 - Good</option>
                  <option value="5">5 - Excellent</option>
                </select>
                <div class="form-text">Overall assessment of the work</div>
              </div>
            </div>

            <!-- Feedback -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <h6 class="text-primary border-bottom pb-2 mb-3">
                  <i class="bi bi-chat-dots me-2"></i>Feedback
                </h6>
              </div>
              <div class="col-12">
                <label for="constructive_feedback" class="form-label">Constructive Feedback</label>
                <textarea class="form-control" id="constructive_feedback" name="constructive_feedback" rows="4" placeholder="Provide specific, constructive feedback on the work..."></textarea>
                <div class="form-text">Be specific and helpful in your feedback</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="strengths" class="form-label">Strengths</label>
                <textarea class="form-control" id="strengths" name="strengths" rows="3" placeholder="What did the student do well?"></textarea>
                <div class="form-text">Highlight positive aspects</div>
              </div>
              <div class="col-12 col-md-6">
                <label for="improvements" class="form-label">Areas for Improvement</label>
                <textarea class="form-control" id="improvements" name="improvements" rows="3" placeholder="What could be improved?"></textarea>
                <div class="form-text">Suggest specific improvements</div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>Save Review
              </button>
              <a href="{{ url_for('teacher.view_peer_reviews', assignment_id=group_assignment.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i>Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Help Panel -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Review Guidelines</h6>
        </div>
        <div class="card-body">
          <h6>Scoring Guidelines</h6>
          <ul class="mb-3 small">
            <li><strong>1 - Poor:</strong> Work doesn't meet basic requirements</li>
            <li><strong>2 - Below Average:</strong> Work meets minimal requirements</li>
            <li><strong>3 - Average:</strong> Work meets expectations</li>
            <li><strong>4 - Good:</strong> Work exceeds expectations</li>
            <li><strong>5 - Excellent:</strong> Work is outstanding</li>
          </ul>
          
          <h6>Feedback Tips</h6>
          <ul class="mb-3 small">
            <li>Be specific and constructive</li>
            <li>Focus on the work, not the person</li>
            <li>Provide actionable suggestions</li>
            <li>Balance criticism with praise</li>
            <li>Use respectful language</li>
          </ul>
          
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Remember:</strong> Peer reviews should be helpful and educational.
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-star me-2"></i>Quick Score Templates</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-success btn-sm" onclick="setQuickScore('excellent')">
              <i class="bi bi-star-fill me-1"></i>Excellent Work
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setQuickScore('good')">
              <i class="bi bi-star me-1"></i>Good Work
            </button>
            <button type="button" class="btn btn-outline-warning btn-sm" onclick="setQuickScore('average')">
              <i class="bi bi-star-half me-1"></i>Average Work
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="setQuickScore('needs_work')">
              <i class="bi bi-star me-1"></i>Needs Work
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Store students data for each group
const groupStudents = {
  {% for group in groups %}
    {{ group.id }}: [
      {% for member in group.members %}
        {id: {{ member.student.id }}, name: "{{ member.student.first_name }} {{ member.student.last_name }}"},
      {% endfor %}
    ],
  {% endfor %}
};

function updateStudents() {
  const groupId = document.getElementById('group_id').value;
  const reviewerSelect = document.getElementById('reviewer_id');
  const revieweeSelect = document.getElementById('reviewee_id');
  
  // Clear existing options
  reviewerSelect.innerHTML = '<option value="">Select Reviewer</option>';
  revieweeSelect.innerHTML = '<option value="">Select Reviewee</option>';
  
  if (groupId && groupStudents[groupId]) {
    const students = groupStudents[groupId];
    
    students.forEach(student => {
      const reviewerOption = new Option(student.name, student.id);
      const revieweeOption = new Option(student.name, student.id);
      
      reviewerSelect.add(reviewerOption);
      revieweeSelect.add(revieweeOption);
    });
  }
}

function setQuickScore(type) {
  const workQuality = document.getElementById('work_quality_score');
  const creativity = document.getElementById('creativity_score');
  const presentation = document.getElementById('presentation_score');
  const overall = document.getElementById('overall_score');
  
  switch(type) {
    case 'excellent':
      workQuality.value = '5';
      creativity.value = '5';
      presentation.value = '5';
      overall.value = '5';
      break;
      
    case 'good':
      workQuality.value = '4';
      creativity.value = '4';
      presentation.value = '4';
      overall.value = '4';
      break;
      
    case 'average':
      workQuality.value = '3';
      creativity.value = '3';
      presentation.value = '3';
      overall.value = '3';
      break;
      
    case 'needs_work':
      workQuality.value = '2';
      creativity.value = '2';
      presentation.value = '2';
      overall.value = '2';
      break;
  }
}
</script>
{% endblock %}
