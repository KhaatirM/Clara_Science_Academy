{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/teacher_grade_assignment.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/teachers_teacher_grade_assignment.css') }}">
<style>
.quiz-question-card {
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
}
.quiz-answer-section {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-top: 0.5rem;
}
.auto-graded-correct {
    color: #198754;
    font-weight: bold;
}
.auto-graded-incorrect {
    color: #dc3545;
    font-weight: bold;
}
.question-points-input {
    max-width: 100px;
}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
    <!-- Enhanced Header -->
    <div class="grading-header mb-4">
        <div class="grading-header-content">
            <div class="grading-header-icon">
                <i class="bi bi-question-circle"></i>
            </div>
            <div class="grading-header-info">
                <h2 class="grading-header-title">{{ assignment.title }}</h2>
                <p class="grading-header-subtitle">{{ class_obj.name }} • {{ assignment.quarter }} • Quiz Assignment</p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('teacher.grading.grade_statistics', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-info">
                <i class="bi bi-bar-chart-fill me-1"></i>Statistics
            </a>
            <button onclick="goBack()" class="btn-grading-back">
                <i class="bi bi-arrow-left me-2"></i>Back
            </button>
        </div>
    </div>

    <!-- Assignment Stats Bar -->
    <div class="grading-stats-bar mb-4">
        <div class="grading-stat-card stat-total">
            <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ students|length }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>
        <div class="grading-stat-card stat-submitted">
            <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ submissions|length }}</div>
                <div class="stat-label">Submitted</div>
            </div>
        </div>
        <div class="grading-stat-card stat-graded">
            <div class="stat-icon"><i class="bi bi-star-fill"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="gradedStatCount">{{ grades|length }}</div>
                <div class="stat-label">Graded</div>
            </div>
        </div>
        <div class="grading-stat-card stat-pending">
            <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="pendingStatCount">{{ students|length - grades|length }}</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        <div class="grading-stat-card stat-average">
            <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
            <div class="stat-content">
                <div class="stat-value" id="averageStatValue">
                    {% set total_score = 0 %}
                    {% set count = 0 %}
                    {% for student_id, grade_data in grades.items() %}
                        {% if grade_data.percentage %}
                            {% set total_score = total_score + grade_data.percentage %}
                            {% set count = count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ (total_score / count)|round(1) if count > 0 else '--' }}%
                </div>
                <div class="stat-label">Average</div>
            </div>
        </div>
    </div>

    <form method="POST" id="quizGradingForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="grading_mode" value="per_question"/>
        
        <div class="student-grading-cards">
            {% for student in students %}
                {% set submission = submissions.get(student.id) %}
                {% set grade_data = grades.get(student.id) %}
                {% set student_answers = quiz_answers_by_student.get(student.id, {}) %}
                
                {% set is_voided = false %}
                {% set points_earned = 0 %}
                {% set total_points = assignment.total_points if assignment.total_points else 100.0 %}
                {% set percentage_value = 0 %}
                {% set comment_data = '' %}
                
                {% if grade_data %}
                    {% set is_voided = grade_data.is_voided|default(false) %}
                    {% set points_earned = grade_data.points_earned|default(grade_data.score|default(0))|float %}
                    {# Use total_points from grade_data for quizzes (actual quiz total), not assignment.total_points #}
                    {% set total_points = grade_data.total_points|default(grade_data.max_score|default(assignment.total_points if assignment.total_points else 100.0))|float %}
                    {% set percentage_value = grade_data.percentage|default(0)|float %}
                    {% if not percentage_value and points_earned > 0 and total_points > 0 %}
                        {% set percentage_value = (points_earned / total_points * 100)|round(2) %}
                    {% endif %}
                    {% set comment_data = grade_data.comment|default('') or grade_data.feedback|default('') %}
                {% endif %}
                
                {% set performance_class = 'voided' if is_voided else ('excellent' if percentage_value >= 90 else ('good' if percentage_value >= 80 else ('warning' if percentage_value >= 70 else ('failing' if percentage_value > 0 else 'ungraded')))) %}
                
                <div class="student-grade-card {{ performance_class }}{% if is_voided %} voided-disabled{% endif %}" data-student-id="{{ student.id }}">
                    <div class="student-grade-header">
                        <div class="student-grade-avatar">
                            {{ student.first_name[0] if student.first_name else '?' }}{{ student.last_name[0] if student.last_name else '?' }}
                        </div>
                        <div class="student-grade-info">
                            <div class="student-grade-name">{{ student.first_name }} {{ student.last_name }}</div>
                            <div class="student-grade-email">{{ student.email or 'No email' }}</div>
                        </div>
                        <div class="student-grade-score">
                            {% if points_earned > 0 %}
                                <div class="score-display">
                                    <span class="score-value">{{ points_earned|round(1) }} / {{ total_points|int }}</span>
                                    <span class="score-percentage">({{ percentage_value|round(1) }}%)</span>
                                </div>
                            {% else %}
                                <div class="score-display">
                                    <span class="score-value">-- / {{ total_points|int }}</span>
                                    <span class="score-percentage">Not Graded</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="student-grade-body">
                        <!-- Submission Status -->
                        <div class="mb-3">
                            <label class="grade-label">
                                <i class="bi bi-clipboard-check"></i> Submission Status
                            </label>
                            {% if submission %}
                                <span class="badge bg-success">Submitted</span>
                                <small class="text-muted ms-2">{{ submission.submitted_at.strftime('%B %d, %Y at %I:%M %p') if submission.submitted_at else '' }}</small>
                            {% else %}
                                <span class="badge bg-warning">Not Submitted</span>
                            {% endif %}
                        </div>
                        
                        <!-- Quiz Questions and Answers -->
                        {% if quiz_questions %}
                            <div class="quiz-questions-section">
                                <h6 class="mb-3"><i class="bi bi-list-ul me-2"></i>Questions & Answers</h6>
                                
                                {% for question in quiz_questions %}
                                    {% set answer = student_answers.get(question.id) %}
                                    <div class="quiz-question-card card mb-3">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Question {{ loop.index }}</strong>
                                                <span class="badge bg-secondary ms-2">{{ question.points }} pts</span>
                                                <span class="badge bg-info ms-2">{{ question.question_type.replace('_', ' ').title() }}</span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="question-text mb-3">
                                                <strong>{{ question.question_text }}</strong>
                                            </div>
                                            
                                            {% if question.question_type == 'multiple_choice' %}
                                                <!-- Multiple Choice Answer -->
                                                <div class="quiz-answer-section">
                                                    {% if answer %}
                                                        {% set selected_option = answer.selected_option %}
                                                        {% set question_options = question.options|list %}
                                                        {% for option in question_options %}
                                                            <div class="form-check mb-2 {% if option.is_correct %}bg-success bg-opacity-10{% elif selected_option and selected_option.id == option.id %}bg-danger bg-opacity-10{% endif %} p-2 rounded">
                                                                <input class="form-check-input" type="radio" disabled {% if selected_option and selected_option.id == option.id %}checked{% endif %}>
                                                                <label class="form-check-label w-100">
                                                                    {% if option.is_correct %}<i class="bi bi-check-circle-fill text-success me-2"></i>{% endif %}
                                                                    {% if selected_option and selected_option.id == option.id and not option.is_correct %}<i class="bi bi-x-circle-fill text-danger me-2"></i>{% endif %}
                                                                    {{ option.option_text }}
                                                                    {% if option.is_correct %}<span class="badge bg-success ms-2">Correct</span>{% endif %}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                        <div class="mt-2">
                                                            {% if answer.is_correct %}
                                                                <span class="auto-graded-correct"><i class="bi bi-check-circle me-1"></i>Correct - {{ answer.points_earned|round(1) }} / {{ question.points }} points</span>
                                                            {% else %}
                                                                <span class="auto-graded-incorrect"><i class="bi bi-x-circle me-1"></i>Incorrect - 0 / {{ question.points }} points</span>
                                                            {% endif %}
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted mb-0">No answer submitted</p>
                                                        <span class="badge bg-secondary">0 / {{ question.points }} points</span>
                                                    {% endif %}
                                                </div>
                                            
                                            {% elif question.question_type == 'true_false' %}
                                                <!-- True/False Answer -->
                                                <div class="quiz-answer-section">
                                                    {% if answer %}
                                                        {% set selected_option = answer.selected_option %}
                                                        {% set question_options = question.options|list %}
                                                        {% for option in question_options %}
                                                            <div class="form-check mb-2 {% if option.is_correct %}bg-success bg-opacity-10{% elif selected_option and selected_option.id == option.id %}bg-danger bg-opacity-10{% endif %} p-2 rounded">
                                                                <input class="form-check-input" type="radio" disabled {% if selected_option and selected_option.id == option.id %}checked{% endif %}>
                                                                <label class="form-check-label w-100">
                                                                    {% if option.is_correct %}<i class="bi bi-check-circle-fill text-success me-2"></i>{% endif %}
                                                                    {% if selected_option and selected_option.id == option.id and not option.is_correct %}<i class="bi bi-x-circle-fill text-danger me-2"></i>{% endif %}
                                                                    {{ option.option_text }}
                                                                    {% if option.is_correct %}<span class="badge bg-success ms-2">Correct</span>{% endif %}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                        <div class="mt-2">
                                                            {% if answer.is_correct %}
                                                                <span class="auto-graded-correct"><i class="bi bi-check-circle me-1"></i>Correct - {{ answer.points_earned|round(1) }} / {{ question.points }} points</span>
                                                            {% else %}
                                                                <span class="auto-graded-incorrect"><i class="bi bi-x-circle me-1"></i>Incorrect - 0 / {{ question.points }} points</span>
                                                            {% endif %}
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted mb-0">No answer submitted</p>
                                                        <span class="badge bg-secondary">0 / {{ question.points }} points</span>
                                                    {% endif %}
                                                </div>
                                            
                                            {% elif question.question_type in ['short_answer', 'essay'] %}
                                                <!-- Short Answer / Essay - Manual Grading -->
                                                <div class="quiz-answer-section">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Student's Answer:</label>
                                                        {% if answer and answer.answer_text %}
                                                            <div class="p-3 bg-white border rounded">
                                                                {{ answer.answer_text }}
                                                            </div>
                                                        {% else %}
                                                            <p class="text-muted mb-0">No answer submitted</p>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="row align-items-end">
                                                        <div class="col-md-6">
                                                            <label class="form-label fw-bold">
                                                                Points (0 - {{ question.points }})
                                                            </label>
                                                            <input type="number" 
                                                                   class="form-control question-points-input" 
                                                                   name="points_{{ student.id }}_q{{ question.id }}"
                                                                   min="0" 
                                                                   max="{{ question.points }}" 
                                                                   step="0.1"
                                                                   value="{{ answer.points_earned if answer else 0 }}"
                                                                   onchange="updateStudentTotalScore({{ student.id }})">
                                                            <small class="text-muted">Out of {{ question.points }} points</small>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div id="questionScoreDisplay_{{ student.id }}_q{{ question.id }}" class="text-muted">
                                                                {% if answer %}
                                                                    Current: {{ answer.points_earned|round(1) }} / {{ question.points }}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Overall Feedback -->
                        <div class="mt-3">
                            <label class="grade-label">
                                <i class="bi bi-chat-left-text"></i> Feedback/Comments
                            </label>
                            <textarea class="form-control" name="comment_{{ student.id }}" rows="3" placeholder="Enter feedback for this student...">{{ comment_data }}</textarea>
                        </div>
                        
                        <!-- Total Score Display (Calculated) -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total Score:</strong>
                                <div>
                                    <span id="studentTotalScore_{{ student.id }}" class="fs-5 fw-bold">
                                        {{ points_earned|round(1) if points_earned > 0 else '0.0' }}
                                    </span>
                                    <span class="text-muted"> / {{ total_points|int }}</span>
                                    <span class="ms-2" id="studentTotalPercentage_{{ student.id }}">
                                        ({{ percentage_value|round(1) if percentage_value > 0 else '0.0' }}%)
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Save Button -->
        <div class="d-flex justify-content-end gap-2 mt-4 mb-4">
            <button type="button" class="btn btn-secondary" onclick="goBack()">Cancel</button>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save me-2"></i>Save All Grades
            </button>
        </div>
    </form>
</div>

<script>
function goBack() {
    window.history.back();
}

function updateStudentTotalScore(studentId) {
    // Calculate total score from all question inputs for this student
    const questionInputs = document.querySelectorAll(`input[name^="points_${studentId}_q"]`);
    let totalScore = 0;
    
    questionInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        totalScore += value;
    });
    
    // Update display
    const totalDisplay = document.getElementById(`studentTotalScore_${studentId}`);
    const percentageDisplay = document.getElementById(`studentTotalPercentage_${studentId}`);
    
    if (totalDisplay) {
        const totalPoints = {{ assignment.total_points if assignment.total_points else 100.0 }};
        totalDisplay.textContent = totalScore.toFixed(1);
        const percentage = totalPoints > 0 ? ((totalScore / totalPoints) * 100).toFixed(1) : 0;
        percentageDisplay.textContent = `(${percentage}%)`;
    }
}

// Initialize total scores on page load
document.addEventListener('DOMContentLoaded', function() {
    {% for student in students %}
    updateStudentTotalScore({{ student.id }});
    {% endfor %}
});
</script>
{% endblock %}

