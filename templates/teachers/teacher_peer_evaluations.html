{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h3 class="mb-2 mb-md-0"><i class="bi bi-people me-2"></i>Peer Evaluations - {{ assignment.title }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('teacher.assignments.view_group_assignment', assignment_id=assignment.id) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Assignment
      </a>
    </div>
  </div>

  <!-- Assignment Info -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
      <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Assignment Details</h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <strong>Assignment:</strong> {{ assignment.title }}
        </div>
        <div class="col-12 col-md-6">
          <strong>Due Date:</strong> {{ assignment.due_date.strftime('%B %d, %Y at %I:%M %p') }}
        </div>
        {% if assignment.description %}
          <div class="col-12">
            <strong>Description:</strong> {{ assignment.description }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Evaluations Overview -->
  <div class="row g-3 g-md-4 mb-4">
    <div class="col-12 col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-primary">{{ evaluations_by_group|length }}</h4>
          <p class="mb-0">Groups with Evaluations</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-success">
            {% set total_evaluations = 0 %}
            {% for group_id, evals in evaluations_by_group.items() %}
              {% set total_evaluations = total_evaluations + evals|length %}
            {% endfor %}
            {{ total_evaluations }}
          </h4>
          <p class="mb-0">Total Evaluations</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-info">
            {% set avg_score = 0 %}
            {% set score_count = 0 %}
            {% for group_id, evals in evaluations_by_group.items() %}
              {% for eval in evals %}
                {% set avg_score = avg_score + eval.overall_score %}
                {% set score_count = score_count + 1 %}
              {% endfor %}
            {% endfor %}
            {% if score_count > 0 %}
              {{ "%.1f"|format(avg_score / score_count) }}
            {% else %}
              0.0
            {% endif %}
          </h4>
          <p class="mb-0">Average Score</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-warning">
            {% set high_scores = 0 %}
            {% for group_id, evals in evaluations_by_group.items() %}
              {% for eval in evals %}
                {% if eval.overall_score >= 4 %}
                  {% set high_scores = high_scores + 1 %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {{ high_scores }}
          </h4>
          <p class="mb-0">High Scores (4+)</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Peer Evaluations by Group -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Peer Evaluations by Group</h5>
    </div>
    <div class="card-body">
      {% if evaluations_by_group %}
        {% for group_id, evaluations in evaluations_by_group.items() %}
          <div class="card border-primary mb-4">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="bi bi-people me-2"></i>Group: {{ evaluations[0].group.name }}
                <span class="badge bg-primary ms-2">{{ evaluations|length }} evaluations</span>
              </h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead>
                    <tr>
                      <th>Evaluator</th>
                      <th>Evaluatee</th>
                      <th>Collaboration</th>
                      <th>Contribution</th>
                      <th>Communication</th>
                      <th>Overall</th>
                      <th>Comments</th>
                      <th>Submitted</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for evaluation in evaluations %}
                      <tr>
                        <td>
                          <strong>{{ evaluation.evaluator.first_name }} {{ evaluation.evaluator.last_name }}</strong>
                        </td>
                        <td>
                          <strong>{{ evaluation.evaluatee.first_name }} {{ evaluation.evaluatee.last_name }}</strong>
                        </td>
                        <td>
                          <span class="badge bg-info">{{ evaluation.collaboration_score }}/5</span>
                        </td>
                        <td>
                          <span class="badge bg-success">{{ evaluation.contribution_score }}/5</span>
                        </td>
                        <td>
                          <span class="badge bg-warning">{{ evaluation.communication_score }}/5</span>
                        </td>
                        <td>
                          {% if evaluation.overall_score >= 4 %}
                            <span class="badge bg-success">{{ evaluation.overall_score }}/5</span>
                          {% elif evaluation.overall_score >= 3 %}
                            <span class="badge bg-warning">{{ evaluation.overall_score }}/5</span>
                          {% else %}
                            <span class="badge bg-danger">{{ evaluation.overall_score }}/5</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if evaluation.comments %}
                            <button type="button" class="btn btn-outline-info btn-sm" 
                                    data-bs-toggle="tooltip" data-bs-placement="top" 
                                    title="{{ evaluation.comments }}">
                              <i class="bi bi-chat-text"></i>
                            </button>
                          {% else %}
                            <span class="text-muted">No comments</span>
                          {% endif %}
                        </td>
                        <td>
                          <small class="text-muted">{{ evaluation.submitted_at.strftime('%m/%d/%Y %I:%M %p') }}</small>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              <!-- Group Summary -->
              <div class="row mt-3">
                <div class="col-12">
                  <div class="alert alert-info">
                    <h6><i class="bi bi-graph-up me-2"></i>Group Summary</h6>
                    <div class="row g-2">
                      <div class="col-6 col-md-3">
                        <small class="text-muted">Avg Collaboration:</small>
                        <div class="fw-bold">
                          {% set avg_collab = evaluations|sum(attribute='collaboration_score') / evaluations|length %}
                          {{ "%.1f"|format(avg_collab) }}/5
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <small class="text-muted">Avg Contribution:</small>
                        <div class="fw-bold">
                          {% set avg_contrib = evaluations|sum(attribute='contribution_score') / evaluations|length %}
                          {{ "%.1f"|format(avg_contrib) }}/5
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <small class="text-muted">Avg Communication:</small>
                        <div class="fw-bold">
                          {% set avg_comm = evaluations|sum(attribute='communication_score') / evaluations|length %}
                          {{ "%.1f"|format(avg_comm) }}/5
                        </div>
                      </div>
                      <div class="col-6 col-md-3">
                        <small class="text-muted">Avg Overall:</small>
                        <div class="fw-bold">
                          {% set avg_overall = evaluations|sum(attribute='overall_score') / evaluations|length %}
                          {{ "%.1f"|format(avg_overall) }}/5
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-people display-1 text-muted"></i>
          <h5 class="mt-3 text-muted">No Peer Evaluations Found</h5>
          <p class="text-muted">Students haven't submitted peer evaluations for this assignment yet.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Evaluation Insights -->
  {% if evaluations_by_group %}
    <div class="row g-3 g-md-4 mt-4">
      <div class="col-12 col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Top Performers</h6>
          </div>
          <div class="card-body">
            {% set top_evaluations = [] %}
            {% for group_id, evals in evaluations_by_group.items() %}
              {% for eval in evals %}
                {% if eval.overall_score >= 4 %}
                  {% set _ = top_evaluations.append(eval) %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {% if top_evaluations %}
              {% for eval in top_evaluations[:5] %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span>{{ eval.evaluatee.first_name }} {{ eval.evaluatee.last_name }}</span>
                  <span class="badge bg-success">{{ eval.overall_score }}/5</span>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">No high performers yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-warning text-white">
            <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Areas for Improvement</h6>
          </div>
          <div class="card-body">
            {% set low_evaluations = [] %}
            {% for group_id, evals in evaluations_by_group.items() %}
              {% for eval in evals %}
                {% if eval.overall_score < 3 %}
                  {% set _ = low_evaluations.append(eval) %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {% if low_evaluations %}
              {% for eval in low_evaluations[:5] %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span>{{ eval.evaluatee.first_name }} {{ eval.evaluatee.last_name }}</span>
                  <span class="badge bg-danger">{{ eval.overall_score }}/5</span>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">All students are performing well!</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})
</script>
{% endblock %}
