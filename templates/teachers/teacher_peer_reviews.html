{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h3 class="mb-2 mb-md-0"><i class="bi bi-eye me-2"></i>Peer Reviews - {{ group_assignment.title }}</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('teacher.assignments.view_group_assignment', assignment_id=group_assignment.id) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Assignment
      </a>
      <a href="{{ url_for('teacher.create_peer_review', assignment_id=group_assignment.id) }}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-circle me-1"></i>Create Review
      </a>
    </div>
  </div>

  <!-- Reviews Overview -->
  <div class="row g-3 g-md-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-primary">{{ peer_reviews|length }}</h4>
          <p class="mb-0">Total Reviews</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-success">
            {% if peer_reviews %}
              {{ (peer_reviews|sum(attribute='overall_score') / peer_reviews|length)|round(1) }}
            {% else %}
              0
            {% endif %}
          </h4>
          <p class="mb-0">Average Score</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="text-info">{{ reviews_by_reviewer|length }}</h4>
          <p class="mb-0">Active Reviewers</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews List -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Peer Reviews</h5>
    </div>
    <div class="card-body">
      {% if peer_reviews %}
        <div class="accordion" id="reviewsAccordion">
          {% for reviewer_id, reviews in reviews_by_reviewer.items() %}
            {% set reviewer = class_obj.students|selectattr('id', 'equalto', reviewer_id)|first %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading{{ reviewer_id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ reviewer_id }}" aria-expanded="false" aria-controls="collapse{{ reviewer_id }}">
                  <div class="d-flex justify-content-between align-items-center w-100 me-3">
                    <div>
                      <i class="bi bi-person-check me-2"></i>
                      <strong>{{ reviewer.first_name }} {{ reviewer.last_name }}</strong>
                      <span class="badge bg-primary ms-2">{{ reviews|length }} reviews</span>
                    </div>
                    <div class="text-muted">
                      {% if reviews %}
                        Avg: {{ (reviews|sum(attribute='overall_score') / reviews|length)|round(1) }}/5
                      {% endif %}
                    </div>
                  </div>
                </button>
              </h2>
              <div id="collapse{{ reviewer_id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ reviewer_id }}" data-bs-parent="#reviewsAccordion">
                <div class="accordion-body">
                  <div class="row g-3">
                    {% for review in reviews %}
                      {% set reviewee = class_obj.students|selectattr('id', 'equalto', review.reviewee_id)|first %}
                      <div class="col-12 col-md-6">
                        <div class="card border-info h-100">
                          <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                              <i class="bi bi-person me-2"></i>Review of {{ reviewee.first_name }} {{ reviewee.last_name }}
                            </h6>
                          </div>
                          <div class="card-body">
                            <!-- Scores -->
                            <div class="row g-2 mb-3">
                              <div class="col-6">
                                <small class="text-muted">Work Quality:</small>
                                <div class="fw-bold">
                                  {% for i in range(1, 6) %}
                                    {% if i <= review.work_quality_score %}
                                      <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                      <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                  {% endfor %}
                                  <span class="ms-1">{{ review.work_quality_score }}/5</span>
                                </div>
                              </div>
                              <div class="col-6">
                                <small class="text-muted">Creativity:</small>
                                <div class="fw-bold">
                                  {% for i in range(1, 6) %}
                                    {% if i <= review.creativity_score %}
                                      <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                      <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                  {% endfor %}
                                  <span class="ms-1">{{ review.creativity_score }}/5</span>
                                </div>
                              </div>
                              <div class="col-6">
                                <small class="text-muted">Presentation:</small>
                                <div class="fw-bold">
                                  {% for i in range(1, 6) %}
                                    {% if i <= review.presentation_score %}
                                      <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                      <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                  {% endfor %}
                                  <span class="ms-1">{{ review.presentation_score }}/5</span>
                                </div>
                              </div>
                              <div class="col-6">
                                <small class="text-muted">Overall:</small>
                                <div class="fw-bold">
                                  {% for i in range(1, 6) %}
                                    {% if i <= review.overall_score %}
                                      <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                      <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                  {% endfor %}
                                  <span class="ms-1">{{ review.overall_score }}/5</span>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Feedback -->
                            {% if review.constructive_feedback %}
                              <div class="mb-2">
                                <small class="text-muted">Feedback:</small>
                                <p class="small mb-0">{{ review.constructive_feedback }}</p>
                              </div>
                            {% endif %}
                            
                            {% if review.strengths %}
                              <div class="mb-2">
                                <small class="text-muted">Strengths:</small>
                                <p class="small mb-0 text-success">{{ review.strengths }}</p>
                              </div>
                            {% endif %}
                            
                            {% if review.improvements %}
                              <div class="mb-2">
                                <small class="text-muted">Improvements:</small>
                                <p class="small mb-0 text-warning">{{ review.improvements }}</p>
                              </div>
                            {% endif %}
                            
                            <small class="text-muted">
                              Submitted: {{ review.submitted_at.strftime('%m/%d/%Y %I:%M %p') }}
                            </small>
                          </div>
                          <div class="card-footer bg-transparent">
                            <div class="btn-group w-100" role="group">
                              <a href="{{ url_for('teacher.edit_peer_review', review_id=review.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil me-1"></i>Edit
                              </a>
                              <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteReview({{ review.id }})">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-eye display-1 text-muted"></i>
          <h5 class="mt-3 text-muted">No Peer Reviews Found</h5>
          <p class="text-muted">Create peer reviews to get student feedback on their work.</p>
          <a href="{{ url_for('teacher.create_peer_review', assignment_id=group_assignment.id) }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Create Your First Review
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-3 g-md-4 mt-4">
    <div class="col-12 col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Peer Review Benefits</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Encourage critical thinking</li>
            <li>Improve communication skills</li>
            <li>Provide diverse perspectives</li>
            <li>Build collaborative skills</li>
            <li>Enhance learning outcomes</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-white">
          <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Quick Actions</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{{ url_for('teacher.create_peer_review', assignment_id=group_assignment.id) }}" class="btn btn-primary btn-sm">
              <i class="bi bi-plus-circle me-1"></i>Create New Review
            </a>
            <a href="{{ url_for('teacher.assignments.view_group_assignment', assignment_id=group_assignment.id) }}" class="btn btn-success btn-sm">
              <i class="bi bi-arrow-left me-1"></i>Back to Assignment
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function deleteReview(reviewId) {
  if (confirm('Are you sure you want to delete this peer review? This action cannot be undone.')) {
    // Create a form to submit the delete request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('teacher.delete_peer_review', review_id=0) }}".replace('0', reviewId);
    
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}
