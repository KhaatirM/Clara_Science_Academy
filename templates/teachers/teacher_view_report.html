{% extends "shared/dashboard_layout.html" %}

{% block dashboard_content %}
<div class="container-fluid px-2 px-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h3 class="mb-2 mb-md-0"><i class="bi bi-file-text me-2"></i>{{ report.report_name }}</h3>
    <div class="d-flex gap-2">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-download me-1"></i>Export
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="{{ url_for('teacher.export_report', report_id=report.id, format='pdf') }}">PDF</a></li>
          <li><a class="dropdown-item" href="{{ url_for('teacher.export_report', report_id=report.id, format='excel') }}">Excel</a></li>
          <li><a class="dropdown-item" href="{{ url_for('teacher.export_report', report_id=report.id, format='csv') }}">CSV</a></li>
        </ul>
      </div>
      <a href="{{ url_for('teacher.grading.class_reports', class_id=class_obj.id) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Reports
      </a>
    </div>
  </div>

  <!-- Report Header -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Report Information</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <strong>Class:</strong><br>
              <span class="fw-bold">{{ class_obj.name }}</span>
            </div>
            <div class="col-12 col-md-6">
              <strong>Report Type:</strong><br>
              <span class="badge bg-info fs-6">{{ report.report_type.replace('_', ' ').title() }}</span>
            </div>
            <div class="col-12 col-md-6">
              <strong>Period:</strong><br>
              <span class="fw-bold">
                {{ report.report_period_start.strftime('%B %d, %Y') }} - 
                {{ report.report_period_end.strftime('%B %d, %Y') }}
              </span>
            </div>
            <div class="col-12 col-md-6">
              <strong>Generated:</strong><br>
              <span class="fw-bold">{{ report.generated_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
            </div>
            <div class="col-12 col-md-6">
              <strong>Status:</strong><br>
              {% if report.is_exported %}
                <span class="badge bg-success">Exported</span>
              {% else %}
                <span class="badge bg-warning">Available</span>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <strong>Generated By:</strong><br>
              <span class="fw-bold">{{ report.generator.first_name }} {{ report.generator.last_name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Content -->
  <div class="row g-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Report Data</h5>
        </div>
        <div class="card-body">
          {% if report_data %}
            {% if report.report_type == 'comprehensive' %}
              <!-- Comprehensive Report Content -->
              <div class="row g-4 mb-4">
                <div class="col-12 col-md-6">
                  <h6 class="text-primary">Groups Overview</h6>
                  {% if report_data.groups %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Group</th>
                            <th>Members</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for group in report_data.groups %}
                            <tr>
                              <td>{{ group.name }}</td>
                              <td><span class="badge bg-secondary">{{ group.member_count }}</span></td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">No groups found for this period.</p>
                  {% endif %}
                </div>
                <div class="col-12 col-md-6">
                  <h6 class="text-primary">Assignments Overview</h6>
                  {% if report_data.assignments %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Assignment</th>
                            <th>Due Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for assignment in report_data.assignments %}
                            <tr>
                              <td>{{ assignment.title }}</td>
                              <td><small class="text-muted">{{ assignment.due_date[:10] }}</small></td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">No assignments found for this period.</p>
                  {% endif %}
                </div>
              </div>

              <div class="row g-4">
                <div class="col-12">
                  <h6 class="text-primary">Contributions Summary</h6>
                  {% if report_data.contributions %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Student ID</th>
                            <th>Contribution Type</th>
                            <th>Quality Rating</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for contribution in report_data.contributions %}
                            <tr>
                              <td>{{ contribution.student_id }}</td>
                              <td><span class="badge bg-info">{{ contribution.type.replace('_', ' ').title() }}</span></td>
                              <td>
                                {% if contribution.quality %}
                                  <span class="badge bg-success">{{ contribution.quality }}/5</span>
                                {% else %}
                                  <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">No contributions recorded for this period.</p>
                  {% endif %}
                </div>
              </div>

            {% elif report.report_type == 'performance' %}
              <!-- Performance Report Content -->
              <div class="row g-4">
                <div class="col-12">
                  <h6 class="text-primary">Performance Summary</h6>
                  {% if report_data.grades %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Student ID</th>
                            <th>Grade Data</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for grade in report_data.grades %}
                            <tr>
                              <td>{{ grade.student_id }}</td>
                              <td><code>{{ grade.grade_data }}</code></td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">No performance data found for this period.</p>
                  {% endif %}
                </div>
              </div>

            {% elif report.report_type == 'collaboration' %}
              <!-- Collaboration Report Content -->
              <div class="row g-4">
                <div class="col-12">
                  <h6 class="text-primary">Collaboration Metrics</h6>
                  {% if report_data.collaboration_metrics %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Group ID</th>
                            <th>Metric Type</th>
                            <th>Value</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for metric in report_data.collaboration_metrics %}
                            <tr>
                              <td>{{ metric.group_id }}</td>
                              <td><span class="badge bg-info">{{ metric.type.replace('_', ' ').title() }}</span></td>
                              <td>
                                <div class="progress" style="height: 20px;">
                                  <div class="progress-bar" role="progressbar" style="width: {{ (metric.value / 5 * 100)|round(1) }}%">
                                    {{ metric.value }}/5
                                  </div>
                                </div>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">No collaboration metrics found for this period.</p>
                  {% endif %}
                </div>
              </div>

            {% else %}
              <!-- Default/Other Report Types -->
              <div class="row g-4">
                <div class="col-12">
                  <h6 class="text-primary">Report Data</h6>
                  <pre class="bg-light p-3 rounded"><code>{{ report_data|tojson(indent=2) }}</code></pre>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="text-center py-4">
              <i class="bi bi-file-text display-4 text-muted"></i>
              <h6 class="mt-3 text-muted">No Report Data</h6>
              <p class="text-muted">This report does not contain any data for the selected period.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Export History -->
  {% if report.exports %}
  <div class="row g-4 mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-download me-2"></i>Export History</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Format</th>
                  <th>Exported By</th>
                  <th>Exported At</th>
                  <th>Downloads</th>
                  <th>Last Downloaded</th>
                </tr>
              </thead>
              <tbody>
                {% for export in report.exports %}
                  <tr>
                    <td>
                      <span class="badge bg-secondary">{{ export.export_format.upper() }}</span>
                    </td>
                    <td>{{ export.exporter.first_name }} {{ export.exporter.last_name }}</td>
                    <td>{{ export.exported_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                    <td><span class="badge bg-info">{{ export.download_count }}</span></td>
                    <td>
                      {% if export.last_downloaded %}
                        {{ export.last_downloaded.strftime('%m/%d/%Y %I:%M %p') }}
                      {% else %}
                        <span class="text-muted">Never</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
