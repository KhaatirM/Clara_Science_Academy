{% extends "shared/dashboard_layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tech_dashboard.css') }}">
<style>
    .dashboard-content-wrapper {
        position: relative;
        z-index: 1;
    }
    
    /* Performance optimizations for activity log */
    .tech-dashboard-wrapper {
        /* Disable heavy animations on this page */
        animation: none !important;
    }
    
    .tech-dashboard-wrapper::before,
    .tech-dashboard-wrapper::after {
        display: none !important;
    }
    
    /* Optimize table rendering */
    .tech-table {
        /* Disable backdrop filter for better performance */
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background: rgba(255, 255, 255, 0.95) !important;
    }
    
    .tech-table thead th {
        color: #333 !important;
        background: rgba(102, 126, 234, 0.1) !important;
        font-weight: 600;
    }
    
    .tech-table tbody td {
        color: #333 !important;
        background: white !important;
    }
    
    .tech-table tbody tr {
        background: white !important;
    }
    
    .tech-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05) !important;
    }
    
    /* Better text contrast */
    .tech-badge {
        color: white !important;
    }
    
    /* Activity Log Title with Gradient - Enhanced visibility and contrast */
    h1.activity-log-title,
    .activity-log-title {
        background: linear-gradient(135deg, #4c63d2 0%, #5a3d91 20%, #c850c0 40%, #3d8bfd 70%, #0066cc 90%, #0073e6 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        font-weight: 800 !important;
        font-size: 2.25rem !important;
        display: inline-block;
        overflow: visible !important;
        padding: 0;
        margin: 0;
        position: relative;
        line-height: 1.2;
    }
    
    /* Ensure icon also gets gradient */
    .activity-log-title i {
        background: linear-gradient(135deg, #4c63d2 0%, #5a3d91 20%, #c850c0 40%, #3d8bfd 70%, #0066cc 90%, #0073e6 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
    }
    
    /* Ensure header card doesn't clip gradient */
    .tech-card.tech-header {
        overflow: visible !important;
    }
    
    .tech-card.tech-header > div {
        overflow: visible !important;
    }
    
    /* Action badge with better contrast on white background */
    .action-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .tech-table tbody td small {
        color: #666 !important;
    }
    
    /* Disable card animations */
    .tech-card {
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
    }
    
    /* Optimize filters */
    .tech-filters {
        backdrop-filter: blur(5px) !important;
        -webkit-backdrop-filter: blur(5px) !important;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="tech-dashboard-wrapper activity-log-page">
<div class="container-fluid px-2 px-md-4 dashboard-content-wrapper py-4">
    <div class="row g-3 g-md-4">
        <div class="col-12">
            <div class="tech-card tech-header mb-4" style="background: rgba(255, 255, 255, 0.95) !important; overflow: visible;">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2" style="overflow: visible;">
                    <div style="overflow: visible; padding: 0.5rem 0.5rem 0.5rem 0;">
                        <h1 class="mb-1 activity-log-title"><i class="bi bi-clock-history me-2"></i>Activity Log</h1>
                        <p class="mb-0" style="color: #666;">View detailed user activity and security logs</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="exportLog()">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                        <button class="btn btn-danger" onclick="clearOldLogs()">
                            <i class="bi bi-trash me-1"></i>Clear Old
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Filters -->
    <div class="tech-filters mb-4" style="background: rgba(255, 255, 255, 0.95) !important;">
        <h5 class="mb-3" style="color: #333;">
            <i class="bi bi-funnel-fill me-2"></i>Filters
        </h5>
        <form method="GET" class="row g-3">
            <div class="col-12 col-md-2">
                <label for="user_id" class="tech-form-label" style="color: #333;">User</label>
                <select class="form-select" name="user_id" id="user_id" style="background: white; color: #333; border: 1px solid #ddd;">
                    <option value="">All Users</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if filters.user_id == user.id %}selected{% endif %}>
                        {{ user.username }} ({{ user.role }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-2">
                <label for="action" class="tech-form-label" style="color: #333;">Action</label>
                <select class="form-select" name="action" id="action" style="background: white; color: #333; border: 1px solid #ddd;">
                    <option value="">All Actions</option>
                    {% for action in actions %}
                    <option value="{{ action }}" {% if filters.action == action %}selected{% endif %}>
                        {{ action }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-2">
                <label for="start_date" class="tech-form-label" style="color: #333;">Start Date</label>
                <input type="date" class="form-control" name="start_date" id="start_date" 
                       value="{{ filters.start_date }}" style="background: white; color: #333; border: 1px solid #ddd;">
            </div>
            <div class="col-12 col-md-2">
                <label for="end_date" class="tech-form-label" style="color: #333;">End Date</label>
                <input type="date" class="form-control" name="end_date" id="end_date" 
                       value="{{ filters.end_date }}" style="background: white; color: #333; border: 1px solid #ddd;">
            </div>
            <div class="col-12 col-md-2">
                <label for="limit" class="tech-form-label" style="color: #333;">Limit</label>
                <select class="form-select" name="limit" id="limit" style="background: white; color: #333; border: 1px solid #ddd;">
                    <option value="50" {% if filters.limit == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if filters.limit == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if filters.limit == 200 %}selected{% endif %}>200</option>
                    <option value="500" {% if filters.limit == 500 %}selected{% endif %}>500</option>
                </select>
            </div>
            <div class="col-12 col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary flex-fill">
                    <i class="bi bi-search me-1"></i>Filter
                </button>
                <a href="{{ url_for('tech.activity_log') }}" class="btn btn-secondary flex-fill">
                    <i class="bi bi-x-circle me-1"></i>Clear
                </a>
            </div>
        </form>
    </div>
    <!-- Activity Log Table -->
    <div class="row g-3 g-md-4">
        <div class="col-12">
            <div class="tech-card" style="background: rgba(255, 255, 255, 0.95) !important;">
                <div class="tech-header" style="background: rgba(102, 126, 234, 0.1) !important;">
                    <h5 class="mb-0" style="color: #333;"><i class="bi bi-table me-2"></i>Activity Log Entries</h5>
                </div>
                <div class="p-0">
                    {% if logs %}
                    <div class="table-responsive">
                        <table class="tech-table table">
                            <thead>
                                <tr>
                                    <th style="width: 160px;">Timestamp</th>
                                    <th style="width: 150px;">User</th>
                                    <th style="width: 120px;">Action</th>
                                    <th style="width: 100px;">Status</th>
                                    <th style="width: 130px;">IP Address</th>
                                    <th style="width: 120px;">User Agent</th>
                                    <th style="width: 150px;">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr class="{% if not log.success %}table-danger{% endif %}">
                                    <td>
                                        <div style="font-size: 0.85rem; line-height: 1.4;">
                                            <div style="font-weight: 600; color: #333;">{{ log.timestamp.strftime('%m/%d/%Y') if log.timestamp else 'N/A' }}</div>
                                            <div style="color: #666;">{{ log.timestamp.strftime('%H:%M:%S') if log.timestamp else '' }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if log.user %}
                                        <span class="tech-badge tech-badge-primary">{{ log.user.username }}</span>
                                        <small style="color: #666; display: block; margin-top: 0.25rem; font-size: 0.75rem;">{{ log.user.role }}</small>
                                        {% else %}
                                        <span style="color: #666;">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="action-badge" style="font-size: 0.75rem;">{{ log.action }}</span>
                                    </td>
                                    <td>
                                        {% if log.success %}
                                        <span class="tech-badge tech-badge-success">Success</span>
                                        {% else %}
                                        <span class="tech-badge tech-badge-danger">Failed</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small style="color: #666; font-family: monospace;">{{ log.ip_address or 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <small style="color: #666; font-size: 0.75rem; display: block; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ log.user_agent or 'N/A' }}">
                                            {{ (log.user_agent[:30] + '...') if log.user_agent and log.user_agent|length > 30 else (log.user_agent or 'N/A') }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1 flex-wrap">
                                            {% if log.details or log.error_message or log.user_agent %}
                                            <button class="tech-btn tech-btn-info" style="padding: 0.35rem 0.7rem; font-size: 0.8rem;" onclick="showDetails({{ log.id }})" title="View full details">
                                                <i class="bi bi-eye"></i>View
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="tech-empty-state">
                        <i class="bi bi-inbox d-block mb-3"></i>
                        <h5>No activity logs found</h5>
                        <p>Try adjusting your filters or check back later.</p>
                    </div>
                    {% endif %}
                    
                    {% if pagination.pages > 1 %}
                    <div class="p-3" style="background: rgba(255, 255, 255, 0.95); border-top: 1px solid rgba(0, 0, 0, 0.1);">
                        <nav aria-label="Activity log pagination">
                            <ul class="pagination mb-0 justify-content-center">
                                {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('tech.activity_log', page=pagination.prev_num, user_id=filters.user_id, action=filters.action, start_date=filters.start_date, end_date=filters.end_date, limit=filters.limit) }}">Previous</a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if page_num %}
                                        {% if page_num == pagination.page %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('tech.activity_log', page=page_num, user_id=filters.user_id, action=filters.action, start_date=filters.start_date, end_date=filters.end_date, limit=filters.limit) }}">{{ page_num }}</a>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('tech.activity_log', page=pagination.next_num, user_id=filters.user_id, action=filters.action, start_date=filters.start_date, end_date=filters.end_date, limit=filters.limit) }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        <div class="text-center mt-2" style="color: #666; font-size: 0.85rem;">
                            Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} to {{ pagination.per_page * (pagination.page - 1) + pagination.items|length }} of {{ pagination.total }} entries
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle me-2"></i>Activity Log Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDetails(logId) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    const contentDiv = document.getElementById('detailsContent');
    
    // Show loading state
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading details...</p>
        </div>
    `;
    modal.show();
    
    // Fetch details via AJAX
    fetch(`{{ url_for('tech.activity_log_details', log_id=0) }}`.replace('/0', `/${logId}`))
        .then(response => response.json())
        .then(data => {
            let detailsHtml = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-person me-2"></i>User Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Username:</strong></td><td>${data.user}</td></tr>
                            <tr><td><strong>Role:</strong></td><td>${data.user_role}</td></tr>
                            <tr><td><strong>User ID:</strong></td><td>${data.id}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-clock me-2"></i>Activity Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Action:</strong></td><td><span class="badge bg-secondary">${data.action}</span></td></tr>
                            <tr><td><strong>Timestamp:</strong></td><td>${data.timestamp}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${data.success ? 'success' : 'danger'}">${data.success ? 'Success' : 'Failed'}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-globe me-2"></i>Network Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>IP Address:</strong></td><td><code>${data.ip_address}</code></td></tr>
                            <tr><td><strong>User Agent:</strong></td><td><small>${data.user_agent}</small></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-file-text me-2"></i>Additional Details</h6>
                        <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.25rem;">
                            ${data.details ? (typeof data.details === 'object' ? '<pre>' + JSON.stringify(data.details, null, 2) + '</pre>' : '<pre>' + data.details + '</pre>') : '<em class="text-muted">No additional details</em>'}
                        </div>
                    </div>
            `;
            
            if (data.error_message) {
                detailsHtml += `
                    <div class="col-12">
                        <h6 class="text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error Message</h6>
                        <div class="alert alert-danger">
                            <pre style="white-space: pre-wrap; margin: 0;">${data.error_message}</pre>
                        </div>
                    </div>
                `;
            }
            
            detailsHtml += '</div>';
            contentDiv.innerHTML = detailsHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading details: ${error.message}
                </div>
            `;
        });
}

function exportLog() {
    // Export functionality would go here
    alert('Export functionality would be implemented here');
}

function clearOldLogs() {
    if (confirm('Are you sure you want to clear logs older than 30 days?')) {
        // Clear old logs functionality would go here
        alert('Clear old logs functionality would be implemented here');
    }
}
</script>
{% endblock %} 